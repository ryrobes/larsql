cascade_id: comprehensive_test
description: 'Comprehensive test: deterministic data, LLM soundings, validation, decision
  points, artifacts'
inputs_schema:
  analysis_type: Type of analysis (sales/customer/product)
cells:
# SQL data extraction with progress display (non-blocking)
- name: extract_sales_data
  tool: sql_data
  await_input: false  # Don't block - this is a progress display
  hitl: |
    <div class="card">
      <header>
        <h2 class="card-title flex items-center gap-2">
          <svg class="animate-spin h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Extracting Sales Data
        </h2>
        <p class="card-description">Running SQL query to generate sample data...</p>
      </header>
      <section class="py-4">
        <pre class="bg-muted p-3 rounded text-xs text-muted-foreground">SELECT * FROM sales...</pre>
      </section>
    </div>
  inputs:
    query: "-- Generate sample sales data\nSELECT * FROM (\n  VALUES\n    ('2024-12-01',\
      \ 'Electronics', 'Laptop', 1200, 5),\n    ('2024-12-02', 'Electronics', 'Phone',\
      \ 800, 12),\n    ('2024-12-03', 'Clothing', 'Jacket', 150, 25),\n    ('2024-12-04',\
      \ 'Home', 'Chair', 300, 8),\n    ('2024-12-05', 'Electronics', 'Tablet', 600,\
      \ 15),\n    ('2024-12-06', 'Clothing', 'Shoes', 120, 30),\n    ('2024-12-07',\
      \ 'Home', 'Desk', 450, 6),\n    ('2024-12-08', 'Electronics', 'Headphones',\
      \ 200, 20)\n) AS sales(date, category, product, price, quantity)\n"
  handoffs:
    - enrich_data
# Python data enrichment with progress display (non-blocking)
- name: enrich_data
  tool: python_data
  await_input: false  # Don't block - this is a progress display
  hitl: |
    <div class="card">
      <header>
        <h2 class="card-title flex items-center gap-2">
          <svg class="animate-spin h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Enriching Data
        </h2>
        <p class="card-description">Running Python to calculate revenue and profits...</p>
      </header>
      <section class="py-4 space-y-2">
        <div class="text-sm text-muted-foreground">Processing {{ outputs.extract_sales_data | length if outputs.extract_sales_data else '?' }} rows</div>
        <div class="flex gap-2 flex-wrap">
          <span class="badge-outline text-xs">Revenue</span>
          <span class="badge-outline text-xs">Profit Margin</span>
          <span class="badge-outline text-xs">Tier Classification</span>
        </div>
      </section>
    </div>
  inputs:
    code: "import pandas as pd\n\n# Access prior phase data (zero-copy from temp table!)\n\
      df = data.extract_sales_data\n\n# Calculate metrics\ndf['revenue'] = df['price']\
      \ * df['quantity']\ndf['profit_margin'] = df['category'].map({\n    'Electronics':\
      \ 0.15,\n    'Clothing': 0.40,\n    'Home': 0.25\n})\ndf['profit'] = df['revenue']\
      \ * df['profit_margin']\ndf['date'] = pd.to_datetime(df['date'])\n\n# Performance\
      \ classification\ndf['tier'] = pd.cut(df['revenue'],\n                    bins=[0,\
      \ 2000, 5000, float('inf')],\n                    labels=['Low', 'Medium', 'High'])\n\
      \nresult = df\n# Auto-creates temp table: _enrich_data\n"
  handoffs:
    - analyze_with_soundings
# LLM analysis with progress display (non-blocking during takes)
- name: analyze_with_soundings
  await_input: false  # Don't block - this is a progress display
  hitl: |
    <div class="card">
      <header>
        <h2 class="card-title flex items-center gap-2">
          <svg class="animate-spin h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          AI Analyzing Data
        </h2>
        <p class="card-description">Running 3 take analyses in parallel...</p>
      </header>
      <section class="py-4">
        <div class="flex gap-2">
          <span class="badge text-xs">Take 1</span>
          <span class="badge text-xs">Take 2</span>
          <span class="badge text-xs">Take 3</span>
        </div>
        <p class="text-sm text-muted-foreground mt-2">Analysis type: {{ input.analysis_type }}</p>
      </section>
    </div>
  instructions: "Analyze the sales data and provide business insights.\n\nFocus: {{\
    \ input.analysis_type }}\n\nYou can query the enriched data from temp table _enrich_data.\n\
    \nProvide structured analysis as JSON:\n{\n  \"key_insights\": [\"insight 1\"\
    , \"insight 2\", \"insight 3\"],\n  \"top_performers\": [\"product/category with\
    \ metrics\"],\n  \"recommendations\": [\"actionable rec 1\", \"actionable rec\
    \ 2\"],\n  \"confidence\": 0.85\n}\n\nBe specific - reference actual products,\
    \ categories, and numbers.\n"
  handoffs:
    - validate_analysis
  output_schema:
    properties:
      confidence:
        maximum: 1
        minimum: 0
        type: number
      key_insights:
        items:
          type: string
        minItems: 3
        type: array
      recommendations:
        items:
          type: string
        minItems: 2
        type: array
      top_performers:
        items:
          type: string
        minItems: 1
        type: array
    required:
    - key_insights
    - top_performers
    - recommendations
    - confidence
    type: object
  takes:
    evaluator_instructions: 'Pick the most data-driven and actionable analysis.


      Criteria:

      - References specific products/categories from the data

      - Uses actual numbers (not generic percentages)

      - Recommendations are concrete and achievable


      (Note: Indexes is zero-based)


      Return: {"winner_index": 0, "reason": "why this one is best", "confidence":
      0.85}

      '
    factor: 3
    mode: evaluate
  skills:
  - set_state
- handoffs:
  - request_approval
  instructions: "Validate and refine the business analysis.\n\nAnalysis: {{ outputs.analyze_with_soundings\
    \ }}\n\nCheck:\n1. Do insights reference actual products from our data? (Laptop,\
    \ Phone, Jacket, Chair, Tablet, Shoes, Desk, Headphones)\n2. Are recommendations\
    \ specific and achievable?\n3. Is the confidence score reasonable given depth\
    \ of analysis?\n\nIf issues found: revise the analysis.\nIf all good: confirm\
    \ validation passed.\n\nOutput same JSON structure with added field:\n{\n  \"\
    key_insights\": [...],\n  \"top_performers\": [...],\n  \"recommendations\": [...],\n\
    \  \"confidence\": 0.XX,\n  \"validation_status\": \"passed\" or \"revised\",\n\
    \  \"validation_notes\": \"what you checked/changed\"\n}\n"
  name: validate_analysis
  output_schema:
    required:
    - key_insights
    - recommendations
    - confidence
    - validation_status
    type: object
  rules:
    loop_until: satisfied
    loop_until_prompt: Ensure validation_status is explicitly set to 'passed' to confirm
      validation succeeded
    max_attempts: 3
    max_turns: 1
  skills:
  - set_state
- decision_points:
    enabled: true
    routing:
      _timeout: create_dashboard
      publish: create_dashboard
      skip: finalize
    timeout_seconds: 60
    trigger: output
  instructions: "Request human approval before publishing.\n\nValidated analysis:\n\
    {{ outputs.validate_analysis | tojson(indent=2) }}\n\nOutput a decision block\
    \ asking for approval:\n\n<decision>\n{\n  \"question\": \"Publish this analysis\
    \ as an artifact?\",\n  \"context\": \"Analysis passed validation. Review findings\
    \ and recommendations above.\",\n  \"severity\": \"info\",\n  \"options\": [\n\
    \    {\n      \"id\": \"publish\",\n      \"label\": \"Publish Now\",\n      \"\
    description\": \"Create artifact and complete\",\n      \"style\": \"primary\"\
    \n    },\n    {\n      \"id\": \"skip\",\n      \"label\": \"Skip Publishing\"\
    ,\n      \"description\": \"Complete without artifact\",\n      \"style\": \"\
    secondary\"\n    }\n  ]\n}\n</decision>\n"
  name: request_approval
  skills:
  - route_to
- handoffs:
  - finalize
  instructions: 'Create an interactive HTML dashboard artifact.


    Analysis data: {{ outputs.validate_analysis }}


    Use create_artifact to publish a dashboard titled "Sales Analysis Report".


    Include:

    - Key insights in a card grid

    - Top performers list

    - Recommendations section

    - Dark theme (#0a0a0a background, #60a5fa accents)


    Keep it simple - focus on readability.

    '
  name: create_dashboard
  skills:
  - create_artifact
  - set_state
- instructions: 'Cascade complete! Summarize what was accomplished.


    {% if outputs.create_dashboard %}

    ✓ Published artifact

    {% else %}

    ℹ️  Skipped artifact publishing

    {% endif %}


    Analysis results: {{ outputs.validate_analysis.validation_status }}

    '
  name: finalize
  skills:
  - set_state
