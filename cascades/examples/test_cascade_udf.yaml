cascade_id: test_cascade_udf
description: Test cascade UDF with takes + validation
cells:
- name: load_transactions
  tool: sql_data
  inputs:
    query: "SELECT * FROM (VALUES\n  (1, 'Acme Corp', 150000.00),\n  (2, 'Small Business\
      \ LLC', 5000.00),\n  (3, 'Test Company', 500000.00),\n  (4, 'Legitimate Industries',\
      \ 25000.00)\n) AS t(customer_id, customer_name, transaction_amount)\n"
    materialize: 'true'
- name: fraud_check_per_row
  tool: sql_data
  inputs:
    query: "SELECT\n  customer_id,\n  customer_name,\n  transaction_amount,\n\n  --\
      \ Run COMPLETE cascade per row (includes 3 takes + validation!)\n  rvbbit_run(\n\
      \    'skills/fraud_assessment_with_takes.yaml',\n    json_object(\n    \
      \  'customer_id', customer_id,\n      'customer_name', customer_name,\n    \
      \  'transaction_amount', transaction_amount\n    )\n  ) as fraud_analysis_json\n\
      \nFROM _load_transactions\n"
    materialize: 'true'
  context:
    from:
    - load_transactions
- name: extract_and_aggregate
  tool: sql_data
  inputs:
    query: "SELECT\n  customer_name,\n  transaction_amount,\n\n  -- Extract fields\
      \ from cascade JSON output\n  CAST(json_extract_string(fraud_analysis_json,\
      \ '$.outputs.assess_risk.risk_score') AS DOUBLE) as risk_score,\n  json_extract_string(fraud_analysis_json,\
      \ '$.outputs.assess_risk.risk_level') as risk_level,\n  json_extract_string(fraud_analysis_json,\
      \ '$.outputs.assess_risk.recommended_action') as action,\n  json_extract_string(fraud_analysis_json,\
      \ '$.outputs.assess_risk.reasoning') as reasoning,\n  json_extract_string(fraud_analysis_json,\
      \ '$.session_id') as cascade_session_id\n\nFROM _fraud_check_per_row\nORDER\
      \ BY risk_score DESC\n"
  context:
    from:
    - fraud_check_per_row
