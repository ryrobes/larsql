# Single Image Outpaint to 16:9
#
# Input: { "image_path": "/path/to/image.jpg", "output_dir": "/path/to/output" }

cascade_id: outpaint_single
description: Outpaint a single image to 16:9 using Seedream 4.5

inputs_schema:
  image_path: Path to the image file
  output_dir: Directory to save result

cells:
  - name: load_image
    tool: read_image
    inputs:
      path: "{{ input.image_path }}"
    handoffs: [outpaint]

  - name: outpaint
    model: bytedance-seed/seedream-4.5
    instructions: |
      Extend this image to 16:9 aspect ratio by outpainting.
      Seamlessly continue the scene beyond its current borders.
      Match the style, lighting, and content naturally.
    context:
      from:
        - cell: load_image
          include: [images]
    handoffs: [save_result]

  - name: save_result
    tool: python_data
    inputs:
      code: |
        import os
        import shutil
        import json
        from datetime import datetime

        source = "{{ input.image_path }}"
        out_dir = "{{ input.output_dir }}"
        os.makedirs(out_dir, exist_ok=True)

        # Get images from outpaint cell - they're saved by the runner
        outpaint_raw = '''{{ outputs['outpaint'] | tojson }}'''
        try:
            outpaint_output = json.loads(outpaint_raw)
        except:
            outpaint_output = {"raw": outpaint_raw}

        images = outpaint_output.get('images', []) if isinstance(outpaint_output, dict) else []

        if images:
            name = os.path.splitext(os.path.basename(source))[0]
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            random_suffix = os.urandom(3).hex()

            saved = []
            for i, img_path in enumerate(images):
                # Images are API paths like /api/images/session/cell/image_0.png
                # We need to find the actual file
                if img_path.startswith('/api/images/'):
                    # Convert API path to filesystem path
                    from rvbbit.config import get_config
                    cfg = get_config()
                    rel_path = img_path.replace('/api/images/', '')
                    actual_path = os.path.join(cfg.image_dir, rel_path)
                else:
                    actual_path = img_path

                if os.path.exists(actual_path):
                    ext = os.path.splitext(actual_path)[1] or '.png'
                    dest = os.path.join(out_dir, f"{name}_16x9_{timestamp}_{random_suffix}{ext}")
                    shutil.copy2(actual_path, dest)
                    saved.append(dest)

            result = {
                "status": "success",
                "source": source,
                "outputs": saved,
                "count": len(saved)
            }
        else:
            result = {
                "status": "error",
                "source": source,
                "error": "No images generated",
                "raw_output": str(outpaint_output)[:500]
            }
