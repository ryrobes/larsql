# MEANING / CLUSTER - Semantic grouping
# Assigns each value to a semantic cluster for GROUP BY operations
#
# SQL Usage:
#   SELECT MEANING(county, 8, 'geographic region') as region, COUNT(*)
#   FROM sightings GROUP BY 1
#
# Direct Function:
#   SELECT semantic_cluster(county, 8, 'geographic region') FROM sightings

cascade_id: semantic_cluster

description: |
  Semantic clustering - assigns each value to one of N semantic clusters.
  The LLM first identifies cluster centroids, then classifies each value.
  Used for GROUP BY MEANING operations.

inputs_schema:
  values: JSON array of all unique values to cluster
  num_clusters: Number of clusters to create
  criterion: Optional semantic guidance for clustering (e.g., 'geographic region')

sql_function:
  name: semantic_cluster
  description: Assigns values to N semantic clusters based on criterion
  args:
    - name: values
      type: JSON
    - name: num_clusters
      type: INTEGER
      default: "8"
    - name: criterion
      type: VARCHAR
      optional: true
  returns: JSON
  shape: AGGREGATE
  context_arg: values
  operators:
    - "MEANING({{ values }})"
    - "MEANING({{ values }}, {{ num_clusters }})"
    - "MEANING({{ values }}, {{ num_clusters }}, {{ criterion }})"
  cache: true

cells:
  - name: identify_clusters
    model: google/gemini-2.5-flash-lite
    instructions: |
      Analyze these values and identify {{ input.num_clusters | default(8) }} semantic clusters.

      VALUES:
      {{ input.values }}

      {% if input.criterion %}
      CLUSTERING CRITERION: {{ input.criterion }}
      Group values by: {{ input.criterion }}
      {% else %}
      Group values by semantic similarity - find natural categories.
      {% endif %}

      Return a JSON object with this exact structure:
      {
        "clusters": [
          {"id": 0, "name": "Cluster Name", "description": "What values belong here"},
          {"id": 1, "name": "Another Cluster", "description": "Description"},
          ...
        ]
      }

      Rules:
      - Create exactly {{ input.num_clusters | default(8) }} clusters
      - Cluster names should be descriptive but concise (2-4 words)
      - Every value should fit into exactly one cluster
      - Make clusters roughly balanced when possible
    rules:
      max_turns: 1
    output_schema:
      type: object
      properties:
        clusters:
          type: array
          items:
            type: object
            properties:
              id: {type: integer}
              name: {type: string}
              description: {type: string}

  - name: assign_values
    model: google/gemini-2.5-flash-lite
    context:
      from: [identify_clusters]
    instructions: |
      Assign each value to one of the identified clusters.

      CLUSTERS:
      {{ outputs.identify_clusters.clusters | tojson }}

      VALUES TO ASSIGN:
      {{ input.values }}

      Return a JSON object mapping each value to its cluster ID:
      {
        "assignments": {
          "value1": 0,
          "value2": 1,
          "value3": 0,
          ...
        }
      }

      Rules:
      - Every value must be assigned to exactly one cluster
      - Use the cluster IDs from the CLUSTERS list
      - Choose the best-fitting cluster for each value
    rules:
      max_turns: 1
    output_schema:
      type: object
      properties:
        assignments:
          type: object
