cascade_id: semantic_matches
internal: true
description: 'Semantic boolean filter - returns TRUE if text semantically matches
  the criterion.

  Used for WHERE clauses with natural language conditions.

  '
inputs_schema:
  text: The text to evaluate
  criterion: The semantic criterion to match against
sql_function:
  name: semantic_matches
  description: Returns TRUE if text semantically matches the criterion
  args:
  - name: text
    type: VARCHAR
  - name: criterion
    type: VARCHAR
  returns: BOOLEAN
  shape: SCALAR
  operators:
  - '{{ text }} MEANS {{ criterion }}'
  - '{{ text }} MATCHES {{ criterion }}'
  - '{{ text }} ~ {{ criterion }}'
  cache: true
  test_cases:
  # MEANS infix operator
  - sql: WITH t AS (SELECT 'apple pie recipe' AS text) SELECT * FROM t WHERE text MEANS 'dessert recipes'
    expect:
      type: contains
      value: apple pie
    description: "Infix MEANS: matches related content"
  # Tilde operator (short form)
  - sql: WITH t AS (SELECT 'quantum physics' AS topic) SELECT * FROM t WHERE topic ~ 'science'
    expect:
      type: contains
      value: quantum
    description: "Infix ~: matches semantic content"
  # MATCHES infix operator
  - sql: WITH t AS (SELECT 'customer complaint about shipping delay' AS msg) SELECT * FROM t WHERE msg MATCHES 'delivery issues'
    expect:
      type: contains
      value: shipping
    description: "Infix MATCHES: filters by semantic match"
  # Function syntax
  - sql: "SELECT semantic_matches('renewable energy investments', 'environmental topics')"
    expect: true
    description: "Function: returns true for semantic match"
  # Skip flaky test - LLM interpretation can be overly generous
  - sql: "SELECT semantic_matches('basketball game results', 'cooking recipes')"
    skip: true
    expect: false
    description: "Function: returns false for unrelated topics (skipped - LLM varies)"
  # Negative case with infix
  - sql: WITH t AS (SELECT 'weather forecast' AS text) SELECT CASE WHEN text MEANS 'financial news' THEN 'yes' ELSE 'no' END FROM t
    expect: "no"
    description: "Infix MEANS: returns false for unrelated"
cells:
- name: evaluate
  model: google/gemini-2.5-flash-lite
  use_training: true
  training_limit: 5
  training_strategy: recent
  training_min_confidence: 0.8
  training_format: xml
  instructions: 'Does this text match the semantic criterion?


    TEXT: {{ input.text }}


    CRITERION: {{ input.criterion }}


    Respond with ONLY "true" or "false" - no explanation, no other text.


    Think about whether the text''s meaning, topic, or sentiment aligns with the criterion.

    Be generous in interpretation - if there''s a reasonable semantic connection,
    answer "true".

    '
  rules:
    max_turns: 1
  output_schema:
    type: boolean
