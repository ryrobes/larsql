cascade_id: semantic_similar_to

description: |
  Compute cosine similarity between two texts.

  Returns similarity score 0.0 to 1.0 (higher = more similar).
  Useful for WHERE clauses and filtering.

  SQL Usage:
    SELECT * FROM products
    WHERE description SIMILAR_TO 'sustainable' > 0.7;

    SELECT c1.name, c2.name,
           c1.description SIMILAR_TO c2.description as similarity
    FROM companies c1, companies c2
    WHERE c1.id < c2.id
      AND c1.description SIMILAR_TO c2.description > 0.8;

  Performance:
    - Per comparison: ~100ms (2 embeddings + cosine calc)
    - Cached: <1ms for duplicate text pairs
    - Use LIMIT to avoid N×M explosion in JOINs

  Warning:
    Be careful with CROSS JOINs! Use LIMIT to prevent massive LLM costs:
      WHERE a SIMILAR_TO b > 0.8 LIMIT 100  -- Good
      WHERE a SIMILAR_TO b > 0.8            -- Dangerous (N×M calls)

inputs_schema:
  text1: "First text (required)"
  text2: "Second text (required, can be literal or column)"

sql_function:
  name: similar_to
  description: Cosine similarity between two texts (0.0 to 1.0)
  args:
    - name: text1
      type: VARCHAR
      description: "First text"
    - name: text2
      type: VARCHAR
      description: "Second text"
  returns: DOUBLE  # Similarity 0.0 to 1.0
  shape: SCALAR
  operators:
    - "{{ text1 }} SIMILAR_TO {{ text2 }}"
    - "SIMILAR_TO({{ text1 }}, {{ text2 }})"
  cache: true
  context_arg: text1  # Primary text for context

cells:
  - name: compute_similarity
    tool: cosine_similarity_texts
    inputs:
      text1: "{{ input.text1 }}"
      text2: "{{ input.text2 }}"
    description: "Compute cosine similarity via embeddings"
    context:
      enabled: false

  - name: format_output
    tool: python_data
    inputs:
      code: |
        # Return similarity as float (0.0 to 1.0)
        similarity_result = data.compute_similarity
        similarity = similarity_result['similarity']
        # Clamp and round
        result = round(max(0.0, min(1.0, similarity)), 6)
    context:
      from: ["compute_similarity"]  # Require compute_similarity to complete first
