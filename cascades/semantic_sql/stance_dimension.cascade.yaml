# STANCE - Position/Stance Dimension
# A dimension function that identifies the author's stance/position on a topic.
#
# SQL Usage:
#   SELECT stance(tweet_text, 'climate change') as position, COUNT(*)
#   FROM tweets
#   GROUP BY stance(tweet_text, 'climate change')
#
#   -- With custom stance options
#   SELECT stance(tweet_text, 'remote work', 'Pro-Remote, Pro-Office, Hybrid, Neutral') as position
#   FROM workplace_tweets
#   GROUP BY stance(tweet_text, 'remote work', 'Pro-Remote, Pro-Office, Hybrid, Neutral')

cascade_id: stance_dimension
internal: true

description: |
  Stance/position analyzer for text content. Identifies where the author
  stands on a given topic or issue.

  REQUIRES a topic to analyze stance on. Optionally accepts custom stance
  categories.

  This is a DIMENSION-shaped function for use in GROUP BY clauses.

inputs_schema:
  texts: JSON array of all text values to analyze
  topic: The topic/issue to analyze stance on (REQUIRED)
  stances: Optional comma-separated list of stance categories

sql_function:
  name: stance
  description: |
    Identify author's stance on a topic. REQUIRES topic as second argument.
    Optionally specify custom stance categories as third argument.

  shape: DIMENSION
  mode: mapping

  args:
    - name: text
      type: VARCHAR
      role: dimension_source
    - name: topic
      type: VARCHAR
      description: The topic to analyze stance on (e.g., 'AI regulation', 'remote work')
    - name: stances
      type: VARCHAR
      default: null
      description: Optional custom stances (e.g., 'Supportive, Opposed, Skeptical, Neutral')

  returns: VARCHAR
  cache: true

cells:
  - name: analyze_stance
    model: google/gemini-2.5-flash-lite

    instructions: |
      Analyze the STANCE/POSITION on "{{ input.topic }}" expressed in these {{ input.texts | length }} texts.

      TOPIC TO ANALYZE: {{ input.topic }}

      {% if input.stances %}
      USE THESE STANCE CATEGORIES:
      {% for stance in input.stances.split(',') %}
      - {{ stance | trim }}
      {% endfor %}
      {% else %}
      USE THESE STANCE CATEGORIES:
      - Strongly Supportive (enthusiastic advocacy, clear support)
      - Supportive (agrees, positive but not passionate)
      - Neutral/Balanced (no clear position, balanced view)
      - Skeptical (doubts, concerns, questioning)
      - Opposed (disagrees, negative view)
      - Strongly Opposed (vehement opposition, harsh criticism)
      - Off-Topic (doesn't address {{ input.topic }})
      {% endif %}

      Texts to analyze (with index numbers):
      {% for v in input.texts %}
      [{{ loop.index0 }}] "{{ v[:500] | replace('"', '\\"') }}"
      {% endfor %}

      Return a JSON object mapping each text's INDEX NUMBER to the author's stance:

      {
        "mapping": {
          "0": "Stance Category",
          "1": "Stance Category",
          ...
        }
      }

      RULES:
      - Use the INDEX NUMBER (0, 1, 2, ...) as keys
      - Analyze stance specifically on "{{ input.topic }}"
      - Consider: explicit statements, implied positions, tone, arguments made
      - If text doesn't address the topic, use "Off-Topic" (or neutral if forced)
      - Return ONLY the JSON object

    rules:
      max_turns: 1
      max_attempts: 3

    output_schema:
      type: object
      properties:
        mapping:
          type: object
      required:
        - mapping
