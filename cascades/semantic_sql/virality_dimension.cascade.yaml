# VIRALITY - Viral Potential Dimension
# A dimension function that predicts the viral potential of social media content.
#
# SQL Usage:
#   SELECT virality(tweet_text) as potential, COUNT(*)
#   FROM tweets
#   GROUP BY virality(tweet_text)
#
#   -- With specific viral mechanism focus
#   SELECT virality(tweet_text, 'outrage') as outrage_potential, COUNT(*)
#   FROM political_tweets
#   GROUP BY virality(tweet_text, 'outrage')

cascade_id: virality_dimension
internal: true

description: |
  Viral potential predictor for social media content. Assesses how likely
  content is to spread widely and what viral mechanism it might leverage.

  Can focus on specific viral drivers: humor, outrage, inspiration, controversy, etc.

  This is a DIMENSION-shaped function for use in GROUP BY clauses.

inputs_schema:
  texts: JSON array of all text values to analyze
  mechanism: Optional focus on specific viral mechanism

sql_function:
  name: virality
  description: |
    Predict viral potential of content. What's the likelihood of wide spread?
    Optional mechanism parameter focuses on specific viral drivers.

  shape: DIMENSION
  mode: mapping

  args:
    - name: text
      type: VARCHAR
      role: dimension_source
    - name: mechanism
      type: VARCHAR
      default: null
      description: Focus on specific mechanism (humor, outrage, inspiration, controversy)

  returns: VARCHAR
  cache: true

cells:
  - name: assess_virality
    model: google/gemini-2.5-flash-lite

    instructions: |
      Assess the VIRAL POTENTIAL of these {{ input.texts | length }} social media posts.

      {% if input.mechanism %}
      FOCUS ON VIRAL MECHANISM: {{ input.mechanism }}
      {% if input.mechanism == 'humor' %}
      Look for: jokes, wit, comedic timing, meme potential, absurdity
      {% elif input.mechanism == 'outrage' %}
      Look for: rage-inducing content, injustice, "can you believe this", moral outrage
      {% elif input.mechanism == 'inspiration' %}
      Look for: motivational, heartwarming, feel-good, achievement stories
      {% elif input.mechanism == 'controversy' %}
      Look for: hot takes, unpopular opinions, debate-starting claims
      {% elif input.mechanism == 'utility' %}
      Look for: useful tips, how-tos, life hacks, must-know information
      {% endif %}

      USE THESE LEVELS for {{ input.mechanism }} virality:
      - No {{ input.mechanism | title }} Potential
      - Low {{ input.mechanism | title }} Potential
      - Moderate {{ input.mechanism | title }} Potential
      - High {{ input.mechanism | title }} Potential
      - Extreme {{ input.mechanism | title }} Potential
      {% else %}
      Assess OVERALL viral potential. Consider what makes content spread:
      - Emotional resonance (humor, outrage, inspiration, fear)
      - Relatability ("this is so me", "we've all been there")
      - Novelty (surprising, new information, unique perspective)
      - Social currency (makes sharer look good/smart/funny)
      - Controversy (debate-worthy, hot takes)
      - Utility (helpful, actionable, "save this")

      USE THESE CATEGORIES:
      - Low Potential (unlikely to spread beyond followers)
      - Niche Viral (could spread within specific community)
      - Moderate Viral (has elements that encourage sharing)
      - High Viral (strong viral hooks, likely to spread)
      - Mega Viral (exceptional viral potential, all the right elements)
      {% endif %}

      Posts to analyze (with index numbers):
      {% for v in input.texts %}
      [{{ loop.index0 }}] "{{ v[:500] | replace('"', '\\"') }}"
      {% endfor %}

      Return a JSON object mapping each post's INDEX NUMBER to its virality assessment:

      {
        "mapping": {
          "0": "Virality Level",
          "1": "Virality Level",
          ...
        }
      }

      RULES:
      - Use the INDEX NUMBER (0, 1, 2, ...) as keys
      - Be realistic - most content is NOT viral
      - Consider: hook strength, emotional pull, shareability
      - Return ONLY the JSON object

    rules:
      max_turns: 1
      max_attempts: 3

    output_schema:
      type: object
      properties:
        mapping:
          type: object
      required:
        - mapping
