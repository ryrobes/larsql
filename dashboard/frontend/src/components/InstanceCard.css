/* InstanceCard - Standalone single instance display */

.instance-card {
  background: #0d1117;
  border: 2px solid #2C3B4B;
  border-radius: 12px;
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: 100%;
  overflow: hidden; /* Let inner containers handle scroll */
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  /* Prevent layout shift during dynamic updates */
  contain: style;
}

.instance-card:hover {
  border-color: #3d4f5f;
}

/* Running state */
.instance-card.running {
  border-color: #D9A553;
  animation: pulse-border 2s ease-in-out infinite;
}

/* Finalizing state */
.instance-card.finalizing {
  border-color: #2DD4BF;
  animation: pulse-border-blue 2s ease-in-out infinite;
}

@keyframes pulse-border {
  0%, 100% {
    border-color: #D9A553;
    box-shadow: 0 0 0 0 rgba(217, 165, 83, 0.4);
  }
  50% {
    border-color: #D9A553;
    box-shadow: 0 0 0 4px rgba(217, 165, 83, 0);
  }
}

@keyframes pulse-border-blue {
  0%, 100% {
    border-color: #2DD4BF;
    box-shadow: 0 0 0 0 rgba(45, 212, 191, 0.4);
  }
  50% {
    border-color: #2DD4BF;
    box-shadow: 0 0 0 4px rgba(45, 212, 191, 0);
  }
}

/* Wide chart layout */
.instance-card.has-wide-chart .instance-card-content {
  flex-direction: column;
}

/* Loading/Error states */
.instance-card.loading-state,
.instance-card.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  min-height: 300px;
  color: #9AA5B1;
}

.instance-card.error-state {
  color: #CF6679;
  flex-direction: row;
}

/* Header */
.instance-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #2C3B4B;
}

.instance-card-header-left {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  min-width: 0;
  flex: 1;
}

.instance-card-header .session-id {
  font-size: 0.9rem;
  font-weight: 600;
  margin: 0;
  color: #F0F4F8;
  font-family: 'IBM Plex Mono', 'Monaco', 'Courier New', monospace;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.instance-card-header .timestamp {
  font-size: 0.7rem;
  color: #64748b;
  margin: 0;
}

/* Inline metrics in header */
.instance-card-metrics-inline {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-shrink: 0;
}

.metric-inline {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.metric-inline .metric-value {
  font-size: 1rem;
  font-weight: 600;
  color: #D9A553;
}

.metric-inline.cost .metric-value {
  color: #2DD4BF;
  font-size: 1.1rem;
}

.token-sparkline-inline {
  opacity: 0.8;
}

/* Status badges */
.running-badge {
  display: inline-flex;
  align-items: center;
  font-size: 0.7rem;
  font-weight: 600;
  color: #D9A553;
  background: rgba(217, 165, 83, 0.15);
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  border: 1px solid #D9A553;
  animation: pulse-text 1.5s ease-in-out infinite;
}

.finalizing-badge {
  display: inline-flex;
  align-items: center;
  font-size: 0.7rem;
  font-weight: 600;
  color: #2DD4BF;
  background: rgba(45, 212, 191, 0.15);
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  border: 1px solid rgba(45, 212, 191, 0.3);
  animation: pulse-text-blue 1.5s ease-in-out infinite;
}

.failed-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.7rem;
  font-weight: 600;
  color: #CF6679;
  background: rgba(207, 102, 121, 0.15);
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  border: 1px solid #CF6679;
}

@keyframes pulse-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes pulse-text-blue {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Wide mermaid wrapper */
.instance-card .mermaid-wrapper-top {
  width: 100%;
  min-height: 80px;
  max-height: 300px;
  background: transparent;
  border: none;
  overflow: hidden;
}

.instance-card .mermaid-wrapper-top svg {
  filter: drop-shadow(0 0 4px rgba(167, 139, 250, 0.5))
          drop-shadow(0 0 8px rgba(6, 182, 212, 0.4));
  transition: filter 0.3s ease;
}

/* Main content area */
.instance-card-content {
  display: flex;
  flex-direction: column; /* Stack vertically by default for narrow containers */
  gap: 1rem;
  flex: 1;
  min-height: 0;
}

/* Left side: Info + Mermaid */
.instance-card-info {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  min-width: 0;
}

.model-tags-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Input params */
.instance-card .input-params {
  padding: 0.5rem;
  background: #0B1219;
  border: 1px solid #2C3B4B;
  border-radius: 6px;
  max-height: 150px;
  overflow-y: auto;
}

.instance-card .input-fields {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.instance-card .input-field-display {
  display: flex;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-family: 'IBM Plex Mono', 'Monaco', 'Courier New', monospace;
  line-height: 1.4;
}

.instance-card .input-key {
  color: #2DD4BF;
  font-weight: 600;
  min-width: 60px;
  flex-shrink: 0;
}

.instance-card .input-value {
  color: #F0F4F8;
  flex: 1;
  word-break: break-word;
}

/* Mermaid wrapper */
.instance-card .mermaid-wrapper {
  width: 100%;
  min-height: 80px;
  background: transparent;
  border: none;
  overflow: visible;
}

.instance-card .mermaid-wrapper svg {
  filter: drop-shadow(0 0 3px rgba(167, 139, 250, 0.4))
          drop-shadow(0 0 6px rgba(6, 182, 212, 0.3));
}

/* Right side: Phases + Output */
.instance-card-phases {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0;
  min-width: 0;
  min-height: 0; /* Critical: Allow flex child to shrink below content size */
  overflow: hidden;
  /* Extend to card edge for scrollbar positioning */
  margin-right: -1.25rem;
  padding-right: 0;
}

/* Sticky cascade bar at top - outside scroll */
.instance-card-phases .cascade-bar-sticky {
  flex-shrink: 0;
  z-index: 10;
  background: #0d1117;
  padding-right: 1.25rem; /* Restore padding for content */
  margin-bottom: 0; /* CascadeBar has its own margin */
}

/* Scrollable phase bars container */
.instance-card-phases .phase-bars-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0; /* Critical: Allow flex child to shrink and enable scrolling */
  /* Content padding - scrollbar stays at edge */
  padding-right: 1rem;
  padding-bottom: 1rem; /* Normal padding, no hack needed */
}

/* Custom scrollbar styling - thinner and at edge */
.instance-card-phases .phase-bars-scroll::-webkit-scrollbar {
  width: 8px;
}

.instance-card-phases .phase-bars-scroll::-webkit-scrollbar-track {
  background: rgba(22, 32, 42, 0.5);
  border-radius: 4px;
}

.instance-card-phases .phase-bars-scroll::-webkit-scrollbar-thumb {
  background: rgba(45, 212, 191, 0.3);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

.instance-card-phases .phase-bars-scroll::-webkit-scrollbar-thumb:hover {
  background: rgba(45, 212, 191, 0.5);
  border: 2px solid transparent;
  background-clip: padding-box;
}

/* Final output */
.instance-card .final-output {
  margin-top: auto;
  padding: 0.75rem;
  background: #0B1219;
  border: 1px solid #2C3B4B;
  border-radius: 6px;
  min-height: 50px;
  max-height: 200px;
  overflow-y: auto;
}

.instance-card .final-output-content {
  font-size: 0.8rem;
  color: #F0F4F8;
  line-height: 1.5;
}

.instance-card .final-output-content p {
  margin: 0 0 0.5rem 0;
}

.instance-card .final-output-content p:last-child {
  margin-bottom: 0;
}

.instance-card .final-output-content code {
  background: #16202A;
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
  font-family: 'IBM Plex Mono', 'Monaco', 'Courier New', monospace;
  font-size: 0.75rem;
  color: #D9A553;
}

.instance-card .final-output-content pre {
  background: #16202A;
  padding: 0.5rem;
  border-radius: 6px;
  overflow-x: auto;
  margin: 0.5rem 0;
}

.instance-card .final-output-content pre code {
  background: none;
  padding: 0;
  color: #F0F4F8;
}

/* Live duration */
.live-duration {
  color: #fbbf24;
  font-variant-numeric: tabular-nums; /* Prevent layout shift from varying digit widths */
}

/* Animated number component - smooth transitions */
.animated-number {
  display: inline-block;
  font-variant-numeric: tabular-nums;
  transition: color 0.2s ease;
}

/* Subtle glow effect for running durations */
.live-duration .animated-number {
  text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
}

@keyframes pulse-duration {
  0%, 100% { opacity: 1; text-shadow: 0 0 8px rgba(251, 191, 36, 0.4); }
  50% { opacity: 0.85; text-shadow: 0 0 12px rgba(251, 191, 36, 0.6); }
}

/* Compact mode */
.instance-card.compact {
  padding: 1rem;
}

.instance-card.compact .final-output {
  max-height: 120px;
}

/* Header wrapping for narrow containers */
.instance-card-header {
  flex-wrap: wrap;
}

.instance-card-metrics-inline {
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Responsive - for very narrow viewports */
@media (max-width: 500px) {
  .instance-card {
    padding: 0.75rem;
  }

  .instance-card-header {
    flex-direction: column;
    gap: 0.5rem;
  }

  .instance-card-metrics-inline {
    align-self: flex-start;
  }
}

/* ============================================
   Message Detail Panel
   Shows expanded message content from MessageFlowView
   ============================================ */

.message-detail-panel {
  background: linear-gradient(135deg, rgba(167, 139, 250, 0.08), rgba(96, 165, 250, 0.05));
  border: 1px solid rgba(167, 139, 250, 0.3);
  border-radius: 8px;
  margin-bottom: 1rem;
  overflow: hidden;
  animation: slideIn 0.2s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-detail-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: rgba(167, 139, 250, 0.15);
  border-bottom: 1px solid rgba(167, 139, 250, 0.2);
}

.message-detail-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: #a78bfa;
}

.message-detail-title svg {
  opacity: 0.8;
}

.message-detail-phase {
  font-size: 0.75rem;
  font-weight: 500;
  background: rgba(96, 165, 250, 0.2);
  color: #60a5fa;
  padding: 2px 8px;
  border-radius: 4px;
  margin-left: 0.5rem;
}

.message-detail-badges {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  flex: 1;
}

.detail-role-badge,
.detail-type-badge,
.detail-sounding-badge,
.detail-reforge-badge,
.detail-winner-badge {
  font-size: 0.65rem;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
}

.detail-role-badge.role-assistant {
  background: rgba(78, 201, 176, 0.2);
  color: #4ec9b0;
}

.detail-role-badge.role-user {
  background: rgba(96, 165, 250, 0.2);
  color: #60a5fa;
}

.detail-role-badge.role-system {
  background: rgba(106, 153, 85, 0.2);
  color: #6a9955;
}

.detail-role-badge.role-tool {
  background: rgba(220, 220, 170, 0.2);
  color: #dcdcaa;
}

.detail-type-badge {
  background: rgba(128, 128, 128, 0.2);
  color: #9AA5B1;
}

.detail-sounding-badge {
  background: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
}

.detail-reforge-badge {
  background: rgba(197, 134, 192, 0.2);
  color: #c586c0;
}

.detail-winner-badge {
  background: rgba(251, 191, 36, 0.25);
  color: #fbbf24;
  display: flex;
  align-items: center;
  padding: 2px 4px;
}

.message-detail-close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: rgba(248, 113, 113, 0.1);
  border: 1px solid rgba(248, 113, 113, 0.3);
  border-radius: 6px;
  color: #f87171;
  cursor: pointer;
  transition: all 0.15s ease;
  margin-left: auto;
}

.message-detail-close:hover {
  background: rgba(248, 113, 113, 0.2);
  border-color: rgba(248, 113, 113, 0.5);
}

.message-detail-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(44, 59, 75, 0.5);
  flex-wrap: wrap;
}

.detail-model {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  background: rgba(96, 165, 250, 0.15);
  color: #60a5fa;
  padding: 2px 8px;
  border-radius: 4px;
}

.detail-turn {
  font-size: 0.7rem;
  font-weight: 600;
  color: #9AA5B1;
}

.detail-tokens {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  color: #fb923c;
}

.detail-cost {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  color: #34d399;
}

.message-detail-section {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid rgba(44, 59, 75, 0.5);
}

.message-detail-section:last-child {
  border-bottom: none;
}

.detail-section-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: #9AA5B1;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 0 0 0.75rem 0;
}

.detail-section-title svg {
  opacity: 0.7;
}

.detail-llm-messages {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-llm-message {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  overflow: hidden;
}

.detail-llm-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 0.75rem;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(44, 59, 75, 0.5);
}

.detail-llm-index {
  font-size: 0.65rem;
  font-family: 'JetBrains Mono', monospace;
  color: #6B7280;
}

.detail-llm-role {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
}

.detail-llm-role.role-system { color: #6a9955; }
.detail-llm-role.role-user { color: #60a5fa; }
.detail-llm-role.role-assistant { color: #4ec9b0; }
.detail-llm-role.role-tool { color: #dcdcaa; }

.detail-llm-content {
  padding: 0.75rem;
  font-size: 0.8rem;
  line-height: 1.5;
  color: #D4D4D4;
  word-break: break-word;
}

/* Hoverable LLM messages in detail panel */
.detail-llm-message.hoverable {
  cursor: pointer;
  transition: all 0.15s ease;
}

.detail-llm-message.hoverable:hover,
.detail-llm-message.highlighted {
  background: rgba(167, 139, 250, 0.1);
  border-left: 3px solid #a78bfa;
  margin-left: -3px;
}

.detail-llm-hash {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  background: rgba(167, 139, 250, 0.2);
  color: #a78bfa;
  padding: 1px 4px;
  border-radius: 3px;
  margin-left: auto;
}

.detail-llm-tools,
.detail-llm-tool-id {
  font-size: 0.6rem;
  display: flex;
  align-items: center;
  gap: 2px;
  color: #6B7280;
}

/* Context info bar */
.message-detail-context-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(167, 139, 250, 0.08);
  border-bottom: 1px solid rgba(44, 59, 75, 0.5);
  font-size: 0.75rem;
  color: #a78bfa;
}

.message-detail-context-info .context-hint {
  color: #6B7280;
  font-style: italic;
  font-size: 0.7rem;
}

/* Markdown rendering in detail panel */
.detail-llm-content p,
.detail-content p {
  margin: 0 0 0.5em 0;
}

.detail-llm-content p:last-child,
.detail-content p:last-child {
  margin-bottom: 0;
}

.detail-llm-content code,
.detail-content code {
  background: rgba(0, 0, 0, 0.3);
  padding: 0.1em 0.3em;
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9em;
}

.detail-llm-content pre,
.detail-content pre {
  background: rgba(0, 0, 0, 0.4);
  padding: 0.75rem;
  border-radius: 6px;
  overflow-x: auto;
  margin: 0.5em 0;
}

.detail-llm-content pre code,
.detail-content pre code {
  background: transparent;
  padding: 0;
}

.detail-llm-content ul,
.detail-llm-content ol,
.detail-content ul,
.detail-content ol {
  margin: 0.5em 0;
  padding-left: 1.5em;
}

.detail-llm-content h1,
.detail-llm-content h2,
.detail-llm-content h3,
.detail-llm-content h4,
.detail-content h1,
.detail-content h2,
.detail-content h3,
.detail-content h4 {
  margin: 0.75em 0 0.5em 0;
  color: #F0F4F8;
}

.detail-llm-content blockquote,
.detail-content blockquote {
  border-left: 3px solid #a78bfa;
  margin: 0.5em 0;
  padding-left: 1em;
  color: #9AA5B1;
}

/* JSON content styling */
.llm-json-content,
.llm-json-part,
.response-json-content {
  background: rgba(0, 0, 0, 0.35);
  padding: 0.75rem;
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  line-height: 1.4;
  color: #D4D4D4;
  white-space: pre-wrap;
  word-break: break-word;
  margin: 0;
}

/* Multimodal content */
.llm-multimodal-content {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.llm-text-part {
  /* inherits markdown styles */
}

/* Extracted images container */
.extracted-images {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

/* Image rendering in detail panel */
.llm-image-part,
.response-image-part {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.25);
  border-radius: 6px;
  border: 1px solid rgba(44, 59, 75, 0.5);
}

.detail-inline-image {
  max-width: 100%;
  max-height: 400px;
  object-fit: contain;
  border-radius: 4px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.detail-inline-image:hover {
  transform: scale(1.02);
}

.image-label {
  font-size: 0.65rem;
  color: #6B7280;
  text-align: center;
}

.image-path {
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  color: #9AA5B1;
  word-break: break-all;
}

.response-images-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.response-markdown {
  /* inherits from detail-content */
}

.detail-content {
  font-size: 0.85rem;
  line-height: 1.6;
  color: #E8E8E8;
  word-break: break-word;
  background: rgba(0, 0, 0, 0.25);
  padding: 1rem;
  border-radius: 6px;
}

/* Detail Panel Image Modal */
.detail-image-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.92);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 2rem;
  cursor: zoom-out;
}

.detail-image-modal-content {
  position: relative;
  max-width: 95vw;
  max-height: 95vh;
  cursor: default;
}

.detail-image-modal-content img {
  max-width: 100%;
  max-height: 90vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.detail-image-modal-close {
  position: absolute;
  top: -40px;
  right: 0;
  width: 36px;
  height: 36px;
  background: rgba(248, 113, 113, 0.2);
  border: 1px solid rgba(248, 113, 113, 0.4);
  border-radius: 8px;
  color: #f87171;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
}

.detail-image-modal-close:hover {
  background: rgba(248, 113, 113, 0.3);
  border-color: #f87171;
}
