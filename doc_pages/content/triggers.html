<h1>Triggers</h1>
<p class="lead">
  Triggers enable declarative scheduling and event-based cascade execution. Schedule cascades with
  cron expressions, poll for conditions with sensors, or respond to external events via webhooks.
</p>

<div class="toc">
  <div class="toc-title">On This Page</div>
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#cron">Cron Triggers</a></li>
    <li><a href="#sensor">Sensor Triggers</a></li>
    <li><a href="#webhook">Webhook Triggers</a></li>
    <li><a href="#cli">CLI Commands</a></li>
  </ul>
</div>

<h2 id="overview">Overview</h2>

<p>
  Triggers are defined at the cascade level and specify when the cascade should run.
  Multiple triggers can be defined per cascade.
</p>

<div class="feature-grid">
  <div class="feature-card">
    <div class="feature-card-icon"><iconify-icon icon="mdi:clock-outline"></iconify-icon></div>
    <h4>Cron</h4>
    <p>Time-based scheduling with standard cron syntax</p>
  </div>
  <div class="feature-card">
    <div class="feature-card-icon magenta"><iconify-icon icon="mdi:radar"></iconify-icon></div>
    <h4>Sensor</h4>
    <p>Poll for conditions and trigger when met</p>
  </div>
  <div class="feature-card">
    <div class="feature-card-icon" style="color: var(--green);"><iconify-icon icon="mdi:webhook"></iconify-icon></div>
    <h4>Webhook</h4>
    <p>Respond to external HTTP events</p>
  </div>
</div>

<h2 id="cron">Cron Triggers</h2>

<p>
  Schedule cascades to run at specific times using standard cron syntax:
</p>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang yaml">Cron Trigger</span>
  </div>
  <div class="code-block-content">
    <pre><span class="key">cascade_id</span>: daily_report
<span class="key">triggers</span>:
  - <span class="key">name</span>: daily_run
    <span class="key">type</span>: cron
    <span class="key">schedule</span>: <span class="str">"0 6 * * *"</span>         <span class="cmt"># 6 AM daily</span>
    <span class="key">timezone</span>: America/New_York
    <span class="key">inputs</span>:                         <span class="cmt"># Inputs to pass</span>
      <span class="key">mode</span>: full
      <span class="key">date</span>: <span class="str">"{{ now.strftime('%Y-%m-%d') }}"</span>

<span class="key">cells</span>:
  - <span class="key">name</span>: generate_report
    <span class="key">instructions</span>: <span class="str">"Generate the daily report for {{ input.date }}"</span></pre>
  </div>
</div>

<h3>Cron Syntax Reference</h3>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Values</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Minute</td>
      <td>0-59</td>
      <td><code>0</code> = top of hour</td>
    </tr>
    <tr>
      <td>Hour</td>
      <td>0-23</td>
      <td><code>6</code> = 6 AM</td>
    </tr>
    <tr>
      <td>Day of Month</td>
      <td>1-31</td>
      <td><code>1</code> = first day</td>
    </tr>
    <tr>
      <td>Month</td>
      <td>1-12</td>
      <td><code>*</code> = every month</td>
    </tr>
    <tr>
      <td>Day of Week</td>
      <td>0-6 (Sun=0)</td>
      <td><code>1-5</code> = weekdays</td>
    </tr>
  </tbody>
</table>

<h3>Common Schedules</h3>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang yaml">Schedule Examples</span>
  </div>
  <div class="code-block-content">
    <pre><span class="cmt"># Every hour</span>
<span class="key">schedule</span>: <span class="str">"0 * * * *"</span>

<span class="cmt"># Every 15 minutes</span>
<span class="key">schedule</span>: <span class="str">"*/15 * * * *"</span>

<span class="cmt"># Weekdays at 9 AM</span>
<span class="key">schedule</span>: <span class="str">"0 9 * * 1-5"</span>

<span class="cmt"># First of month at midnight</span>
<span class="key">schedule</span>: <span class="str">"0 0 1 * *"</span>

<span class="cmt"># Every Sunday at 2 AM</span>
<span class="key">schedule</span>: <span class="str">"0 2 * * 0"</span></pre>
  </div>
</div>

<h2 id="sensor">Sensor Triggers</h2>

<p>
  Sensors poll for conditions and trigger when the condition is met:
</p>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang yaml">Sensor Trigger</span>
  </div>
  <div class="code-block-content">
    <pre><span class="key">cascade_id</span>: process_new_data
<span class="key">triggers</span>:
  - <span class="key">name</span>: on_data_ready
    <span class="key">type</span>: sensor
    <span class="key">check</span>: <span class="str">"python:sensors.table_freshness"</span>
    <span class="key">args</span>:
      <span class="key">table</span>: raw.events
      <span class="key">max_age_minutes</span>: <span class="num">60</span>
    <span class="key">poll_interval</span>: 5m            <span class="cmt"># Check every 5 minutes</span>
    <span class="key">inputs</span>:
      <span class="key">source_table</span>: raw.events</pre>
  </div>
</div>

<h3>Sensor Functions</h3>

<p>
  Sensor check functions must return a dict with <code>triggered</code> and optionally <code>payload</code>:
</p>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang python">sensors.py</span>
  </div>
  <div class="code-block-content">
    <pre><span class="kw">def</span> <span class="fn">table_freshness</span>(table: <span class="fn">str</span>, max_age_minutes: <span class="fn">int</span>) -> <span class="fn">dict</span>:
    <span class="str">"""Check if table has fresh data."""</span>
    <span class="cmt"># Query for latest timestamp</span>
    latest = get_latest_timestamp(table)
    age_minutes = (datetime.now() - latest).total_seconds() / <span class="num">60</span>

    <span class="kw">return</span> {
        <span class="str">"triggered"</span>: age_minutes <= max_age_minutes,
        <span class="str">"payload"</span>: {
            <span class="str">"latest_timestamp"</span>: latest.isoformat(),
            <span class="str">"age_minutes"</span>: age_minutes
        }
    }</pre>
  </div>
</div>

<h2 id="webhook">Webhook Triggers</h2>

<p>
  Respond to external HTTP events:
</p>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang yaml">Webhook Trigger</span>
  </div>
  <div class="code-block-content">
    <pre><span class="key">cascade_id</span>: github_pr_review
<span class="key">triggers</span>:
  - <span class="key">name</span>: on_pr_opened
    <span class="key">type</span>: webhook
    <span class="key">auth</span>: <span class="str">"hmac:${WEBHOOK_SECRET}"</span>  <span class="cmt"># HMAC signature validation</span>
    <span class="key">filter</span>:                           <span class="cmt"># Only trigger if matches</span>
      <span class="key">action</span>: opened
      <span class="key">pull_request.base.ref</span>: main</pre>
  </div>
</div>

<h3>Authentication Options</h3>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Format</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>HMAC</td>
      <td><code>hmac:${SECRET}</code></td>
      <td>Validate request signature (GitHub, Stripe)</td>
    </tr>
    <tr>
      <td>Bearer</td>
      <td><code>bearer:${TOKEN}</code></td>
      <td>Validate Authorization header</td>
    </tr>
    <tr>
      <td>Basic</td>
      <td><code>basic:${USER}:${PASS}</code></td>
      <td>HTTP Basic authentication</td>
    </tr>
    <tr>
      <td>None</td>
      <td><code>none</code></td>
      <td>No authentication (public)</td>
    </tr>
  </tbody>
</table>

<h2 id="cli">CLI Commands</h2>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang bash">Trigger Management</span>
  </div>
  <div class="code-block-content">
    <pre><span class="cmt"># List triggers for a cascade</span>
lars triggers list cascades/etl.yaml

<span class="cmt"># Export as cron format (for external schedulers)</span>
lars triggers export cascades/etl.yaml --format cron

<span class="cmt"># Export as Kubernetes CronJob</span>
lars triggers export cascades/etl.yaml --format kubernetes --image lars:latest

<span class="cmt"># Check a specific trigger</span>
lars triggers check cascades/etl.yaml on_data_ready</pre>
  </div>
</div>

<h3>Export Formats</h3>

<p>
  Export triggers for use with external schedulers:
</p>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang bash">Cron Export</span>
  </div>
  <div class="code-block-content">
    <pre>$ lars triggers export cascades/daily_report.yaml --format cron

<span class="cmt"># Output:</span>
0 6 * * * cd /path/to/project && lars run cascades/daily_report.yaml --input '{"mode": "full"}'</pre>
  </div>
</div>

<div class="code-block">
  <div class="code-block-header">
    <span class="code-block-lang yaml">Kubernetes CronJob Export</span>
  </div>
  <div class="code-block-content">
    <pre>apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-report
spec:
  schedule: <span class="str">"0 6 * * *"</span>
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: lars
            image: lars:latest
            command: [<span class="str">"lars"</span>, <span class="str">"run"</span>, <span class="str">"cascades/daily_report.yaml"</span>]</pre>
  </div>
</div>

<div class="info-box">
  <div class="info-box-title">Trigger Execution</div>
  <p>
    Triggers define <em>when</em> to run, but LARS doesn't include a built-in scheduler daemon.
    Use the CLI exports to integrate with your existing scheduler (cron, Kubernetes, Airflow, etc.)
    or run <code>lars serve watcher</code> for polling-based sensors.
  </p>
</div>

<hr>

<h2>Next: Watches</h2>
<p>
  Learn about reactive SQL subscriptions: <a href="#watches" data-link>Watches</a>.
</p>
