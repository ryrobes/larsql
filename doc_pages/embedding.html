<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vector Search & Embedding - RVBBIT Documentation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cascadia+Code:ital,wght@0,200..700;1,200..700&family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/docs.css">
</head>
<body>
  <div class="page">
    <header>
      <div class="container">
        <nav class="nav">
          <a href="index.html" class="brand"><span>RVBBIT</span></a>
          <div class="nav-links">
            <a href="index.html">Docs</a>
            <a href="https://github.com/rvbbit/rvbbit">GitHub</a>
          </div>
        </nav>
      </div>
    </header>

    <div class="container">
      <div class="docs-layout">
        <aside class="sidebar">
          <nav>
            <div class="sidebar-section">
              <h4 class="sidebar-title">Getting Started</h4>
              <ul class="sidebar-links">
                <li><a href="index.html">Overview</a></li>
                <li><a href="core-concepts.html">Core Concepts</a></li>
              </ul>
            </div>
            <div class="sidebar-section">
              <h4 class="sidebar-title">Cascade DSL</h4>
              <ul class="sidebar-links">
                <li><a href="cascade-dsl.html">DSL Reference</a></li>
                <li><a href="cell-types.html">Cell Types</a></li>
                <li><a href="validation.html">Validation (Wards)</a></li>
                <li><a href="context.html">Context Management</a></li>
              </ul>
            </div>
            <div class="sidebar-section">
              <h4 class="sidebar-title">Features</h4>
              <ul class="sidebar-links">
                <li><a href="semantic-sql.html">Semantic SQL</a></li>
                <li><a href="candidates.html">Candidates & Evaluation</a></li>
                <li><a href="embedding.html" class="active">Vector Search & Embedding</a></li>
                <li><a href="tools.html">Tools (Traits)</a></li>
                <li><a href="mcp.html">MCP Integration</a></li>
              </ul>
            </div>
          </nav>
        </aside>

        <main class="docs-content">
          <h1>Vector Search & Embedding</h1>
          <p class="lead">
            Elegant SQL syntax for semantic search powered by embeddings. Natural field references,
            automatic backend routing, and multiple search modes.
          </p>

          <div class="toc">
            <div class="toc-title">On This Page</div>
            <ul>
              <li><a href="#quick-start">Quick Start</a></li>
              <li><a href="#functions">Four Search Functions</a></li>
              <li><a href="#embed">RVBBIT EMBED Statement</a></li>
              <li><a href="#vector-search">VECTOR_SEARCH Function</a></li>
              <li><a href="#hybrid-search">HYBRID_SEARCH Function</a></li>
              <li><a href="#backends">Backends Comparison</a></li>
              <li><a href="#patterns">Common Patterns</a></li>
              <li><a href="#troubleshooting">Troubleshooting</a></li>
            </ul>
          </div>

          <h2 id="quick-start">Quick Start</h2>

          <h3>1. Embed Your Data</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Embedding Examples</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- ClickHouse backend (fastest, pure semantic):</span>
<span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text <span class="kw">FROM</span> articles);

<span class="cmt">-- Elasticsearch backend (hybrid semantic + keyword support):</span>
<span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text <span class="kw">FROM</span> articles)
<span class="kw">WITH</span> (backend=<span class="str">'elastic'</span>, index=<span class="str">'articles_idx'</span>);</pre>
            </div>
          </div>

          <h3>2. Search Your Data</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Search Examples</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- VECTOR_SEARCH → ClickHouse (pure semantic, fastest):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate change policy'</span>, articles.content, <span class="num">10</span>);

<span class="cmt">-- ELASTIC_SEARCH → Elastic (pure semantic):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">ELASTIC_SEARCH</span>(<span class="str">'climate change policy'</span>, articles.content, <span class="num">10</span>);

<span class="cmt">-- HYBRID_SEARCH → Elastic (semantic + keyword mix):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'Venezuela crisis'</span>, bird_line.text, <span class="num">20</span>, <span class="num">0.5</span>, <span class="num">0.7</span>, <span class="num">0.3</span>);

<span class="cmt">-- KEYWORD_SEARCH → Elastic (pure BM25 keyword):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">KEYWORD_SEARCH</span>(<span class="str">'MacBook Pro M3 16-inch'</span>, products.name, <span class="num">10</span>);</pre>
            </div>
          </div>

          <div class="info-box tip">
            <div class="info-box-title">Natural Syntax</div>
            <p>
              Notice the field references: <code>articles.content</code>, <code>bird_line.text</code>.
              These are <strong>identifiers</strong> (not strings), enabling IDE autocomplete,
              syntax highlighting, and typo detection!
            </p>
          </div>

          <h2 id="functions">Four Search Functions - Which to Use?</h2>

          <table>
            <thead>
              <tr>
                <th>Function</th>
                <th>Backend</th>
                <th>Mode</th>
                <th>Use When</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>VECTOR_SEARCH</code></td>
                <td>ClickHouse</td>
                <td>Pure semantic</td>
                <td>Fast concept search (default choice)</td>
              </tr>
              <tr>
                <td><code>ELASTIC_SEARCH</code></td>
                <td>Elasticsearch</td>
                <td>Pure semantic</td>
                <td>Need Elastic features (aggregations, etc.)</td>
              </tr>
              <tr>
                <td><code>HYBRID_SEARCH</code></td>
                <td>Elasticsearch</td>
                <td>Semantic + keyword</td>
                <td>Balance concepts AND exact terms</td>
              </tr>
              <tr>
                <td><code>KEYWORD_SEARCH</code></td>
                <td>Elasticsearch</td>
                <td>Pure BM25</td>
                <td>Exact term matching (SKUs, names, codes)</td>
              </tr>
            </tbody>
          </table>

          <h3>Decision Tree</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Which Function?</span></div>
            <div class="code-block-content">
              <pre>Need exact term matching? (SKUs, product codes, names)
  → <span class="fn">KEYWORD_SEARCH</span>

Need concept understanding + term matching?
  → <span class="fn">HYBRID_SEARCH</span> (tune weights to your needs)

Need pure concept understanding?
  ├─ Want fastest? → <span class="fn">VECTOR_SEARCH</span> (ClickHouse)
  └─ Need Elastic? → <span class="fn">ELASTIC_SEARCH</span>

Not sure? → Start with <span class="fn">VECTOR_SEARCH</span> (fastest, works great)</pre>
            </div>
          </div>

          <h2 id="embed">RVBBIT EMBED Statement</h2>

          <h3>Syntax</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">EMBED Syntax</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> &lt;table&gt;.&lt;column&gt;
<span class="kw">USING</span> (&lt;select_query&gt;)
[<span class="kw">WITH</span> (&lt;options&gt;)]</pre>
            </div>
          </div>

          <h3>Required Components</h3>

          <h4>Field Reference</h4>
          <p>
            <code>table.column</code> identifier (no quotes, must be valid SQL identifier)
          </p>
          <ul>
            <li>Example: <code>bird_line.text</code>, <code>articles.content</code>, <code>products.description</code></li>
          </ul>

          <h4>USING Clause</h4>
          <p>Must return exactly these columns:</p>
          <ul>
            <li><code>id</code>: VARCHAR (primary key, must be unique)</li>
            <li><code>text</code>: VARCHAR (content to embed)</li>
            <li><code>metadata</code>: JSON (optional - additional fields)</li>
          </ul>

          <h3>WITH Options</h3>
          <table>
            <thead>
              <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr><td><code>backend</code></td><td>String</td><td><code>'clickhouse'</code></td><td>Backend: <code>'clickhouse'</code> or <code>'elastic'</code></td></tr>
              <tr><td><code>batch_size</code></td><td>Integer</td><td><code>100</code></td><td>Rows per batch</td></tr>
              <tr><td><code>index</code></td><td>String</td><td><code>'rvbbit_embeddings'</code></td><td>Elastic index name (elastic only)</td></tr>
            </tbody>
          </table>

          <h3>Examples</h3>

          <h4>Basic ClickHouse Embedding</h4>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Basic Example</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> bird_line.text
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, text <span class="kw">FROM</span> bird_line);</pre>
            </div>
          </div>

          <h4>With Batch Size</h4>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Batch Size</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text <span class="kw">FROM</span> articles <span class="kw">LIMIT</span> <span class="num">10000</span>)
<span class="kw">WITH</span> (backend=<span class="str">'clickhouse'</span>, batch_size=<span class="num">50</span>);</pre>
            </div>
          </div>

          <h4>Elasticsearch Backend</h4>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Elasticsearch</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> products.description
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, description <span class="kw">AS</span> text <span class="kw">FROM</span> products)
<span class="kw">WITH</span> (backend=<span class="str">'elastic'</span>, batch_size=<span class="num">200</span>, index=<span class="str">'products_idx'</span>);</pre>
            </div>
          </div>

          <h4>With Metadata</h4>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Metadata Embedding</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> documents.body
<span class="kw">USING</span> (
  <span class="kw">SELECT</span>
    id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id,
    body <span class="kw">AS</span> text,
    <span class="fn">to_json</span>({<span class="str">'title'</span>: title, <span class="str">'author'</span>: author, <span class="str">'date'</span>: published_at}) <span class="kw">AS</span> metadata
  <span class="kw">FROM</span> documents
);</pre>
            </div>
          </div>

          <h4>Background Embedding (Async)</h4>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Background Processing</span></div>
            <div class="code-block-content">
              <pre><span class="kw">BACKGROUND</span>
<span class="kw">RVBBIT EMBED</span> large_corpus.text
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, text <span class="kw">FROM</span> large_corpus)
<span class="kw">WITH</span> (batch_size=<span class="num">500</span>);</pre>
            </div>
          </div>

          <h2 id="vector-search">VECTOR_SEARCH Function</h2>
          <p>
            Pure semantic search using ClickHouse backend. Fastest option for concept-based search.
          </p>

          <h3>Signature</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Function Signature</span></div>
            <div class="code-block-content">
              <pre><span class="fn">VECTOR_SEARCH</span>(
  query: <span class="fn">VARCHAR</span>,           <span class="cmt">-- Search query</span>
  field: table.column,      <span class="cmt">-- Field reference (identifier, not string!)</span>
  limit: <span class="fn">INTEGER</span>,           <span class="cmt">-- Max results</span>
  [min_score: <span class="fn">DOUBLE</span>]       <span class="cmt">-- Optional: score threshold (0.0-1.0)</span>
)
<span class="kw">RETURNS TABLE</span> (
  id <span class="fn">VARCHAR</span>,
  score <span class="fn">DOUBLE</span>,
  chunk_text <span class="fn">VARCHAR</span>,
  metadata <span class="fn">JSON</span>
)</pre>
            </div>
          </div>

          <h3>Arguments</h3>
          <ol>
            <li><strong>query</strong> (required): Search query text
              <ul><li>Example: <code>'climate change'</code>, <code>'renewable energy'</code></li></ul>
            </li>
            <li><strong>field</strong> (required): Field reference as identifier
              <ul>
                <li>Example: <code>articles.content</code>, <code>bird_line.text</code></li>
                <li><strong>Not</strong> a string: <s><code>'articles.content'</code></s></li>
              </ul>
            </li>
            <li><strong>limit</strong> (required): Maximum results
              <ul><li>Example: <code>10</code>, <code>50</code>, <code>100</code></li></ul>
            </li>
            <li><strong>min_score</strong> (optional): Minimum similarity score (0.0-1.0)
              <ul><li>Example: <code>0.5</code> (only results with score ≥ 0.5)</li></ul>
            </li>
          </ol>

          <h3>Return Columns</h3>
          <table>
            <thead>
              <tr><th>Column</th><th>Type</th><th>Description</th></tr>
            </thead>
            <tbody>
              <tr><td><code>id</code></td><td>VARCHAR</td><td>Document/chunk ID</td></tr>
              <tr><td><code>score</code></td><td>DOUBLE</td><td>Similarity score (0.0-1.0)</td></tr>
              <tr><td><code>chunk_text</code></td><td>VARCHAR</td><td>Matched text content</td></tr>
              <tr><td><code>metadata</code></td><td>JSON</td><td>Additional fields (column_name, table_name, etc.)</td></tr>
            </tbody>
          </table>

          <h3>Examples</h3>

          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">VECTOR_SEARCH Examples</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Basic search:</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate change'</span>, articles.content, <span class="num">10</span>);

<span class="cmt">-- With score threshold:</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'renewable energy'</span>, articles.content, <span class="num">20</span>, <span class="num">0.6</span>);

<span class="cmt">-- Join with source table:</span>
<span class="kw">SELECT</span>
  a.title,
  a.author,
  vs.score,
  vs.chunk_text
<span class="kw">FROM</span> articles a
<span class="kw">JOIN</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate policy'</span>, articles.content, <span class="num">10</span>) vs
  <span class="kw">ON</span> vs.id = a.id::<span class="fn">VARCHAR</span>
<span class="kw">WHERE</span> vs.score > <span class="num">0.7</span>
<span class="kw">ORDER BY</span> vs.score <span class="kw">DESC</span>;</pre>
            </div>
          </div>

          <h2 id="hybrid-search">HYBRID_SEARCH Function</h2>
          <p>
            Combines semantic understanding with keyword matching. Perfect for balancing
            conceptual search with exact term requirements.
          </p>

          <h3>Signature</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">HYBRID_SEARCH Signature</span></div>
            <div class="code-block-content">
              <pre><span class="fn">HYBRID_SEARCH</span>(
  query: <span class="fn">VARCHAR</span>,                   <span class="cmt">-- Search query</span>
  field: table.column,              <span class="cmt">-- Field reference</span>
  limit: <span class="fn">INTEGER</span>,                   <span class="cmt">-- Max results</span>
  [min_score: <span class="fn">DOUBLE</span>],             <span class="cmt">-- Optional: score threshold</span>
  [semantic_weight: <span class="fn">DOUBLE</span>],       <span class="cmt">-- Optional: semantic score weight (default 0.7)</span>
  [keyword_weight: <span class="fn">DOUBLE</span>]         <span class="cmt">-- Optional: keyword score weight (default 0.3)</span>
)
<span class="kw">RETURNS TABLE</span> (
  id <span class="fn">VARCHAR</span>,
  score <span class="fn">DOUBLE</span>,              <span class="cmt">-- Combined hybrid score</span>
  semantic_score <span class="fn">DOUBLE</span>,     <span class="cmt">-- Vector similarity component</span>
  keyword_score <span class="fn">DOUBLE</span>,      <span class="cmt">-- BM25 keyword component</span>
  chunk_text <span class="fn">VARCHAR</span>,
  metadata <span class="fn">JSON</span>
)</pre>
            </div>
          </div>

          <h3>Weight Tuning</h3>
          <p>
            Adjust <code>semantic_weight</code> and <code>keyword_weight</code> to balance
            concept vs exact term matching:
          </p>

          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Weight Examples</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Default: 70% semantic, 30% keyword</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'climate action'</span>, articles.content, <span class="num">10</span>);

<span class="cmt">-- Semantic-heavy: 90% semantic, 10% keyword</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'climate action'</span>, articles.content, <span class="num">20</span>, <span class="num">0.5</span>, <span class="num">0.9</span>, <span class="num">0.1</span>);

<span class="cmt">-- Keyword-heavy: 30% semantic, 70% keyword</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'exact product model'</span>, products.description, <span class="num">50</span>, <span class="num">0.6</span>, <span class="num">0.3</span>, <span class="num">0.7</span>);

<span class="cmt">-- Pure semantic (via HYBRID_SEARCH):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'sustainability'</span>, docs.text, <span class="num">30</span>, <span class="num">0.5</span>, <span class="num">1.0</span>, <span class="num">0.0</span>);</pre>
            </div>
          </div>

          <div class="info-box">
            <div class="info-box-title">Score Breakdown</div>
            <p>
              <code>HYBRID_SEARCH</code> returns separate <code>semantic_score</code> and
              <code>keyword_score</code> columns, letting you analyze which component
              contributed more to each result.
            </p>
          </div>

          <h2 id="backends">Backends Comparison</h2>

          <h3>ClickHouse Backend</h3>
          <p><strong>Pros:</strong></p>
          <ul>
            <li>Fast vector similarity (ANN index)</li>
            <li>Great for pure semantic search</li>
            <li>Integrates with existing ClickHouse analytics</li>
          </ul>

          <p><strong>Cons:</strong></p>
          <ul>
            <li>No keyword search (semantic only)</li>
            <li>Requires ClickHouse running</li>
          </ul>

          <p><strong>Use When:</strong></p>
          <ul>
            <li>You want pure semantic search</li>
            <li>You're already using ClickHouse</li>
            <li>You need fast analytical queries on results</li>
          </ul>

          <h3>Elasticsearch Backend</h3>
          <p><strong>Pros:</strong></p>
          <ul>
            <li>Hybrid search (semantic + BM25 keyword)</li>
            <li>Tunable weighting (adjust semantic vs keyword)</li>
            <li>Great for mixed precision/recall needs</li>
          </ul>

          <p><strong>Cons:</strong></p>
          <ul>
            <li>Requires Elasticsearch running</li>
            <li>Slightly slower than ClickHouse pure vector</li>
          </ul>

          <p><strong>Use When:</strong></p>
          <ul>
            <li>You need hybrid semantic + keyword search</li>
            <li>Exact keyword matches matter (product names, codes)</li>
            <li>You want to tune precision/recall balance</li>
          </ul>

          <h2 id="patterns">Common Patterns</h2>

          <h3>Pattern 1: Incremental Embedding</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Incremental Updates</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Embed only new/updated rows:</span>
<span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (
  <span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text
  <span class="kw">FROM</span> articles
  <span class="kw">WHERE</span> embedded_at <span class="kw">IS NULL</span>
     <span class="kw">OR</span> updated_at > embedded_at
);

<span class="cmt">-- Update timestamp after:</span>
<span class="kw">UPDATE</span> articles
<span class="kw">SET</span> embedded_at = <span class="fn">NOW</span>()
<span class="kw">WHERE</span> embedded_at <span class="kw">IS NULL</span> <span class="kw">OR</span> updated_at > embedded_at;</pre>
            </div>
          </div>

          <h3>Pattern 2: Multi-Column Search</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Multiple Columns</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Embed both title and content:</span>
<span class="kw">RVBBIT EMBED</span> articles.title
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, title <span class="kw">AS</span> text <span class="kw">FROM</span> articles);

<span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text <span class="kw">FROM</span> articles);

<span class="cmt">-- Search title only:</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate policy'</span>, articles.title, <span class="num">10</span>);

<span class="cmt">-- Search content only:</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate policy'</span>, articles.content, <span class="num">10</span>);

<span class="cmt">-- Search both (union):</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate policy'</span>, articles.title, <span class="num">5</span>)
<span class="kw">UNION ALL</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'climate policy'</span>, articles.content, <span class="num">5</span>);</pre>
            </div>
          </div>

          <h3>Pattern 3: Weighted Hybrid Search</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Weight Tuning</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Product search: exact model numbers matter more</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'MacBook Pro'</span>, products.description, <span class="num">20</span>, <span class="num">0.5</span>, <span class="num">0.3</span>, <span class="num">0.7</span>);
<span class="cmt">--                                                                         ^^^  ^^^</span>
<span class="cmt">--                                                                         30%  70%</span>
<span class="cmt">--                                                                         sem  keyword</span>

<span class="cmt">-- Concept search: semantics matter more</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">HYBRID_SEARCH</span>(<span class="str">'eco-friendly sustainable'</span>, products.description, <span class="num">20</span>, <span class="num">0.5</span>, <span class="num">0.9</span>, <span class="num">0.1</span>);
<span class="cmt">--                                                                                      ^^^  ^^^</span>
<span class="cmt">--                                                                                      90%  10%</span></pre>
            </div>
          </div>

          <h3>Pattern 4: Re-ranking with Filters</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Filter and Re-rank</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Broad search, then filter and re-rank:</span>
<span class="kw">WITH</span> search_results <span class="kw">AS</span> (
  <span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'sustainability'</span>, products.description, <span class="num">100</span>, <span class="num">0.4</span>)
)
<span class="kw">SELECT</span>
  sr.*,
  p.price,
  p.category
<span class="kw">FROM</span> search_results sr
<span class="kw">JOIN</span> products p <span class="kw">ON</span> sr.id = p.id::<span class="fn">VARCHAR</span>
<span class="kw">WHERE</span> p.price < <span class="num">1000</span>
  <span class="kw">AND</span> p.in_stock = <span class="kw">true</span>
<span class="kw">ORDER BY</span> sr.score <span class="kw">DESC</span>
<span class="kw">LIMIT</span> <span class="num">10</span>;</pre>
            </div>
          </div>

          <h2>Real-World Workflows</h2>

          <h3>Workflow 1: Document Q&A System</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Document Q&A</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Step 1: Embed documents</span>
<span class="kw">RVBBIT EMBED</span> documents.content
<span class="kw">USING</span> (
  <span class="kw">SELECT</span>
    id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id,
    content <span class="kw">AS</span> text,
    <span class="fn">to_json</span>({<span class="str">'title'</span>: title, <span class="str">'author'</span>: author}) <span class="kw">AS</span> metadata
  <span class="kw">FROM</span> documents
);

<span class="cmt">-- Step 2: Search with natural language</span>
<span class="kw">SELECT</span>
  <span class="fn">json_extract_string</span>(metadata, <span class="str">'$.title'</span>) <span class="kw">AS</span> title,
  <span class="fn">json_extract_string</span>(metadata, <span class="str">'$.author'</span>) <span class="kw">AS</span> author,
  score,
  chunk_text
<span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'What are the latest findings on climate adaptation?'</span>, documents.content, <span class="num">10</span>, <span class="num">0.6</span>)
<span class="kw">ORDER BY</span> score <span class="kw">DESC</span>;</pre>
            </div>
          </div>

          <h3>Workflow 2: Product Recommendation</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Product Recommendations</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Embed product descriptions:</span>
<span class="kw">RVBBIT EMBED</span> products.description
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, description <span class="kw">AS</span> text <span class="kw">FROM</span> products <span class="kw">WHERE</span> active = <span class="kw">true</span>);

<span class="cmt">-- Find similar products:</span>
<span class="kw">SELECT</span>
  p.product_name,
  p.price,
  vs.score <span class="kw">AS</span> similarity
<span class="kw">FROM</span> products p
<span class="kw">JOIN</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'eco-friendly sustainable materials'</span>, products.description, <span class="num">20</span>, <span class="num">0.5</span>) vs
  <span class="kw">ON</span> vs.id = p.id::<span class="fn">VARCHAR</span>
<span class="kw">ORDER BY</span> vs.score <span class="kw">DESC</span>;</pre>
            </div>
          </div>

          <h3>Workflow 3: Multi-Language Search</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Multilingual Search</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Embed articles in multiple languages:</span>
<span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (
  <span class="kw">SELECT</span>
    id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id,
    content <span class="kw">AS</span> text,
    <span class="fn">to_json</span>({<span class="str">'language'</span>: language, <span class="str">'country'</span>: country}) <span class="kw">AS</span> metadata
  <span class="kw">FROM</span> articles
);

<span class="cmt">-- Search across languages (embeddings are multilingual):</span>
<span class="kw">SELECT</span>
  <span class="fn">json_extract_string</span>(metadata, <span class="str">'$.language'</span>) <span class="kw">AS</span> lang,
  chunk_text,
  score
<span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'renewable energy policy'</span>, articles.content, <span class="num">30</span>, <span class="num">0.6</span>)
<span class="kw">WHERE</span> <span class="fn">json_extract_string</span>(metadata, <span class="str">'$.country'</span>) = <span class="str">'Brazil'</span>
<span class="kw">ORDER BY</span> score <span class="kw">DESC</span>;</pre>
            </div>
          </div>

          <h2 id="troubleshooting">Troubleshooting</h2>

          <h3>Error: "USING query must return columns: id, text"</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Problem</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> content <span class="kw">FROM</span> articles)  <span class="cmt">-- Missing 'id'!</span></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Fix</span></div>
            <div class="code-block-content">
              <pre><span class="kw">RVBBIT EMBED</span> articles.content
<span class="kw">USING</span> (<span class="kw">SELECT</span> id::<span class="fn">VARCHAR</span> <span class="kw">AS</span> id, content <span class="kw">AS</span> text <span class="kw">FROM</span> articles)
<span class="cmt">--             ^^^^^^^^^^^^^^^ required    ^^^^^^^^^^^^^^^^^^^^ required</span></pre>
            </div>
          </div>

          <h3>Error: "Invalid field reference"</h3>
          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Problem</span></div>
            <div class="code-block-content">
              <pre><span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'query'</span>, <span class="str">'articles.content'</span>, <span class="num">10</span>)
<span class="cmt">--                                   ^^^^^^^^^^^^^^^^^^</span>
<span class="cmt">--                                   String, not identifier!</span></pre>
            </div>
          </div>

          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Fix</span></div>
            <div class="code-block-content">
              <pre><span class="kw">SELECT</span> * <span class="kw">FROM</span> <span class="fn">VECTOR_SEARCH</span>(<span class="str">'query'</span>, articles.content, <span class="num">10</span>)
<span class="cmt">--                                   ^^^^^^^^^^^^^^^^^</span>
<span class="cmt">--                                   Identifier (no quotes)</span></pre>
            </div>
          </div>

          <h3>Search Returns No Results</h3>
          <p><strong>Check:</strong></p>
          <ol>
            <li>Was data embedded? <code>SELECT COUNT(*) FROM embed_status('articles');</code></li>
            <li>Is score threshold too high? Try without <code>min_score</code></li>
            <li>Is column filter too restrictive? Check <code>metadata.column_name</code></li>
          </ol>

          <h2>Performance Tips</h2>

          <h3>Embedding Performance</h3>
          <p><strong>Batch Size:</strong> Larger batches = faster but more memory</p>

          <div class="code-block">
            <div class="code-block-header"><span class="code-block-lang">Batch Size Tuning</span></div>
            <div class="code-block-content">
              <pre><span class="cmt">-- Small batches (safer, slower):</span>
<span class="kw">WITH</span> (batch_size=<span class="num">50</span>)

<span class="cmt">-- Large batches (faster, more memory):</span>
<span class="kw">WITH</span> (batch_size=<span class="num">500</span>)</pre>
            </div>
          </div>

          <h3>Search Performance</h3>
          <ul>
            <li><strong>Limit Results:</strong> Smaller limit = faster search</li>
            <li><strong>Score Threshold:</strong> Higher threshold = fewer results = faster</li>
            <li><strong>Metadata Filtering:</strong> Filter at search time vs post-processing</li>
          </ul>

          <div class="info-box tip">
            <div class="info-box-title">Automatic Metadata Filtering</div>
            <p>
              When a table has multiple embedded columns, <code>VECTOR_SEARCH</code> automatically
              adds <code>WHERE metadata.column_name = 'content'</code> to only search the specified
              column. This prevents mixed results from different columns!
            </p>
          </div>

          <hr style="margin: 48px 0; border: none; border-top: 1px solid rgba(28, 246, 255, 0.2);">

          <h2>Next Steps</h2>
          <ul>
            <li><a href="semantic-sql.html">Semantic SQL</a> - Combine vector search with other operators</li>
            <li><a href="cell-types.html">Cell Types</a> - Use vector search in deterministic cells</li>
            <li>See <code>docs/VECTOR_SEARCH_GUIDE.md</code> for additional technical details</li>
          </ul>

        </main>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>RVBBIT &copy; 2026 | <a href="https://github.com/rvbbit/rvbbit">GitHub</a></p>
      </div>
    </footer>
  </div>
</body>
</html>
