cascade_id: llm_entity_extraction
description: 'Entity extraction pipeline with soundings: SQL → LLM (extract entities
  with best-of-3) → JS (transform) → SQL (analyze).'
inputs_schema: {}
cells:
- name: news_articles
  tool: sql_data
  inputs:
    query: "-- News article snippets for entity extraction\nSELECT * FROM (\n  VALUES\n\
      \    ('A001', 'Tech', 'Apple announced the new iPhone 16 at their Cupertino\
      \ headquarters. CEO Tim Cook presented the device alongside new AirPods.'),\n\
      \    ('A002', 'Finance', 'Tesla stock surged 15% after Elon Musk announced record\
      \ Q4 deliveries. The Austin-based company beat analyst expectations.'),\n  \
      \  ('A003', 'Tech', 'Microsoft and OpenAI expanded their partnership in San\
      \ Francisco. Satya Nadella called it a defining moment for AI.'),\n    ('A004',\
      \ 'Sports', 'LeBron James led the Lakers to victory at Crypto.com Arena. Coach\
      \ Darvin Ham praised the teams defensive effort.'),\n    ('A005', 'Politics',\
      \ 'President Biden met with European leaders in Brussels. The summit focused\
      \ on climate policy and trade agreements.'),\n    ('A006', 'Tech', 'Google DeepMind\
      \ unveiled Gemini 2 at their London office. Demis Hassabis demonstrated new\
      \ reasoning capabilities.'),\n    ('A007', 'Finance', 'JPMorgan Chase reported\
      \ strong earnings. Jamie Dimon warned about inflation risks from their New York\
      \ headquarters.'),\n    ('A008', 'Entertainment', 'Taylor Swift broke Spotify\
      \ records with her new album. The singer announced a world tour starting in\
      \ Los Angeles.')\n) AS t(article_id, category, content)\n"
  handoffs:
  - llm_extract_entities
- name: llm_extract_entities
  tool: windlass_data
  inputs:
    code: "instructions: |\n  Extract named entities from these news articles.\n\n\
      \  Articles:\n  {{outputs.news_articles}}\n\n  For each article, extract ALL\
      \ entities you can find:\n  - people: Names of individuals mentioned\n  - organizations:\
      \ Companies, institutions, teams\n  - locations: Cities, countries, venues\n\
      \  - products: Product names, services\n\n  Be thorough - extract every entity\
      \ mentioned. Include titles (CEO, President) with names.\n\nmodel: google/gemini-2.5-flash\n\
      \n# Use soundings to get best extraction\nsoundings:\n  factor: 3\n  evaluator_instructions:\
      \ |\n    Pick the extraction that is most complete and accurate.\n    Prefer\
      \ the response that:\n    1. Captures the most entities without duplicates\n\
      \    2. Correctly categorizes each entity\n    3. Includes proper context (titles,\
      \ roles)\n\noutput_schema:\n  type: array\n  items:\n    type: object\n    properties:\n\
      \      article_id: { type: string }\n      category: { type: string }\n    \
      \  people:\n        type: array\n        items: { type: string }\n      organizations:\n\
      \        type: array\n        items: { type: string }\n      locations:\n  \
      \      type: array\n        items: { type: string }\n      products:\n     \
      \   type: array\n        items: { type: string }\n    required: [article_id,\
      \ people, organizations, locations, products]\n"
  handoffs:
  - js_flatten_entities
- name: js_flatten_entities
  tool: js_data
  inputs:
    code: "// Flatten entity arrays into individual records for analysis\nconst articles\
      \ = data.llm_extract_entities;\n\nconst flattened = [];\n\narticles.forEach(article\
      \ => {\n  // Helper to add entity records\n  const addEntities = (entities,\
      \ type) => {\n    (entities || []).forEach(entity => {\n      flattened.push({\n\
      \        article_id: article.article_id,\n        category: article.category,\n\
      \        entity_type: type,\n        entity_name: entity\n      });\n    });\n\
      \  };\n\n  addEntities(article.people, 'person');\n  addEntities(article.organizations,\
      \ 'organization');\n  addEntities(article.locations, 'location');\n  addEntities(article.products,\
      \ 'product');\n});\n\nresult = flattened;\n"
  handoffs:
  - entity_analysis
- name: entity_analysis
  tool: sql_data
  inputs:
    query: "-- Analyze extracted entities\nWITH entity_counts AS (\n  SELECT\n   \
      \ entity_type,\n    entity_name,\n    COUNT(*) as mentions,\n    array_agg(DISTINCT\
      \ category) as categories\n  FROM _js_flatten_entities\n  GROUP BY entity_type,\
      \ entity_name\n)\nSELECT\n  entity_type,\n  entity_name,\n  mentions,\n  array_to_string(categories,\
      \ ', ') as appears_in_categories\nFROM entity_counts\nORDER BY mentions DESC,\
      \ entity_type, entity_name\n"
