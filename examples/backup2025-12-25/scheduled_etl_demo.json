{
  "cascade_id": "scheduled_etl_demo",
  "description": "Demonstrates trigger definitions for scheduled and sensor-based cascade execution. Use `windlass triggers export` to generate scheduler configs.",

  "triggers": [
    {
      "name": "daily_morning",
      "type": "cron",
      "schedule": "0 6 * * *",
      "timezone": "America/New_York",
      "description": "Run every day at 6 AM Eastern",
      "inputs": {
        "mode": "incremental",
        "date": "yesterday"
      }
    },
    {
      "name": "weekly_full",
      "type": "cron",
      "schedule": "0 2 * * 0",
      "timezone": "UTC",
      "description": "Full refresh every Sunday at 2 AM UTC",
      "inputs": {
        "mode": "full"
      }
    },
    {
      "name": "on_source_ready",
      "type": "sensor",
      "check": "python:windlass.triggers.sensor_file_exists",
      "args": {
        "path": "/data/incoming/daily_feed.csv",
        "min_size_bytes": 1000
      },
      "poll_interval": "5m",
      "timeout": "4h",
      "description": "Trigger when daily feed file appears",
      "inputs": {
        "mode": "incremental",
        "source": "file"
      }
    },
    {
      "name": "manual_run",
      "type": "manual",
      "description": "Manual trigger for ad-hoc runs",
      "inputs_schema": {
        "mode": {
          "type": "string",
          "enum": ["full", "incremental"],
          "default": "incremental"
        },
        "date": {
          "type": "string",
          "description": "Date to process (YYYY-MM-DD)"
        }
      }
    }
  ],

  "phases": [
    {
      "name": "validate_inputs",
      "tool": "python:windlass.demo_tools.validate_sql",
      "inputs": {
        "query": "SELECT '{{ input.mode }}' as mode, '{{ input.date | default(\"today\") }}' as date"
      },
      "routing": {
        "valid": "extract_data",
        "invalid": "log_error"
      },
      "handoffs": ["extract_data", "log_error"]
    },
    {
      "name": "log_error",
      "instructions": "Log the validation error and notify the team.",
      "tackle": []
    },
    {
      "name": "extract_data",
      "instructions": "Extract data for {{ input.mode }} run on date {{ input.date | default('today') }}.\n\nSimulate data extraction and return a sample dataset.",
      "tackle": [],
      "handoffs": ["transform_data"]
    },
    {
      "name": "transform_data",
      "tool": "python:windlass.demo_tools.transform_data",
      "inputs": {
        "data": "[{\"id\": 1, \"value\": 100}, {\"id\": 2, \"value\": 200}]",
        "operation": "sum_numeric"
      },
      "routing": {
        "success": "load_data",
        "empty": "log_empty",
        "error": "handle_transform_error"
      },
      "handoffs": ["load_data", "log_empty", "handle_transform_error"]
    },
    {
      "name": "log_empty",
      "instructions": "No data to process. Log this and exit gracefully.",
      "tackle": []
    },
    {
      "name": "handle_transform_error",
      "instructions": "Transform failed: {{ state.last_deterministic_error.error }}\n\nDiagnose and suggest remediation.",
      "tackle": ["linux_shell"]
    },
    {
      "name": "load_data",
      "instructions": "Load the transformed data:\n\n{{ state.output_transform_data | tojson }}\n\nSimulate loading to warehouse and confirm success.",
      "tackle": []
    }
  ]
}
