{
  "cascade_id": "sql_chart_gen_analysis",
  "description": "Demonstrates SQL schema discovery and query execution with natural language, creates a chart, iterates on it, tells you about it.",
  "inputs_schema": {
    "question": "Natural language question about the data"
  },
  "memory": "sql_rag_search",
  "phases": [
    {
      "name": "discover_schema",
      "instructions": "The user asked: {{ input.question }}\n\nFirst, use sql_search to find relevant tables that might contain data to answer this question.\n\nSearch for tables using natural language - the tool will return schema information including:\n- Column names and types\n- Value distributions for categorical columns\n- Sample rows\n- Row counts\n\nAnalyze the results and identify which table(s) would be most useful. \nNote: the search data is ephemeral, so if you need access to it later please include important parts in your reply.",
      "tackle": ["sql_search", "list_sql_connections", "sql_rag_search"],
      "handoffs": ["write_query"]
    },
    {
      "name": "write_query",
      "instructions": "Based on the schema information from the previous phase, write a SQL query to answer: {{ input.question }}\n\nUse the sql_query tool to execute your query.\n\nIMPORTANT Query Syntax:\n- CSV folders: SELECT * FROM connection_name.table_name\n- PostgreSQL/MySQL: SELECT * FROM connection_name.schema.table\n- Example: SELECT * FROM csv_files.bigfoot_sightings WHERE state = 'California'\n\nThe schema info from the previous phase shows you:\n- Exact column names\n- Data types\n- Sample values (use these to understand the data format)\n- Value distributions (shows you what values exist in categorical columns)\n\nWrite a clear, efficient query based on this information.",
      "tackle": ["sql_query", "sql_rag_search"],
      "context": {"from": ["previous"]},
      "handoffs": ["analyze_results"]
    },
    {
      "name": "analyze_results",
      "instructions": "Analyze the query results from the previous phase and provide a clear answer to: {{ input.question }}\n\nSummarize:\n- Key findings from the data\n- Any interesting patterns or insights\n- Direct answer to the user's question\n\nBe specific and reference actual numbers from the results.",
      "tackle": [],
      "context": {"from": ["previous"]},
      "handoffs": ["create_initial_chart"]
    },
        {
    "name": "create_initial_chart",
    "instructions": "Create a chart based on this data to help illustrate the findings. \n\nUse the create_vega_lite or create_plotly tool. After creating it, the image will be automatically injected for you to see.\n\nOnce you see the chart image, analyze it against the requirements and describe:\n1. What you observe visually\n2. How well it meets the requirements\n3. What specific improvements are needed - does it help to answer the users question? If mutiple compound charts would help visualize, go for that. For styling use dark mode and give it some flair and personality.",
    "tackle": ["create_vega_lite", "create_plotly"],
    "soundings": {
      "factor": 3,
      "evaluator_instructions": "Evaluate based on:\n1. Accuracy of visual observations about the chart\n2. Depth of analysis against requirements\n3. Specificity of improvement suggestions\n\nSelect the analysis that is most detailed and actionable.",
      "reforge": {
        "steps": 2,
        "honing_prompt": "You previously analyzed this chart. Looking at the chart image again, provide even MORE specific improvements:\n\n- Exact color codes for better contrast (hex values)\n- Precise font sizes for labels\n- Specific axis range adjustments\n- Data point annotation placement\n- Are things being overlapped or clipped? \nLegend positioning coordinates\n\nBe EXTREMELY specific and actionable. Reference exact elements you see in the image.",
        "factor_per_step": 2,
        "mutate": true,
        "evaluator_override": "Evaluate refinements on:\n1. Specificity (exact values, not vague suggestions)\n2. Visual awareness (referencing actual chart elements)\n3. Implementation feasibility\n4. Completeness of improvements\n\nPick the most production-ready, implementable analysis."
      }
    },
    "rules": {"max_turns": 1},
    "handoffs": ["say_summary_summarize"]
  },
  {
    "name": "say_summary_summarize",
    "instructions": "Use the `say` tool to speak to the user and give a VERY short summary of the findings and chart. Persona is a sassy, foul mouthed, street kid turned corpo. Yet a beautiful vixen, none the less.",
    "tackle": ["say"],
    "context": {"from": ["all"]},
    "rules": {"max_turns": 1}
  }
  ]
}
