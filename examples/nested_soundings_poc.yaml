# Nested Soundings POC - "Soundings within Soundings"
#
# Architecture:
#
# OUTER LEVEL: Cascade-level soundings (factor: 2)
# ├── Cascade Run 0 (complete execution)
# │   └── Phase: ideate_plans
# │       └── Phase-level soundings (10 plans, multi-model, reforge 3x)
# │           ├── 10 different models generate plans in parallel
# │           ├── Reforge: Winner iterates 3 times (depth = detail)
# │           └── Inner evaluator picks best or merges if low-confidence
# │
# └── Cascade Run 1 (complete execution)
#     └── Same process but with mutation diversity
#
# SECOND-TIER EVALUATOR: Picks the ultimate winner from cascade outputs
#
# This tests the hypothesis that running the entire evaluation pipeline
# multiple times with different starting conditions yields better results
# than a single, larger run.

cascade_id: nested_soundings_poc
description: |
  Proof of concept for nested soundings - cascade-level soundings containing
  phase-level soundings with multi-model parallel execution and iterative reforge.

  Tests: Can we get better outputs by running the entire "parallel plans + evaluate"
  process twice, then picking the meta-winner?

inputs_schema:
  challenge: "The design/architecture challenge to solve"
  constraints: "Any constraints or requirements (optional)"

# OUTER LEVEL: Run the entire cascade twice
soundings:
  factor: 2
  mutate: true
  mutation_mode: approach  # Different thinking strategies per cascade run
  evaluator_instructions: |
    You are the SECOND-TIER evaluator - the "evaluator of evaluators".

    You're seeing the winning solutions from TWO completely independent
    planning runs, each of which already went through:
    - 10 parallel model attempts
    - 3 rounds of iterative refinement
    - Internal evaluation and selection

    Your job is to pick the ULTIMATE winner.

    ## Evaluation Criteria

    1. **Solution Quality** (40%)
       - Correctness and feasibility
       - Handles edge cases
       - Follows best practices

    2. **Depth of Thought** (30%)
       - Shows evidence of iteration and refinement
       - Addresses trade-offs explicitly
       - Anticipates implementation challenges

    3. **Clarity & Actionability** (30%)
       - Could someone implement this today?
       - Clear structure and organization
       - Concrete next steps

    ## Your Decision

    Pick the winner OR if both are roughly equal but have complementary
    strengths, you may synthesize them into a merged superior solution.

    Format your response as:
    ```
    WINNER: [0 or 1 or "MERGED"]

    REASONING: [Your detailed reasoning]

    [If MERGED, provide the synthesized solution]
    ```

phases:
  - name: ideate_plans
    #model: "anthropic/claude-sonnet-4.5"
    instructions: |
      ## Design Challenge

      {{ input.challenge }}

      {% if input.constraints %}
      ## Constraints
      {{ input.constraints }}
      {% endif %}

      ---

      You are a senior architect tasked with creating a comprehensive plan
      to address this challenge. Your plan should be:

      1. **Concrete** - Specific enough to implement
      2. **Structured** - Clear phases or components
      3. **Justified** - Explain why each decision
      4. **Risk-aware** - Note potential issues and mitigations

      {% if is_sounding %}
      This is sounding {{ sounding_index }} of {{ sounding_factor }}.
      Be creative and explore a UNIQUE approach - don't play it safe.
      {% endif %}

      ## Output Format

      ### Executive Summary
      [2-3 sentences on the core approach]

      ### Architecture Overview
      [High-level structure with components]

      ### Implementation Plan
      [Phased approach with concrete steps]

      ### Trade-offs & Risks
      [What we're giving up, what could go wrong]

      ### Success Criteria
      [How we know this worked]

    tackle: ["create_artifact"]

    # INNER LEVEL: 10 parallel plans across multiple models
    soundings:
      factor: 6

      # Multi-model configuration - the "big 3" plus wildcards
      models:
        #- anthropic/claude-sonnet-4.5
        - anthropic/claude-opus-4.5
        - openai/gpt-5.2
        - x-ai/grok-4

      model_strategy: round-robin
      mutate: true
      mutation_mode: approach  # Use different thinking strategies

      evaluator_instructions: |
        You are the INNER evaluator - selecting the best plan from 10 parallel attempts.

        ## What You're Evaluating

        These are 10 different architectural plans for the same challenge,
        generated by different models with different approaches.

        ## Evaluation Criteria

        1. **Feasibility** (25%) - Can this actually be built?
        2. **Completeness** (25%) - Does it address all aspects?
        3. **Innovation** (25%) - Novel approaches or insights?
        4. **Clarity** (25%) - Well-structured and understandable?

        ## Selection Rules

        - Pick ONE winner if there's a clear best
        - If top 2-3 are very close (within ~5% quality), consider:
          - Do they have complementary strengths?
          - Could merging improve the result?

        ## Output Format

        If selecting a winner:
        ```
        WINNER: [index]
        CONFIDENCE: [high/medium/low]
        REASONING: [why this one won]
        ```

        If merging (only for low confidence + complementary strengths):
        ```
        WINNER: MERGED
        CONFIDENCE: low
        SOURCES: [indices of plans being merged]
        MERGED_PLAN: [your synthesized superior plan]
        ```

      # REFORGE: Iterate the winner 3 times for depth
      reforge:
        model: anthropic/claude-sonnet-4.5 
        steps: 3
        factor_per_step: 2
        mutate: false  # Keep consistent during refinement

        honing_prompt: |
          You are REFINING a plan that was selected as the best from 10 alternatives.

          ## Your Mission

          Take this winning plan and make it BETTER. This is iteration {{ state._reforge_step | default(1) }} of 3.

          ## Refinement Focus Areas

          **Iteration 1:** Add concrete implementation details
          - Specific technologies, libraries, patterns
          - Code structure or pseudocode where helpful
          - Database schemas, API contracts, etc.

          **Iteration 2:** Harden against edge cases
          - Error handling strategies
          - Performance considerations
          - Security implications
          - Scalability concerns

          **Iteration 3:** Polish for actionability
          - Clear task breakdown
          - Dependency ordering
          - Time/effort rough estimates
          - Definition of done for each component

          ## Rules

          - Keep all the good parts of the original
          - ADD depth, don't restructure unless necessary
          - Be specific - vague refinement is not refinement
          - If you find a flaw, fix it and note you fixed it

        evaluator_override: |
          Compare the refined versions. Pick the one that:
          1. Added the most useful concrete detail
          2. Maintained clarity despite added complexity
          3. Addressed the refinement focus areas effectively

          Brief reasoning, then pick a winner.

    rules:
      max_turns: 1  # Single generation per sounding

  - name: final_polish
    model: anthropic/claude-sonnet-4.5
    instructions: |
      ## The Winning Plan

      {{ outputs.ideate_plans }}

      ---

      You are doing a final polish pass on the winning plan.

      Your ONLY jobs:
      1. Fix any formatting issues
      2. Ensure consistent terminology
      3. Add a "Quick Start" section at the end with the first 3 things to do

      Do NOT change the substance. This is cosmetic only.

      Create the plan as an artifact when done please! 
      And when you make the artifact please make sure you tag it as the winner and perhaps indicate that in the title briefly.

    tackle: ["create_artifact"]
    context:
      from: [previous]
    rules:
      max_turns: 1
