cascade_id: js_analytics_demo
description: Demonstrates JavaScript's modern array methods, destructuring, and functional
  patterns for data analytics.
inputs_schema: {}
cells:
- name: events
  tool: sql_data
  inputs:
    query: "-- Generate clickstream events\nSELECT * FROM (\n  VALUES\n    ('2024-03-01\
      \ 10:00:00', 'sess_001', 'page_view', '/home', null),\n    ('2024-03-01 10:00:30',\
      \ 'sess_001', 'click', '/home', 'hero_cta'),\n    ('2024-03-01 10:01:00', 'sess_001',\
      \ 'page_view', '/products', null),\n    ('2024-03-01 10:02:00', 'sess_001',\
      \ 'click', '/products', 'product_123'),\n    ('2024-03-01 10:02:30', 'sess_001',\
      \ 'page_view', '/product/123', null),\n    ('2024-03-01 10:03:00', 'sess_001',\
      \ 'add_to_cart', '/product/123', 'product_123'),\n    ('2024-03-01 10:05:00',\
      \ 'sess_001', 'purchase', '/checkout', 'order_456'),\n    ('2024-03-01 11:00:00',\
      \ 'sess_002', 'page_view', '/home', null),\n    ('2024-03-01 11:00:20', 'sess_002',\
      \ 'page_view', '/about', null),\n    ('2024-03-01 11:01:00', 'sess_002', 'page_view',\
      \ '/home', null),\n    ('2024-03-01 14:00:00', 'sess_003', 'page_view', '/products',\
      \ null),\n    ('2024-03-01 14:01:00', 'sess_003', 'click', '/products', 'product_789'),\n\
      \    ('2024-03-01 14:01:30', 'sess_003', 'page_view', '/product/789', null),\n\
      \    ('2024-03-01 14:02:00', 'sess_003', 'add_to_cart', '/product/789', 'product_789'),\n\
      \    ('2024-03-01 14:10:00', 'sess_003', 'page_view', '/cart', null)\n) AS t(timestamp,\
      \ session_id, event_type, page, target)\n"
  handoffs:
  - js_sessionize
- name: js_sessionize
  tool: js_data
  inputs:
    code: "// Modern JS: Sessionize and enrich clickstream data\nconst events = data.events;\n\
      \n// Group by session using reduce with Map\nconst sessionMap = events.reduce((acc,\
      \ event) => {\n  const { session_id, ...rest } = event;\n  if (!acc.has(session_id))\
      \ {\n    acc.set(session_id, []);\n  }\n  acc.get(session_id).push({ ...rest,\
      \ session_id });\n  return acc;\n}, new Map());\n\n// Process each session\n\
      const sessions = [...sessionMap.entries()].map(([sessionId, events]) => {\n\
      \  const timestamps = events.map(e => new Date(e.timestamp));\n  const firstEvent\
      \ = Math.min(...timestamps);\n  const lastEvent = Math.max(...timestamps);\n\
      \n  // Funnel analysis\n  const eventTypes = new Set(events.map(e => e.event_type));\n\
      \  const funnelSteps = {\n    viewed: eventTypes.has('page_view'),\n    clicked:\
      \ eventTypes.has('click'),\n    addedToCart: eventTypes.has('add_to_cart'),\n\
      \    purchased: eventTypes.has('purchase')\n  };\n\n  // Calculate furthest\
      \ funnel step\n  const funnelOrder = ['viewed', 'clicked', 'addedToCart', 'purchased'];\n\
      \  const maxStep = funnelOrder.filter(step => funnelSteps[step]).pop();\n\n\
      \  return {\n    session_id: sessionId,\n    event_count: events.length,\n \
      \   duration_seconds: (lastEvent - firstEvent) / 1000,\n    pages_viewed: [...new\
      \ Set(events.filter(e => e.event_type === 'page_view').map(e => e.page))],\n\
      \    page_view_count: events.filter(e => e.event_type === 'page_view').length,\n\
      \    max_funnel_step: maxStep,\n    converted: funnelSteps.purchased,\n    bounce:\
      \ events.length <= 2 && !funnelSteps.clicked\n  };\n});\n\nresult = sessions;\n"
  handoffs:
  - js_funnel
- name: js_funnel
  tool: js_data
  inputs:
    code: "// Funnel analysis with modern JS patterns\nconst sessions = data.js_sessionize;\n\
      \n// Define funnel stages\nconst funnelStages = ['viewed', 'clicked', 'addedToCart',\
      \ 'purchased'];\n\n// Calculate conversion at each stage\nconst funnelAnalysis\
      \ = funnelStages.map((stage, index) => {\n  const stageOrder = funnelStages.slice(0,\
      \ index + 1);\n  const reachedCount = sessions.filter(s =>\n    stageOrder.includes(s.max_funnel_step)\
      \ ||\n    funnelStages.indexOf(s.max_funnel_step) >= index\n  ).length;\n\n\
      \  const conversionRate = sessions.length > 0\n    ? ((reachedCount / sessions.length)\
      \ * 100).toFixed(1)\n    : 0;\n\n  return {\n    stage,\n    stage_number: index\
      \ + 1,\n    sessions_reached: reachedCount,\n    conversion_rate: `${conversionRate}%`,\n\
      \    drop_off: index === 0 ? 0 : sessions.length - reachedCount\n  };\n});\n\
      \n// Overall metrics using destructuring and spread\nconst metrics = {\n  total_sessions:\
      \ sessions.length,\n  converted_sessions: sessions.filter(s => s.converted).length,\n\
      \  bounced_sessions: sessions.filter(s => s.bounce).length,\n  avg_duration:\
      \ (sessions.reduce((sum, s) => sum + s.duration_seconds, 0) / sessions.length).toFixed(1),\n\
      \  avg_pages_per_session: (sessions.reduce((sum, s) => sum + s.page_view_count,\
      \ 0) / sessions.length).toFixed(1),\n  funnel: funnelAnalysis\n};\n\nresult\
      \ = metrics;\n"
  handoffs:
  - python_viz_prep
- name: python_viz_prep
  tool: python_data
  inputs:
    code: "# Prepare data for visualization\nimport pandas as pd\n\nmetrics = data.js_funnel\n\
      funnel_data = pd.DataFrame(metrics['funnel'])\n\n# Add visualization-ready columns\n\
      funnel_data['bar_width'] = funnel_data['sessions_reached'] / funnel_data['sessions_reached'].max()\
      \ * 100\nfunnel_data['stage_label'] = funnel_data['stage'].str.replace('addedToCart',\
      \ 'Added to Cart').str.title()\n\n# Summary stats\nsummary = {\n    'total_sessions':\
      \ metrics['total_sessions'],\n    'conversion_rate': f\"{(metrics['converted_sessions']\
      \ / metrics['total_sessions'] * 100):.1f}%\",\n    'bounce_rate': f\"{(metrics['bounced_sessions']\
      \ / metrics['total_sessions'] * 100):.1f}%\",\n    'avg_duration': f\"{float(metrics['avg_duration']):.0f}s\"\
      ,\n    'avg_pages': metrics['avg_pages_per_session']\n}\n\n# Return both for\
      \ final SQL\nresult = {'funnel': funnel_data.to_dict('records'), 'summary':\
      \ summary}\n"
  handoffs:
  - final_report
- name: final_report
  tool: sql_data
  inputs:
    query: "-- Final funnel report\nSELECT\n  stage_label as \"Funnel Stage\",\n \
      \ sessions_reached as \"Sessions\",\n  conversion_rate as \"Rate\",\n  drop_off\
      \ as \"Drop-off\",\n  REPEAT('â–ˆ', CAST(bar_width/5 AS INTEGER)) as \"Visualization\"\
      \nFROM _python_viz_prep_funnel\nORDER BY stage_number\n"
