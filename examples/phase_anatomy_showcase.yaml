# Phase Anatomy Showcase
#
# This cascade demonstrates ALL phase features visible in the Phase Anatomy panel.
# Use this to test the visualization of:
# - Input layer (instructions, inputs_schema, tool)
# - Context layer (selective context injection)
# - Wards layer (pre/post validators)
# - Soundings layer (factor, mutate, multi-model, max_turns)
# - Convergence section (evaluator, pre-validator, aggregate mode)
# - Reforge layer (iterative refinement)
# - Output layer (schema, extraction, callouts, handoffs)

cascade_id: phase_anatomy_showcase
description: "Comprehensive showcase of all phase features for testing the Phase Anatomy panel"

inputs_schema:
  topic: "The topic to analyze"
  depth: "How deep to go (shallow, medium, deep)"

phases:
  # ============================================================
  # PHASE 1: Simple LLM Phase with Instructions
  # Shows: Input layer with instructions and inputs_schema
  # ============================================================
  - name: initial_analysis
    instructions: |
      You are an expert analyst. Analyze the following topic at the specified depth level.

      Topic: {{ input.topic }}
      Depth: {{ input.depth }}

      Provide a structured analysis with:
      1. Key concepts
      2. Main challenges
      3. Potential opportunities

      Be concise but thorough.

    model: google/gemini-2.5-flash

    rules:
      max_turns: 2

    tackle:
      - set_state

    output_schema:
      type: object
      required:
        - concepts
        - challenges
        - opportunities

  # ============================================================
  # PHASE 2: Soundings with Multi-Model and Mutations
  # Shows: Soundings layer with factor, mutate, models, evaluator
  # ============================================================
  - name: parallel_brainstorm
    instructions: |
      Based on the initial analysis, brainstorm creative solutions.

      Previous analysis: {{ outputs.initial_analysis }}

      Generate 3-5 innovative ideas that address the challenges identified.
      Think outside the box and consider unconventional approaches.

    context:
      from:
        - initial_analysis
      include:
        - output

    soundings:
      factor: 6
      mutate: true
      models:
        - anthropic/claude-sonnet-4
        - google/gemini-2.5-flash
        - openai/gpt-4o-mini

      evaluator_instructions: |
        Compare the three brainstorming outputs and select the winner.

        Criteria:
        1. Creativity and originality (40%)
        2. Feasibility of ideas (30%)
        3. Relevance to the challenges (30%)

        Explain your reasoning and declare the winner by index (0, 1, or 2).

      validator: |
        def validate(output):
            if not output or len(output) < 100:
                return {"valid": False, "reason": "Output too short"}
            return {"valid": True, "reason": "Output meets minimum length"}

    rules:
      max_turns: 3

    tackle:
      - set_state

  # ============================================================
  # PHASE 3: Wards (Pre and Post Validators)
  # Shows: Wards layer with blocking and advisory validators
  # ============================================================
  - name: validated_refinement
    instructions: |
      Take the winning brainstorm and refine it into a concrete proposal.

      Winning ideas: {{ outputs.parallel_brainstorm }}

      Create a detailed proposal with:
      - Executive summary
      - Implementation steps
      - Resource requirements
      - Timeline estimate

    context:
      from:
        - parallel_brainstorm
      include:
        - output
        - winner

    wards:
      pre:
        - name: input_quality_check
          mode: blocking
          validator: |
            def validate(context):
                if not context.get('outputs', {}).get('parallel_brainstorm'):
                    return {"valid": False, "reason": "No brainstorm output available"}
                return {"valid": True, "reason": "Input quality verified"}

      post:
        - name: proposal_completeness
          mode: advisory
          validator: |
            def validate(output):
                required = ['summary', 'steps', 'resources', 'timeline']
                missing = [r for r in required if r.lower() not in output.lower()]
                if missing:
                    return {"valid": False, "reason": f"Missing sections: {missing}"}
                return {"valid": True, "reason": "All required sections present"}

        - name: length_check
          mode: blocking
          validator: |
            def validate(output):
                if len(output) < 500:
                    return {"valid": False, "reason": "Proposal too brief"}
                return {"valid": True, "reason": "Sufficient detail provided"}

    rules:
      max_turns: 2

    model: anthropic/claude-sonnet-4

  # ============================================================
  # PHASE 4: Loop-Until Validation
  # Shows: Soundings layer with loop_until and turn_prompt
  # ============================================================
  - name: iterative_improvement
    instructions: |
      Review and improve the proposal to meet quality standards.

      Current proposal: {{ outputs.validated_refinement }}

      Ensure the proposal:
      1. Has clear, actionable steps
      2. Includes realistic timelines
      3. Addresses potential risks
      4. Has measurable success criteria

    context:
      from:
        - validated_refinement

    rules:
      max_turns: 5
      max_attempts: 3
      loop_until: |
        def validate(output):
            # Check for all required elements
            checks = {
                'actionable': 'step' in output.lower() or 'action' in output.lower(),
                'timeline': 'week' in output.lower() or 'month' in output.lower() or 'day' in output.lower(),
                'risks': 'risk' in output.lower() or 'challenge' in output.lower(),
                'metrics': 'metric' in output.lower() or 'measure' in output.lower() or 'kpi' in output.lower()
            }
            passed = all(checks.values())
            failed = [k for k, v in checks.items() if not v]
            if passed:
                return {"valid": True, "reason": "All quality criteria met"}
            return {"valid": False, "reason": f"Missing elements: {failed}"}

      turn_prompt: |
        Your previous response was missing some elements: {{ validation_reason }}
        Please revise to include all required components.

    model: google/gemini-2.5-flash

  # ============================================================
  # PHASE 5: Reforge (Iterative Refinement)
  # Shows: Reforge layer with steps and validator
  # ============================================================
  - name: reforged_synthesis
    instructions: |
      Create a final synthesized document combining all insights.

      Original topic: {{ input.topic }}
      Analysis: {{ outputs.initial_analysis }}
      Improved proposal: {{ outputs.iterative_improvement }}

      Produce a polished, professional document.

    context:
      from:
        - initial_analysis
        - iterative_improvement
      include:
        - output

    soundings:
      factor: 2
      models:
        - anthropic/claude-sonnet-4
        - openai/gpt-4o

      evaluator_instructions: |
        Select the better synthesis based on clarity, completeness, and professionalism.

      reforge:
        steps: 3
        validator: |
          def validate(output):
              word_count = len(output.split())
              if word_count < 300:
                  return {"valid": False, "reason": f"Only {word_count} words, need at least 300"}
              return {"valid": True, "reason": f"Good length: {word_count} words"}

        prompt: |
          The current output needs improvement: {{ validation_reason }}

          Please expand and enhance the synthesis while maintaining quality.

    rules:
      max_turns: 2

  # ============================================================
  # PHASE 6: Aggregate Mode (Combine All Soundings)
  # Shows: Convergence section in aggregate mode
  # ============================================================
  - name: multi_perspective_review
    instructions: |
      Provide a critical review of the synthesized document from your unique perspective.

      Document: {{ outputs.reforged_synthesis }}

      Sounding {{ sounding_index }} of {{ sounding_factor }}:
      {% if sounding_index == 0 %}
      Review from a TECHNICAL perspective - focus on feasibility and implementation details.
      {% elif sounding_index == 1 %}
      Review from a BUSINESS perspective - focus on ROI, market fit, and scalability.
      {% else %}
      Review from a USER perspective - focus on usability, adoption, and experience.
      {% endif %}

    context:
      from:
        - reforged_synthesis

    soundings:
      factor: 3
      mode: aggregate

      aggregator_instructions: |
        Combine all three perspective reviews into a comprehensive feedback document.
        Organize by perspective (Technical, Business, User) and highlight:
        - Key strengths identified
        - Areas for improvement
        - Recommended next steps

    rules:
      max_turns: 1

    model: google/gemini-2.5-flash

  # ============================================================
  # PHASE 7: Deterministic Phase (Tool-based)
  # Shows: Input layer with tool instead of instructions
  # ============================================================
  - name: save_results
    tool: set_state
    inputs:
      key: final_analysis
      value: "{{ outputs.multi_perspective_review }}"

  # ============================================================
  # PHASE 8: Handoffs (Dynamic Routing)
  # Shows: Output layer with handoffs
  # ============================================================
  - name: route_next_action
    instructions: |
      Based on the multi-perspective review, determine the best next action.

      Review: {{ outputs.multi_perspective_review }}

      Decide whether to:
      1. APPROVE - The proposal is ready for implementation
      2. REVISE - More work needed on specific areas
      3. ESCALATE - Needs senior review due to complexity/risk

      Use the route_to tool to direct to the appropriate next phase.

    context:
      from:
        - multi_perspective_review

    handoffs:
      - approve_proposal
      - request_revision
      - escalate_review

    rules:
      max_turns: 2

    tackle:
      - set_state

    callouts:
      - decision_point
      - routing

  # ============================================================
  # PHASE 9: Output Extraction
  # Shows: Output layer with extraction patterns
  # ============================================================
  - name: approve_proposal
    instructions: |
      Generate the final approval document.

      Include:
      - Approval statement
      - Key decision factors
      - Implementation authorization
      - Success metrics to track

      Format with clear headers.

    output_extraction:
      - pattern: "APPROVED:\\s*(.+)"
        target: approval_status
      - pattern: "Implementation Start:\\s*(\\d{4}-\\d{2}-\\d{2})"
        target: start_date

    output_schema:
      type: object
      properties:
        status:
          type: string
          enum: [approved, conditional, pending]
        authorization_level:
          type: string
      required:
        - status

    rules:
      max_turns: 1

    model: anthropic/claude-sonnet-4

  # Revision handler
  - name: request_revision
    instructions: |
      Document the specific revisions needed.

      Based on the review feedback, list:
      1. Specific areas requiring changes
      2. Suggested improvements
      3. Deadline for revisions

    rules:
      max_turns: 1

  # Escalation handler
  - name: escalate_review
    instructions: |
      Prepare an escalation brief for senior review.

      Include:
      - Summary of the proposal
      - Reasons for escalation
      - Specific questions for senior leadership
      - Risk assessment

    rules:
      max_turns: 1

    callouts:
      - escalation
      - high_priority
