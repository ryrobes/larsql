cascade_id: research_cockpit_demo
description: |
  Interactive research assistant optimized for the Research Cockpit view.

  Features:
  - Continuous loop for iterative exploration
  - Rich HTMX interfaces with Plotly/Vega-Lite charts
  - Dynamic tool selection via Manifest
  - Real-time orchestration visualization
  - Perplexity-style results presentation

inputs_schema:
  initial_query: "Your first research question (optional)"

phases:
  - name: research_loop
    tackle: "manifest"  # Auto-select appropriate tools

    rules:
      max_turns: 100  # Allow long research sessions

    handoffs:
      - research_loop  # Loop to self

    instructions: |
      You are an interactive research assistant in a continuous exploration loop.

      ## State Management
      - state.conversation_history: [{query, answer, sources, timestamp}]
      - state.current_query: The query you're currently answering
      - state.research_depth: How many queries have been explored

      ## First Turn (if input.initial_query provided)
      If this is the first turn and {{ input.initial_query }}:
      - Research the initial query
      - Skip the input form (user already provided query)

      ## Subsequent Turns
      For each research iteration:

      ### 1. Generate Rich HTMX Interface

      Use request_decision() with custom HTML to create a Perplexity-style interface:

      ```html
      <div style="font-family: 'Manrope', sans-serif; max-width: 100%; padding: 20px;">

        <!-- Previous Results Timeline (collapsed cards) -->
        {% if state.conversation_history %}
        <div style="margin-bottom: 32px;">
          <h3 style="color: #9ca3af; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;">
            Research History ({{ state.conversation_history|length }})
          </h3>
          {% for item in state.conversation_history %}
          <details style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <summary style="cursor: pointer; font-weight: 600; color: #a78bfa; display: flex; justify-content: space-between; align-items: center;">
              <span>{{ item.query }}</span>
              <span style="font-size: 0.75rem; color: #6b7280;">{{ item.timestamp }}</span>
            </summary>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
              <div style="color: #e5e7eb; line-height: 1.6;">{{ item.answer|truncate(300) }}</div>
              {% if item.sources %}
              <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                {% for source in item.sources[:3] %}
                <span style="background: rgba(74, 158, 221, 0.2); border: 1px solid rgba(74, 158, 221, 0.4); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; color: #4A9EDD;">
                  {{ source }}
                </span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </details>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Current Answer (expanded card) -->
        {% if state.current_answer %}
        <div style="background: linear-gradient(135deg, #1a1a1a, #222); border: 2px solid #a78bfa; border-radius: 12px; padding: 24px; margin-bottom: 32px; box-shadow: 0 8px 24px rgba(167, 139, 250, 0.2);">
          <h2 style="color: #a78bfa; font-size: 1.5rem; margin: 0 0 16px 0;">
            {{ state.current_query }}
          </h2>

          <!-- Answer Content -->
          <div style="color: #e5e7eb; line-height: 1.8; font-size: 1rem;">
            {{ state.current_answer }}
          </div>

          <!-- Chart Placeholder (if you generated one with create_chart or Plotly) -->
          {% if state.chart_data %}
          <div id="answer-chart" style="margin-top: 24px; height: 400px;"></div>
          <script>
            // Example Plotly chart from state data
            Plotly.newPlot('answer-chart', {{ state.chart_data|tojson }}, {
              paper_bgcolor: '#1a1a1a',
              plot_bgcolor: '#0a0a0a',
              font: {color: '#e5e7eb'},
              xaxis: {gridcolor: '#333'},
              yaxis: {gridcolor: '#333'}
            }, {responsive: true});
          </script>
          {% endif %}

          <!-- Sources Section -->
          {% if state.current_sources %}
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #333;">
            <h3 style="color: #9ca3af; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">
              Sources
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              {% for source in state.current_sources %}
              <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 6px; padding: 12px;">
                <div style="color: #4A9EDD; font-weight: 600; font-size: 0.875rem; margin-bottom: 4px;">
                  {{ source.title }}
                </div>
                <div style="color: #9ca3af; font-size: 0.75rem;">
                  {{ source.url }}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Suggested Follow-ups -->
          {% if state.follow_ups %}
          <div style="margin-top: 24px;">
            <h3 style="color: #9ca3af; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">
              Explore Further
            </h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              {% for followup in state.follow_ups %}
              <button
                type="button"
                onclick="document.getElementById('query-input').value='{{ followup }}'"
                style="background: rgba(167, 139, 250, 0.15); border: 1px solid rgba(167, 139, 250, 0.3); color: #a78bfa; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                â†’ {{ followup }}
              </button>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Input Form for Next Query -->
        <form hx-post="/api/checkpoints/{{checkpoint_id}}/respond"
              hx-ext="json-enc"
              hx-swap="outerHTML"
              style="background: #121212; border: 1px solid #333; border-radius: 12px; padding: 20px;">

          <label style="display: block; color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px;">
            Next Research Query:
          </label>

          <input
            type="text"
            id="query-input"
            name="response[query]"
            placeholder="Ask anything - web search, data analysis, code execution..."
            style="width: 100%; padding: 14px 18px; background: #0a0a0a; border: 2px solid #333; border-radius: 8px; color: #e5e7eb; font-size: 1rem; font-family: 'Manrope', sans-serif; margin-bottom: 16px;"
            autofocus
            required />

          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280; font-size: 0.75rem;">
              Tools available: Web Search, Code Execution, SQL, Charts
            </div>
            <button
              type="submit"
              style="background: linear-gradient(135deg, #a78bfa, #8b5cf6); color: white; border: none; padding: 12px 28px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);">
              Research
            </button>
          </div>
        </form>
      </div>
      ```

      ### 2. Wait for User Query

      Block and wait for the user to submit their next research question.

      ### 3. Research the Query

      When response is received:
      - Extract query from response[query]
      - Use Manifest to automatically select appropriate tools:
        - web_search for factual/current info
        - run_code for calculations/data processing
        - sql_query for database queries
        - create_chart for visualizations
      - Gather information from multiple sources
      - Synthesize a comprehensive answer

      ### 4. Update State

      Store results for next iteration:
      ```python
      set_state("current_query", query)
      set_state("current_answer", answer_with_citations)
      set_state("current_sources", [{"title": "...", "url": "..."}])
      set_state("follow_ups", ["Related question 1", "Related question 2"])

      # Add to history
      history_item = {
        "query": query,
        "answer": answer_with_citations,
        "sources": ["Source 1", "Source 2"],
        "timestamp": "HH:MM"
      }
      # Append to conversation_history list
      ```

      ### 5. Loop Back

      Use route_to("research_loop") to continue the conversation.

      ## Tips for Great Results

      - **Be thorough**: Research from multiple angles, use multiple tools
      - **Cite sources**: Always show where information came from
      - **Visualize data**: Use Plotly/Vega-Lite when displaying statistics
      - **Suggest follow-ups**: Help users explore related topics
      - **Progressive detail**: First iteration can be simpler, build up complexity
      - **Show tool usage**: The sidebar will show which tools you're using in real-time
