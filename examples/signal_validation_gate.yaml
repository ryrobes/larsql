# Validation Gate with Approval Signal
# Demonstrates a workflow that validates input deterministically,
# then waits for an approval signal before proceeding.
#
# This is useful for:
#   - Human-in-the-loop approval workflows
#   - Multi-system coordination gates
#   - Compliance checkpoints
#
# Flow:
#   1. [Deterministic] Validate the request
#   2. [Signal] Wait for approval signal
#   3. [Deterministic] Transform approved data
#   4. [LLM] Generate completion report

cascade_id: signal_validation_gate
description: >
  Validation gate that combines deterministic validation with
  signal-based approval. Run this cascade, then fire the 'approved'
  signal from CLI to continue: windlass signals fire approved --payload '{"approver":"admin"}'

inputs_schema:
  query: "SQL query to validate before approval"

phases:
  # Phase 1: Deterministic validation (no LLM needed)
  - name: validate_request
    tool: "python:windlass.demo_tools.validate_sql"
    inputs:
      query: "{{ input.query | default('SELECT * FROM users WHERE active = true') }}"
    routing:
      valid: request_approval
      invalid: reject_invalid
    handoffs:
      - request_approval
      - reject_invalid

  # Phase 2: Reject invalid requests with LLM explanation
  - name: reject_invalid
    instructions: |
      The request failed validation and cannot proceed to approval:

      Query: {{ input.query | default('SELECT * FROM users WHERE active = true') }}
      Validation Error: {{ state.output_validate_request.error }}

      Explain why this request was rejected and what needs to be fixed.
    tackle: []

  # Phase 3: Wait for approval signal
  - name: request_approval
    instructions: |
      The request has been validated successfully:

      Query: {{ state.output_validate_request.cleaned_query }}
      Validation: PASSED

      Now waiting for approval. Use await_signal to wait for signal named
      'approved' with a timeout of '2m'. Set description to 'Awaiting approval for validated request'.

      While waiting, an administrator can approve by running:
      windlass signals fire approved --payload '{"approver":"admin","reason":"looks good"}'
    tackle:
      - await_signal
    handoffs:
      - process_approved
      - handle_timeout

  # Phase 4: Handle approval timeout
  - name: handle_timeout
    instructions: |
      The approval request timed out:

      {{ state.output_request_approval }}

      The request was valid but no approval was received within the timeout period.
      Suggest next steps (retry, escalate, etc.).
    tackle: []

  # Phase 5: Process approved request with deterministic transform
  - name: process_approved
    tool: "python:windlass.demo_tools.transform_data"
    inputs:
      data: '[{"user_id": 1, "score": 85}, {"user_id": 2, "score": 92}, {"user_id": 3, "score": 78}]'
      operation: "sum_numeric"
    routing:
      success: generate_completion_report
      empty: handle_empty
      error: handle_error
    handoffs:
      - generate_completion_report
      - handle_empty
      - handle_error

  # Phase 6: Handle empty results
  - name: handle_empty
    instructions: No data to process after approval. Log and exit gracefully.
    tackle: []

  # Phase 7: Handle processing errors
  - name: handle_error
    instructions: |
      Processing failed after approval: {{ state.last_deterministic_error }}
      This is unexpected - the request was approved but processing failed.
    tackle: []

  # Phase 8: Generate completion report
  - name: generate_completion_report
    instructions: |
      Generate a completion report for this approved workflow:

      VALIDATION PHASE:
      {{ state.output_validate_request }}

      APPROVAL PHASE:
      {{ state.output_request_approval }}

      PROCESSING PHASE:
      {{ state.output_process_approved }}

      Include:
      1. What was validated
      2. Who approved it (from signal payload)
      3. What was processed
      4. Final results
    tackle: []
