{
  "cascade_id": "deterministic_demo",
  "description": "Demonstrates deterministic (tool-based) phases mixed with LLM phases. Shows direct tool execution, routing, and hybrid error handling.",
  "inputs_schema": {
    "query": "A SQL query to analyze"
  },
  "phases": [
    {
      "name": "validate_query",
      "tool": "python:windlass.demo_tools.validate_sql",
      "inputs": {
        "query": "{{ input.query }}"
      },
      "routing": {
        "valid": "execute_query",
        "invalid": "fix_query"
      },
      "handoffs": ["execute_query", "fix_query"]
    },
    {
      "name": "fix_query",
      "instructions": "The SQL query was invalid. Please analyze and fix the following query:\n\nOriginal Query: {{ input.query }}\n\nValidation Error: {{ state.output_validate_query.error }}\n\nProvide the corrected SQL query.",
      "tackle": [],
      "handoffs": ["execute_query"]
    },
    {
      "name": "execute_query",
      "tool": "smart_sql_run",
      "inputs": {
        "query": "{{ state.output_validate_query.cleaned_query | default(input.query) }}"
      },
      "on_error": {
        "instructions": "SQL execution failed with error: {{ state.last_deterministic_error.error }}\n\nOriginal query: {{ input.query }}\n\nPlease diagnose the issue and suggest a fix.",
        "tackle": ["smart_sql_run"],
        "rules": {"max_turns": 3}
      },
      "handoffs": ["summarize_results"]
    },
    {
      "name": "summarize_results",
      "instructions": "Summarize the query results:\n\nQuery: {{ input.query }}\nResults: {{ state.output_execute_query | tojson }}\n\nProvide a human-readable summary of what the data shows.",
      "tackle": []
    }
  ]
}
