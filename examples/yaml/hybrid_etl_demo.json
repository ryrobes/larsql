{
  "cascade_id": "hybrid_etl_demo",
  "description": "Demonstrates a hybrid ETL pipeline where deterministic phases handle data operations and LLM phases handle intelligent error recovery and summarization.",
  "inputs_schema": {
    "source_path": "Path to source data file",
    "operation": "Transform operation to apply (identity, count, sum_numeric)"
  },
  "cells": [
    {
      "name": "check_source",
      "tool": "python:windlass.demo_tools.file_exists",
      "inputs": {
        "path": "{{ input.source_path }}"
      },
      "routing": {
        "exists": "load_data",
        "not_found": "handle_missing_file"
      },
      "handoffs": [
        "load_data",
        "handle_missing_file"
      ]
    },
    {
      "name": "handle_missing_file",
      "instructions": "The source file was not found:\n\nPath: {{ input.source_path }}\n\nPlease suggest alternatives or explain what might have gone wrong.",
      "traits": [
        "linux_shell"
      ]
    },
    {
      "name": "load_data",
      "tool": "linux_shell",
      "inputs": {
        "command": "cat {{ state.output_check_source.path }}"
      },
      "on_error": "handle_load_error",
      "handoffs": [
        "parse_data"
      ]
    },
    {
      "name": "handle_load_error",
      "instructions": "Failed to load data from file:\n\nPath: {{ input.source_path }}\nError: {{ state.last_deterministic_error.error }}\n\nDiagnose the issue and suggest a solution.",
      "traits": [
        "linux_shell"
      ]
    },
    {
      "name": "parse_data",
      "tool": "python:windlass.demo_tools.parse_json",
      "inputs": {
        "text": "{{ state.output_load_data.stdout }}"
      },
      "routing": {
        "success": "transform_data",
        "error": "handle_parse_error"
      },
      "handoffs": [
        "transform_data",
        "handle_parse_error"
      ]
    },
    {
      "name": "handle_parse_error",
      "instructions": "Failed to parse data as JSON:\n\nRaw content: {{ state.output_load_data.stdout[:500] }}\nParse error: {{ state.output_parse_data.error }}\n\nAnalyze the format and suggest how to fix the data or parse it differently.",
      "traits": [
        "run_code"
      ]
    },
    {
      "name": "transform_data",
      "tool": "python:windlass.demo_tools.transform_data",
      "inputs": {
        "data": "{{ state.output_parse_data.data }}",
        "operation": "{{ input.operation }}"
      },
      "routing": {
        "success": "summarize",
        "empty": "handle_empty_data",
        "error": "handle_transform_error"
      },
      "handoffs": [
        "summarize",
        "handle_empty_data",
        "handle_transform_error"
      ]
    },
    {
      "name": "handle_empty_data",
      "instructions": "The data source was empty. Suggest next steps.",
      "traits": []
    },
    {
      "name": "handle_transform_error",
      "instructions": "Transform operation failed:\n\nOperation: {{ input.operation }}\nError: {{ state.output_transform_data.error }}\n\nSuggest an alternative approach.",
      "traits": []
    },
    {
      "name": "summarize",
      "instructions": "Provide a summary of the ETL pipeline results:\n\n**Source**: {{ input.source_path }}\n**Operation**: {{ input.operation }}\n**Records Processed**: {{ state.output_transform_data.count }}\n**Result**: {{ state.output_transform_data.result | tojson }}\n\nExplain what the data shows and any insights.",
      "traits": []
    }
  ]
}