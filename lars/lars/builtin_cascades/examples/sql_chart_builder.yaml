cascade_id: sql_chart_builder
description: 'Single-phase SQL chart builder that discovers schema, queries data,
  and creates visualizations in a multi-turn conversation.

  '
inputs_schema:
  question: (Optional) The analytical question to answer and visualize
memory: sql_rag_search
validators:
  chart_image_ready:
    model: google/gemini-2.5-flash
    instructions: 'You are validating whether a chart was successfully created.


      **You will be shown:**

      1. Any chart images that were generated (displayed visually above)

      2. The agent''s text output (below)


      **Image Status:** {{ input.image_count }} image(s) available

      {% if input.has_images %}

      ⬆️ LOOK ABOVE: You should see the actual chart image(s). Examine them carefully!

      {% else %}

      ⚠️ NO IMAGES DETECTED - This should fail validation.

      {% endif %}


      **Agent''s Text Output:**

      {{ input.content }}


      ---


      ## Validation Criteria


      For validation to PASS, ALL of the following must be true:

      1. **Image exists** - You can actually SEE a chart image (not just text claiming
      one exists)

      2. **Real data visualization** - The chart has bars, lines, points, or other
      visual data elements

      3. **Readable and complete** - Has title, axis labels, legend as appropriate

      4. **No errors** - Image isn''t blank, corrupted, or showing error messages

      5. **Agent analyzed it** - The text describes what the chart shows


      ## Your Task


      LOOK AT THE IMAGE and verify:

      - Can you see an actual rendered chart? (not placeholder/error)

      - Does it contain data visualization? (bars, lines, scatter, pie, etc.)

      - Is it properly labeled and readable?

      - Does the agent''s description match what you see?


      **Return JSON only:**

      - If valid: {"valid": true, "reason": "Chart verified: [describe what you see]"}

      - If not valid: {"valid": false, "reason": "[no image visible / blank / error
      / incomplete]"}

      '
cells:
- name: build_chart
  instructions: 'You are an expert data analyst and visualization specialist. Your
    task is to answer the following question with a beautiful, insightful chart:


    **Question:** {% if input.question %}{{ input.question }}{% else %}Superstore
    sales Overview on the East Coast{% endif %}


    You have access to SQL databases with various data. Work through these steps:


    ## Step 1: Discover the Data

    Use `sql_search` or `sql_rag_search` to find tables relevant to the question.

    Use `list_sql_connections` to see available data sources.


    The search tools use semantic search - describe what you''re looking for in natural
    language.


    ## Step 2: Explore and Query

    Once you find relevant tables, use `sql_query` to:

    - Sample the data: `SELECT * FROM connection.table LIMIT 5`

    - Check distributions: `SELECT column, COUNT(*) FROM connection.table GROUP BY
    column`

    - Get the data you need to answer the question


    IMPORTANT Query Syntax:

    - CSV folders: `SELECT * FROM connection_name.table_name`

    - PostgreSQL: `SELECT * FROM connection_name.schema.table`

    - Example: `SELECT Region, SUM(Sales) FROM csv_files.superstore GROUP BY Region`


    ## Step 3: Create the Visualization

    Use `create_vega_lite` or `create_plotly` to create a chart. The chart image will
    be automatically shown to you.


    Design guidelines:

    - Use dark mode styling (dark background, light text)

    - Choose the right chart type for the data (bar, line, scatter, etc.)

    - Include clear title, axis labels, and legend if needed

    - Make it visually appealing with good color choices

    - Consider using multiple views or compound charts if it helps tell the story


    ## Step 4: Analyze Your Chart

    After the chart is rendered, you''ll see the image. Describe:

    - What the visualization shows

    - Key insights visible in the chart

    - How it answers the original question


    If the chart has issues (wrong data, bad layout, rendering errors), fix it and
    try again.


    Keep iterating until you have a polished, insightful visualization that clearly
    answers the question.

    '
  context:
    from:
    - previous
  skills:
  - sql_search
  - sql_rag_search
  - list_sql_connections
  - sql_query
  - create_vega_lite
  - create_plotly
  takes:
    factor: 10
    evaluator_instructions: 'Evaluate chart building attempts based on:


      1. **Chart Quality** (40%): Is the visualization clear, well-designed, and insightful?

      2. **Data Accuracy** (30%): Does the chart correctly represent the data and
      answer the question?

      3. **Visual Design** (20%): Is it aesthetically pleasing with good colors, labels,
      and layout?

      4. **Efficiency** (10%): Did they find and query the right data without unnecessary
      steps?


      Select the attempt that:

      - Successfully rendered a chart (no errors)

      - Best answers the original question visually

      - Has the most polished, professional appearance

      - Demonstrates clear analysis of what the chart shows


      CRITICAL: Attempts without a successfully rendered chart image should be heavily
      penalized.

      '
    models:
    - mistralai/devstral-2512:free
    - nex-agi/deepseek-v3.1-nex-n1:free
    - essentialai/rnj-1-instruct
    - mistralai/ministral-14b-2512
    - z-ai/glm-4.6v
    - prime-intellect/intellect-3
    - amazon/nova-2-lite-v1:free
    - anthropic/claude-haiku-4.5
    - allenai/olmo-3-32b-think:free
    mutate: false
    model_strategy: random
    reforge:
      steps: 2
      honing_prompt: 'Look at the previous chart image. Your job is to CREATE AN IMPROVED
        VERSION using the chart tools.


        Analyze what could be better:

        - Color contrast and visual appeal

        - Label clarity and font sizes

        - Axis ranges and data presentation

        - Legend positioning

        - Any overlapping or clipped elements


        Then USE THE TOOLS (`create_vega_lite` or `create_plotly`) to generate a NEW,
        IMPROVED chart.


        DO NOT just describe improvements - actually implement them by creating a
        new visualization!

        You have access to all the same tools. Create a better chart now.

        '
      factor_per_step: 2
      mutate: false
      evaluator_override: 'Compare the ACTUAL CHART IMAGES produced by each refinement
        attempt.


        Evaluate based on:

        1. **Visual Quality** (40%): Is the new chart cleaner, more readable, more
        polished?

        2. **Improvement Over Original** (30%): Did they actually make meaningful
        improvements?

        3. **Data Clarity** (20%): Is the data easier to understand visually?

        4. **Professional Polish** (10%): Does it look production-ready?


        CRITICAL: Only consider attempts that actually generated a NEW chart image.

        Attempts that only described improvements without creating a chart should
        lose.


        Pick the refinement with the BEST ACTUAL CHART OUTPUT.

        '
  rules:
    max_turns: 8
    loop_until: chart_image_ready
    loop_until_silent: true
