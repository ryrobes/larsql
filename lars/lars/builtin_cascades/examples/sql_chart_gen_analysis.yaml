cascade_id: sql_chart_gen_analysis
description: Demonstrates SQL schema discovery and query execution with natural language,
  creates a chart, iterates on it, tells you about it.
inputs_schema:
  question: Natural language question about the data
memory: sql_rag_search
cells:
- handoffs:
  - write_query
  instructions: "The user asked: {{ input.question }}\n\nFirst, use sql_search to\
    \ find relevant tables that might contain data to answer this question.\n\nSearch\
    \ for tables using natural language - the tool will return schema information\
    \ including:\n- Column names and types\n- Value distributions for categorical\
    \ columns\n- Sample rows\n- Row counts\n\nAnalyze the results and identify which\
    \ table(s) would be most useful. \nNote: the search data is ephemeral, so if you\
    \ need access to it later please include important parts in your reply."
  name: discover_schema
  skills:
  - sql_search
  - list_sql_connections
  - sql_rag_search
- context:
    from:
    - previous
  handoffs:
  - analyze_results
  instructions: 'Based on the schema information from the previous phase, write a
    SQL query to answer: {{ input.question }}


    Use the sql_query tool to execute your query.


    IMPORTANT Query Syntax:

    - CSV folders: SELECT * FROM connection_name.table_name

    - PostgreSQL/MySQL: SELECT * FROM connection_name.schema.table

    - Example: SELECT * FROM csv_files.bigfoot_sightings WHERE state = ''California''


    The schema info from the previous phase shows you:

    - Exact column names

    - Data types

    - Sample values (use these to understand the data format)

    - Value distributions (shows you what values exist in categorical columns)


    Write a clear, efficient query based on this information.'
  name: write_query
  skills:
  - sql_query
  - sql_rag_search
- context:
    from:
    - previous
  handoffs:
  - create_initial_chart
  instructions: 'Analyze the query results from the previous phase and provide a clear
    answer to: {{ input.question }}


    Summarize:

    - Key findings from the data

    - Any interesting patterns or insights

    - Direct answer to the user''s question


    Be specific and reference actual numbers from the results.'
  name: analyze_results
  skills: []
- handoffs:
  - say_summary_summarize
  instructions: "Create a chart based on this data to help illustrate the findings.\
    \ \n\nUse the create_vega_lite or create_plotly tool. After creating it, the image\
    \ will be automatically injected for you to see.\n\nOnce you see the chart image,\
    \ analyze it against the requirements and describe:\n1. What you observe visually\n\
    2. How well it meets the requirements\n3. What specific improvements are needed\
    \ - does it help to answer the users question? If mutiple compound charts would\
    \ help visualize, go for that. For styling use dark mode and give it some flair\
    \ and personality."
  name: create_initial_chart
  rules:
    max_turns: 1
  takes:
    evaluator_instructions: 'Evaluate based on:

      1. Accuracy of visual observations about the chart

      2. Depth of analysis against requirements

      3. Specificity of improvement suggestions


      Select the analysis that is most detailed and actionable.'
    factor: 3
    reforge:
      evaluator_override: 'Evaluate refinements on:

        1. Specificity (exact values, not vague suggestions)

        2. Visual awareness (referencing actual chart elements)

        3. Implementation feasibility

        4. Completeness of improvements


        Pick the most production-ready, implementable analysis.'
      factor_per_step: 2
      honing_prompt: "You previously analyzed this chart. Looking at the chart image\
        \ again, provide even MORE specific improvements:\n\n- Exact color codes for\
        \ better contrast (hex values)\n- Precise font sizes for labels\n- Specific\
        \ axis range adjustments\n- Data point annotation placement\n- Are things\
        \ being overlapped or clipped? \nLegend positioning coordinates\n\nBe EXTREMELY\
        \ specific and actionable. Reference exact elements you see in the image."
      mutate: true
      steps: 2
  skills:
  - create_vega_lite
  - create_plotly
- context:
    from:
    - all
  instructions: Use the `say` tool to speak to the user and give a VERY short summary
    of the findings and chart. Persona is a sassy, foul mouthed, street kid turned
    corpo. Yet a beautiful vixen, none the less.
  name: say_summary_summarize
  rules:
    max_turns: 1
  skills:
  - say
