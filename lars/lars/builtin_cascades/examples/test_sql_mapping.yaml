cascade_id: test_sql_mapping
description: Test SQL-native mapping with for_each_row
cells:
- name: load_customers
  tool: sql_data
  inputs:
    query: "SELECT * FROM (VALUES\n  (1, 'Acme Corp', 'acme@example.com', 'enterprise'),\n\
      \  (2, 'Small Shop', 'shop@small.com', 'smb'),\n  (3, 'Big Enterprise', 'contact@bigco.com',\
      \ 'enterprise'),\n  (4, 'Startup Inc', 'hello@startup.io', 'startup')\n) AS\
      \ t(customer_id, customer_name, email, segment)\n"
    materialize: 'true'
- name: analyze_customers
  for_each_row:
    table: _load_customers
    cascade: skills/analyze_customer.yaml
    inputs:
      customer_id: '{{ row.customer_id }}'
      customer_name: '{{ row.customer_name }}'
      email: '{{ row.email }}'
    max_parallel: 4
    result_table: _customer_analysis
    on_error: continue
  context:
    from:
    - load_customers
- name: summary_query
  tool: sql_data
  inputs:
    query: "SELECT\n  customer_name,\n  email,\n  segment,\n  CAST(json_extract_string(result_state.output_analyze,\
      \ '$.risk_score') AS DOUBLE) as risk_score,\n  json_extract_string(result_state.output_analyze,\
      \ '$.recommendation') as recommendation,\n  json_extract_string(result_state.output_analyze,\
      \ '$.insights') as insights\nFROM _customer_analysis\nORDER BY risk_score DESC\n"
  context:
    from:
    - analyze_customers
