"use strict";(self.webpackChunklars_ui=self.webpackChunklars_ui||[]).push([[272],{26272:(e,s,n)=>{n.r(s),n.d(s,{default:()=>Is});var t=n(89379),a=n(65043),l=n(45685),i=n(79942),o=n(24768),c=n(5748),r=n(4131),d=n(54893),u=n(23814),m=n(24227);const h=(0,r.v)((0,d.Zr)((0,u.D)((e,s)=>({connections:[],connectionsLoading:!1,connectionsError:null,schemas:{},schemasLoading:{},schemasError:{},expandedNodes:[],tabs:[{id:"tab_1",title:"Query 1",connection:null,sql:"",cursorPosition:{line:1,column:1},results:null,error:null,isRunning:!1,isDirty:!1,executionTime:null,rowCount:null}],activeTabId:"tab_1",tabCounter:1,history:[],historyTotal:0,historyLoading:!1,historyError:null,schemaPanelWidth:250,resultsPanelHeight:300,historyPanelOpen:!1,fetchConnections:async()=>{e(e=>{e.connectionsLoading=!0,e.connectionsError=null});try{const s=await fetch("".concat(m.e,"/connections")),n=await s.json();if(n.error)throw new Error(n.error);e(e=>{e.connections=n.connections,e.connectionsLoading=!1})}catch(s){e(e=>{e.connectionsError=s.message,e.connectionsLoading=!1})}},fetchSchema:async s=>{e(e=>{e.schemasLoading[s]=!0,e.schemasError[s]=null});try{const n=await fetch("".concat(m.e,"/schema/").concat(s)),t=await n.json();if(t.error)throw new Error(t.error);e(e=>{e.schemas[s]=t,e.schemasLoading[s]=!1})}catch(n){e(e=>{e.schemasError[s]=n.message,e.schemasLoading[s]=!1})}},toggleNodeExpanded:s=>{e(e=>{const n=e.expandedNodes.indexOf(s);-1===n?e.expandedNodes.push(s):e.expandedNodes.splice(n,1)})},isNodeExpanded:e=>s().expandedNodes.includes(e),createTab:function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(e=>{var n;const t=e.tabCounter+1,a={id:"tab_".concat(t),title:"Query ".concat(t),connection:s.connection||(null===(n=e.connections[0])||void 0===n?void 0:n.name)||null,sql:s.sql||"",cursorPosition:{line:1,column:1},results:null,error:null,isRunning:!1,isDirty:!1,executionTime:null,rowCount:null};e.tabs.push(a),e.activeTabId=a.id,e.tabCounter=t})},closeTab:s=>{e(e=>{const n=e.tabs.findIndex(e=>e.id===s);if(!(-1===n||e.tabs.length<=1)&&(e.tabs.splice(n,1),e.activeTabId===s)){const s=Math.min(n,e.tabs.length-1);e.activeTabId=e.tabs[s].id}})},setActiveTab:s=>{e(e=>{e.activeTabId=s})},updateTab:(s,n)=>{e(e=>{const t=e.tabs.find(e=>e.id===s);t&&(Object.assign(t,n),"sql"in n&&""!==n.sql&&(t.isDirty=!0))})},getActiveTab:()=>{const e=s();return e.tabs.find(s=>s.id===e.activeTabId)},executeQuery:async n=>{const t=s().tabs.find(e=>e.id===n);if(!t||!t.connection||!t.sql.trim())return;e(e=>{const s=e.tabs.find(e=>e.id===n);s&&(s.isRunning=!0,s.error=null,s.results=null)});const a=performance.now();try{const l=await fetch("".concat(m.e,"/query"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({connection:t.connection,sql:t.sql,limit:1e3})}),i=await l.json(),o=Math.round(performance.now()-a);i.error?(e(e=>{const s=e.tabs.find(e=>e.id===n);s&&(s.isRunning=!1,s.error=i.error,s.executionTime=o)}),await s().saveToHistory({connection:t.connection,sql:t.sql,row_count:null,duration_ms:o,error:i.error})):(e(e=>{const s=e.tabs.find(e=>e.id===n);s&&(s.isRunning=!1,s.results={columns:i.columns,rows:i.rows||i.results},s.rowCount=i.row_count,s.executionTime=o,s.isDirty=!1)}),await s().saveToHistory({connection:t.connection,sql:t.sql,row_count:i.row_count,duration_ms:o,error:null}))}catch(l){const s=Math.round(performance.now()-a);e(e=>{const t=e.tabs.find(e=>e.id===n);t&&(t.isRunning=!1,t.error=l.message,t.executionTime=s)})}},fetchHistory:async function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(e=>{e.historyLoading=!0,e.historyError=null});try{const n=new URLSearchParams;s.limit&&n.set("limit",s.limit),s.offset&&n.set("offset",s.offset),s.connection&&n.set("connection",s.connection),s.search&&n.set("search",s.search);const t=await fetch("".concat(m.e,"/history?").concat(n)),a=await t.json();if(a.error)throw new Error(a.error);e(e=>{e.history=a.history,e.historyTotal=a.total,e.historyLoading=!1})}catch(n){e(e=>{e.historyError=n.message,e.historyLoading=!1})}},saveToHistory:async e=>{try{await fetch("".concat(m.e,"/history"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s().historyPanelOpen&&s().fetchHistory({limit:50})}catch(n){console.error("Failed to save history:",n)}},deleteHistoryEntry:async s=>{try{await fetch("".concat(m.e,"/history/").concat(s),{method:"DELETE"}),e(e=>{e.history=e.history.filter(e=>e.id!==s),e.historyTotal-=1})}catch(n){console.error("Failed to delete history:",n)}},loadFromHistory:s=>{e(e=>{const n=e.tabs.find(s=>s.id===e.activeTabId);n&&(n.sql=s.sql,n.connection=s.connection,n.isDirty=!0,n.results=null,n.error=null)})},setSchemaPanelWidth:s=>{e(e=>{e.schemaPanelWidth=s})},setResultsPanelHeight:s=>{e(e=>{e.resultsPanelHeight=s})},toggleHistoryPanel:()=>{e(e=>{e.historyPanelOpen=!e.historyPanelOpen,e.historyPanelOpen&&s().fetchHistory({limit:50})})}})),{name:"studio-query-storage",partialize:e=>({schemaPanelWidth:e.schemaPanelWidth,resultsPanelHeight:e.resultsPanelHeight,expandedNodes:e.expandedNodes}),onRehydrateStorage:()=>e=>{const s=localStorage.getItem("sql-query-storage"),n=localStorage.getItem("studio-query-storage");s&&!n&&(console.log("[Migration] Copying sql-query-storage \u2192 studio-query-storage"),localStorage.setItem("studio-query-storage",s))}}));var p=n(50717),x=n(70579);const v={VARCHAR:"#a78bfa",TEXT:"#a78bfa",CHAR:"#a78bfa",INTEGER:"#60a5fa",BIGINT:"#60a5fa",SMALLINT:"#60a5fa",INT:"#60a5fa",DOUBLE:"#2dd4bf",FLOAT:"#2dd4bf",DECIMAL:"#2dd4bf",NUMERIC:"#2dd4bf",BOOLEAN:"#fbbf24",BOOL:"#fbbf24",DATE:"#f472b6",TIMESTAMP:"#f472b6",TIME:"#f472b6",JSON:"#34d399",JSONB:"#34d399",BLOB:"#94a3b8",BINARY:"#94a3b8"};function g(e){var s;let{connection:n}=e;const{schemas:t,schemasLoading:a,schemasError:l,toggleNodeExpanded:i,fetchSchema:o,isNodeExpanded:r}=h(),d="conn_".concat(n.name),u=r(d),m=a[n.name],p=l[n.name],v=t[n.name];return(0,x.jsxs)("div",{className:"schema-tree-node",children:[(0,x.jsxs)("div",{className:"schema-tree-row schema-tree-connection",onClick:()=>{i(d),u||v||m||o(n.name)},children:[(0,x.jsx)(c.In,{icon:u?"mdi:chevron-down":"mdi:chevron-right",className:"schema-tree-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:database",className:"schema-tree-icon connection-icon"}),(0,x.jsx)("span",{className:"schema-tree-label",children:n.name}),(0,x.jsx)("span",{className:"schema-tree-badge",children:n.table_count})]}),u&&(0,x.jsxs)("div",{className:"schema-tree-children",children:[m&&(0,x.jsxs)("div",{className:"schema-tree-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin"}),(0,x.jsx)("span",{children:"Loading..."})]}),p&&(0,x.jsx)("div",{className:"schema-tree-error",children:p}),v&&(null===(s=v.schemas)||void 0===s?void 0:s.map(e=>(0,x.jsx)(j,{schema:e,connectionName:n.name},e.name)))]})]})}function j(e){var s,n;let{schema:t,connectionName:a}=e;const{toggleNodeExpanded:l,isNodeExpanded:i}=h(),o="schema_".concat(a,"_").concat(t.name),r=i(o);var d;return t.name!==a?(0,x.jsxs)("div",{className:"schema-tree-node",children:[(0,x.jsxs)("div",{className:"schema-tree-row schema-tree-schema",onClick:()=>l(o),children:[(0,x.jsx)(c.In,{icon:r?"mdi:chevron-down":"mdi:chevron-right",className:"schema-tree-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:folder",className:"schema-tree-icon schema-icon"}),(0,x.jsx)("span",{className:"schema-tree-label",children:t.name}),(0,x.jsx)("span",{className:"schema-tree-badge",children:(null===(s=t.tables)||void 0===s?void 0:s.length)||0})]}),r&&(0,x.jsx)("div",{className:"schema-tree-children",children:null===(n=t.tables)||void 0===n?void 0:n.map(e=>(0,x.jsx)(f,{table:e,connectionName:a,schemaName:t.name},e.name))})]}):(0,x.jsx)(x.Fragment,{children:null===(d=t.tables)||void 0===d?void 0:d.map(e=>(0,x.jsx)(f,{table:e,connectionName:a,schemaName:t.name},e.name))})}function f(e){let{table:s,connectionName:n,schemaName:t}=e;const{toggleNodeExpanded:a,isNodeExpanded:l,updateTab:i,activeTabId:o}=h(),r="table_".concat(n,"_").concat(t,"_").concat(s.name),d=l(r),u=e=>{const s=h.getState(),n=s.tabs.find(e=>e.id===s.activeTabId);if(n){const s=n.sql||"",t=s+(s&&!s.endsWith(" ")?" ":"")+e;i(o,{sql:t})}};return(0,x.jsxs)("div",{className:"schema-tree-node",children:[(0,x.jsxs)("div",{className:"schema-tree-row schema-tree-table",onClick:()=>a(r),onDoubleClick:e=>{e.stopPropagation();const t=s.qualified_name||"".concat(n,".").concat(s.name);u(t)},title:"Double-click to insert table name",children:[(0,x.jsx)(c.In,{icon:d?"mdi:chevron-down":"mdi:chevron-right",className:"schema-tree-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:table",className:"schema-tree-icon table-icon"}),(0,x.jsx)("span",{className:"schema-tree-label",children:s.name}),(0,x.jsx)("span",{className:"schema-tree-row-count",children:(m=s.row_count,m>=1e6?"".concat((m/1e6).toFixed(1),"M"):m>=1e3?"".concat((m/1e3).toFixed(1),"K"):(null===m||void 0===m?void 0:m.toString())||"0")})]}),d&&s.columns&&(0,x.jsx)("div",{className:"schema-tree-children",children:s.columns.map(e=>(0,x.jsx)(y,{column:e,onInsert:u},e.name))})]});var m}function y(e){var s;let{column:n,onInsert:t}=e;const a=function(e){if(!e)return"#64748b";const s=e.toUpperCase().split("(")[0].trim();return v[s]||"#64748b"}(n.type),l=(null===(s=n.type)||void 0===s?void 0:s.split("(")[0])||"unknown";return(0,x.jsxs)("div",{className:"schema-tree-row schema-tree-column",onDoubleClick:e=>{e.stopPropagation(),t(n.name)},title:"".concat(n.type).concat(n.nullable?" (nullable)":"","\nDouble-click to insert"),children:[(0,x.jsx)(c.In,{icon:"mdi:minus",className:"schema-tree-chevron column-spacer"}),(0,x.jsx)(c.In,{icon:"mdi:alpha-c-box",className:"schema-tree-icon column-icon"}),(0,x.jsx)("span",{className:"schema-tree-label",children:n.name}),(0,x.jsx)("span",{className:"schema-tree-type",style:{color:a},children:l})]})}const b=function(){const{connections:e,connectionsLoading:s,connectionsError:n}=h();return s?(0,x.jsxs)("div",{className:"schema-tree-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin"}),(0,x.jsx)("span",{children:"Loading connections..."})]}):n?(0,x.jsx)("div",{className:"schema-tree-error",children:n}):0===e.length?(0,x.jsxs)("div",{className:"schema-tree-empty",children:["No SQL connections configured.",(0,x.jsx)("br",{}),"Run ",(0,x.jsx)("code",{children:"lars sql chart"})," to index schemas."]}):(0,x.jsx)("div",{className:"schema-tree",children:e.map(e=>(0,x.jsx)(g,{connection:e},e.name))})};const N=function(){const{tabs:e,activeTabId:s,setActiveTab:n,createTab:t,closeTab:a,connections:l,updateTab:i,executeQuery:o,toggleHistoryPanel:r,historyPanelOpen:d}=h(),u=e.find(e=>e.id===s),m=(s,n)=>{s.stopPropagation(),e.length>1&&a(n)};return(0,x.jsxs)("div",{className:"query-tab-manager",children:[(0,x.jsxs)("div",{className:"query-tab-bar",children:[(0,x.jsx)("div",{className:"query-tabs",children:e.map(t=>(0,x.jsxs)("div",{className:"query-tab ".concat(t.id===s?"active":""," ").concat(t.isRunning?"running":""),onClick:()=>n(t.id),onMouseDown:e=>((e,s)=>{1===e.button&&(e.preventDefault(),m(e,s))})(e,t.id),children:[t.isDirty&&(0,x.jsx)("span",{className:"query-tab-dirty-indicator"}),t.isRunning&&(0,x.jsx)(c.In,{icon:"mdi:loading",className:"query-tab-spinner spin"}),(0,x.jsx)("span",{className:"query-tab-title",children:t.title}),e.length>1&&(0,x.jsx)("button",{className:"query-tab-close",onClick:e=>m(e,t.id),title:"Close tab",children:(0,x.jsx)(c.In,{icon:"mdi:close"})})]},t.id))}),(0,x.jsx)("button",{className:"query-tab-new",onClick:()=>t(),title:"New query tab",children:(0,x.jsx)(c.In,{icon:"mdi:plus"})})]}),(0,x.jsxs)("div",{className:"query-toolbar",children:[(0,x.jsx)("div",{className:"query-toolbar-left",children:(0,x.jsxs)("div",{className:"query-connection-selector",children:[(0,x.jsx)(c.In,{icon:"mdi:database",className:"query-connection-icon"}),(0,x.jsxs)("select",{value:(null===u||void 0===u?void 0:u.connection)||"",onChange:e=>{u&&i(u.id,{connection:e.target.value})},disabled:!l.length,children:[!l.length&&(0,x.jsx)("option",{value:"",children:"No connections"}),l.map(e=>(0,x.jsx)("option",{value:e.name,children:e.name},e.name))]})]})}),(0,x.jsxs)("div",{className:"query-toolbar-right",children:[null!==(null===u||void 0===u?void 0:u.executionTime)&&(0,x.jsxs)("span",{className:"query-stats",children:[null!==u.rowCount&&(0,x.jsxs)("span",{className:"query-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:table-row"}),u.rowCount," rows"]}),(0,x.jsxs)("span",{className:"query-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:timer-outline"}),u.executionTime,"ms"]})]}),(0,x.jsx)("button",{className:"query-toolbar-btn ".concat(d?"active":""),onClick:r,title:"Query history",children:(0,x.jsx)(c.In,{icon:"mdi:history"})}),(0,x.jsx)("button",{className:"query-execute-btn",onClick:()=>{u&&u.connection&&u.sql.trim()&&o(u.id)},disabled:!(null!==u&&void 0!==u&&u.connection)||!(null!==u&&void 0!==u&&u.sql.trim())||(null===u||void 0===u?void 0:u.isRunning),title:"Execute query (Ctrl+Enter)",children:null!==u&&void 0!==u&&u.isRunning?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin"}),"Running..."]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:play"}),"Run"]})})]})]})]})};var w=n(77158),S=n(64745);const k=function(){const e=(0,a.useRef)(null),s=(0,a.useRef)(null),{tabs:n,activeTabId:t,updateTab:l}=h(),i=n.find(e=>e.id===t),o=(0,a.useCallback)((n,t)=>{e.current=n,s.current=t,(0,S.JJ)(n,t),n.updateOptions({tabSize:2,insertSpaces:!0,detectIndentation:!1}),n.addCommand(t.KeyMod.CtrlCmd|t.KeyCode.Enter,()=>{const e=h.getState(),s=e.tabs.find(s=>s.id===e.activeTabId);s&&s.connection&&s.sql.trim()&&e.executeQuery(s.id)}),n.addCommand(t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.Enter,()=>{const e=n.getSelection(),s=n.getModel().getValueInRange(e);if(s.trim()){const e=h.getState(),n=e.tabs.find(s=>s.id===e.activeTabId);n&&n.connection&&(e.updateTab(n.id,{sql:s}),e.executeQuery(n.id))}}),c(t)},[]),c=(0,a.useCallback)(e=>{const s=["SELECT","FROM","WHERE","AND","OR","NOT","IN","LIKE","BETWEEN","ORDER BY","GROUP BY","HAVING","LIMIT","OFFSET","JOIN","LEFT JOIN","RIGHT JOIN","INNER JOIN","OUTER JOIN","ON","AS","DISTINCT","COUNT","SUM","AVG","MIN","MAX","CASE","WHEN","THEN","ELSE","END","NULL","IS NULL","IS NOT NULL","ASC","DESC","UNION","INTERSECT","EXCEPT","INSERT INTO","VALUES","UPDATE","SET","DELETE FROM","CREATE TABLE","DROP TABLE","ALTER TABLE","WITH","CTE"];e.languages.registerCompletionItemProvider("sql",{provideCompletionItems:(n,t)=>{const a=[];s.forEach(s=>{a.push({label:s,kind:e.languages.CompletionItemKind.Keyword,insertText:s,detail:"SQL keyword"})});const l=h.getState();return Object.values(l.schemas).forEach(s=>{var n;null===(n=s.schemas)||void 0===n||n.forEach(s=>{var n;null===(n=s.tables)||void 0===n||n.forEach(s=>{var n;a.push({label:s.qualified_name||s.name,kind:e.languages.CompletionItemKind.Class,insertText:s.qualified_name||s.name,detail:"Table (".concat(s.row_count||0," rows)")}),null===(n=s.columns)||void 0===n||n.forEach(s=>{a.push({label:s.name,kind:e.languages.CompletionItemKind.Field,insertText:s.name,detail:"Column (".concat(s.type,")")})})})})}),{suggestions:a}}})},[]),r=(0,a.useCallback)(e=>{i&&l(i.id,{sql:e})},[i,l]);return i?(0,x.jsx)("div",{className:"sql-editor",children:(0,x.jsx)(w.Ay,{height:"100%",language:"sql",theme:S.TH,value:i.sql,onChange:r,onMount:o,beforeMount:S.$B,options:{minimap:{enabled:!1},fontSize:14,fontFamily:"'Google Sans Code', 'Google Sans Code', 'Menlo', monospace",lineNumbers:"on",renderLineHighlight:"line",renderLineHighlightOnlyWhenFocus:!0,scrollBeyondLastLine:!1,wordWrap:"on",automaticLayout:!0,tabSize:2,insertSpaces:!0,folding:!0,bracketPairColorization:{enabled:!0},guides:{indentation:!0,bracketPairs:!0},padding:{top:12,bottom:12},smoothScrolling:!0,cursorBlinking:"smooth",cursorSmoothCaretAnimation:"on",suggestOnTriggerCharacters:!0,quickSuggestions:!0,parameterHints:{enabled:!0},formatOnPaste:!0}})}):(0,x.jsx)("div",{className:"sql-editor-empty",children:"No active query tab"})};var _=n(94424),C=n(87955);C.syG.registerModules([C.JKr]);const I=C.zl0.withParams({backgroundColor:"#000000",foregroundColor:"#cbd5e1",headerBackgroundColor:"#0a0510",headerTextColor:"#f0f4f8",oddRowBackgroundColor:"#050410",borderColor:"#1a1628",rowBorder:!0,wrapperBorder:!1,headerFontSize:12,headerFontWeight:600,fontFamily:"'Google Sans Code', 'Google Sans Code', monospace",fontSize:13,accentColor:"#00e5ff",chromeBackgroundColor:"#000000"});const A=function(){var e,s,n;const t=(0,a.useRef)(null),{tabs:l,activeTabId:i}=h(),o=l.find(e=>e.id===i),r=null===o||void 0===o?void 0:o.results,d=null===o||void 0===o?void 0:o.error,u=null===o||void 0===o?void 0:o.isRunning,m=(0,a.useMemo)(()=>null!==r&&void 0!==r&&r.columns?r.columns.map((e,s)=>({field:"col_".concat(s),headerName:e,sortable:!0,filter:!0,resizable:!0,minWidth:100,flex:1,cellRenderer:e=>{const s=e.value;return null===s||void 0===s?(0,x.jsx)("span",{className:"null-value",children:"NULL"}):"object"===typeof s?(0,x.jsx)("span",{className:"json-value",children:JSON.stringify(s)}):s}})):[],[null===r||void 0===r?void 0:r.columns]),p=(0,a.useMemo)(()=>null!==r&&void 0!==r&&r.rows&&null!==r&&void 0!==r&&r.columns?r.rows.map((e,s)=>{const n={_rowIndex:s};return r.columns.forEach((s,t)=>{n["col_".concat(t)]=e[s]}),n}):[],[r]),v=(0,a.useMemo)(()=>({sortable:!0,filter:!0,resizable:!0,minWidth:80}),[]),g=(0,a.useCallback)(()=>{var e;null!==(e=t.current)&&void 0!==e&&e.api&&t.current.api.exportDataAsCsv({fileName:"query_results_".concat((new Date).toISOString().slice(0,10),".csv")})},[]),j=(0,a.useCallback)(e=>{e.api.autoSizeAllColumns()},[]);return u?(0,x.jsx)("div",{className:"query-results-container",children:(0,x.jsxs)("div",{className:"query-results-status",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin"}),(0,x.jsx)("span",{children:"Executing query..."})]})}):d?(0,x.jsx)("div",{className:"query-results-container",children:(0,x.jsxs)("div",{className:"query-results-error",children:[(0,x.jsxs)("div",{className:"query-results-error-header",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle"}),(0,x.jsx)("span",{children:"Query Error"})]}),(0,x.jsx)("pre",{className:"query-results-error-message",children:d})]})}):r?0===(null===(e=r.rows)||void 0===e?void 0:e.length)?(0,x.jsxs)("div",{className:"query-results-container",children:[(0,x.jsx)("div",{className:"query-results-toolbar",children:(0,x.jsxs)("span",{className:"query-results-info",children:[(0,x.jsx)(c.In,{icon:"mdi:table"}),"0 rows returned"]})}),(0,x.jsxs)("div",{className:"query-results-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:table-off"}),(0,x.jsx)("span",{children:"Query returned no results"})]})]}):(0,x.jsxs)("div",{className:"query-results-container",children:[(0,x.jsxs)("div",{className:"query-results-toolbar",children:[(0,x.jsxs)("span",{className:"query-results-info",children:[(0,x.jsx)(c.In,{icon:"mdi:table-row"}),(null===(s=r.rows)||void 0===s?void 0:s.length)||0," rows",(null===(n=r.rows)||void 0===n?void 0:n.length)>=1e3&&(0,x.jsx)("span",{className:"query-results-truncated",children:"(limited)"})]}),(0,x.jsx)("div",{className:"query-results-actions",children:(0,x.jsxs)("button",{className:"query-results-export-btn",onClick:g,title:"Export to CSV",children:[(0,x.jsx)(c.In,{icon:"mdi:download"}),"Export CSV"]})})]}),(0,x.jsx)("div",{className:"query-results-grid",children:(0,x.jsx)(_.W6,{ref:t,rowData:p,columnDefs:m,defaultColDef:v,theme:I,animateRows:!1,onFirstDataRendered:j,enableCellTextSelection:!0,ensureDomOrder:!0,suppressRowClickSelection:!0,pagination:p.length>100,paginationPageSize:100,paginationPageSizeSelector:[50,100,500,1e3]})})]}):(0,x.jsx)("div",{className:"query-results-container",children:(0,x.jsxs)("div",{className:"query-results-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:database-search"}),(0,x.jsx)("span",{children:"Run a query to see results"}),(0,x.jsx)("span",{className:"query-results-hint",children:"Press Ctrl+Enter to execute"})]})})};function T(e){if(!e)return"";const s=new Date-new Date(e);if(s<0)return"just now";const n=Math.floor(s/1e3),t=Math.floor(n/60),a=Math.floor(t/60),l=Math.floor(a/24);return l>0?"".concat(l,"d ago"):a>0?"".concat(a,"h ago"):t>0?"".concat(t,"m ago"):"just now"}function E(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:80;if(!e)return"";const n=e.replace(/\s+/g," ").trim();return n.length<=s?n:n.slice(0,s)+"..."}const M=function(){const{history:e,historyTotal:s,historyLoading:n,historyError:t,fetchHistory:l,deleteHistoryEntry:i,loadFromHistory:o,toggleHistoryPanel:r}=h(),[d,u]=(0,a.useState)(""),[m,p]=(0,a.useState)(""),{connections:v}=h();return(0,a.useEffect)(()=>{l({limit:50})},[l]),(0,x.jsxs)("div",{className:"query-history-panel",children:[(0,x.jsxs)("div",{className:"query-history-header",children:[(0,x.jsxs)("span",{className:"query-history-title",children:[(0,x.jsx)(c.In,{icon:"mdi:history"}),"History"]}),(0,x.jsx)("button",{className:"query-history-close",onClick:r,title:"Close history panel",children:(0,x.jsx)(c.In,{icon:"mdi:close"})})]}),(0,x.jsxs)("form",{className:"query-history-filters",onSubmit:e=>{e.preventDefault(),l({limit:50,search:d||void 0,connection:m||void 0})},children:[(0,x.jsxs)("div",{className:"query-history-search",children:[(0,x.jsx)(c.In,{icon:"mdi:magnify",className:"search-icon"}),(0,x.jsx)("input",{type:"text",placeholder:"Search queries...",value:d,onChange:e=>u(e.target.value)})]}),(0,x.jsxs)("select",{value:m,onChange:e=>p(e.target.value),className:"query-history-connection-filter",children:[(0,x.jsx)("option",{value:"",children:"All connections"}),v.map(e=>(0,x.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,x.jsx)("button",{type:"submit",className:"query-history-search-btn",title:"Search",children:(0,x.jsx)(c.In,{icon:"mdi:magnify"})})]}),(0,x.jsxs)("div",{className:"query-history-count",children:[s," queries"]}),(0,x.jsxs)("div",{className:"query-history-list",children:[n&&(0,x.jsxs)("div",{className:"query-history-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin"}),"Loading..."]}),t&&(0,x.jsx)("div",{className:"query-history-error",children:t}),!n&&0===e.length&&(0,x.jsx)("div",{className:"query-history-empty",children:"No query history yet"}),e.map(e=>(0,x.jsxs)("div",{className:"query-history-item ".concat(e.error?"error":""),onClick:()=>(e=>{o(e)})(e),title:"Click to load this query",children:[(0,x.jsxs)("div",{className:"query-history-item-header",children:[(0,x.jsx)("span",{className:"query-history-item-connection",children:e.connection}),(0,x.jsx)("span",{className:"query-history-item-time",children:T(e.executed_at)})]}),(0,x.jsx)("div",{className:"query-history-item-sql",children:E(e.sql)}),(0,x.jsxs)("div",{className:"query-history-item-footer",children:[e.error?(0,x.jsxs)("span",{className:"query-history-item-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle"}),"Error"]}):(0,x.jsxs)("span",{className:"query-history-item-stats",children:[null!==e.row_count&&(0,x.jsxs)("span",{children:[e.row_count," rows"]}),null!==e.duration_ms&&(0,x.jsxs)("span",{children:[e.duration_ms,"ms"]})]}),(0,x.jsx)("button",{className:"query-history-item-delete",onClick:s=>((e,s)=>{e.stopPropagation(),window.confirm("Delete this query from history?")&&i(s)})(s,e.id),title:"Delete from history",children:(0,x.jsx)(c.In,{icon:"mdi:trash-can-outline"})})]})]},e.id))]})]})};var O=n(59570),L=n(38491),R=n(55661);const F=e=>{let{schema:s}=e;const{cascadeInputs:n,setCascadeInput:t,clearCascadeInputs:a}=(0,p.A)();if(!s||0===Object.keys(s).length)return null;const l=Object.entries(s),i=["#ffd700","#ffa94d","#ff9d76","#fb7185","#f472b6","#d4a8ff","#fde047","#a7f3d0"];return(0,x.jsxs)("div",{className:"inputs-form",children:[(0,x.jsxs)("div",{className:"inputs-form-header",children:[(0,x.jsx)("div",{className:"inputs-form-title-group",children:(0,x.jsx)("span",{className:"inputs-form-title",children:"PARAMETERS"})}),(0,x.jsx)("button",{className:"inputs-form-clear",onClick:a,title:"Clear all inputs",children:"Clear"})]}),(0,x.jsx)("div",{className:"inputs-form-fields",children:l.map((e,s)=>{let[a,l]=e;const o=i[s%i.length];return(0,x.jsxs)("div",{className:"inputs-form-field",children:[(0,x.jsxs)("label",{className:"inputs-form-label",htmlFor:"input-".concat(a),children:[(0,x.jsx)("span",{className:"inputs-form-name",children:a}),(0,x.jsx)("div",{className:"input-color-indicator",style:{backgroundColor:o},title:"Input parameter color (".concat(o,")")})]}),(0,x.jsx)("input",{id:"input-".concat(a),className:"inputs-form-input",type:"text",value:n[a]||"",onChange:e=>t(a,e.target.value),placeholder:l||"Enter ".concat(a,"...")})]},a)})})]})};var P=n(92254);const z={flagship:{icon:"mdi:star",color:"#a78bfa",label:"Flagship"},extended:{icon:"mdi:layers-triple",color:"#60a5fa",label:"Extended Context"},fast:{icon:"mdi:lightning-bolt",color:"#fbbf24",label:"Fast"},vision:{icon:"mdi:image-outline",color:"#34d399",label:"Vision"},reasoning:{icon:"mdi:brain",color:"#f472b6",label:"Reasoning"},free:{icon:"mdi:gift-outline",color:"#10b981",label:"Free"}};function D(e){var s,n,t,a,l,i;const o=[],c=(null===(s=e.name)||void 0===s?void 0:s.toLowerCase())||"",r=(null===(n=e.id)||void 0===n?void 0:n.toLowerCase())||"";return(r.includes("opus")||r.includes("gpt-4o")||r.includes("gemini-2.0-flash-thinking-exp")||r.includes("claude-3.7-sonnet"))&&o.push("flagship"),e.context_length>1e5&&o.push("extended"),(c.includes("flash")||c.includes("haiku")||c.includes("mini")||c.includes("fast"))&&o.push("fast"),(null!==(t=e.architecture)&&void 0!==t&&null!==(a=t.modality)&&void 0!==a&&a.includes("image->text")||c.includes("vision"))&&o.push("vision"),(c.includes("reasoning")||c.includes("thinking")||r.includes("o1")||r.includes("o3"))&&o.push("reasoning"),"0"!==(null===(l=e.pricing)||void 0===l?void 0:l.prompt)&&0!==parseFloat((null===(i=e.pricing)||void 0===i?void 0:i.prompt)||"1")||o.push("free"),o.length>0?o[0]:"fast"}function q(e){return e?e>=1e6?"".concat((e/1e6).toFixed(1),"M"):e>=1e3?"".concat(Math.floor(e/1e3),"K"):e.toString():"?"}function H(e){let{model:s}=e;const n=D(s),a=z[n]||z.fast,l=s.id.split("/"),o=(l[0],l.slice(1).join("/")||s.id),{attributes:r,listeners:d,setNodeRef:u,isDragging:m}=(0,i.PM)({id:"model-".concat(s.id),data:{type:"model",modelId:s.id}});return(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:u},d),r),{},{className:"model-pill model-pill-".concat(n," ").concat(m?"dragging":""),style:{borderColor:a.color+"34"},title:"".concat(s.name,"\nContext: ").concat(q(s.context_length),"\n").concat(s.id),children:[(0,x.jsx)(P.Ay,{modelId:s.id,size:12}),(0,x.jsx)(c.In,{icon:a.icon,width:"10",style:{color:a.color,opacity:.6}}),(0,x.jsx)("span",{className:"model-pill-name",style:{color:a.color},children:o}),(0,x.jsx)("span",{className:"model-pill-context",children:q(s.context_length)})]}))}function J(e){let{title:s,iconName:n,models:t,defaultOpen:l=!0}=e;const[i,o]=(0,a.useState)(l);return Array.isArray(t)&&0!==t.length?(0,x.jsxs)("div",{className:"model-group",children:[(0,x.jsxs)("div",{className:"model-group-header",onClick:()=>o(!i),children:[(0,x.jsx)(c.In,{icon:i?"mdi:chevron-down":"mdi:chevron-right",width:"12",className:"model-group-chevron"}),(0,x.jsx)(c.In,{icon:n,width:"12",className:"model-group-icon"}),(0,x.jsx)("span",{className:"model-group-title",children:s}),(0,x.jsx)("span",{className:"model-group-count",children:t.length})]}),i&&(0,x.jsx)("div",{className:"model-group-content",children:t.map(e=>(0,x.jsx)(H,{model:e},e.id))})]}):null}const W=function(){const[e,s]=(0,a.useState)([]),[n,l]=(0,a.useState)({}),[i,o]=(0,a.useState)([]),[r,d]=(0,a.useState)([]),[u,m]=(0,a.useState)(!0),[h,p]=(0,a.useState)(null),[v,g]=(0,a.useState)(""),[j,f]=(0,a.useState)("all"),[y,b]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-models-expanded");return null!==e&&"true"===e}catch(e){return!1}}),[N,w]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-ollama-expanded");return e?JSON.parse(e):{local:!0}}catch(e){return{local:!0}}}),[S,k]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-vertex-models-expanded");return null===e||"true"===e}catch(e){return!0}}),[_,C]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-bedrock-models-expanded");return null===e||"true"===e}catch(e){return!0}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-models-expanded",String(y))}catch(e){console.warn("Failed to save sidebar state:",e)}},[y]),(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-ollama-expanded",JSON.stringify(N))}catch(e){console.warn("Failed to save sidebar state:",e)}},[N]),(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-vertex-models-expanded",String(S))}catch(e){console.warn("Failed to save sidebar state:",e)}},[S]),(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-bedrock-models-expanded",String(_))}catch(e){console.warn("Failed to save sidebar state:",e)}},[_]),(0,a.useEffect)(()=>{let e=!0;return(async()=>{try{m(!0),p(null);const n=await fetch("/api/studio/models");if(!n.ok)throw new Error("HTTP ".concat(n.status,": ").concat(n.statusText));const t=await n.json();if(e){s(t.models||[]);const e=t.ollama_models;Array.isArray(e)?l({local:e}):l(e||{}),o(t.vertex_models||[]),d(t.bedrock_models||[]),m(!1)}}catch(n){e&&(p(n.message),m(!1))}})(),()=>{e=!1}},[]);const I=(0,a.useMemo)(()=>{let s=e;if(v.trim()){const e=v.toLowerCase();s=s.filter(s=>{var n;return s.id.toLowerCase().includes(e)||(null===(n=s.name)||void 0===n?void 0:n.toLowerCase().includes(e))})}return"all"!==j&&(s=s.filter(e=>[D(e)].includes(j))),s},[e,v,j]),A=(0,a.useMemo)(()=>{const e={};I.forEach(s=>{const n=s.id.split("/")[0]||"unknown";e[n]||(e[n]=[]),e[n].push(s)});const s=["anthropic","openai","google","x-ai","meta-llama"];return Object.keys(e).sort((e,n)=>{const t=s.indexOf(e),a=s.indexOf(n);return-1!==t&&-1!==a?t-a:-1!==t?-1:-1!==a?1:e.localeCompare(n)}).map(s=>({provider:s,models:e[s].sort((e,s)=>(s.context_length||0)-(e.context_length||0))}))},[I]),T=(0,a.useMemo)(()=>Object.keys(n).sort((e,s)=>"local"===e?-1:"local"===s?1:e.localeCompare(s)),[n]);return u?(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>b(!y),children:[(0,x.jsx)(c.In,{icon:y?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)("img",{src:"/openrouter.svg",alt:"OpenRouter",className:"nav-section-icon",style:{width:"14px",height:"14px",objectFit:"contain",opacity:.6}}),(0,x.jsx)("span",{className:"nav-section-title",children:"Models"})]}),y&&(0,x.jsxs)("div",{className:"model-browser-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spinning",width:"16"}),(0,x.jsx)("span",{children:"Loading models..."})]})]}):h?(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>b(!y),children:[(0,x.jsx)(c.In,{icon:y?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)("img",{src:"/openrouter.svg",alt:"OpenRouter",className:"nav-section-icon",style:{width:"14px",height:"14px",objectFit:"contain",opacity:.6}}),(0,x.jsx)("span",{className:"nav-section-title",children:"Models"})]}),y&&(0,x.jsxs)("div",{className:"model-browser-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"16"}),(0,x.jsx)("span",{children:h})]})]}):(0,x.jsxs)(x.Fragment,{children:[T.map(e=>{var s;const a=n[e]||[];if(0===a.length)return null;const l=null===(s=N[e])||void 0===s||s,i="local"===e,o=i?"Local Models":"Ollama (".concat(e,")"),r={width:"14px",height:"14px",objectFit:"contain",opacity:i?.6:.8};return(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>(e=>{w(s=>(0,t.A)((0,t.A)({},s),{},{[e]:!s[e]}))})(e),children:[(0,x.jsx)(c.In,{icon:l?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),i?(0,x.jsx)("img",{src:"/ollama_vector.svg",alt:"Ollama",className:"nav-section-icon",style:r}):(0,x.jsx)(c.In,{icon:"mdi:server-network",className:"nav-section-icon",style:(0,t.A)((0,t.A)({},r),{},{color:"#60a5fa"})}),(0,x.jsx)("span",{className:"nav-section-title",children:o}),(0,x.jsx)("span",{className:"nav-section-count",children:a.length})]}),l&&(0,x.jsx)("div",{className:"nav-section-content model-browser-content",children:(0,x.jsx)("div",{className:"model-groups-container",children:(0,x.jsx)(J,{title:i?"ollama":e,iconName:i?"mdi:chip":"mdi:server",models:a,defaultOpen:!0})})})]},e)}),i.length>0&&(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>k(!S),children:[(0,x.jsx)(c.In,{icon:S?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"simple-icons:googlecloud",className:"nav-section-icon",style:{width:"14px",height:"14px",color:"#4285f4",opacity:.7}}),(0,x.jsx)("span",{className:"nav-section-title",children:"Vertex AI"}),(0,x.jsx)("span",{className:"nav-section-count",children:i.length})]}),S&&(0,x.jsx)("div",{className:"nav-section-content model-browser-content",children:(0,x.jsx)("div",{className:"model-groups-container",children:(0,x.jsx)(J,{title:"gemini",iconName:"simple-icons:google",models:i,defaultOpen:!0})})})]}),r.length>0&&(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>C(!_),children:[(0,x.jsx)(c.In,{icon:_?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"simple-icons:amazonaws",className:"nav-section-icon",style:{width:"14px",height:"14px",color:"#ff9900",opacity:.7}}),(0,x.jsx)("span",{className:"nav-section-title",children:"Bedrock"}),(0,x.jsx)("span",{className:"nav-section-count",children:r.length})]}),_&&(0,x.jsx)("div",{className:"nav-section-content model-browser-content",children:(0,x.jsx)("div",{className:"model-groups-container",children:(0,x.jsx)(J,{title:"bedrock",iconName:"simple-icons:amazonaws",models:r,defaultOpen:!0})})})]}),(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>b(!y),children:[(0,x.jsx)(c.In,{icon:y?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)("img",{src:"/openrouter.svg",alt:"OpenRouter",className:"nav-section-icon",style:{width:"14px",height:"14px",objectFit:"contain",opacity:.6}}),(0,x.jsx)("span",{className:"nav-section-title",children:"Models"}),(0,x.jsx)("span",{className:"nav-section-count",children:I.length})]}),y&&(0,x.jsxs)("div",{className:"nav-section-content model-browser-content",children:[(0,x.jsxs)("div",{className:"model-search-bar",children:[(0,x.jsx)(c.In,{icon:"mdi:magnify",width:"14",className:"model-search-icon"}),(0,x.jsx)("input",{type:"text",placeholder:"Search models...",value:v,onChange:e=>g(e.target.value),className:"model-search-input"}),v&&(0,x.jsx)(c.In,{icon:"mdi:close",width:"14",className:"model-search-clear",onClick:()=>g("")})]}),(0,x.jsxs)("div",{className:"model-category-filters",children:[(0,x.jsx)("button",{className:"model-filter-btn ".concat("all"===j?"active":""),onClick:()=>f("all"),children:"All"}),Object.entries(z).map(e=>{let[s,n]=e;return(0,x.jsx)("button",{className:"model-filter-btn ".concat(j===s?"active":""),onClick:()=>f(s),title:n.label,children:(0,x.jsx)(c.In,{icon:n.icon,width:"12",style:{color:n.color}})},s)})]}),(0,x.jsxs)("div",{className:"model-groups-container",children:[0===A.length&&(0,x.jsxs)("div",{className:"model-browser-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:folder-open-outline",width:"24"}),(0,x.jsx)("span",{children:"No models found"})]}),A.map(e=>{let{provider:s,models:n}=e;return(0,x.jsx)(J,{title:s,iconName:"mdi:domain",models:n,defaultOpen:"anthropic"===s||"openai"===s},s)})]})]})]})]})};var B=n(89387);const U={function:{icon:"mdi:function-variant",color:"#60a5fa",label:"Function"},cascade:{icon:"mdi:water",color:"#a78bfa",label:"Cascade"},memory:{icon:"mdi:database-outline",color:"#34d399",label:"Memory"},validator:{icon:"mdi:shield-check",color:"#f472b6",label:"Validator"},hf_space:{icon:"mdi:cube-outline",color:"#fbbf24",label:"HF Space"},manifest:{icon:"mdi:auto-fix",color:"#ff006e",label:"Manifest (Auto)"}},K=a.memo(()=>{const e=U.manifest,{attributes:s,listeners:n,setNodeRef:a,isDragging:l}=(0,i.PM)({id:"skill-manifest",data:{type:"tool",toolId:"manifest",toolType:"manifest"}});return(0,x.jsx)(B.m_,{label:"manifest (Quartermaster)",description:"Magic skill that analyzes your cell's instructions and conversation context to automatically inject the most relevant tools. The Quartermaster intelligently selects tools based on what the LLM is trying to accomplish.",placement:"right",children:(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:a},n),s),{},{className:"model-pill model-pill-manifest ".concat(l?"dragging":""),style:{borderColor:e.color+"44",background:"linear-gradient(135deg, rgba(255, 0, 110, 0.08), rgba(167, 139, 250, 0.08))",borderWidth:"1.5px"},children:[(0,x.jsx)(c.In,{icon:e.icon,width:"14",style:{color:e.color,opacity:.9}}),(0,x.jsx)("span",{className:"model-pill-name",style:{color:e.color,fontWeight:600},children:"manifest"}),(0,x.jsx)("span",{className:"model-pill-context",style:{fontSize:"8px",color:e.color,opacity:.7,fontWeight:500,textTransform:"uppercase",letterSpacing:"0.5px"},children:"AUTO"})]}))})});function V(e){let{tool:s,isHfSpace:n=!1}=e;const a=n?"hf_space":s.type,l=U[a]||U.function,o=s.name,r=n?s.id:s.name,{attributes:d,listeners:u,setNodeRef:m,isDragging:h}=(0,i.PM)({id:"skill-".concat(r),data:{type:"tool",toolId:r,toolType:a}});let p,v;n?(p="".concat(s.author,"/").concat(s.name),v="HuggingFace Space \u2022 SDK: ".concat(s.sdk||"unknown"," \u2022 Status: ").concat(s.status||"unknown")):(p=o,v=s.description||"No description available");const g=n?"RUNNING"===s.status?"#34d399":"SLEEPING"===s.status?"#fbbf24":"PAUSED"===s.status?"#94a3b8":"#f87171":null;return(0,x.jsx)(B.m_,{label:p,description:v,placement:"right",children:(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:m},u),d),{},{className:"model-pill model-pill-".concat(a," ").concat(h?"dragging":""),style:{borderColor:l.color+"34"},children:[(0,x.jsx)(c.In,{icon:l.icon,width:"12",style:{color:l.color,opacity:.8}}),(0,x.jsx)("span",{className:"model-pill-name",style:{color:l.color},children:o}),n&&(0,x.jsx)("span",{className:"model-pill-context",style:{fontSize:"9px",opacity:.7,color:g,fontWeight:"RUNNING"===s.status?"600":"400"},children:s.status||"?"})]}))})}function $(e){let{title:s,iconName:n,iconImage:t,tools:l,isHfSpace:i=!1,defaultOpen:o=!0}=e;const[r,d]=(0,a.useState)(o);return 0===l.length?null:(0,x.jsxs)("div",{className:"model-group",children:[(0,x.jsxs)("div",{className:"model-group-header",onClick:()=>d(!r),children:[(0,x.jsx)(c.In,{icon:r?"mdi:chevron-down":"mdi:chevron-right",width:"12",className:"model-group-chevron"}),t?(0,x.jsx)("img",{src:t,alt:s,className:"model-group-icon",style:{width:"12px",height:"12px",objectFit:"contain",opacity:.6}}):(0,x.jsx)(c.In,{icon:n,width:"12",className:"model-group-icon"}),(0,x.jsx)("span",{className:"model-group-title",children:s}),(0,x.jsx)("span",{className:"model-group-count",children:l.length})]}),r&&(0,x.jsx)("div",{className:"model-group-content",children:l.map(e=>(0,x.jsx)(V,{tool:e,isHfSpace:i},i?e.id:e.name))})]})}K.displayName="ManifestPill";const G=function(){const[e,s]=(0,a.useState)([]),[n,t]=(0,a.useState)([]),[l,i]=(0,a.useState)(!0),[o,r]=(0,a.useState)(null),[d,u]=(0,a.useState)(""),[m,h]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-skills-expanded");return null!==e&&"true"===e}catch(e){return!1}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-skills-expanded",String(m))}catch(e){console.warn("Failed to save sidebar state:",e)}},[m]),(0,a.useEffect)(()=>{let e=!0;return(async()=>{try{i(!0),r(null);const n=await fetch("/api/studio/tools");if(!n.ok)throw new Error("HTTP ".concat(n.status,": ").concat(n.statusText));const a=await n.json();e&&(s(a.tools||[]),t(a.hf_spaces||[]),i(!1))}catch(n){e&&(r(n.message),i(!1))}})(),()=>{e=!1}},[]);const p=(0,a.useMemo)(()=>{let s=e;if(d.trim()){const e=d.toLowerCase();s=s.filter(s=>{var n;return s.name.toLowerCase().includes(e)||(null===(n=s.description)||void 0===n?void 0:n.toLowerCase().includes(e))})}return s},[e,d]),v=(0,a.useMemo)(()=>{let e=n;if(d.trim()){const s=d.toLowerCase();e=e.filter(e=>e.id.toLowerCase().includes(s)||e.name.toLowerCase().includes(s)||e.author.toLowerCase().includes(s))}return e},[n,d]),g=(0,a.useMemo)(()=>{const e={};p.forEach(s=>{const n=s.type||"function";e[n]||(e[n]=[]),e[n].push(s)});const s=["function","cascade","memory","validator"];return Object.keys(e).sort((e,n)=>{const t=s.indexOf(e),a=s.indexOf(n);return-1!==t&&-1!==a?t-a:-1!==t?-1:-1!==a?1:e.localeCompare(n)}).map(s=>({type:s,tools:e[s].sort((e,s)=>e.name.localeCompare(s.name))}))},[p]);if(l)return(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>h(!m),children:[(0,x.jsx)(c.In,{icon:m?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:rabbit",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Skills"})]}),m&&(0,x.jsxs)("div",{className:"model-browser-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spinning",width:"16"}),(0,x.jsx)("span",{children:"Loading skills..."})]})]});if(o)return(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>h(!m),children:[(0,x.jsx)(c.In,{icon:m?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:rabbit",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Skills"})]}),m&&(0,x.jsxs)("div",{className:"model-browser-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"16"}),(0,x.jsx)("span",{children:o})]})]});const j=p.length+v.length+1;return(0,x.jsxs)("div",{className:"nav-section model-browser-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>h(!m),children:[(0,x.jsx)(c.In,{icon:m?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:rabbit",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Skills"}),(0,x.jsx)("span",{className:"nav-section-count",children:j})]}),m&&(0,x.jsxs)("div",{className:"nav-section-content model-browser-content",children:[(0,x.jsxs)("div",{className:"model-search-bar",children:[(0,x.jsx)(c.In,{icon:"mdi:magnify",width:"14",className:"model-search-icon"}),(0,x.jsx)("input",{type:"text",placeholder:"Search skills...",value:d,onChange:e=>u(e.target.value),className:"model-search-input"}),d&&(0,x.jsx)(c.In,{icon:"mdi:close",width:"14",className:"model-search-clear",onClick:()=>u("")})]}),(0,x.jsxs)("div",{className:"model-groups-container",children:[!d&&(0,x.jsx)("div",{style:{padding:"8px 8px 12px",borderBottom:"1px solid rgba(26, 22, 40, 0.5)"},children:(0,x.jsx)(K,{})}),0===g.length&&0===v.length&&d&&(0,x.jsxs)("div",{className:"model-browser-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:folder-open-outline",width:"24"}),(0,x.jsx)("span",{children:"No skills found"})]}),g.map(e=>{var s,n;let{type:t,tools:a}=e;return(0,x.jsx)($,{title:(null===(s=U[t])||void 0===s?void 0:s.label)||t,iconName:(null===(n=U[t])||void 0===n?void 0:n.icon)||"mdi:function-variant",tools:a,defaultOpen:"function"===t},t)}),v.length>0&&(0,x.jsx)($,{title:"HuggingFace Spaces",iconImage:"/huggingface_logo-noborder_greyscale.svg",tools:v,isHfSpace:!0,defaultOpen:!1})]})]})]})},Y={input:{icon:"mdi:import",color:"#a78bfa",label:"Input"},output:{icon:"mdi:export-variant",color:"#60a5fa",label:"Output"},state:{icon:"mdi:database-outline",color:"#34d399",label:"State"},builtin:{icon:"mdi:cog-outline",color:"#fbbf24",label:"Built-in"}},Q=[{path:"lineage",description:"Execution path through cells"},{path:"history",description:"Full conversation history"},{path:"take_index",description:"Current take index (0, 1, 2...)"},{path:"take_factor",description:"Total number of takes"},{path:"is_take",description:"True when running as take"}];function X(e){let{variable:s}=e;const n=(a=s.path).startsWith("input.")?"input":a.startsWith("outputs.")?"output":a.startsWith("state.")?"state":"builtin";var a;const l=Y[n],o=s.path.replace(/^input\./,"").replace(/^outputs\./,"").replace(/^state\./,""),{attributes:r,listeners:d,setNodeRef:u,isDragging:m}=(0,i.PM)({id:"variable-".concat(s.path),data:{type:"variable",variablePath:s.path}});return(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:u},d),r),{},{className:"var-pill var-pill-".concat(n," ").concat(m?"dragging":""),style:{borderColor:l.color+34},title:s.description||"{{ ".concat(s.path," }}"),children:[(0,x.jsx)(c.In,{icon:l.icon,width:"12",style:{color:l.color}}),(0,x.jsx)("span",{style:{color:l.color},children:o})]}))}function Z(e){let{title:s,iconName:n,variables:t,defaultOpen:l=!0}=e;const[i,o]=(0,a.useState)(l);return 0===t.length?null:(0,x.jsxs)("div",{className:"var-group",children:[(0,x.jsxs)("div",{className:"var-group-header",onClick:()=>o(!i),children:[(0,x.jsx)(c.In,{icon:i?"mdi:chevron-down":"mdi:chevron-right",width:"12",className:"var-group-chevron"}),(0,x.jsx)(c.In,{icon:n,width:"12",className:"var-group-icon"}),(0,x.jsx)("span",{className:"var-group-title",children:s}),(0,x.jsx)("span",{className:"var-group-count",children:t.length})]}),i&&(0,x.jsx)("div",{className:"var-group-content",children:t.map(e=>(0,x.jsx)(X,{variable:e},e.path))})]})}const ee=function(){const{cascade:e}=(0,p.A)(),[s,n]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-variables-expanded");return null!==e&&"true"===e}catch(e){return!1}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-variables-expanded",String(s))}catch(e){console.warn("Failed to save sidebar state:",e)}},[s]);const t=(0,a.useMemo)(()=>{var s;const n=[];if(!e)return n;e.inputs_schema&&Object.entries(e.inputs_schema).forEach(e=>{let[s,t]=e;n.push({path:"input.".concat(s),description:"string"===typeof t?t:"Input: ".concat(s)})}),e.cells&&e.cells.forEach(e=>{e.name&&n.push({path:"outputs.".concat(e.name),description:'Output from cell "'.concat(e.name,'"')})});const t=new Set,a=/state\.(\w+)/g;return null===(s=e.cells)||void 0===s||s.forEach(e=>{var s,n;const l=(null===(s=e.inputs)||void 0===s?void 0:s.code)||(null===(n=e.inputs)||void 0===n?void 0:n.query)||e.instructions||"";let i;for(;null!==(i=a.exec(l));)t.add(i[1])}),t.forEach(e=>{n.push({path:"state.".concat(e),description:"State variable: ".concat(e)})}),Q.forEach(e=>{n.push(e)}),n},[e]),l=(0,a.useMemo)(()=>({input:t.filter(e=>e.path.startsWith("input.")),output:t.filter(e=>e.path.startsWith("outputs.")),state:t.filter(e=>e.path.startsWith("state.")),builtin:t.filter(e=>!e.path.startsWith("input.")&&!e.path.startsWith("outputs.")&&!e.path.startsWith("state."))}),[t]);return 0===t.length?null:(0,x.jsxs)("div",{className:"nav-section var-palette-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>n(!s),children:[(0,x.jsx)(c.In,{icon:s?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:code-braces",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Variables"}),(0,x.jsx)("span",{className:"nav-section-count",children:t.length})]}),s&&(0,x.jsxs)("div",{className:"nav-section-content var-palette-content",children:[(0,x.jsx)(Z,{title:"Inputs",iconName:"mdi:import",variables:l.input}),(0,x.jsx)(Z,{title:"Previous Cells",iconName:"mdi:export-variant",variables:l.output}),(0,x.jsx)(Z,{title:"State",iconName:"mdi:database-outline",variables:l.state}),(0,x.jsx)(Z,{title:"Built-ins",iconName:"mdi:cog-outline",variables:l.builtin,defaultOpen:!1})]})]})};const se=function(){const{cascade:e,viewMode:s,replaySessionId:n,setReplayMode:t,setLiveMode:l}=(0,p.A)(),[i,o]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-recent-runs-expanded");return null!==e&&"true"===e}catch(e){return!1}}),[r,d]=(0,a.useState)([]);(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-recent-runs-expanded",String(i))}catch(e){console.warn("Failed to save sidebar state:",e)}},[i]);const[u,h]=(0,a.useState)(!1),[,v]=(0,a.useState)(0);if((0,a.useEffect)(()=>{if(!i||0===r.length)return;const e=setInterval(()=>{v(e=>e+1)},6e4);return()=>clearInterval(e)},[i,r.length]),(0,a.useEffect)(()=>{if(!i||null===e||void 0===e||!e.cascade_id)return;(async()=>{h(!0);try{const s=await fetch("".concat(m.J,"/api/sessions?cascade_id=").concat(encodeURIComponent(e.cascade_id),"&limit=20")),n=await s.json();if(n.error)return void console.error("[RecentRuns] Error:",n.error);d(n.sessions||[])}catch(s){console.error("[RecentRuns] Fetch error:",s)}finally{h(!1)}})()},[i,null===e||void 0===e?void 0:e.cascade_id]),!e)return null;const g=e=>{if(!e)return"";let s=e;"string"!==typeof e||e.endsWith("Z")||e.includes("+")||(s=e+"Z");const n=new Date(s),t=new Date-n,a=Math.floor(t/6e4);return a<1?"just now":a<60?"".concat(a,"m ago"):a<1440?"".concat(Math.floor(a/60),"h ago"):a<10080?"".concat(Math.floor(a/1440),"d ago"):n.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},j=e=>{if(!e)return"";const s=Math.round(e/1e3);return s<60?"".concat(s,"s"):"".concat(Math.floor(s/60),"m ").concat(s%60,"s")};return(0,x.jsxs)("div",{className:"nav-section recent-runs-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>o(!i),children:[(0,x.jsx)(c.In,{icon:i?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:history",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Recent Runs"})]}),i&&(0,x.jsx)("div",{className:"nav-section-content recent-runs-content",children:u?(0,x.jsx)("div",{className:"recent-runs-loading",children:"Loading..."}):0===r.length?(0,x.jsx)("div",{className:"recent-runs-empty",children:"No recent runs"}):(0,x.jsxs)(x.Fragment,{children:["live"===s&&(0,x.jsxs)("div",{className:"recent-run-item recent-run-live",children:[(0,x.jsxs)("div",{className:"recent-run-status",children:[(0,x.jsx)("span",{className:"recent-run-live-dot"}),(0,x.jsx)("span",{className:"recent-run-label",children:"Live"})]}),(0,x.jsx)("div",{className:"recent-run-meta",children:"Current session"})]}),r.map(e=>{const a=(e=>{const s=e.total_cost||0,n=e.cluster_avg_cost||0;if(!n||0===n||0===s)return null;const t=s/n;return t>=1.5?{text:"".concat(t.toFixed(1),"x avg"),color:"#f87171"}:t>=1.2?{text:"".concat(t.toFixed(1),"x avg"),color:"#fbbf24"}:t<=.7?{text:"".concat(t.toFixed(1),"x avg"),color:"#34d399"}:null})(e),i=(e=>e.is_cost_outlier||e.is_duration_outlier)(e);return(0,x.jsx)("button",{className:"recent-run-item ".concat("replay"===s&&n===e.session_id?"recent-run-active":""),onClick:()=>(async e=>{"replay"===s&&n===e.session_id?l():(console.log("[RecentRuns] Loading replay session:",e.session_id),await t(e.session_id),console.log("[RecentRuns] Replay mode activated"))})(e),title:e.session_id,children:(0,x.jsxs)("div",{className:"recent-run-status",children:[(0,x.jsxs)("div",{style:{position:"relative"},children:[(0,x.jsx)(c.In,{icon:"error"===e.status?"mdi:alert-circle":"mdi:check-circle",className:"recent-run-icon ".concat("error"===e.status?"recent-run-error":"recent-run-success")}),i&&(0,x.jsx)("span",{style:{position:"absolute",top:"-2px",right:"-2px",width:"6px",height:"6px",borderRadius:"50%",background:"#f87171",border:"1px solid #0a0a0a"},title:"Statistical outlier"})]}),(0,x.jsxs)("div",{style:{display:"flex",flexDirection:"column",flex:1,gap:"2px"},children:[(0,x.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px"},children:[(0,x.jsx)("span",{className:"recent-run-label",children:g(e.started_at)}),(0,x.jsx)("span",{style:{fontSize:"10px",color:"rgba(255,255,255,0.4)",fontFamily:"monospace"},children:e.session_id})]}),(0,x.jsxs)("div",{className:"recent-run-meta",style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,x.jsx)("span",{children:j(e.duration_ms)}),(0,x.jsxs)("span",{style:{display:"flex",alignItems:"center",gap:"4px",textAlign:"right"},children:[e.context_cost_pct>40&&(0,x.jsxs)("span",{style:{fontSize:"9px",color:"#fbbf24"},title:"".concat(e.context_cost_pct.toFixed(0),"% of cost from context injection"),children:[e.context_cost_pct.toFixed(0),"% ctx"]}),e.total_cost>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("span",{className:"recent-run-cost",children:(o=e.total_cost,o&&0!==o?o<.01?"<$0.01":"$".concat(o.toFixed(2)):"$0.00")}),a&&(0,x.jsxs)("span",{style:{fontSize:"9px",color:a.color},children:["(",a.text,")"]})]})]})]})]})]})},e.session_id);var o})]})})]})};const ne=function(e){let{sessionId:s,isRunning:n}=e;const[t,l]=(0,a.useState)(null),[i,o]=(0,a.useState)(!1),[r,d]=(0,a.useState)(null),[u,h]=(0,a.useState)(new Set),[p,v]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-session-state-expanded");return null===e||"true"===e}catch(e){return!0}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-session-state-expanded",String(p))}catch(e){console.warn("Failed to save sidebar state:",e)}},[p]);const g=(0,a.useCallback)(async()=>{if(s)try{const e=await fetch("".concat(m.J,"/api/studio/session-state/").concat(s)),n=await e.json();if(n.error)return void d(n.error);l(n),d(null)}catch(e){console.error("[SessionStatePanel] Fetch error:",e),d(e.message)}},[s]);(0,a.useEffect)(()=>{s&&(o(!0),g().finally(()=>o(!1)))},[s,g]),(0,a.useEffect)(()=>{if(!n||!s)return;const e=setInterval(g,1e3);return()=>clearInterval(e)},[n,s,g]);const j=e=>{const{value_parsed:s,value_type:n}=e;if("string"===n)return(0,x.jsxs)("span",{className:"state-value state-value-string",children:['"',s,'"']});if("number"===n)return(0,x.jsx)("span",{className:"state-value state-value-number",children:s});if("boolean"===n)return(0,x.jsx)("span",{className:"state-value state-value-boolean",children:s?"true":"false"});if("null"===n)return(0,x.jsx)("span",{className:"state-value state-value-null",children:"null"});if("object"===n||"array"===n){const e="object"===n?"{".concat(Object.keys(s||{}).length," keys}"):"[".concat((s||[]).length," items]");return(0,x.jsx)("span",{className:"state-value state-value-complex",children:e})}return(0,x.jsx)("span",{className:"state-value",children:String(s)})},f=e=>{if(!e)return"";const s=new Date(e+"Z"),n=new Date-s,t=Math.floor(n/1e3);if(t<5)return"just now";if(t<60)return"".concat(t,"s ago");const a=Math.floor(t/60);return a<60?"".concat(a,"m ago"):s.toLocaleTimeString()};if((!t||!t.state_by_key||0===Object.keys(t.state_by_key).length)&&!i&&!r)return null;const y=null!==t&&void 0!==t&&t.state_by_key?Object.keys(t.state_by_key).length:0;return(0,x.jsxs)("div",{className:"nav-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>v(!p),children:[(0,x.jsx)(c.In,{icon:p?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:database-outline",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Session State"}),y>0&&(0,x.jsx)("span",{className:"nav-section-count",children:y}),n&&(0,x.jsx)("span",{className:"state-live-indicator",title:"Updating live",children:"\u25cf"})]}),p&&(0,x.jsxs)("div",{className:"nav-section-content",children:[i&&!t&&(0,x.jsx)("div",{className:"state-loading",children:"Loading..."}),r&&(0,x.jsx)("div",{className:"state-error",children:r}),t&&t.state_by_key&&Object.keys(t.state_by_key).length>0&&(0,x.jsx)("div",{className:"state-list",children:Object.entries(t.state_by_key).map(e=>{let[s,n]=e;const t=n[0],a=u.has(s),l=n.length>1,i="object"===t.value_type||"array"===t.value_type;return(0,x.jsxs)("div",{className:"state-item",children:[(0,x.jsxs)("div",{className:"state-item-header",children:[(0,x.jsxs)("div",{className:"state-key-row",children:[(0,x.jsx)(c.In,{icon:i?"mdi:code-braces":"mdi:key-variant",width:"14",className:"state-icon"}),(0,x.jsx)("span",{className:"state-key",children:s}),(0,x.jsx)("span",{className:"state-type-badge",children:t.value_type})]}),(0,x.jsxs)("div",{className:"state-meta",children:[(0,x.jsx)("span",{className:"state-cell",children:t.cell_name}),(0,x.jsx)("span",{className:"state-time",children:f(t.created_at)})]})]}),(0,x.jsx)("div",{className:"state-value-row",children:j(t)}),(i||l)&&(0,x.jsxs)("button",{className:"state-expand-btn",onClick:()=>(e=>{h(s=>{const n=new Set(s);return n.has(e)?n.delete(e):n.add(e),n})})(s),title:a?"Collapse":"Expand",children:[(0,x.jsx)(c.In,{icon:a?"mdi:chevron-up":"mdi:chevron-down",width:"16"}),l&&(0,x.jsxs)("span",{className:"state-history-count",children:[n.length," updates"]})]}),a&&(0,x.jsxs)("div",{className:"state-expanded",children:[i&&(0,x.jsx)("pre",{className:"state-json",children:JSON.stringify(t.value_parsed,null,2)}),l&&(0,x.jsxs)("div",{className:"state-history",children:[(0,x.jsx)("div",{className:"state-history-header",children:"Update History:"}),n.map((e,s)=>(0,x.jsxs)("div",{className:"state-history-item",children:[(0,x.jsx)("span",{className:"state-history-time",children:f(e.created_at)}),(0,x.jsx)("span",{className:"state-history-cell",children:e.cell_name}),"string"===e.value_type&&(0,x.jsxs)("span",{className:"state-history-value",children:['"',e.value_parsed,'"']}),"string"!==e.value_type&&(0,x.jsx)("span",{className:"state-history-value",children:JSON.stringify(e.value_parsed)})]},s))]})]})]},s)})})]})]})};const te=function(e){let{value:s,onChange:n,onFocus:t,onBlur:l,onValidationError:i,readOnly:o=!1}=e;const r=(0,a.useRef)(null),d=(0,a.useRef)(null),u=(0,a.useCallback)((e,s)=>{r.current=e,d.current=s,window.__activeMonacoEditor=e,(0,S.JJ)(e,s),e.updateOptions({tabSize:2,insertSpaces:!0,detectIndentation:!1}),e.onDidFocusEditorText(()=>{window.__activeMonacoEditor=e,t&&t()}),e.onDidBlurEditorText(()=>{if(l){const s=e.getValue();l(s)}}),e.addCommand(s.KeyMod.CtrlCmd|s.KeyCode.KeyS,()=>{const s=e.getValue();null===n||void 0===n||n(s)})},[n,t,l]),m=(0,a.useCallback)(e=>{null===n||void 0===n||n(e)},[n]),h={minimap:{enabled:!1},fontSize:12,fontFamily:"'Google Sans Code', 'Menlo', monospace",lineNumbers:"off",renderLineHighlight:"line",renderLineHighlightOnlyWhenFocus:!0,scrollBeyondLastLine:!1,wordWrap:"on",wrappingStrategy:"advanced",automaticLayout:!0,tabSize:2,insertSpaces:!0,folding:!0,foldingStrategy:"indentation",showFoldingControls:"mouseover",bracketPairColorization:{enabled:!0},guides:{indentation:!0,bracketPairs:!0},padding:{top:12,bottom:12},smoothScrolling:!0,cursorBlinking:"smooth",cursorSmoothCaretAnimation:"on",readOnly:o};return(0,x.jsx)("div",{className:"monaco-yaml-editor",children:(0,x.jsx)("div",{className:"editor-container",children:(0,x.jsx)(w.Ay,{height:"100%",defaultLanguage:"yaml",value:s,onChange:m,onMount:u,beforeMount:S.$B,theme:S.TH,options:h,loading:(0,x.jsxs)("div",{className:"editor-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",width:"24",className:"spin"}),(0,x.jsx)("span",{children:"Loading editor..."})]})})})})};var ae=n(64065),le=n(93436),ie=n(60957);const oe={VARCHAR:"#a78bfa",TEXT:"#a78bfa",STRING:"#a78bfa",CHAR:"#a78bfa",INTEGER:"#60a5fa",BIGINT:"#60a5fa",SMALLINT:"#60a5fa",INT:"#60a5fa",INT64:"#60a5fa",DOUBLE:"#2dd4bf",FLOAT:"#2dd4bf",FLOAT64:"#2dd4bf",DECIMAL:"#2dd4bf",NUMERIC:"#2dd4bf",BOOLEAN:"#fbbf24",BOOL:"#fbbf24",DATE:"#f472b6",TIMESTAMP:"#f472b6",DATETIME:"#f472b6",TIME:"#f472b6",JSON:"#34d399",JSONB:"#34d399",OBJECT:"#34d399",DICT:"#34d399",BLOB:"#94a3b8",BINARY:"#94a3b8"};function ce(e){if(!e)return"#64748b";const s=e.toUpperCase().split("(")[0].trim();return oe[s]||"#64748b"}function re(e){return null===e||void 0===e?"NULL":"number"===typeof e?Number.isInteger(e)?"INTEGER":"FLOAT":"boolean"===typeof e?"BOOLEAN":"object"===typeof e?"OBJECT":"STRING"}function de(e){let{status:s}=e;const n={pending:{icon:"mdi:clock-outline",color:"#64748b",label:"Pending"},running:{icon:"mdi:loading",color:"#fbbf24",label:"Running",spin:!0},success:{icon:"mdi:check-circle",color:"#34d399",label:"Success"},error:{icon:"mdi:alert-circle",color:"#f87171",label:"Error"},stale:{icon:"mdi:clock-alert-outline",color:"#fb923c",label:"Stale - needs re-run"}},{icon:t,color:a,label:l,spin:i}=n[s]||n.pending;return(0,x.jsx)(B.m_,{label:l,children:(0,x.jsx)("span",{className:"cell-status-icon-wrapper",children:(0,x.jsx)(c.In,{icon:t,className:"cell-status-icon ".concat(i?"spin":""),style:{color:a}})})})}function ue(e){if(!e&&0!==e)return null;const s=Math.round(e);return s<1e3?"".concat(s,"ms"):s<6e4?"".concat((s/1e3).toFixed(1),"s"):"".concat((s/6e4).toFixed(1),"m")}function me(e){var s,n;let{cell:t,index:l,cellState:i,isActive:o,onNavigate:r,cost:d=0,costBarWidth:u=0,analytics:m=null}=e;const[h,p]=(0,a.useState)(!1),v=(null===i||void 0===i?void 0:i.status)||"pending",g=null===i||void 0===i?void 0:i.result,j=null===i||void 0===i?void 0:i.duration,f=g&&(g.rows||g.columns||g.result),y=(null===g||void 0===g?void 0:g.row_count)||(null===g||void 0===g||null===(s=g.rows)||void 0===s?void 0:s.length)||0,b=(null===g||void 0===g?void 0:g.columns)||[],N=(null===g||void 0===g?void 0:g.rows)||[],w=(null===m||void 0===m?void 0:m.species_avg_cost)||0,S=(null===m||void 0===m?void 0:m.cell_cost_pct)||0,k=(null===m||void 0===m?void 0:m.is_cost_outlier)||!1,_=w>0&&d>0?d/w:null,C=0===d?null:k||_&&_>=1.5?"red":_&&_>=1.2?"orange":_&&_<=.7?"green":S>50?"orange":"cyan",I=b.map(e=>{let s="unknown";return N.length>0&&void 0!==N[0][e]&&(s=re(N[0][e])),{name:e,type:s}}),A="dict"===(null===g||void 0===g?void 0:g.type)&&null!==g&&void 0!==g&&g.result?Object.keys(g.result).map(e=>({name:e,type:re(g.result[e])})):[],T=I.length>0?I:A,E=(null===(n=t.inputs)||void 0===n?void 0:n.command)||"",M="browser"===t.tool,O=("linux_shell"===t.tool||"linux_shell_dangerous"===t.tool)&&(E.includes("rabbitize")||E.includes("lars browser batch")),L=M||O,R=a.useMemo(()=>{if(!L)return null;const e={};if("success"===(null===i||void 0===i?void 0:i.status)){var s;null!==(s=i.images)&&void 0!==s&&s.length&&(e.images=i.images.length);const t=i.result;var n;if(t&&"object"===typeof t)null!==(n=t.images)&&void 0!==n&&n.length?e.images=t.images.length:t.screenshots&&(e.images=Array.isArray(t.screenshots)?t.screenshots.length:t.screenshots),t.dom_snapshots&&(e.dom_snapshots=Array.isArray(t.dom_snapshots)?t.dom_snapshots.length:t.dom_snapshots),t.dom_coords&&(e.dom_coords=Array.isArray(t.dom_coords)?t.dom_coords.length:t.dom_coords),(t.video||t.video_path||t.has_video)&&(e.video=1)}if(0===Object.keys(e).length&&M){var a,l;const s=((null===(a=t.inputs)||void 0===a?void 0:a.actions)||[]).filter(e=>{if("object"===typeof e){return"wait"!==Object.keys(e)[0]}return!0}).length;s>0&&(e.images=s,e.dom_snapshots=s),null!==(l=t.inputs)&&void 0!==l&&l.record_video&&(e.video=1)}if(0===Object.keys(e).length&&O){const s=E.match(/--commands='(\[[\s\S]*?\])'/)||E.match(/--batch-commands='(\[[\s\S]*?\])'/);if(s)try{const n=JSON.parse(s[1]).filter(e=>":wait"!==(Array.isArray(e)?e[0]:e)).length;n>0&&(e.images=n,e.dom_snapshots=n,e.dom_coords=n),E.includes("--process-video")&&(e.video=1)}catch(o){console.error("Failed to parse browser commands:",o)}}return Object.keys(e).length>0?e:null},[L,M,O,t.inputs,E,i]),F=T.length>0,P=null!==R,z=F||P,D={sql_data:{icon:"mdi:database",color:"#60a5fa"},python_data:{icon:"mdi:language-python",color:"#fbbf24"},js_data:{icon:"mdi:language-javascript",color:"#f7df1e"},clojure_data:{icon:"simple-icons:clojure",color:"#63b132"},llm_cell:{icon:"mdi:brain",color:"#a78bfa"},lars_data:{icon:"mdi:sail-boat",color:"#2dd4bf"},browser:{icon:"mdi:web",color:"#f87171"},linux_shell:{icon:"mdi:record-circle",color:"#f87171"},linux_shell_dangerous:{icon:"mdi:record-circle",color:"#f87171"},hitl_screen:{icon:"mdi:monitor-dashboard",color:"#f97316"}},q=t.tool||(t.hitl?"hitl_screen":t.instructions?"llm_cell":"python_data"),{icon:H,color:J}=D[q]||D.python_data;return(0,x.jsxs)("div",{className:"nav-cell-node ".concat(o?"active":""),children:[(0,x.jsxs)("div",{className:"nav-cell-row",onClick:()=>{r(t.name)},children:[z?(0,x.jsx)(c.In,{icon:h?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron",onClick:e=>{e.stopPropagation(),z&&p(!h)}}):(0,x.jsx)("span",{className:"nav-chevron-placeholder"}),(0,x.jsx)(de,{status:v}),(0,x.jsx)(c.In,{icon:H,className:"nav-tool-icon",style:{color:J}}),(0,x.jsxs)("div",{className:"nav-cell-content",children:[(0,x.jsx)("span",{className:"nav-cell-name",children:t.name}),d>0&&(0,x.jsxs)("div",{className:"nav-cell-cost-viz",children:[(0,x.jsx)("div",{className:"nav-cost-bar ".concat(C||"cyan"),style:{width:"".concat(u,"%")},title:"$".concat(d.toFixed(6)).concat(w>0?" (avg: $".concat(w.toFixed(4),")"):"")}),(0,x.jsxs)("div",{className:"nav-cost-metrics",children:[(0,x.jsxs)("span",{className:"nav-cost-amount ".concat(C||"cyan"),children:["$",d<.01?"<0.01":d.toFixed(4)]}),_&&Math.abs(_-1)>=.15?(0,x.jsxs)("span",{className:"nav-cost-delta ".concat(C||"cyan"),children:[_.toFixed(1),"x avg"]}):S>=25?(0,x.jsxs)("span",{className:"nav-cost-delta ".concat(C||"cyan"),children:[S.toFixed(0),"%"]}):null]})]})]}),(0,x.jsxs)("div",{className:"nav-cell-stats",children:[(null===i||void 0===i?void 0:i.cached)&&(0,x.jsx)(B.m_,{label:"Result from cache",children:(0,x.jsx)("span",{className:"nav-cell-cached",children:"cached"})}),f&&y>0&&(0,x.jsx)(B.m_,{label:"".concat(y," rows"),children:(0,x.jsxs)("span",{className:"nav-cell-rows",children:[(W=y,W||0===W?W>=1e6?"".concat((W/1e6).toFixed(1),"M"):W>=1e3?"".concat((W/1e3).toFixed(1),"K"):W.toString():null)," rows"]})}),void 0!==j&&null!==j&&(0,x.jsx)(B.m_,{label:"Execution time: ".concat(j,"ms"),children:(0,x.jsx)("span",{className:"nav-cell-duration",children:ue(j)})})]})]}),h&&F&&(0,x.jsx)("div",{className:"nav-cell-columns",children:T.map(e=>(0,x.jsxs)("div",{className:"nav-column-row",children:[(0,x.jsx)(c.In,{icon:"mdi:table-column",className:"nav-column-icon"}),(0,x.jsx)("span",{className:"nav-column-name",children:e.name}),(0,x.jsx)("span",{className:"nav-column-type",style:{color:ce(e.type)},children:e.type.toLowerCase()})]},e.name))}),h&&P&&(0,x.jsx)(ve,{cellName:t.name,artifacts:R,cellState:i})]});var W}const he={images:{icon:"mdi:image-multiple",color:"#a78bfa",label:"Screenshots"},dom_snapshots:{icon:"mdi:code-tags",color:"#60a5fa",label:"DOM Snapshots"},dom_coords:{icon:"mdi:crosshairs-gps",color:"#34d399",label:"DOM Coords"},video:{icon:"mdi:video",color:"#f87171",label:"Video"}};function pe(e){let{cellName:s,artifactType:n,index:a,label:l,thumbnailUrl:o}=e;const r=he[n],d=null!==a?"outputs.".concat(s,".").concat(n,"[").concat(a,"]"):"outputs.".concat(s,".").concat(n),{attributes:u,listeners:h,setNodeRef:p,isDragging:v}=(0,i.PM)({id:"artifact-".concat(s,"-").concat(n,"-").concat(a),data:{type:"variable",variablePath:d}}),g=o&&("images"===n||"screenshots"===n);return(0,x.jsx)(B.m_,{label:"{{ ".concat(d," }}"),children:(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:p},h),u),{},{className:"var-pill artifact-pill ".concat(v?"dragging":""," ").concat(g?"has-thumbnail":""),style:{borderColor:r.color+"34"},children:[g?(0,x.jsx)("img",{src:o?o.startsWith("http")?o:o.startsWith("/api")?"".concat(m.J).concat(o):"".concat(m.J,"/api/browser-media/").concat(o):null,alt:"Screenshot ".concat(l),className:"artifact-pill-thumbnail",onError:e=>{e.target.style.display="none"}}):(0,x.jsx)(c.In,{icon:r.icon,width:"12",style:{color:r.color}}),(0,x.jsx)("span",{style:{color:r.color},children:l})]}))})}function xe(e){let{cellName:s,artifactType:n,count:t,urls:l}=e;const[i,o]=(0,a.useState)(!1),r=he[n];if(0===t)return null;return"video"===n?(0,x.jsx)("div",{className:"nav-artifact-single",children:(0,x.jsx)(pe,{cellName:s,artifactType:n,index:null,label:r.label})}):(0,x.jsxs)("div",{className:"nav-artifact-group",children:[(0,x.jsxs)("div",{className:"nav-artifact-header",onClick:()=>o(!i),children:[(0,x.jsx)(c.In,{icon:i?"mdi:chevron-down":"mdi:chevron-right",width:"12",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:r.icon,width:"12",style:{color:r.color}}),(0,x.jsx)("span",{className:"nav-artifact-label",children:r.label.toUpperCase()}),(0,x.jsx)("span",{className:"nav-artifact-count",children:t})]}),i&&(0,x.jsx)("div",{className:"nav-artifact-pills",children:Array.from({length:t}).map((e,t)=>(0,x.jsx)(pe,{cellName:s,artifactType:n,index:t,label:"".concat(t),thumbnailUrl:null===l||void 0===l?void 0:l[t]},t))})]})}function ve(e){let{cellName:s,artifacts:n,cellState:t}=e;const a=e=>{if(null===t||void 0===t||!t.result)return null;let s=t.result;if("string"===typeof s){const e=s.match(/\{[\s\S]*\}/);if(!e)return null;try{s=JSON.parse(e[0])}catch(n){return null}}if("images"===e||"screenshots"===e){if(Array.isArray(s.screenshots))return s.screenshots.map(e=>"string"===typeof e?e:null!==e&&void 0!==e&&e.path?"".concat(m.J,"/api/browser-media/").concat(e.path):null!==e&&void 0!==e&&e.full_path?e.full_path:null!==e&&void 0!==e&&e.url?e.url:null).filter(Boolean);if(Array.isArray(t.images))return t.images}return null};return(0,x.jsx)("div",{className:"nav-cell-artifacts",children:Object.entries(n).map(e=>{let[n,t]=e;return(0,x.jsx)(xe,{cellName:s,artifactType:n,count:t,urls:a(n)},n)})})}function ge(e){let{sessionId:s,cells:n,cellStates:t}=e;const[l,i]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-session-tables-expanded");return null!==e&&"true"===e}catch(e){return!1}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-session-tables-expanded",String(l))}catch(e){console.warn("Failed to save sidebar state:",e)}},[l]);const o=(null===n||void 0===n?void 0:n.filter(e=>{var s;return"success"===(null===(s=t[e.name])||void 0===s?void 0:s.status)}).map(e=>"_".concat(e.name)))||[];return 0===o.length?null:(0,x.jsxs)("div",{className:"nav-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>i(!l),children:[(0,x.jsx)(c.In,{icon:l?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:table-multiple",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Session Tables"}),(0,x.jsx)("span",{className:"nav-section-count",children:o.length})]}),l&&(0,x.jsxs)("div",{className:"nav-section-content",children:[o.map(e=>(0,x.jsxs)("div",{className:"nav-table-row",children:[(0,x.jsx)(c.In,{icon:"mdi:table",className:"nav-table-icon"}),(0,x.jsx)("span",{className:"nav-table-name",children:e})]},e)),s&&(0,x.jsxs)("div",{className:"nav-session-id",children:["Session: ",s.slice(0,16),"..."]})]})]})}function je(e){let{cells:s,cellStates:n,onNavigateToCell:t}=e;const[l,i]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-media-expanded");return null===e||"true"===e}catch(e){return!0}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-media-expanded",String(l))}catch(e){console.warn("Failed to save sidebar state:",e)}},[l]);const o=a.useMemo(()=>{const e=[];return null===s||void 0===s||s.forEach(s=>{const t=n[s.name],a=null===t||void 0===t?void 0:t.images;a&&Array.isArray(a)&&a.length>0&&a.forEach((n,t)=>{e.push({cellName:s.name,imagePath:n,imageIndex:t,key:"".concat(s.name,"-").concat(t)})})}),e},[s,n]);return 0===o.length?null:(0,x.jsxs)("div",{className:"nav-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>i(!l),children:[(0,x.jsx)(c.In,{icon:l?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:image-multiple",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Media"}),(0,x.jsx)("span",{className:"nav-section-count",children:o.length})]}),l&&(0,x.jsx)("div",{className:"nav-section-content nav-media-content",children:o.map(e=>{const s="string"===typeof e.imagePath?e.imagePath:"";if(!s)return null;const n=s.startsWith("/api")?"".concat(m.J).concat(s):s;return(0,x.jsx)(B.m_,{label:"".concat(e.cellName," - Image ").concat(e.imageIndex+1),children:(0,x.jsxs)("div",{className:"nav-media-item",onClick:()=>t(e.cellName,{outputTab:"images"}),children:[(0,x.jsx)("img",{src:n,alt:"".concat(e.cellName," output")}),(0,x.jsxs)("div",{className:"nav-media-label",children:[(0,x.jsx)(c.In,{icon:"mdi:image",width:"12"}),(0,x.jsx)("span",{children:e.cellName})]})]})},e.key)})})]})}function fe(e){let{type:s,icon:n,label:a,color:l}=e;const{attributes:o,listeners:r,setNodeRef:d,isDragging:u}=(0,i.PM)({id:"cell-type-".concat(s),data:{type:"cell-type",cellType:s}});return(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:d},r),o),{},{className:"nav-cell-type-pill ".concat(u?"dragging":""),style:{borderColor:l+34},children:[(0,x.jsx)(c.In,{icon:n,width:"16",style:{color:l}}),(0,x.jsx)("span",{style:{color:l},children:a})]}))}const ye=a.memo(()=>{const{attributes:e,listeners:s,setNodeRef:n,isDragging:a}=(0,i.PM)({id:"special-input",data:{type:"input-placeholder"}}),l="#34d399";return(0,x.jsxs)("div",(0,t.A)((0,t.A)((0,t.A)({ref:n},s),e),{},{className:"nav-cell-type-pill ".concat(a?"dragging":""),style:{borderColor:l+"34"},children:[(0,x.jsx)(c.In,{icon:"mdi:textbox",width:"16",style:{color:l}}),(0,x.jsx)("span",{style:{color:l},children:"Input"})]}))});function be(e){let{title:s,icon:n,cellTypes:l,defaultExpanded:i=!0}=e;const[o,r]=(0,a.useState)(i);return 0===l.length?null:(0,x.jsxs)("div",{className:"nav-cell-subsection",children:[(0,x.jsxs)("div",{className:"nav-cell-subsection-header",onClick:()=>r(!o),children:[(0,x.jsx)(c.In,{icon:o?"mdi:chevron-down":"mdi:chevron-right",width:"12",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:n,width:"14",className:"nav-subsection-icon"}),(0,x.jsx)("span",{className:"nav-subsection-title",children:s}),(0,x.jsx)("span",{className:"nav-subsection-count",children:l.length})]}),o&&(0,x.jsx)("div",{className:"nav-cell-types-content",children:l.map(e=>(0,x.jsx)(fe,(0,t.A)({},e),e.type))})]})}function Ne(){const[e,s]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-cell-types-expanded");return null!==e&&"true"===e}catch(e){return!1}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-cell-types-expanded",String(e))}catch(s){console.warn("Failed to save sidebar state:",s)}},[e]);const n=(0,p.A)(e=>e.cellTypes),t=(Array.isArray(n)?n:[]).map(e=>({type:e.type_id,icon:e.icon,label:e.display_name,color:e.color,tags:e.tags||[]})),l=a.useMemo(()=>{const e=(e,s)=>s.some(s=>e.tags.includes(s));return{quickStart:t.filter(s=>e(s,["quick-start","popular"])),aiMl:t.filter(s=>s.tags.includes("ai-ml")&&!e(s,["quick-start","popular"])),dataProcessing:t.filter(s=>s.tags.includes("data-processing")&&!e(s,["ai-ml","quick-start","popular"])),visualization:t.filter(e=>e.tags.includes("visualization")),orchestration:t.filter(s=>s.tags.includes("orchestration")&&!e(s,["ai-ml"])),integration:t.filter(e=>e.tags.includes("integration")),advanced:t.filter(s=>e(s,["advanced","novel","powerful"])&&!e(s,["quick-start","popular","visualization","integration"]))}},[t]);return(0,x.jsxs)("div",{className:"nav-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>s(!e),children:[(0,x.jsx)(c.In,{icon:e?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:puzzle",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Cell Templates"}),(0,x.jsx)("span",{className:"nav-section-count",children:t.length})]}),e&&(0,x.jsxs)("div",{className:"nav-section-content",children:[(0,x.jsx)(be,{title:"Quick Start",icon:"mdi:rocket-launch-outline",cellTypes:l.quickStart,defaultExpanded:!0}),(0,x.jsx)(be,{title:"AI & Machine Learning",icon:"mdi:brain",cellTypes:l.aiMl,defaultExpanded:!1}),(0,x.jsx)(be,{title:"Data Processing",icon:"mdi:database-cog",cellTypes:l.dataProcessing,defaultExpanded:!1}),(0,x.jsx)(be,{title:"Visualization",icon:"mdi:chart-line",cellTypes:l.visualization,defaultExpanded:!1}),(0,x.jsx)(be,{title:"Orchestration",icon:"mdi:git-network",cellTypes:l.orchestration,defaultExpanded:!1}),(0,x.jsx)(be,{title:"Integration & Tools",icon:"mdi:tools",cellTypes:l.integration,defaultExpanded:!1}),(0,x.jsx)(be,{title:"Advanced Features",icon:"mdi:star-circle",cellTypes:l.advanced,defaultExpanded:!1})]})]})}function we(){const[e,s]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-connections-expanded");return null!==e&&"true"===e}catch(e){return!1}}),{connections:n}=h();return(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-connections-expanded",String(e))}catch(s){console.warn("Failed to save sidebar state:",s)}},[e]),(0,x.jsxs)("div",{className:"nav-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>s(!e),children:[(0,x.jsx)(c.In,{icon:e?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:database-multiple",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Connections"}),(0,x.jsx)("span",{className:"nav-section-count",children:n.length})]}),e&&(0,x.jsx)("div",{className:"nav-section-content",children:n.map(e=>(0,x.jsxs)("div",{className:"nav-connection-row",children:[(0,x.jsx)(c.In,{icon:"mdi:database",className:"nav-connection-icon"}),(0,x.jsx)("span",{className:"nav-connection-name",children:e.name}),(0,x.jsxs)("span",{className:"nav-connection-tables",children:[e.table_count," tables"]})]},e.name))})]})}ye.displayName="InputPill";const Se=function(){const{cascade:e,cascadeInputs:s,cellStates:n,cellAnalytics:l,sessionId:o,cascadeSessionId:r,isRunningAll:d,runCascadeStandard:u,yamlViewMode:h,setYamlViewMode:v,updateCascadeFromYaml:g,viewMode:j,replaySessionId:f,parentSessionId:y,parentCell:b,selectedCellIndex:N}=(0,p.A)(),[w,S]=(0,a.useState)(null),[k,_]=(0,a.useState)(null),[C,I]=(0,a.useState)(!1),{showToast:A}=(0,ae.dj)(),[T,E]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-sidebar-cells-expanded");return null===e||"true"===e}catch(e){return!0}});(0,a.useEffect)(()=>{try{localStorage.setItem("studio-sidebar-cells-expanded",String(T))}catch(e){console.warn("Failed to save sidebar state:",e)}},[T]);const[M,P]=(0,a.useState)(""),[z,D]=(0,a.useState)(null),[q,H]=(0,a.useState)(!1),J=(0,a.useRef)(""),{setNodeRef:U,isOver:K}=(0,i.zM)({id:"cascade-yaml-editor-drop",data:{type:"monaco-editor"}});(0,a.useEffect)(()=>{w&&S(null)},[s]);const V="replay"===j?f:r;(0,a.useEffect)(()=>{if(console.log("[CascadeNavigator] Checkpoint polling setup:",{checkpointSessionId:V,cascadeSessionId:r,replaySessionId:f,viewMode:j}),!V)return void _(null);const e=async()=>{try{const e=await fetch("".concat(m.J,"/api/checkpoints")),s=await e.json();if(s.error)return void console.warn("[CascadeNavigator] Checkpoint fetch error:",s.error);const n=(s.checkpoints||[]).filter(e=>"pending"===e.status);console.log("[CascadeNavigator] Checkpoint check:",{checkpointSessionId:V,pendingCount:n.length,pendingSessionIds:n.map(e=>e.session_id),match:n.find(e=>e.session_id===V)});const t=n.find(e=>e.session_id===V);_(t||null)}catch(e){console.warn("[CascadeNavigator] Checkpoint fetch failed:",e)}};e();const s=setInterval(e,d?2e3:5e3);return()=>clearInterval(s)},[V,d]);const $=(0,a.useCallback)(async e=>{if(k)try{const s=await fetch("".concat(m.J,"/api/checkpoints/").concat(k.id,"/respond"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:e})}),n=await s.json();if(n.error)return void A("Failed to respond: ".concat(n.error),{type:"error"});A("Response submitted",{type:"success"}),_(null),I(!1)}catch(s){A("Error: ".concat(s.message),{type:"error"})}},[k,A]),Y=(0,a.useCallback)(async()=>{if(k)try{const e=await fetch("".concat(m.J,"/api/checkpoints/").concat(k.id,"/cancel"),{method:"POST"}),s=await e.json();if(s.error)return void A("Failed to cancel: ".concat(s.error),{type:"error"});A("Checkpoint cancelled",{type:"success"}),_(null),I(!1)}catch(e){A("Error: ".concat(e.message),{type:"error"})}},[k,A]);(0,a.useEffect)(()=>{if(!e||q)return;const{cascadeYamlText:s}=p.A.getState();try{const n=s||R.Ay.dump((0,t.A)((0,t.A)({},e),{},{cells:e.cells||[],description:e.description||"",inputs_schema:e.inputs_schema||{}}),{indent:2,lineWidth:-1,noRefs:!0,quotingType:'"',forceQuotes:!1});n!==J.current&&(P(n),J.current=n,D(null))}catch(n){console.error("[CascadeNavigator] Failed to serialize cascade to YAML:",n),D(n.message)}},[e,q]);const Q=(0,a.useCallback)(e=>{P(e);try{R.Ay.load(e),D(null)}catch(s){D(s.message)}},[]),X=(0,a.useCallback)(e=>{if(console.log("[CascadeNavigator] Editor blurred, syncing to store"),H(!1),e===J.current)return;const s=g(e);s.success?(J.current=e,D(null)):D(s.error)},[g]),Z=(0,a.useCallback)(function(e){var s;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{cascade:t,setSelectedCellIndex:a,setDesiredOutputTab:l}=p.A.getState(),i=null===t||void 0===t||null===(s=t.cells)||void 0===s?void 0:s.findIndex(s=>s.name===e);-1!==i&&(a(i),n.outputTab&&l(n.outputTab));const o=document.querySelector('[data-cell-name="'.concat(e,'"]'));o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("cell-highlight"),setTimeout(()=>{o.classList.remove("cell-highlight")},1500))},[]);if(!e)return(0,x.jsxs)("div",{className:"cascade-navigator empty",children:[(0,x.jsx)(c.In,{icon:"mdi:cascade-outline",className:"empty-icon"}),(0,x.jsx)("span",{children:"No cascade loaded"})]});const oe=e.cells||[],ce=e.inputs_schema&&Object.keys(e.inputs_schema).length>0;return(0,x.jsxs)("div",{className:"cascade-navigator",children:[y&&(0,x.jsxs)("div",{className:"nav-parent-banner",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-up-bold",width:"14"}),(0,x.jsx)("span",{children:"Sub-cascade of"}),(0,x.jsxs)("a",{href:"#/studio/".concat(y),className:"nav-parent-link",onClick:e=>{e.preventDefault(),window.location.hash="/studio/".concat(y),window.location.reload()},children:[y.slice(0,16),"..."]}),b&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("span",{className:"nav-parent-sep",children:"\xb7"}),(0,x.jsxs)("span",{className:"nav-parent-cell",children:["Cell: ",b]})]})]}),(0,x.jsxs)("div",{className:"nav-cascade-header",children:[(0,x.jsxs)("div",{className:"nav-cascade-header-left",children:[(0,x.jsx)(c.In,{icon:"mdi:cascade-edit",className:"nav-cascade-icon"}),(0,x.jsx)("div",{className:"nav-cascade-info",children:(0,x.jsx)("span",{className:"nav-cascade-name",children:e.cascade_id})})]}),(0,x.jsxs)("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"4px"},children:[(0,x.jsxs)("div",{style:{display:"flex",gap:"6px"},children:[(0,x.jsx)(B.m_,{label:h?"Show Navigator":"Show YAML Editor",children:(0,x.jsx)(ae.$n,{variant:"ghost",size:"sm",icon:h?"mdi:view-dashboard":"mdi:code-braces",onClick:()=>v(!h)})}),d?(0,x.jsx)(B.m_,{label:"Stop running cascade",children:(0,x.jsx)(ae.$n,{variant:"danger",size:"sm",icon:"mdi:stop",onClick:async()=>{if(!r)return void A("No active session to cancel",{type:"warning"});console.log("[handleCancelCascade] Cancelling session:",r),p.A.setState({isRunningAll:!1}),_(null),I(!1);const e=await(0,ie.tn)(r,"Cancelled via Studio UI");var s;e.success?(console.log("[handleCancelCascade] Success! Verified status:",e.verified_status),console.log("[handleCancelCascade] Checkpoints deleted:",(null===(s=e.data)||void 0===s?void 0:s.checkpoints_deleted)||0),"cancelled"===e.verified_status?A("Cascade cancelled",{type:"success"}):(console.warn("[handleCancelCascade] Warning: DB status is",e.verified_status,'not "cancelled"'),A("Cancelled (DB: ".concat(e.verified_status||"unknown",")"),{type:"warning"}))):(console.error("[handleCancelCascade] Failed:",e.error),A("Failed to cancel: ".concat(e.error),{type:"error"}))},children:"Stop"})}):(0,x.jsx)(B.m_,{label:w||"Run all cells",children:(0,x.jsx)(ae.$n,{variant:"primary",size:"sm",icon:"mdi:play",onClick:async()=>{if(ce){const n=e.inputs_schema,t=[],a=s||{};console.log("[CascadeNavigator] Validating inputs:",a),console.log("[CascadeNavigator] Required schema:",n);for(const e of Object.keys(n)){const s=a[e];console.log("[CascadeNavigator] Checking ".concat(e,":"),s,"isEmpty?",void 0===s||null===s||""===s||"string"===typeof s&&""===s.trim()),(void 0===s||null===s||""===s||"string"===typeof s&&""===s.trim())&&t.push(e)}if(t.length>0){console.log("[CascadeNavigator] Empty inputs found:",t),S("Missing: ".concat(t.join(", ")));const e=document.querySelector(".nav-inputs-section");return void(e&&e.scrollIntoView({behavior:"smooth",block:"start"}))}}S(null),await u()},disabled:0===oe.length,children:"Run All"})})]}),w&&(0,x.jsxs)("div",{style:{fontSize:"11px",color:"#f87171",display:"flex",alignItems:"center",gap:"4px",padding:"4px 8px",background:"rgba(248, 113, 113, 0.1)",borderRadius:"4px",whiteSpace:"nowrap"},children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),(0,x.jsx)("span",{children:w})]})]})]}),(0,x.jsx)("div",{className:"nav-card-flip-container",children:(0,x.jsxs)(O.N,{mode:"wait",initial:!1,children:[h&&(0,x.jsxs)(L.P.div,{className:"nav-yaml-view nav-flip-card",initial:{rotateY:90,zIndex:200},animate:{rotateY:0,zIndex:200},exit:{rotateY:-90,zIndex:200},transition:{duration:.2,ease:"easeInOut"},children:["replay"===j&&(0,x.jsxs)("div",{className:"nav-yaml-warning replay-warning",children:[(0,x.jsx)(c.In,{icon:"mdi:information",width:"14"}),(0,x.jsx)("span",{children:"Viewing historical session - YAML editor is read-only"})]}),d&&(0,x.jsxs)("div",{className:"nav-yaml-warning running-warning",children:[(0,x.jsx)(c.In,{icon:"mdi:alert",width:"14"}),(0,x.jsx)("span",{children:"Cascade is running - edits may cause unexpected behavior"})]}),z&&(0,x.jsxs)("div",{className:"nav-yaml-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"14"}),(0,x.jsxs)("span",{children:["Parse Error: ",z]})]}),(0,x.jsx)("div",{ref:U,className:"nav-yaml-editor-container ".concat(K?"drop-active":""),children:(0,x.jsx)(te,{value:M,onChange:Q,onFocus:()=>H(!0),onBlur:X,readOnly:"replay"===j,onValidationError:e=>D(e)})})]},"yaml"),!h&&(0,x.jsxs)(L.P.div,{className:"nav-normal-view nav-flip-card",initial:{rotateY:-90,zIndex:200},animate:{rotateY:0,zIndex:1},exit:{rotateY:90,zIndex:200},transition:{duration:.2,ease:"easeInOut"},children:[ce&&(0,x.jsx)("div",{className:"nav-inputs-section",children:(0,x.jsx)(F,{schema:e.inputs_schema})}),k&&(0,x.jsxs)("div",{className:"nav-interrupt-alert",children:[(0,x.jsxs)("div",{className:"nav-interrupt-alert-content",children:[(0,x.jsx)("div",{className:"nav-interrupt-alert-icon",children:(0,x.jsx)(c.In,{icon:"mdi:hand-back-right",width:"20"})}),(0,x.jsxs)("div",{className:"nav-interrupt-alert-text",children:[(0,x.jsx)("span",{className:"nav-interrupt-alert-title",children:"Human Input Required"}),(0,x.jsxs)("span",{className:"nav-interrupt-alert-meta",children:[k.checkpoint_type,k.cell_name&&" \u2022 ".concat(k.cell_name)]})]})]}),(0,x.jsx)(ae.$n,{variant:"primary",size:"sm",icon:"mdi:open-in-new",onClick:()=>I(!0),children:"Respond"})]}),(0,x.jsx)("div",{className:"nav-quick-access",children:(0,x.jsxs)("div",{className:"nav-quick-access-pills",children:[(0,x.jsx)(fe,{type:"llm_cell",icon:"mdi:brain",label:"LLM",color:"#a78bfa"}),(0,x.jsx)(fe,{type:"bodybuilder",icon:"mdi:dumbbell",label:"Bodybuilder",color:"#ff6b35"}),(0,x.jsx)(fe,{type:"image_gen",icon:"mdi:image-auto",label:"Image",color:"#ff006e"}),(0,x.jsx)(ye,{}),(0,x.jsx)(fe,{type:"python_data",icon:"mdi:language-python",label:"Python",color:"#fbbf24"}),(0,x.jsx)(fe,{type:"sql_data",icon:"mdi:database",label:"SQL",color:"#60a5fa"}),(0,x.jsx)(fe,{type:"shell_command",icon:"mdi:console",label:"Bash",color:"#64748b"}),(0,x.jsx)(fe,{type:"js_data",icon:"mdi:language-javascript",label:"JS",color:"#f7df1e"}),(0,x.jsx)(fe,{type:"clojure_data",icon:"simple-icons:clojure",label:"Clojure",color:"#63b132"})]})}),(0,x.jsx)(Ne,{}),(0,x.jsx)(W,{}),(0,x.jsx)(G,{}),(0,x.jsx)(ee,{}),(0,x.jsx)(se,{}),(0,x.jsx)(ne,{sessionId:o||"unknown",isRunning:d||!1}),(0,x.jsxs)("div",{className:"nav-section nav-cells-section",children:[(0,x.jsxs)("div",{className:"nav-section-header",onClick:()=>E(!T),children:[(0,x.jsx)(c.In,{icon:T?"mdi:chevron-down":"mdi:chevron-right",className:"nav-chevron"}),(0,x.jsx)(c.In,{icon:"mdi:format-list-numbered",className:"nav-section-icon"}),(0,x.jsx)("span",{className:"nav-section-title",children:"Cells"}),(0,x.jsx)("span",{className:"nav-section-count",children:oe.length})]}),T&&(0,x.jsx)("div",{className:"nav-cells-list",children:(()=>{const e=oe.map((e,s)=>{var t;return{cell:e,index:s,cost:(null===(t=n[e.name])||void 0===t?void 0:t.cost)||0}}),s=Math.max(...e.map(e=>e.cost),1e-4);return[...e].sort((e,s)=>s.cost-e.cost).map(e=>{let{cell:t,index:a,cost:i}=e;const o=s>0?i/s*100:0,c=(null===l||void 0===l?void 0:l[t.name])||null;return(0,x.jsx)(me,{cell:t,index:a,cellState:n[t.name],isActive:N===a,onNavigate:Z,cost:i,costBarWidth:o,analytics:c},t.name)})})()})]}),(0,x.jsx)(ge,{sessionId:o,cells:oe,cellStates:n}),(0,x.jsx)(je,{cells:oe,cellStates:n,onNavigateToCell:Z}),(0,x.jsx)(we,{})]},"navigator")]})}),C&&k&&(0,x.jsx)(le.A,{checkpoint:k,onSubmit:$,onClose:()=>I(!1),onCancel:Y})]})};var ke=n(84713);const _e=function(e,s){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[l,i]=(0,a.useState)([]),[o,c]=(0,a.useState)(!1),[r,d]=(0,a.useState)(null),[u,h]=(0,a.useState)(!1),[p,x]=(0,a.useState)(null),[v,g]=(0,a.useState)(null),[j,f]=(0,a.useState)(null),[y,b]=(0,a.useState)(0),[N,w]=(0,a.useState)({}),[S,k]=(0,a.useState)(null),[_,C]=(0,a.useState)({}),I=(0,a.useRef)("1970-01-01 00:00:00"),A=(0,a.useRef)(null),T=(0,a.useRef)(null),E=(0,a.useRef)(new Set),M=(0,a.useRef)(null),O=(0,a.useCallback)(async()=>{if(e)try{let s;if(n)s="".concat(m.J,"/api/playground/session-stream/").concat(e,"?after=1970-01-01 00:00:00");else{const n=new Date,t=new Date(n.getTime()-3e4).toISOString().replace("T"," ").replace("Z","").split(".")[0],a=I.current<t?I.current:t;s="".concat(m.J,"/api/playground/session-stream/").concat(e,"?after=").concat(encodeURIComponent(a))}const a=await fetch(s);if(!a.ok)throw new Error("HTTP ".concat(a.status));const l=await a.json();if(l.error)throw new Error(l.error);const o=(l.rows||[]).filter(s=>{var n;return s.session_id===e||s.parent_session_id===e||(null===(n=s.session_id)||void 0===n?void 0:n.startsWith("".concat(e,"_")))});if(n)i(o);else{const e=[],s=new Set;for(const n of o)n.message_id&&(E.current.has(n.message_id)?n.cost&&n.cost>0&&s.add(n.message_id):(E.current.add(n.message_id),e.push(n)));(e.length>0||s.size>0)&&i(n=>{if(0===s.size)return[...n,...e];return[...n.map(e=>{if(s.has(e.message_id)){const s=o.find(s=>s.message_id===e.message_id);if(s)return(0,t.A)((0,t.A)({},e),s)}return e}),...e]}),I.current=l.cursor||I.current}l.session_complete&&!u&&h(!0),void 0!==l.session_status&&(x(l.session_status),g(e)),void 0!==l.session_error&&f(l.session_error),void 0!==l.total_cost&&b(l.total_cost),l.child_sessions&&w(e=>{const s=(0,t.A)({},e);return l.child_sessions.forEach(e=>{s[e.session_id]=e}),s}),l.cascade_analytics&&(console.log("[useTimelinePolling] Received cascade_analytics:",l.cascade_analytics),k(l.cascade_analytics)),l.cell_analytics&&Object.keys(l.cell_analytics).length>0&&(console.log("[useTimelinePolling] Received cell_analytics:",Object.keys(l.cell_analytics),l.cell_analytics),C(l.cell_analytics)),r&&d(null)}catch(s){console.error("[TimelinePolling] Error:",s),d(s.message)}},[e,n]);(0,a.useEffect)(()=>{e!==M.current&&(console.log("[useTimelinePolling] Session changed:",M.current,"\u2192",e,"- CLEARING ALL DATA"),A.current&&(clearInterval(A.current),A.current=null),i([]),c(!1),h(!1),x(null),g(null),f(null),b(0),w({}),k(null),C({}),I.current="1970-01-01 00:00:00",E.current.clear(),M.current=e,console.log("[useTimelinePolling] Cleared sessionStatus to prevent stale terminal state"))},[e]),(0,a.useEffect)(()=>(console.log("[useTimelinePolling] Start/stop check:",{sessionId:e,isRunning:s,hasInterval:!!A.current}),e&&s?(console.log("[useTimelinePolling] Starting polling for session:",e,"isReplayMode:",n),c(!0),O(),A.current=setInterval(O,750),console.log("[useTimelinePolling] Poll interval set (every",750,"ms)"),()=>{console.log("[useTimelinePolling] Cleanup: stopping poll interval for session:",e),A.current&&(clearInterval(A.current),A.current=null)}):(console.log("[useTimelinePolling] Stopping polling (no session or not running)"),c(!1),void(A.current&&(clearInterval(A.current),A.current=null)))),[e,s,O,n]),(0,a.useEffect)(()=>{if(u){const e=setInterval(O,750);return T.current=setTimeout(()=>{clearInterval(e),c(!1)},1e4),()=>{clearInterval(e),T.current&&clearTimeout(T.current)}}},[u,O]);const L=a.useMemo(()=>{const e={};if(l.length>0){const s=[...new Set(l.map(e=>e.cell_name).filter(Boolean))];for(const n of s)e[n]=(0,ke.l)(l,n)}return e},[l]);return{logs:l,cellStates:L,isPolling:o,sessionComplete:u,sessionStatus:p,sessionStatusFor:v,sessionError:j,totalCost:y,childSessions:N,cascadeAnalytics:S,cellAnalytics:_,error:r}};var Ce=n(24818);const Ie=e=>{if(!e)return null;if(e<1e3)return"<1s";const s=Math.floor(e/1e3),n=Math.floor(s/60),t=s%60;return 0===n?"".concat(s,"s"):0===t?"".concat(n,"m"):"".concat(n,"m ").concat(t,"s")},Ae=e=>{var s;let{cell:n,index:t,cellState:l,cellLogs:o=[],isSelected:r,onSelect:d,defaultModel:u,costMetrics:h,isBlocked:p=!1}=e;const v=p?"blocked":(null===l||void 0===l?void 0:l.status)||"pending",g=!0===(null===l||void 0===l?void 0:l.cached),j=null===l||void 0===l?void 0:l.autoFixed,f=(null===l||void 0===l?void 0:l.images)&&l.images.length>0,y=f?l.images[0]:null,b=y?"".concat(m.J).concat(y):null,N=(null===h||void 0===h?void 0:h.scale)||1,w=(null===h||void 0===h||h.costDeltaPct,(null===h||void 0===h?void 0:h.duration)||0),S=(null===h||void 0===h?void 0:h.color)||"cyan",k=(null===h||void 0===h?void 0:h.cellCostPct)||0,_=null===h||void 0===h?void 0:h.costMultiplier,C=(null===h||void 0===h?void 0:h.isOutlier)||!1,I=(null===h||void 0===h?void 0:h.speciesRunCount)||0,A=h&&(_&&Math.abs(_-1)>=.2||k>=25||C),{setNodeRef:T,isOver:E}=(0,i.zM)({id:"cell-card-".concat(n.name),data:{type:"cell-card",cellName:n.name,cellIndex:t}}),M=a.useCallback(()=>{d(t)},[d,t]),O=!("lars_data"!==n.tool&&!n.instructions)?n.model||(null===l||void 0===l?void 0:l.model)||u:null,L=n.takes,R=L&&L.factor&&L.factor>1,F=R?L.factor:null,z=R&&L.reforge?L.reforge.steps:null,D=a.useMemo(()=>{if(!o||0===o.length)return null;const e=new Map;let s=null,n=null;const t=e=>{if(!e)return{};if("string"===typeof e)try{return JSON.parse(e)}catch(s){return{}}return e};for(const l of o){const a=t(l.metadata_json);if(null!==l.winning_take_index&&void 0!==l.winning_take_index&&(s=l.winning_take_index),a.max_turns&&null===n&&(n=a.max_turns),null!==l.take_index&&void 0!==l.take_index){const s=l.take_index;e.has(s)||e.set(s,{status:"running",maxTurn:0,maxTurnsAllowed:null});const n=e.get(s);a.turn_number&&a.turn_number>n.maxTurn&&(n.maxTurn=a.turn_number),a.max_turns&&!n.maxTurnsAllowed&&(n.maxTurnsAllowed=a.max_turns),n.maxTurn>0&&n.maxTurnsAllowed&&n.maxTurn>=n.maxTurnsAllowed&&"running"===n.status&&(n.status="complete"),"take_attempt"!==l.role&&"take_attempt"!==l.node_type||(n.status="complete"),"error"===l.role&&(n.status="error")}}if(0===e.size)return null;const a=Array.from(e.entries()).sort((e,s)=>e[0]-s[0]).map(e=>{let[n,t]=e;return{index:n,status:t.status,isWinner:n===s}});return{takes:a,winner:s,maxTurns:n}},[o]),q={sql_data:{label:"SQL",icon:"mdi:database",color:"#60a5fa"},python_data:{label:"Python",icon:"mdi:language-python",color:"#fbbf24"},js_data:{label:"JS",icon:"mdi:language-javascript",color:"#f7df1e"},clojure_data:{label:"Clj",icon:"simple-icons:clojure",color:"#63b132"},llm_cell:{label:"LLM",icon:"mdi:brain",color:"#a78bfa"},lars_data:{label:"LLM (Data)",icon:"mdi:sail-boat",color:"#2dd4bf"},bodybuilder:{label:"Bodybuilder",icon:"mdi:dumbbell",color:"#ff6b35"},browser:{label:"Browser",icon:"mdi:web",color:"#f87171"},linux_shell:{label:"Shell",icon:"mdi:console",color:"#94a3b8"},linux_shell_dangerous:{label:"Shell",icon:"mdi:console",color:"#94a3b8"},hitl_screen:{label:"HITL",icon:"mdi:monitor-dashboard",color:"#f97316"}},H=q[n.tool||(n.hitl?"hitl_screen":n.instructions?"llm_cell":"python_data")]||q.python_data,J=()=>{switch(v){case"blocked":return(0,x.jsx)(c.In,{icon:"mdi:hand-back-right",className:"cell-card-status-blocked"});case"running":return(0,x.jsx)("span",{className:"cell-card-status-spinner"});case"success":return(0,x.jsx)(c.In,{icon:"mdi:check-circle",className:"cell-card-status-success"});case"error":return(0,x.jsx)(c.In,{icon:"mdi:alert-circle",className:"cell-card-status-error"});case"stale":return(0,x.jsx)(c.In,{icon:"mdi:circle-outline",className:"cell-card-status-stale"});default:return(0,x.jsx)(c.In,{icon:"mdi:circle-outline",className:"cell-card-status-pending"})}};return(0,x.jsxs)("div",{className:"cell-card-wrapper",style:{transform:"scale(".concat(N,")"),transformOrigin:"center center"},children:[(0,x.jsxs)("div",{ref:T,className:"cell-card cell-card-".concat(v," ").concat(r?"cell-card-selected":""," ").concat(R?"cell-card-stacked":""," ").concat(E?"cell-card-drop-target":""," ").concat(b?"has-image-bg":""),onClick:M,"data-cell-name":n.name,style:b?{"--bg-image-url":"url(".concat(b,")")}:void 0,children:[(0,x.jsxs)("div",{className:"cell-card-top-row",children:[(0,x.jsxs)("div",{className:"cell-card-type-row",children:[(0,x.jsx)(c.In,{icon:H.icon,width:"16",style:{color:H.color}}),(0,x.jsx)("span",{className:"cell-card-type-label",style:{color:H.color},children:H.label}),f&&(0,x.jsx)(c.In,{icon:"mdi:image",width:"14",style:{color:"#a78bfa",marginLeft:"4px"},title:"Contains images"})]}),(0,x.jsx)(J,{})]}),(0,x.jsx)("div",{className:"cell-card-name",title:n.name,children:n.name}),(0,x.jsxs)("div",{className:"cell-card-bottom-row",children:[void 0!==(null===l||void 0===l?void 0:l.duration)&&null!==l.duration&&(0,x.jsxs)("span",{className:"cell-card-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:clock-outline",width:"12"}),Ie(l.duration)]}),void 0!==(null===l||void 0===l||null===(s=l.result)||void 0===s?void 0:s.row_count)&&(0,x.jsxs)("span",{className:"cell-card-stat cell-card-stat-rows",children:[(0,x.jsx)(c.In,{icon:"mdi:table",width:"12"}),l.result.row_count]}),O&&(0,x.jsxs)("span",{className:"cell-card-stat cell-card-stat-model",title:O,style:{color:(0,P.t8)((0,P.sO)(O)),marginLeft:"auto"},children:[(0,x.jsx)(P.Ay,{modelId:O,size:12,showTooltip:!1}),O.split("/").pop().slice(0,15)]}),(null===l||void 0===l?void 0:l.cost)>0&&(0,x.jsx)("span",{className:"cell-card-stat cell-card-stat-cost",title:"LLM cost",children:l.cost<.01?"<$0.01":"$".concat(l.cost.toFixed(4))}),z&&!D&&(0,x.jsxs)(ae.Ex,{variant:"label",color:"purple",size:"sm",children:[z,"x reforge"]}),g&&"success"===v&&(0,x.jsx)(ae.Ex,{variant:"label",color:"purple",size:"sm",children:"cached"}),j&&(0,x.jsx)(ae.Ex,{variant:"label",color:"green",size:"sm",children:"\ud83d\udd27 fixed"})]}),(D||R&&F)&&(0,x.jsx)("div",{className:"cell-card-takes-row",children:D?D.takes.map(e=>(0,x.jsx)("div",{className:"cell-card-take-dot ".concat(e.status," ").concat(e.isWinner?"winner":""),title:e.isWinner?"Take ".concat(e.index," (WINNER)"):"Take ".concat(e.index," - ").concat(e.status)},e.index)):Array.from({length:F},(e,s)=>(0,x.jsx)("div",{className:"cell-card-take-dot pending",title:"Take ".concat(s," - pending")},s))})]}),A&&(0,x.jsxs)("div",{className:"cell-cost-annotation ".concat(S),children:[C&&(0,x.jsx)("span",{style:{marginRight:"4px"},title:"Statistical outlier vs historical runs",children:"\u26a0"}),_&&I>0?(0,x.jsxs)(x.Fragment,{children:[_>=1.1||_<=.9?"".concat(_.toFixed(1),"x avg"):null,k>=25&&(0,x.jsxs)("span",{style:{marginLeft:"4px"},children:[k.toFixed(0),"% of cascade"]})]}):k>=25&&"".concat(k.toFixed(0),"% of cascade"),w>0&&(0,x.jsxs)("span",{className:"annotation-duration",children:[" \xb7 ",(e=>{if(!e)return null;if(e<1e3)return"<1s";const s=Math.floor(e/1e3);if(s<60)return"".concat(s,"s");const n=Math.floor(s/60),t=s%60;return t>0?"".concat(n,"m").concat(t,"s"):"".concat(n,"m")})(w)]})]})]})},Te=(e,s)=>{if(e.index!==s.index)return!1;if(e.isSelected!==s.isSelected)return!1;if(e.defaultModel!==s.defaultModel)return!1;if(e.onSelect!==s.onSelect)return!1;if(e.isBlocked!==s.isBlocked)return!1;if(e.costMetrics!==s.costMetrics){const n=e.costMetrics||{},t=s.costMetrics||{};if(n.cost!==t.cost)return!1;if(n.cellCostPct!==t.cellCostPct)return!1;if(n.costMultiplier!==t.costMultiplier)return!1;if(n.isOutlier!==t.isOutlier)return!1;if(n.speciesRunCount!==t.speciesRunCount)return!1;if(n.speciesAvgCost!==t.speciesAvgCost)return!1;if(n.duration!==t.duration)return!1;if(n.scale!==t.scale)return!1;if(n.color!==t.color)return!1}if(e.cell!==s.cell&&JSON.stringify(e.cell)!==JSON.stringify(s.cell))return!1;if(e.cellState!==s.cellState)if(e.cellState||s.cellState){if(!e.cellState||!s.cellState)return!1;if(JSON.stringify(e.cellState)!==JSON.stringify(s.cellState))return!1}else;return e.cellLogs===s.cellLogs||e.cellLogs.length===s.cellLogs.length},Ee=a.memo(Ae,Te);var Me=n(92805),Oe=n(58096),Le=n.n(Oe),Re=n(44658),Fe=n(55495),Pe=n.n(Fe);function ze(e){let{children:s}=e;a.useEffect(()=>{if(console.log("[AnsiRenderer] Raw input (first 200 chars):",null===s||void 0===s?void 0:s.substring(0,200)),console.log("[AnsiRenderer] Contains \\x1b?",null===s||void 0===s?void 0:s.includes("\x1b")),console.log("[AnsiRenderer] Contains \\u001b?",null===s||void 0===s?void 0:s.includes("\x1b")),s){const e=Pe().ansiToJson(s,{use_classes:!1});console.log("[AnsiRenderer] ansiToJson output (first 5):",e.slice(0,5));const n=Pe().ansiToHtml(s,{use_classes:!1});console.log("[AnsiRenderer] ansiToHtml output (first 200 chars):",n.substring(0,200))}},[s]);const n=a.useMemo(()=>{if(!s||"string"!==typeof s)return"";let e=s;e.includes("\\x1b")&&(console.log("[AnsiRenderer] Found escaped \\x1b codes, unescaping..."),e=e.replace(/\\x1b/g,"\x1b")),e.includes("\\u001b")&&(console.log("[AnsiRenderer] Found escaped \\u001b codes, unescaping..."),e=e.replace(/\\u001b/g,"\x1b")),e.includes("\\033")&&(console.log("[AnsiRenderer] Found escaped \\033 codes, unescaping..."),e=e.replace(/\\033/g,"\x1b")),e=e.replace(/\\n/g,"\n"),e=e.replace(/\\r/g,"\r"),e=e.replace(/\\t/g,"\t");let n=Pe().ansiToHtml(e,{use_classes:!1,remove_empty:!1});return n=n.replace(/ (?![^<]*>)/g,"&nbsp;"),n},[s]);return(0,x.jsx)("div",{className:"ansi-output",children:(0,x.jsx)("pre",{dangerouslySetInnerHTML:{__html:n}})})}const De=a.memo(ze),qe=(0,Me.A)(Le());function He(e){if(!e||"string"!==typeof e)return!1;if(e.trim().length<20)return!1;const s=[/^#{1,6}\s+.+$/m,/\*\*.+\*\*/,/\*.+\*/,/^[-*+]\s+.+$/m,/^\d+\.\s+.+$/m,/\[.+\]\(.+\)/,/^```/m,/^~~~/m,/^>\s+.+$/m,/\|.+\|/];let n=0;for(const t of s)t.test(e)&&n++;return n>=2}const Je=C.zl0.withParams({backgroundColor:"#000000",foregroundColor:"#cbd5e1",headerBackgroundColor:"#0a0510",headerTextColor:"#f0f4f8",oddRowBackgroundColor:"#050410",borderColor:"#1a1628",rowBorder:!0,headerFontSize:11,fontFamily:"'Google Sans Code', monospace",fontSize:12,accentColor:"#00e5ff"}),We=e=>{var s,n,l,i;let{result:o,error:c,images:r}=e;const[d,u]=(0,a.useState)(null),h=a.useMemo(()=>null!==o&&void 0!==o&&o.columns?o.columns.map(e=>({field:e,headerName:e,sortable:!0,filter:!0,resizable:!0,minWidth:80,flex:1})):[],[null===o||void 0===o?void 0:o.columns]),p=a.useMemo(()=>(null===o||void 0===o?void 0:o.rows)||[],[null===o||void 0===o?void 0:o.rows]);if(a.useEffect(()=>{console.log("[ResultRenderer] result type:",typeof o),console.log("[ResultRenderer] has rows?",null===o||void 0===o?void 0:o.rows),console.log("[ResultRenderer] has columns?",null===o||void 0===o?void 0:o.columns),console.log("[ResultRenderer] result:",o)},[o]),c){const e="string"===typeof c?c.replace(/\\n/g,"\n"):JSON.stringify(c,null,2);return(0,x.jsxs)("div",{className:"cell-detail-error",children:[(0,x.jsx)("span",{className:"cell-detail-error-label",children:"Error:"}),(0,x.jsx)("pre",{className:"cell-detail-error-message",children:e})]})}if(r&&r.length>0)return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"cell-detail-images",children:[r.map((e,s)=>{const n="string"===typeof e?e:"";if(!n)return null;const t=n.startsWith("http")?n:"".concat(m.J).concat(n);return(0,x.jsx)("div",{className:"cell-detail-image",children:(0,x.jsx)("img",{src:t,alt:"Output ".concat(s+1),style:{maxWidth:"100%",height:"auto",borderRadius:"4px",cursor:"pointer"},onClick:()=>u({url:t,path:n}),title:"Click to view full size",onError:e=>{console.error("[ResultRenderer] Image load failed:",t),e.target.style.display="none"}})},s)}),o&&(0,x.jsxs)("div",{style:{marginTop:"12px",paddingTop:"12px",borderTop:"1px solid rgba(255,255,255,0.1)"},children:[(0,x.jsx)("div",{style:{fontSize:"11px",color:"rgba(255,255,255,0.5)",marginBottom:"8px"},children:"Additional Output:"}),"string"===typeof o&&(0,x.jsx)("pre",{style:{fontSize:"12px",color:"#cbd5e1"},children:o}),"object"===typeof o&&(null===o||void 0===o?void 0:o.rows)&&(0,x.jsxs)("div",{style:{fontSize:"11px",color:"#888"},children:[o.rows.length," rows returned"]})]})]}),(0,x.jsx)(ae.aF,{isOpen:!!d,onClose:()=>u(null),size:"full",closeOnBackdrop:!0,closeOnEscape:!0,className:"result-image-modal",children:d&&(0,x.jsxs)("div",{className:"result-modal-image-container",children:[(0,x.jsx)("div",{className:"result-modal-image-header",children:(0,x.jsx)("span",{className:"result-modal-image-title",children:d.path})}),(0,x.jsx)("div",{className:"result-modal-image-body",children:(0,x.jsx)("img",{src:d.url,alt:"Full size",className:"result-modal-image",onClick:()=>u(null)})})]})})]});if(null!==o&&void 0!==o&&o.rows&&null!==o&&void 0!==o&&o.columns)return(0,x.jsx)("div",{className:"cell-detail-grid",children:(0,x.jsx)(_.W6,{rowData:p,columnDefs:h,theme:Je,animateRows:!1,enableCellTextSelection:!0,headerHeight:36,rowHeight:28})});if("string"===typeof o){if(function(e){if(!e||"string"!==typeof e)return!1;const s=[/\x1b\[[0-9;]*m/,/\u001b\[[0-9;]*m/,/\x1b\[[0-9;]*[A-HJKSTfmsu]/,/\\x1b\[[0-9;]*m/,/\\u001b\[[0-9;]*m/,/\\033\[[0-9;]*m/].some(s=>s.test(e));return s&&(console.log("[isAnsi] Detected ANSI in text (first 100 chars):",e.substring(0,100)),console.log("[isAnsi] Has actual \\x1b?",e.includes("\x1b")),console.log("[isAnsi] Has escaped \\\\x1b?",e.includes("\\x1b"))),s}(o))return(0,x.jsx)("div",{className:"cell-detail-ansi",children:(0,x.jsx)(De,{children:o})});return He(o)?(0,x.jsx)("div",{className:"cell-detail-markdown",children:(0,x.jsx)(Re.A,{children:o})}):(0,x.jsx)("div",{className:"cell-detail-text",children:(0,x.jsx)(w.Ay,{height:"100%",language:"markdown",value:o,theme:S.TH,beforeMount:S.$B,options:{readOnly:!0,minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"off",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on",padding:{top:12,bottom:12}}})})}if("image"===(null===o||void 0===o?void 0:o.type)&&(null!==o&&void 0!==o&&o.api_url||null!==o&&void 0!==o&&o.base64)){const e=o.api_url||"data:image/".concat(o.format||"png",";base64,").concat(o.base64),s=o.content||"Generated output";return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{className:"cell-detail-image",children:[(0,x.jsx)("img",{src:e,alt:s,style:{maxWidth:"100%",height:"auto",cursor:"pointer"},onClick:()=>u({url:e,path:s}),title:"Click to view full size"}),o.width&&o.height&&(0,x.jsxs)("div",{className:"cell-detail-image-info",children:[o.width," \xd7 ",o.height]})]}),(0,x.jsx)(ae.aF,{isOpen:!!d,onClose:()=>u(null),size:"full",closeOnBackdrop:!0,closeOnEscape:!0,className:"result-image-modal",children:d&&(0,x.jsxs)("div",{className:"result-modal-image-container",children:[(0,x.jsx)("div",{className:"result-modal-image-header",children:(0,x.jsx)("span",{className:"result-modal-image-title",children:d.path})}),(0,x.jsx)("div",{className:"result-modal-image-body",children:(0,x.jsx)("img",{src:d.url,alt:"Full size",className:"result-modal-image",onClick:()=>u(null)})})]})})]})}if("plotly"===(null===o||void 0===o?void 0:o.type)&&null!==o&&void 0!==o&&o.data)return(0,x.jsx)("div",{className:"cell-detail-plotly",children:(0,x.jsx)(qe,{data:JSON.parse(JSON.stringify(o.data)),layout:(0,t.A)((0,t.A)({},JSON.parse(JSON.stringify(o.layout||{}))),{},{paper_bgcolor:"#000000",plot_bgcolor:"#000000",font:{color:"#cbd5e1"},xaxis:{gridcolor:"#1a1628",zerolinecolor:"#1a1628"},yaxis:{gridcolor:"#1a1628",zerolinecolor:"#1a1628"}}),config:{responsive:!0,displayModeBar:!0},style:{width:"100%",height:"100%"}})});if(void 0!==(null===o||void 0===o?void 0:o.success)&&Array.isArray(null===o||void 0===o?void 0:o.images)){const e=o.images||[],s=o.dom_snapshots||[],n=(o.dom_coords,o.session_id),t=o.url,a=o.video;o.conversation_history;return(0,x.jsxs)("div",{className:"cell-detail-browser-result",children:[(0,x.jsxs)("div",{className:"browser-result-header",children:[n&&(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"Session:"}),(0,x.jsx)("span",{className:"browser-result-value",children:n})]}),t&&(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"URL:"}),(0,x.jsx)("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"browser-result-link",children:t})]}),(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"Status:"}),(0,x.jsx)("span",{className:"browser-result-value",style:{color:o.success?"#34d399":"#f87171"},children:o.success?"Success":"Failed"})]})]}),e.length>0&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsxs)("h4",{className:"browser-result-section-title",children:["Screenshots (",e.length,")"]}),(0,x.jsx)("div",{className:"browser-result-thumbnails",children:e.map((e,s)=>{const n="string"===typeof e&&e.startsWith("data:")?e:"".concat(m.J).concat(e);return(0,x.jsxs)("div",{className:"browser-result-thumbnail",onClick:()=>u({url:n,path:"Screenshot ".concat(s+1)}),title:"Screenshot ".concat(s+1),children:[(0,x.jsx)("img",{src:n,alt:"Screenshot ".concat(s+1)}),(0,x.jsxs)("span",{className:"browser-result-thumbnail-label",children:["Screenshot ",s+1]})]},s)})})]}),s.length>0&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsxs)("h4",{className:"browser-result-section-title",children:["DOM Snapshots (",s.length,")"]}),(0,x.jsx)("div",{className:"browser-result-dom-snapshots",children:s.map((e,s)=>(0,x.jsxs)("details",{className:"browser-result-dom-detail",children:[(0,x.jsxs)("summary",{children:["DOM Snapshot ",s+1]}),(0,x.jsx)("pre",{className:"browser-result-dom-content",children:e})]},s))})]}),a&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsx)("h4",{className:"browser-result-section-title",children:"Video Recording"}),(0,x.jsx)("a",{href:"".concat(m.J,"/api/browser-media/").concat(a),target:"_blank",rel:"noopener noreferrer",className:"browser-result-video-link",children:"Download Video"})]}),(0,x.jsx)(ae.aF,{isOpen:!!d,onClose:()=>u(null),size:"full",closeOnBackdrop:!0,closeOnEscape:!0,className:"result-image-modal",children:d&&(0,x.jsxs)("div",{className:"result-modal-image-container",children:[(0,x.jsx)("div",{className:"result-modal-image-header",children:(0,x.jsx)("span",{className:"result-modal-image-title",children:d.path})}),(0,x.jsx)("div",{className:"result-modal-image-body",children:(0,x.jsx)("img",{src:d.url,alt:"Full size",className:"result-modal-image",onClick:()=>u(null)})})]})})]})}if(null!==o&&void 0!==o&&o.screenshots||null!==o&&void 0!==o&&o.dom_snapshots||null!==o&&void 0!==o&&null!==(s=o.artifacts)&&void 0!==s&&s.basePath){const e=o.screenshots||[],s=o.dom_snapshots||[],n=o.video_path,t=o.session_id;o.client_id,o.test_id;return(0,x.jsxs)("div",{className:"cell-detail-browser-result",children:[(0,x.jsxs)("div",{className:"browser-result-header",children:[(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"Session:"}),(0,x.jsx)("span",{className:"browser-result-value",children:t})]}),o.url&&(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"URL:"}),(0,x.jsx)("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"browser-result-link",children:o.url})]}),(0,x.jsxs)("div",{className:"browser-result-info",children:[(0,x.jsx)("span",{className:"browser-result-label",children:"Commands:"}),(0,x.jsx)("span",{className:"browser-result-value",children:o.command_count||0})]})]}),e.length>0&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsxs)("h4",{className:"browser-result-section-title",children:["Screenshots (",e.length,")"]}),(0,x.jsx)("div",{className:"browser-result-thumbnails",children:e.map((e,s)=>{const n=e.path?"".concat(m.J,"/api/browser-media/").concat(e.path):e.full_path;return(0,x.jsxs)("div",{className:"browser-result-thumbnail",onClick:()=>u({url:n,path:e.name}),title:e.name,children:[(0,x.jsx)("img",{src:n,alt:e.name}),(0,x.jsx)("span",{className:"browser-result-thumbnail-label",children:e.name})]},s)})})]}),s.length>0&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsxs)("h4",{className:"browser-result-section-title",children:["DOM Snapshots (",s.length,")"]}),(0,x.jsx)("div",{className:"browser-result-pills",children:s.map((e,s)=>(0,x.jsx)("a",{href:"".concat(m.J,"/api/browser-media/").concat(e.path),target:"_blank",rel:"noopener noreferrer",className:"browser-result-pill",title:e.name,children:e.name},s))})]}),n&&(0,x.jsxs)("div",{className:"browser-result-section",children:[(0,x.jsx)("h4",{className:"browser-result-section-title",children:"Video Recording"}),(0,x.jsx)("a",{href:"".concat(m.J,"/api/browser-media/").concat(n),target:"_blank",rel:"noopener noreferrer",className:"browser-result-video-link",children:"Download Video"})]}),(0,x.jsx)(ae.aF,{isOpen:!!d,onClose:()=>u(null),size:"full",closeOnBackdrop:!0,closeOnEscape:!0,className:"result-image-modal",children:d&&(0,x.jsxs)("div",{className:"result-modal-image-container",children:[(0,x.jsx)("div",{className:"result-modal-image-header",children:(0,x.jsx)("span",{className:"result-modal-image-title",children:d.path})}),(0,x.jsx)("div",{className:"result-modal-image-body",children:(0,x.jsx)("img",{src:d.url,alt:"Full size",className:"result-modal-image",onClick:()=>u(null)})})]})})]})}if(null!==o&&void 0!==o&&null!==(n=o.result)&&void 0!==n&&null!==(l=n.lineage)&&void 0!==l&&null!==(i=l[0])&&void 0!==i&&i.output){const e=o.result.lineage[0].output,s="string"===typeof e?e:JSON.stringify(e,null,2);return He(s)?(0,x.jsx)("div",{className:"cell-detail-markdown",children:(0,x.jsx)(Re.A,{children:s})}):(0,x.jsx)("div",{className:"cell-detail-text",children:(0,x.jsx)(w.Ay,{height:"100%",language:"markdown",value:s,theme:S.TH,beforeMount:S.$B,options:{readOnly:!0,minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"off",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on",padding:{top:12,bottom:12}}})})}return void 0!==(null===o||void 0===o?void 0:o.result)?(0,x.jsx)("div",{className:"cell-detail-json",children:(0,x.jsx)(w.Ay,{height:"100%",language:"json",value:JSON.stringify(o.result,null,2),theme:S.TH,beforeMount:S.$B,options:{readOnly:!0,minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"off",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on"}})}):null};var Be=n(19122),Ue=n(92667);const Ke=[];var Ve;(Ve={id:"browser-recorder",label:"Browser Recorder",icon:"mdi:record-circle",match:e=>{if("browser"===(null===e||void 0===e?void 0:e.tool))return!0;if("linux_shell"===(null===e||void 0===e?void 0:e.tool)||"linux_shell_dangerous"===(null===e||void 0===e?void 0:e.tool)){var s;const n=(null===e||void 0===e||null===(s=e.inputs)||void 0===s?void 0:s.command)||"",t=n.includes("lars browser batch")&&n.includes("--commands"),a=n.includes("npx rabbitize")&&n.includes("--batch-commands");return t||a}return!1},component:function(e){let{cell:s,onChange:n,cellName:l}=e;const i=e=>{if(Array.isArray(e))return e;const s=Object.keys(e)[0],n=e[s];switch(s){case"wait":return[":wait",n];case"screenshot":return[":screenshot"];case"move":case"move_mouse":return[":move-mouse",":to",n.x||0,n.y||0];case"click":return[":click"];case"double_click":return[":double-click"];case"right_click":return[":right-click"];case"type":case"text":return[":type","object"===typeof n?n.text:n];case"keypress":case"key":return[":keypress",n];case"scroll_down":return[":scroll-wheel-down","number"===typeof n?n:3];case"scroll_up":return[":scroll-wheel-up","number"===typeof n?n:3];case"url":case"navigate":case"goto":return[":url",n];default:return[":".concat(s),n]}},{initialUrl:o,commands:r}=(e=>{var s;if("browser"===(null===e||void 0===e?void 0:e.tool)&&null!==e&&void 0!==e&&e.inputs){const s=e.inputs,n=s.url||"https://example.com";let t=[];return s.actions&&Array.isArray(s.actions)?t=s.actions.map(e=>i(e)):s.commands&&Array.isArray(s.commands)&&(t=s.commands),{initialUrl:n,commands:t,clientId:null,testId:null}}const n=(null===e||void 0===e||null===(s=e.inputs)||void 0===s?void 0:s.command)||"",t=n.match(/--url\s+"([^"]+)"/)||n.match(/--batch-url\s+"([^"]+)"/),a=t?t[1]:"https://example.com",l=n.match(/--commands='(\[[\s\S]*?\])'/)||n.match(/--batch-commands='(\[[\s\S]*?\])'/);let o=[];if(l)try{o=JSON.parse(l[1])}catch(u){console.error("Failed to parse batch commands:",u)}const c=n.match(/--client-id\s+"([^"]+)"/),r=c?c[1]:null,d=n.match(/--test-id\s+"([^"]+)"/);return{initialUrl:a,commands:o,clientId:r,testId:d?d[1]:null}})(s),d="studio_recorder",u=l||"browser",[h,p]=(0,a.useState)(!1),[,v]=(0,a.useState)(null),[g,j]=(0,a.useState)(null),[f,y]=(0,a.useState)(""),[b,N]=(0,a.useState)(null),[w,S]=(0,a.useState)(o),[k,_]=(0,a.useState)(o),[C,I]=(0,a.useState)(r),[A,T]=(0,a.useState)({x:0,y:0}),[E,M]=(0,a.useState)(null),[O,L]=(0,a.useState)(!1),[R,F]=(0,a.useState)(!1),[P,z]=(0,a.useState)(null),D=(0,a.useRef)(null),q={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_API_URL||m.J,H=(0,a.useCallback)((e,a)=>{const l=e.map(e=>(e=>{if(!Array.isArray(e)||0===e.length)return null;switch(e[0]){case":wait":return{wait:e[1]||1};case":screenshot":return{screenshot:{}};case":move-mouse":return{move:{x:e[2]||0,y:e[3]||0}};case":click":return{click:{}};case":double-click":return{double_click:{}};case":right-click":return{right_click:{}};case":type":return{type:{text:(":text"===e[1]?e[2]:e[1])||""}};case":keypress":case":key":return{keypress:e[1]||""};case":scroll-wheel-down":return{scroll_down:e[1]||3};case":scroll-wheel-up":return{scroll_up:e[1]||3};case":url":case":navigate":return{navigate:e[1]||e[2]||""};default:return null}})(e)).filter(e=>null!==e),i=(0,t.A)((0,t.A)({},s),{},{tool:"browser",inputs:{url:a||k,actions:l.length>0?l:[{wait:1},{screenshot:{}}]}});i.inputs.command&&delete i.inputs.command,n(i)},[s,n,k]),J=(0,a.useCallback)(async e=>{if(!e)return;L(!0),z(null);const s="studio_recorder_".concat(l,"_").concat(Date.now());try{const n=await fetch("".concat(q,"/api/rabbitize/session/start"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,clientId:d,testId:u,dashboard_session_id:s})}),t=await n.json();if(!n.ok||!t.success)throw new Error(t.error||"Failed to start session");p(!0),v(t.sessionId),j(s),y("".concat(t.clientId,"/").concat(t.testId,"/").concat(t.sessionId)),N(t.port),_(e),H(C,e)}catch(n){z(n.message||"Failed to start session")}finally{L(!1)}},[q,l,d,u,C,H]),W=(0,a.useCallback)(async()=>{if(h){try{await fetch("".concat(q,"/api/rabbitize/session/end"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dashboard_session_id:g})})}catch(e){console.error("Error ending session:",e)}p(!1),v(null),j(null),N(null),y("")}},[h,q,g]),B=(0,a.useCallback)(async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(h){F(!0);try{const n=((e,s)=>{switch(e){case":click":return[":click"];case":right-click":return[":right-click",":at",s.x,s.y];case":move-mouse":return[":move-mouse",":to",s.x,s.y];case":type":return[":type",":text",s.text];case":key":return[":key",s.key];case":scroll":return[":scroll","up"===s.direction?":up":":down",s.amount];case":wait":return[":wait",s.ms];case":screenshot":return[":screenshot"];case":navigate":return[":navigate",":to",s.url];case":scroll-wheel-down":return[":scroll-wheel-down",s.amount];case":scroll-wheel-up":return[":scroll-wheel-up",s.amount];default:return[e,...Object.values(s)]}})(e,s),t=await fetch("".concat(q,"/api/rabbitize/session/execute"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:n,dashboard_session_id:g})}),a=await t.json();if(a.error)throw new Error(a.error);const l=[...C,n];I(l),H(l,k)}catch(n){z(n.message)}finally{F(!1)}}},[h,q,g,C,k,H]);return(0,a.useEffect)(()=>()=>{h&&W()},[]),(0,x.jsxs)("div",{className:"rabbitize-recorder-editor",children:[(0,x.jsx)("div",{className:"recorder-header",children:h?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("span",{className:"current-url",children:[(0,x.jsx)(c.In,{icon:"mdi:web",width:"16"}),k]}),(0,x.jsxs)("button",{className:"stop-btn",onClick:W,children:[(0,x.jsx)(c.In,{icon:"mdi:stop",width:"16"}),"Stop"]})]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("input",{type:"url",className:"url-input",value:w,onChange:e=>S(e.target.value),placeholder:"Enter URL to start recording...",disabled:O}),(0,x.jsxs)("button",{className:"start-btn",onClick:()=>J(w),disabled:!w||O,children:[(0,x.jsx)(c.In,{icon:O?"mdi:loading":"mdi:play",width:"16",className:O?"spin":""}),O?"Starting...":"Start Recording"]})]})}),P&&(0,x.jsxs)("div",{className:"error-banner",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"16"}),P,(0,x.jsx)("button",{onClick:()=>z(null),children:(0,x.jsx)(c.In,{icon:"mdi:close",width:"14"})})]}),(0,x.jsxs)("div",{className:"recorder-content",children:[(0,x.jsxs)("div",{className:"browser-panel",children:[(0,x.jsx)("div",{className:"browser-viewport",onClick:e=>{if(!h||!D.current)return;const s=D.current,n=s.getBoundingClientRect(),t=s.parentElement.getBoundingClientRect(),a=s.naturalWidth||n.width,l=s.naturalHeight||n.height,i=a/l;let o,c,r,d;n.width/n.height>i?(c=n.height,o=i*c,r=(n.width-o)/2,d=0):(o=n.width,c=o/i,r=0,d=(n.height-c)/2);const u=e.clientX-n.left-r,m=e.clientY-n.top-d,p=a/o,x=l/c,v=Math.round(u*p),g=Math.round(m*x),j=e.clientX-t.left,f=e.clientY-t.top;M({x:v,y:g,displayX:Math.round(j),displayY:Math.round(f)})},onMouseMove:e=>{if(!D.current)return;const s=D.current,n=s.getBoundingClientRect(),t=s.naturalWidth||n.width,a=s.naturalHeight||n.height,l=t/a;let i,o,c,r;n.width/n.height>l?(o=n.height,i=l*o,c=(n.width-i)/2,r=0):(i=n.width,o=i/l,c=0,r=(n.height-o)/2);const d=e.clientX-n.left-c,u=e.clientY-n.top-r,m=t/i,h=a/o,p=Math.round(d*m),x=Math.round(u*h);T({x:Math.max(0,p),y:Math.max(0,x)})},children:h?(0,x.jsxs)("div",{className:"stream-container",children:[(0,x.jsx)("img",{ref:D,src:"".concat(q,"/api/rabbitize/stream/").concat(g,"/").concat(f),alt:"Browser Stream",className:"browser-stream"}),E&&(0,x.jsx)("div",{className:"position-marker",style:{left:E.displayX||E.x,top:E.displayY||E.y}})]}):(0,x.jsxs)("div",{className:"viewport-placeholder",children:[(0,x.jsx)(c.In,{icon:"mdi:web",width:"60"}),(0,x.jsx)("h3",{children:"Ready to Record"}),(0,x.jsx)("p",{children:"Enter a URL above and click Start Recording"})]})}),h&&(0,x.jsxs)("div",{className:"coordinates-bar",children:[(0,x.jsxs)("span",{children:[(0,x.jsx)(c.In,{icon:"mdi:crosshairs",width:"14"}),"(",A.x,", ",A.y,")"]}),E&&(0,x.jsxs)("span",{className:"selected",children:[(0,x.jsx)(c.In,{icon:"mdi:target",width:"14"}),"Selected: (",E.x,", ",E.y,")"]})]})]}),(0,x.jsxs)("div",{className:"recorder-sidebar",children:[(0,x.jsxs)("div",{className:"command-palette",children:[(0,x.jsxs)("h4",{children:[(0,x.jsx)(c.In,{icon:"mdi:palette",width:"16"}),"Commands"]}),(0,x.jsxs)("div",{className:"command-buttons",children:[(0,x.jsxs)("button",{onClick:()=>{B(":click",{})},disabled:!h||R,title:"Click (assumes mouse already positioned)",children:[(0,x.jsx)(c.In,{icon:"mdi:cursor-default-click",width:"14"}),"Click"]}),(0,x.jsxs)("button",{onClick:()=>{E&&B(":right-click",{x:E.x,y:E.y})},disabled:!h||!E||R,title:"Right click at position",children:[(0,x.jsx)(c.In,{icon:"mdi:cursor-default-click-outline",width:"14"}),"Right Click"]}),(0,x.jsxs)("button",{onClick:()=>{E&&B(":move-mouse",{x:E.x,y:E.y})},disabled:!h||!E||R,title:"Move mouse to position",children:[(0,x.jsx)(c.In,{icon:"mdi:cursor-default",width:"14"}),"Move Mouse"]}),(0,x.jsxs)("button",{onClick:()=>{B(":scroll-wheel-down",{amount:5})},disabled:!h||R,title:"Scroll down",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-down",width:"14"}),"Scroll Down"]}),(0,x.jsxs)("button",{onClick:()=>{B(":scroll-wheel-up",{amount:5})},disabled:!h||R,title:"Scroll up",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-up",width:"14"}),"Scroll Up"]}),(0,x.jsxs)("button",{onClick:()=>{const e=prompt("Enter text to type:");e&&B(":type",{text:e})},disabled:!h||R,title:"Type text",children:[(0,x.jsx)(c.In,{icon:"mdi:keyboard",width:"14"}),"Type"]}),(0,x.jsxs)("button",{onClick:()=>{const e=prompt("Navigate to URL:",k);e&&(B(":navigate",{url:e}),_(e))},disabled:!h||R,title:"Navigate to URL",children:[(0,x.jsx)(c.In,{icon:"mdi:link-variant",width:"14"}),"Navigate"]})]})]}),(0,x.jsxs)("div",{className:"command-history",children:[(0,x.jsxs)("div",{className:"history-header",children:[(0,x.jsxs)("h4",{children:[(0,x.jsx)(c.In,{icon:"mdi:history",width:"16"}),"History (",C.length,")"]}),(0,x.jsxs)("div",{className:"history-actions",children:[(0,x.jsx)("button",{onClick:()=>{if(0===C.length)return;const e=C.slice(0,-1);I(e),H(e,k)},disabled:0===C.length,title:"Undo last",children:(0,x.jsx)(c.In,{icon:"mdi:undo",width:"16"})}),(0,x.jsx)("button",{onClick:()=>{I([]),H([],k)},disabled:0===C.length,title:"Clear all",children:(0,x.jsx)(c.In,{icon:"mdi:delete-sweep",width:"16"})})]})]}),(0,x.jsx)("div",{className:"command-list",children:0===C.length?(0,x.jsxs)("div",{className:"empty-history",children:[(0,x.jsx)(c.In,{icon:"mdi:script-text-outline",width:"24"}),(0,x.jsx)("p",{children:"No commands yet"})]}):C.map((e,s)=>(0,x.jsxs)("div",{className:"command-item",children:[(0,x.jsx)("span",{className:"command-index",children:s+1}),(0,x.jsx)("code",{className:"command-text",children:JSON.stringify(e)}),(0,x.jsx)("button",{className:"remove-btn",onClick:()=>(e=>{const s=C.filter((s,n)=>n!==e);I(s),H(s,k)})(s),title:"Remove",children:(0,x.jsx)(c.In,{icon:"mdi:close",width:"12"})})]},s))})]})]})]})]})}}).id&&Ve.label&&Ve.match&&Ve.component?Ke.find(e=>e.id===Ve.id)?console.warn('Cell editor with id "'.concat(Ve.id,'" already registered, skipping')):Ke.push(Ve):console.error("Invalid cell editor registration:",Ve);const $e=500,Ge="/api/spec/validate";const Ye=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{enabled:n=!0,debounceMs:t=$e,cellMode:l=!1,cascadeContext:i=null}=s,[o,c]=(0,a.useState)(!1),[r,d]=(0,a.useState)({valid:!0,issues:[],parseError:null}),u=(0,a.useRef)(null),m=(0,a.useRef)(null),h=(0,a.useCallback)(async e=>{if(!e||!n)return void d({valid:!0,issues:[],parseError:null});m.current&&m.current.abort(),m.current=new AbortController,c(!0);const s=l||function(e){if(!e||"string"!==typeof e)return!1;const s=/^cascade_id\s*:/m.test(e),n=/^cells\s*:/m.test(e),t=/^name\s*:/m.test(e),a=/^instructions\s*:/m.test(e),l=/^tool\s*:/m.test(e);return!s&&!n&&t&&(a||l)}(e);try{let n;if(s&&i)n=await fetch("/api/spec/validate-cell",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cell_yaml:e,cascade_context:{cell_names:i.cellNames||[],cascade_id:i.cascadeId||"_temp"}}),signal:m.current.signal});else if(s){const s="cascade_id: _validation_temp\ncells:\n  - ".concat(e.split("\n").join("\n    "),"\n");n=await fetch(Ge,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cascade_yaml:s}),signal:m.current.signal})}else n=await fetch(Ge,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cascade_yaml:e}),signal:m.current.signal});if(!n.ok)throw new Error("HTTP ".concat(n.status));const t=await n.json();d({valid:t.valid,issues:t.issues||[],parseError:t.parse_error||null})}catch(t){if("AbortError"===t.name)return;console.error("Validation error:",t),d({valid:!1,issues:[],parseError:"Validation API error: ".concat(t.message)})}finally{c(!1)}},[n,l,i]);(0,a.useEffect)(()=>{if(n)return u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{h(e)},t),()=>{u.current&&clearTimeout(u.current)}},[e,h,t,n]),(0,a.useEffect)(()=>()=>{m.current&&m.current.abort()},[]);const p=r.issues.filter(e=>"error"===e.level),x=r.issues.filter(e=>"warning"===e.level),v=r.issues.filter(e=>"suggestion"===e.level);return{isValidating:o,isValid:r.valid,parseError:r.parseError,errors:p,warnings:x,suggestions:v,issues:r.issues,errorCount:p.length,warningCount:x.length}};function Qe(e){let{issue:s,onClick:n}=e;const t=function(e){switch(e){case"error":return{icon:"mdi:alert-circle",color:"#f87171",label:"Error"};case"warning":return{icon:"mdi:alert",color:"#fbbf24",label:"Warning"};case"suggestion":return{icon:"mdi:lightbulb",color:"#60a5fa",label:"Suggestion"};default:return{icon:"mdi:information",color:"#888",label:"Info"}}}(s.level);return(0,x.jsxs)("div",{className:"validation-issue validation-issue-".concat(s.level),onClick:()=>null===n||void 0===n?void 0:n(s),title:s.fix_hint||s.message,children:[(0,x.jsx)(c.In,{icon:t.icon,width:"14",style:{color:t.color}}),(0,x.jsx)("span",{className:"issue-code",children:s.code}),(0,x.jsx)("span",{className:"issue-message",children:s.message}),s.cell_name&&(0,x.jsx)("span",{className:"issue-cell",children:s.cell_name})]})}const Xe=function(e){let{errors:s=[],warnings:n=[],suggestions:t=[],isValidating:l=!1,parseError:i=null,onIssueClick:o,collapsed:r=!1}=e;const[d,u]=a.useState(r),m=s.length+n.length+t.length,h=s.length>0,p=n.length>0;return i||0!==m||l?(0,x.jsxs)("div",{className:"validation-panel ".concat(d?"collapsed":""),children:[(0,x.jsxs)("div",{className:"validation-header",onClick:()=>u(!d),children:[(0,x.jsx)("div",{className:"validation-summary",children:l?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:loading",width:"14",className:"spinning"}),(0,x.jsx)("span",{children:"Validating..."})]}):i?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"14",style:{color:"#f87171"}}),(0,x.jsx)("span",{children:"Parse Error"})]}):(0,x.jsxs)(x.Fragment,{children:[h&&(0,x.jsxs)("span",{className:"issue-count error-count",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),s.length]}),p&&(0,x.jsxs)("span",{className:"issue-count warning-count",children:[(0,x.jsx)(c.In,{icon:"mdi:alert",width:"12"}),n.length]}),!h&&!p&&0===m&&(0,x.jsxs)("span",{className:"validation-ok",children:[(0,x.jsx)(c.In,{icon:"mdi:check-circle",width:"14",style:{color:"#34d399"}}),"Valid"]})]})}),(0,x.jsx)(c.In,{icon:d?"mdi:chevron-down":"mdi:chevron-up",width:"16",className:"collapse-icon"})]}),!d&&(0,x.jsxs)("div",{className:"validation-issues",children:[i&&(0,x.jsxs)("div",{className:"validation-issue validation-issue-error parse-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"14",style:{color:"#f87171"}}),(0,x.jsx)("span",{className:"issue-message",children:i})]}),s.map((e,s)=>(0,x.jsx)(Qe,{issue:e,onClick:o},"error-".concat(s))),n.map((e,s)=>(0,x.jsx)(Qe,{issue:e,onClick:o},"warning-".concat(s))),t.map((e,s)=>(0,x.jsx)(Qe,{issue:e,onClick:o},"suggestion-".concat(s)))]})]}):null},Ze=e=>{if(!e)return null;if(e<1e3)return"<1s";const s=Math.floor(e/1e3),n=Math.floor(s/60),t=s%60;return 0===n?"".concat(s,"s"):0===t?"".concat(n,"m"):"".concat(n,"m ").concat(t,"s")},es=e=>{let{cell:s,index:n,cellState:l,cellLogs:r=[],allSessionLogs:d=[],currentSessionId:u=null,onClose:h,onMessageClick:v,hoveredHash:g=null,onHoverHash:j,externalSelectedMessage:f=null}=e;const{updateCell:y,removeCell:b,desiredOutputTab:N,setDesiredOutputTab:k,isRunningAll:_,cascadeSessionId:C,viewMode:I,cascade:A}=(0,p.A)(),[T,E]=(0,a.useState)("code"),[M,O]=(0,a.useState)("output"),[L,F]=(0,a.useState)(!1),[P,z]=(0,a.useState)(!1),[D,q]=(0,a.useState)(""),[H,J]=(0,a.useState)(null),[W,B]=(0,a.useState)(!1),[U,K]=(0,a.useState)(null),V=(0,a.useRef)(""),[$,G]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-cell-editor-results-split");return e?JSON.parse(e):[60,40]}catch(e){return[60,40]}}),[Y,Q]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-cell-code-yaml-split");return e?JSON.parse(e):[60,40]}catch(e){return[60,40]}}),X=(0,a.useCallback)(e=>{G(e);try{localStorage.setItem("studio-cell-editor-results-split",JSON.stringify(e))}catch(s){console.warn("Failed to save split sizes to localStorage:",s)}},[]),Z=(0,a.useCallback)(e=>{Q(e);try{localStorage.setItem("studio-cell-code-yaml-split",JSON.stringify(e))}catch(s){console.warn("Failed to save split sizes to localStorage:",s)}},[]),ee=(0,a.useRef)(null),se=(0,a.useRef)(null),ne=(0,a.useRef)(!1),te=(0,a.useMemo)(()=>A&&A.cells?{cellNames:A.cells.map(e=>e.name),cascadeId:A.cascade_id||"_temp"}:null,[A]),le=Ye(D,{enabled:L&&D.length>0,cellMode:!0,cascadeContext:te});a.useEffect(()=>{N&&(O(N),k(null))},[N,k]);const{setNodeRef:ie,isOver:oe}=(0,i.zM)({id:"editor-drop-".concat(s.name),data:{type:"monaco-editor"}}),{setNodeRef:ce,isOver:re}=(0,i.zM)({id:"yaml-editor-drop-".concat(s.name),data:{type:"monaco-editor"}});a.useEffect(()=>()=>{if(ee.current)try{ee.current.dispose()}catch(e){}if(se.current)try{se.current.dispose()}catch(e){}},[]);s.tool,s.tool,s.tool,s.tool;const de="lars_data"===s.tool,ue=!!s.hitl,me=!s.tool&&!s.hitl&&s.instructions,he={sql_data:{language:"sql",codeKey:"query",source:"inputs"},python_data:{language:"python",codeKey:"code",source:"inputs"},js_data:{language:"javascript",codeKey:"code",source:"inputs"},clojure_data:{language:"clojure",codeKey:"code",source:"inputs"},llm_cell:{language:"markdown",codeKey:"instructions",source:"cell"},lars_data:{language:"yaml",codeKey:"code",source:"inputs"},bodybuilder:{language:"markdown",codeKey:"request",source:"inputs"},browser:{language:"yaml",codeKey:"inputs",source:"inputs_yaml"},linux_shell:{language:"shell",codeKey:"command",source:"inputs"},linux_shell_dangerous:{language:"shell",codeKey:"command",source:"inputs"},hitl_screen:{language:"html",codeKey:"hitl",source:"cell"}},pe=s.tool||(ue?"hitl_screen":me?"llm_cell":"python_data"),xe=he[pe]||he.python_data,ve=(0,a.useMemo)(()=>function(e){return e?Ke.filter(s=>{try{return s.match(e)}catch(fe){return console.error('Error in match function for editor "'.concat(s.id,'":'),fe),!1}}):[]}(s),[s]),ge=ve.length>0,je=(0,a.useMemo)(()=>{var e;if("inputs_yaml"!==xe.source)return"inputs"===xe.source?(null===(e=s.inputs)||void 0===e?void 0:e[xe.codeKey])||"":s[xe.codeKey]||"";try{return s.inputs?R.Ay.dump(s.inputs,{indent:2,lineWidth:-1}):""}catch(n){return console.error("Failed to serialize inputs as YAML:",n),JSON.stringify(s.inputs,null,2)||""}},[s,xe.source,xe.codeKey]),fe=(null===l||void 0===l||l.status,null===l||void 0===l?void 0:l.error),ye=null===l||void 0===l?void 0:l.images;a.useEffect(()=>{console.log("[CellDetailPanel] Code extraction:",{cellName:s.name,cellTool:s.tool,cellType:pe,infoSource:xe.source,infoCodeKey:xe.codeKey,infoLanguage:xe.language,codeLength:(null===je||void 0===je?void 0:je.length)||0,hasInputs:!!s.inputs,inputsKeys:s.inputs?Object.keys(s.inputs):[],cellKeys:Object.keys(s)})},[s,pe,xe,je]),a.useEffect(()=>{(null!==l&&void 0!==l&&l.duration||null!==l&&void 0!==l&&l.cost||null!==l&&void 0!==l&&l.tokens_in)&&console.log("[CellDetailPanel]",s.name,"- Duration:",l.duration,"Cost:",l.cost,"Tokens:",l.tokens_in,"/",l.tokens_out)},[s.name,l]);const be=(0,a.useCallback)(e=>{const s=(e.options||[]).map(e=>'\n      <button\n        type="submit"\n        name="response[option]"\n        value="'.concat(e.id,'"\n        class="decision-option decision-option-').concat(e.style||"secondary",'"\n      >\n        <div class="decision-option-label">').concat(e.label,"</div>\n        ").concat(e.description?'<div class="decision-option-desc">'.concat(e.description,"</div>"):"","\n      </button>\n    ")).join("");return'\n      <div class="decision-card">\n        <div class="decision-header">\n          <h3>'.concat(e.question||"Decision Required","</h3>\n        </div>\n        ").concat(e.context?'\n          <div class="decision-context">\n            '.concat(e.context,"\n          </div>\n        "):"",'\n        <form hx-post="{{ api_endpoint }}" hx-headers=\'{"X-Checkpoint-ID": "{{ checkpoint_id }}"}\'>\n          <div class="decision-options">\n            ').concat(s,"\n          </div>\n        </form>\n      </div>\n      <style>\n        .decision-card {\n          max-width: 600px;\n          margin: 0 auto;\n          background: linear-gradient(135deg, #0f1821, #0a0e14);\n          border: 2px solid #f59e0b;\n          border-radius: 12px;\n          padding: 24px;\n        }\n        .decision-header h3 {\n          margin: 0 0 16px 0;\n          font-size: 18px;\n          font-weight: 700;\n          color: #fbbf24;\n        }\n        .decision-context {\n          padding: 12px 16px;\n          background-color: rgba(100, 116, 139, 0.1);\n          border-left: 3px solid #64748b;\n          border-radius: 6px;\n          margin-bottom: 20px;\n        }\n        .decision-options {\n          display: flex;\n          flex-direction: column;\n          gap: 12px;\n        }\n        .decision-option {\n          padding: 16px;\n          border-radius: 8px;\n          border: 2px solid #1a2028;\n          background-color: #0a0e14;\n          cursor: pointer;\n          transition: all 0.2s ease;\n          text-align: left;\n          width: 100%;\n        }\n        .decision-option:hover {\n          transform: translateY(-2px);\n        }\n        .decision-option-primary {\n          border-color: #2dd4bf;\n          background: linear-gradient(135deg, rgba(45, 212, 191, 0.15), rgba(20, 184, 166, 0.1));\n        }\n        .decision-option-primary:hover {\n          border-color: #14b8a6;\n          background: linear-gradient(135deg, rgba(45, 212, 191, 0.25), rgba(20, 184, 166, 0.15));\n          box-shadow: 0 4px 16px rgba(45, 212, 191, 0.4);\n        }\n        .decision-option-secondary {\n          border-color: #475569;\n        }\n        .decision-option-secondary:hover {\n          border-color: #64748b;\n          background-color: #0f1419;\n        }\n        .decision-option-danger {\n          border-color: #f87171;\n          background: linear-gradient(135deg, rgba(248, 113, 113, 0.15), rgba(239, 68, 68, 0.1));\n        }\n        .decision-option-danger:hover {\n          border-color: #ef4444;\n          box-shadow: 0 4px 16px rgba(248, 113, 113, 0.4);\n        }\n        .decision-option-label {\n          font-size: 15px;\n          font-weight: 600;\n          color: #f0f4f8;\n          margin-bottom: 4px;\n        }\n        .decision-option-desc {\n          font-size: 13px;\n          color: #94a3b8;\n        }\n      </style>\n    ")},[]),Ne=a.useMemo(()=>{if(!r||0===r.length)return null;const e={};let s=null;if(!r.some(e=>null!==e.take_index&&void 0!==e.take_index))return null;for(const i of r)null!==i.winning_take_index&&void 0!==i.winning_take_index&&(s=i.winning_take_index);for(const i of r){var n;if(!["user","assistant","tool","system"].includes(i.role))continue;const s=null!==(n=i.take_index)&&void 0!==n?n:"main";e[s]||(e[s]=[]);let o=i.content_json;if("string"===typeof o)try{o=JSON.parse(o)}catch(t){}let c=i.tool_calls_json;if("string"===typeof c)try{c=JSON.parse(c)}catch(a){}let r=i.images_json;if("string"===typeof r)try{r=JSON.parse(r)}catch(l){}e[s].push({role:i.role,node_type:i.node_type,turn_number:i.turn_number,content:o,tool_calls:c,duration_ms:i.duration_ms,cost:i.cost,tokens_in:i.tokens_in,tokens_out:i.tokens_out,model:i.model,timestamp:i.timestamp_iso,trace_id:i.trace_id,images:r,has_images:i.has_images,session_id:i.session_id})}return{grouped:e,winner:s}},[r]),we=a.useMemo(()=>r&&0!==r.length?r.filter(e=>["user","assistant","tool","system"].includes(e.role)).map(e=>{let s=e.content_json;if("string"===typeof s)try{s=JSON.parse(s)}catch(a){}let n=e.tool_calls_json;if("string"===typeof n)try{n=JSON.parse(n)}catch(l){}let t=e.images_json;if("string"===typeof t)try{t=JSON.parse(t)}catch(i){}return{role:e.role,node_type:e.node_type,turn_number:e.turn_number,content:s,tool_calls:n,duration_ms:e.duration_ms,cost:e.cost,tokens_in:e.tokens_in,tokens_out:e.tokens_out,model:e.model,timestamp:e.timestamp_iso,trace_id:e.trace_id,images:t,has_images:e.has_images,session_id:e.session_id}}):[],[r]),Se=null===l||void 0===l?void 0:l.result,ke=a.useMemo(()=>{if(!r||0===r.length)return null;const e=r.find(e=>"evaluator"===e.role);if(!e)return null;let s=e.content_json;if("string"===typeof s)try{s=JSON.parse(s)}catch(n){}return{content:s,timestamp:e.timestamp_iso,model:e.model}},[r]),_e=a.useMemo(()=>{const e=d.length>0?d:r;if(!e||0===e.length)return null;const s=e.find(e=>"checkpoint_waiting"===e.role);if(s){var n,t;console.log("[CellDetailPanel] Found checkpoint_waiting log in session logs");let e=s.metadata_json;if("string"===typeof e)try{e=JSON.parse(e)}catch(l){console.error("[CellDetailPanel] Failed to parse metadata_json:",l)}if(null!==(n=e)&&void 0!==n&&n.ui_spec&&null!==(t=e)&&void 0!==t&&t.checkpoint_id){var a;let s=e.ui_spec;if("string"===typeof s)try{s=JSON.parse(s)}catch(i){}return console.log("[CellDetailPanel] Using checkpoint ui_spec:",{checkpointId:e.checkpoint_id,hasHtml:null===(a=s.sections)||void 0===a?void 0:a.some(e=>"html"===e.type)}),{checkpointId:e.checkpoint_id,uiSpec:s,checkpointType:e.checkpoint_type,source:"checkpoint"}}}for(const c of r)if("assistant"===c.role&&c.content_json){let e=c.content_json;if("string"===typeof e)try{e=JSON.parse(e)}catch(o){}const s=("string"===typeof e?e:JSON.stringify(e)).match(/<decision>\s*([\s\S]*?)\s*<\/decision>/);if(s)try{const e=JSON.parse(s[1]);console.log("[CellDetailPanel] Found <decision> tag - building ui_spec");return{checkpointId:null,uiSpec:{sections:[{type:"html",content:be(e)}]},checkpointType:"decision",decisionData:e,source:"decision_tag"}}catch(l){console.error("[CellDetailPanel] Failed to parse <decision> JSON:",l)}}return null},[r,d,be]),Ce=a.useMemo(()=>{if(!r||0===r.length)return null;const e=r.find(e=>e.full_request_json);if(!e)return null;let s=e.full_request_json;if("string"===typeof s)try{s=JSON.parse(s)}catch(n){console.error("[CellDetailPanel] Failed to parse request JSON:",n)}return s},[r]);a.useEffect(()=>{Ne&&null!==Ne.winner&&O("take-".concat(Ne.winner))},[s.name,Ne]);const Ie=(0,a.useRef)(null);a.useEffect(()=>{if(!L)return;const e="".concat((null===te||void 0===te?void 0:te.cascadeId)||"","_").concat(s.name);if(Ie.current!==e){const n=R.Ay.dump(s,{indent:2,lineWidth:-1,noRefs:!0});q(n),V.current=n,Ie.current=e,J(null)}},[s,s.name,L,te]),a.useEffect(()=>{!L&&D&&(q(""),V.current="",Ie.current=null,J(null),ne.current=!1)},[L,D]),a.useEffect(()=>{if(!P&&D)try{const e=R.Ay.load(D);if(JSON.stringify(e)===JSON.stringify(s))return;const n=R.Ay.dump(s,{indent:2,lineWidth:-1,noRefs:!0});n!==V.current&&(console.log("[CellDetailPanel] Cell structure changed externally, regenerating YAML"),q(n),V.current=n)}catch(e){console.warn("[CellDetailPanel] Parse error in localYaml, regenerating:",e);const n=R.Ay.dump(s,{indent:2,lineWidth:-1,noRefs:!0});q(n),V.current=n}},[s,P,D]);const Ae=D,Te=(0,a.useCallback)(e=>{q(e);try{const s=e.split("\n").map(e=>"  "+e).join("\n"),n="cells:\n".concat(s),t=R.Ay.load(n);t&&t.cells&&"object"===typeof t.cells&&J(null)}catch(s){e.trim().length>0?J(s.message):J(null)}},[]),Ee=(0,a.useCallback)(e=>{if(console.log("[CellDetailPanel] YAML editor blurred, syncing to store"),e!==V.current)try{const s=R.Ay.load(e);if(!s||"object"!==typeof s)throw new Error("Invalid cell structure: must be an object");if(!s.name)throw new Error('Invalid cell: missing required field "name"');y(n,(0,t.A)({},s)),V.current=e,J(null),z(!1)}catch(s){J(s.message),console.debug("YAML parse/validation error on blur:",s.message),z(!1)}else z(!1)},[n,y]),Me=(0,a.useCallback)(e=>{if("inputs_yaml"===xe.source)try{const s=R.Ay.load(e);s&&"object"===typeof s&&y(n,{inputs:s})}catch(a){console.debug("YAML parse error (still typing):",a.message)}else"inputs"===xe.source?y(n,{inputs:(0,t.A)((0,t.A)({},s.inputs),{},{[xe.codeKey]:e})}):y(n,{[xe.codeKey]:e})},[n,s.inputs,xe.codeKey,xe.source,y]),Oe=a.useMemo(()=>{if(!_e)return!1;if("decision_tag"===_e.source)return console.log("[CellDetailPanel] Decision tag detected - no checkpoint to submit to, read-only"),!1;if("replay"===I)return!1;const e=null===r||void 0===r?void 0:r.some(e=>"checkpoint_responded"===e.role||"checkpoint_cancelled"===e.role),s="live"===I&&!e&&_e.checkpointId;return console.log("[CellDetailPanel] Decision live status:",{viewMode:I,hasResponse:e,isLive:s,checkpointId:_e.checkpointId,source:_e.source}),s},[_e,I,r]);return a.useEffect(()=>{_e&&(console.log("[CellDetailPanel] Setting active tab to decision"),O("decision"))},[s.name,_e]),a.useEffect(()=>{if("output"===M||"raw"===M||"request"===M)return;let e=!0;if("decision"!==M||_e)if("images"!==M||ye&&0!==ye.length)if("error"!==M||fe)if("messages"!==M||we&&0!==we.length){if(M.startsWith("take-")){const s=M.replace("take-","");Ne&&Ne.grouped[s]||(e=!1)}}else e=!1;else e=!1;else e=!1;else e=!1;e||(console.log("[CellDetailPanel] Tab invalid for new cell, resetting:",M,"\u2192 output"),O("output"))},[s.name,M,_e,ye,fe,we,Ne]),(0,x.jsxs)("div",{className:"cell-detail-panel",children:[(0,x.jsxs)("div",{className:"cell-detail-header",children:[(0,x.jsxs)("div",{className:"cell-detail-header-left",children:[(0,x.jsx)("input",{className:"cell-detail-name-input",value:s.name,onChange:e=>{y(n,{name:e.target.value})},placeholder:"cell_name"}),(0,x.jsxs)("span",{className:"cell-detail-index",children:["#",n+1]})]}),(0,x.jsxs)("div",{className:"cell-detail-header-center",children:[de&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("button",{className:"cell-detail-tab ".concat("code"===T?"active":""),onClick:()=>E("code"),children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"16"}),"Code"]}),(0,x.jsxs)("button",{className:"cell-detail-tab ".concat("config"===T?"active":""),onClick:()=>E("config"),children:[(0,x.jsx)(c.In,{icon:"mdi:cog",width:"16"}),"Config"]})]}),!de&&!ge&&(0,x.jsxs)("div",{className:"cell-detail-mode-label",children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"16"}),"Code Editor",(0,x.jsxs)("button",{className:"cell-detail-yaml-toggle ".concat(L?"active":""),onClick:()=>F(!L),title:L?"Hide YAML editor":"Show YAML editor",children:[(0,x.jsx)(c.In,{icon:"mdi:code-json",width:"14"}),"YAML"]})]}),!de&&ge&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("button",{className:"cell-detail-tab ".concat("code"===T?"active":""),onClick:()=>E("code"),children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"16"}),"Code"]}),ve.map(e=>(0,x.jsxs)("button",{className:"cell-detail-tab ".concat(T===e.id?"active":""),onClick:()=>E(e.id),children:[e.icon&&(0,x.jsx)(c.In,{icon:e.icon,width:"16"}),e.label,(0,x.jsx)("span",{className:"cell-detail-tab-badge",children:"Custom"})]},e.id)),(0,x.jsxs)("button",{className:"cell-detail-yaml-toggle ".concat(L?"active":""),onClick:()=>F(!L),title:L?"Hide YAML editor":"Show YAML editor",style:{marginLeft:"auto"},children:[(0,x.jsx)(c.In,{icon:"mdi:code-json",width:"14"}),"YAML"]})]})]}),(0,x.jsxs)("div",{className:"cell-detail-header-right",children:[(0,x.jsx)("button",{className:"cell-detail-btn cell-detail-btn-delete",onClick:()=>{B(!0)},children:(0,x.jsx)(c.In,{icon:"mdi:delete",width:"16"})}),(0,x.jsx)("button",{className:"cell-detail-btn cell-detail-btn-close",onClick:h,children:(0,x.jsx)(c.In,{icon:"mdi:close",width:"16"})})]})]}),(0,x.jsx)("div",{className:"cell-detail-body",children:"config"===T&&de?(0,x.jsx)("div",{className:"cell-detail-config",children:(0,x.jsxs)("div",{className:"cell-detail-config-section",children:[(0,x.jsx)("h4",{children:"LLM Configuration"}),(0,x.jsx)("p",{className:"cell-detail-placeholder",children:"Config UI coming soon: model selection, takes, wards, handoffs..."})]})}):(0,x.jsxs)(o.A,{className:"cell-detail-split",direction:"vertical",sizes:$,minSize:[100,100],gutterSize:6,gutterAlign:"center",onDragEnd:X,children:[(0,x.jsx)("div",{className:"cell-detail-code-container",children:ve.find(e=>e.id===T)?L?(0,x.jsxs)(o.A,{className:"cell-detail-code-yaml-split",direction:"horizontal",sizes:Y,minSize:[200,200],gutterSize:6,gutterAlign:"center",onDragEnd:Z,children:[(0,x.jsx)("div",{className:"cell-detail-custom-editor",children:a.createElement(ve.find(e=>e.id===T).component,{cell:s,onChange:e=>y(n,e),cellName:s.name})}),(0,x.jsxs)("div",{className:"cell-detail-yaml-section",children:[(0,x.jsxs)("div",{className:"cell-detail-yaml-header",children:[(0,x.jsx)(c.In,{icon:"mdi:file-code-outline",width:"14"}),(0,x.jsx)("span",{children:"Full Cell YAML"}),H&&(0,x.jsxs)("span",{className:"cell-yaml-error",title:H,children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),"Parse Error"]}),!H&&le.errorCount>0&&(0,x.jsxs)("span",{className:"cell-yaml-error",title:"".concat(le.errorCount," validation error(s)"),children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),le.errorCount," error",le.errorCount>1?"s":""]}),!H&&le.warningCount>0&&(0,x.jsxs)("span",{className:"cell-yaml-warning",title:"".concat(le.warningCount," warning(s)"),children:[(0,x.jsx)(c.In,{icon:"mdi:alert",width:"12"}),le.warningCount]}),(0,x.jsx)("span",{className:"cell-yaml-hint",children:"Auto-saves on blur"})]}),(0,x.jsx)("div",{className:"cell-detail-yaml-editor-wrapper",children:(0,x.jsx)(w.Ay,{height:"100%",language:"yaml",value:Ae,onChange:Te,theme:S.TH,beforeMount:S.$B,onMount:(e,s)=>{se.current=e,(0,S.JJ)(e,s),e.onDidFocusEditorText(()=>{ne.current=!0,z(!0)}),e.onDidBlurEditorText(()=>{if(!ne.current)return;const s=e.getValue();Ee(s)})},options:{minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"on",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on",automaticLayout:!0,scrollBeyondLastLine:!1,padding:{top:12,bottom:12}}},"yaml-".concat(s.name))}),(0,x.jsx)(Xe,{errors:le.errors,warnings:le.warnings,suggestions:le.suggestions,isValidating:le.isValidating,parseError:le.parseError,collapsed:!0})]})]}):(0,x.jsx)("div",{className:"cell-detail-custom-editor",children:a.createElement(ve.find(e=>e.id===T).component,{cell:s,onChange:e=>y(n,e),cellName:s.name})}):L?(0,x.jsxs)(o.A,{className:"cell-detail-code-yaml-split",direction:"horizontal",sizes:Y,minSize:[200,200],gutterSize:6,gutterAlign:"center",onDragEnd:Z,children:[(0,x.jsxs)("div",{ref:ie,className:"cell-detail-code-section ".concat(oe?"drop-active":""),children:[(0,x.jsxs)("div",{className:"cell-detail-code-header",children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"14"}),(0,x.jsx)("span",{children:"query"===xe.codeKey?"Query":"code"===xe.codeKey?"Code":"instructions"===xe.codeKey?"Instructions":"command"===xe.codeKey?"Command":"inputs"===xe.codeKey?"Inputs":xe.codeKey.charAt(0).toUpperCase()+xe.codeKey.slice(1)})]}),(0,x.jsx)("div",{className:"cell-detail-editor-wrapper",children:(0,x.jsx)(w.Ay,{height:"100%",language:xe.language,value:je,onChange:Me,theme:S.TH,beforeMount:S.$B,onMount:(e,s)=>{ee.current=e,window.__activeMonacoEditor=e,(0,S.JJ)(e,s)},options:{minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"on",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on",automaticLayout:!0,scrollBeyondLastLine:!1,padding:{top:12,bottom:12}}},"editor-".concat(s.name))})]}),(0,x.jsxs)("div",{ref:ce,className:"cell-detail-yaml-section ".concat(re?"drop-active":""),children:[(0,x.jsxs)("div",{className:"cell-detail-yaml-header",children:[(0,x.jsx)(c.In,{icon:"mdi:file-code-outline",width:"14"}),(0,x.jsx)("span",{children:"Full Cell YAML"}),H&&(0,x.jsxs)("span",{className:"cell-yaml-error",title:H,children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),"Parse Error"]}),!H&&le.errorCount>0&&(0,x.jsxs)("span",{className:"cell-yaml-error",title:"".concat(le.errorCount," validation error(s)"),children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),le.errorCount," error",le.errorCount>1?"s":""]}),!H&&le.warningCount>0&&(0,x.jsxs)("span",{className:"cell-yaml-warning",title:"".concat(le.warningCount," warning(s)"),children:[(0,x.jsx)(c.In,{icon:"mdi:alert",width:"12"}),le.warningCount]}),(0,x.jsx)("span",{className:"cell-yaml-hint",children:"Auto-saves on blur"})]}),(0,x.jsx)("div",{className:"cell-detail-editor-wrapper",children:(0,x.jsx)(w.Ay,{height:"100%",language:"yaml",value:Ae,onChange:Te,theme:S.TH,beforeMount:S.$B,onMount:(e,s)=>{se.current=e,window.__activeMonacoEditor=e,(0,S.JJ)(e,s),e.onDidFocusEditorText(()=>{ne.current=!0,z(!0),window.__activeMonacoEditor=e}),e.onDidBlurEditorText(()=>{if(!ne.current)return;const s=e.getValue();Ee(s)})},options:{minimap:{enabled:!1},fontSize:12,fontFamily:"'Google Sans Code', 'Menlo', monospace",lineNumbers:"off",renderLineHighlight:"line",renderLineHighlightOnlyWhenFocus:!0,wordWrap:"on",wrappingStrategy:"advanced",automaticLayout:!0,scrollBeyondLastLine:!1,folding:!0,foldingStrategy:"indentation",showFoldingControls:"mouseover",bracketPairColorization:{enabled:!0},guides:{indentation:!0,bracketPairs:!0},padding:{top:12,bottom:12},smoothScrolling:!0,cursorBlinking:"smooth",cursorSmoothCaretAnimation:"on"}},"yaml-".concat(s.name))}),(0,x.jsx)(Xe,{errors:le.errors,warnings:le.warnings,suggestions:le.suggestions,isValidating:le.isValidating,parseError:le.parseError,collapsed:!0})]})]}):(0,x.jsxs)("div",{ref:ie,className:"cell-detail-code-section ".concat(oe?"drop-active":""),children:[(0,x.jsxs)("div",{className:"cell-detail-code-header",children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"14"}),(0,x.jsx)("span",{children:"query"===xe.codeKey?"Query":"code"===xe.codeKey?"Code":"instructions"===xe.codeKey?"Instructions":"command"===xe.codeKey?"Command":xe.codeKey.charAt(0).toUpperCase()+xe.codeKey.slice(1)})]}),(0,x.jsx)("div",{className:"cell-detail-editor-wrapper",children:(0,x.jsx)(w.Ay,{height:"100%",language:xe.language,value:je,onChange:Me,theme:S.TH,beforeMount:S.$B,onMount:(e,s)=>{ee.current=e,window.__activeMonacoEditor=e,(0,S.JJ)(e,s)},options:{minimap:{enabled:!1},fontSize:13,fontFamily:"'Google Sans Code', monospace",lineNumbers:"on",wordWrap:"on",automaticLayout:!0,scrollBeyondLastLine:!1,padding:{top:12,bottom:12}}},"editor-".concat(s.name))})]})}),(0,x.jsxs)("div",{className:"cell-detail-results-section",children:[(0,x.jsxs)("div",{className:"cell-detail-results-header",children:[(0,x.jsxs)("div",{className:"cell-detail-results-header-left",children:[void 0!==(null===Se||void 0===Se?void 0:Se.row_count)&&(0,x.jsxs)("span",{className:"cell-detail-row-count",children:[Se.row_count," rows"]}),void 0!==(null===l||void 0===l?void 0:l.duration)&&null!==l.duration&&(0,x.jsxs)("span",{className:"cell-detail-duration",children:[(0,x.jsx)(c.In,{icon:"mdi:clock-outline",width:"12"}),Ze(l.duration)]}),(null===l||void 0===l?void 0:l.cost)>0&&(0,x.jsxs)("span",{className:"cell-detail-cost",children:[(0,x.jsx)(c.In,{icon:"mdi:currency-usd",width:"12"}),"$",l.cost<.01?"<0.01":l.cost.toFixed(4)]}),((null===l||void 0===l?void 0:l.tokens_in)>0||(null===l||void 0===l?void 0:l.tokens_out)>0)&&(0,x.jsxs)("span",{className:"cell-detail-tokens",children:[(0,x.jsx)(c.In,{icon:"mdi:dice-multiple",width:"12"}),l.tokens_in||0,"\u2193 ",l.tokens_out||0,"\u2191"]})]}),(0,x.jsxs)("div",{className:"cell-detail-results-tabs",children:[_e&&(console.log("[CellDetailPanel] Rendering Decision tab button"),(0,x.jsxs)("button",{className:"cell-detail-results-tab cell-detail-results-tab-decision ".concat("decision"===M?"active":""),onClick:()=>{console.log("[CellDetailPanel] Decision tab clicked"),O("decision")},title:Oe?"Human decision required (LIVE)":"Decision UI (replay)",children:[(0,x.jsx)(c.In,{icon:"mdi:hand-front-right",width:"14"}),"Decision",Oe&&(0,x.jsx)(c.In,{icon:"mdi:circle",width:"8",style:{color:"#ef4444",marginLeft:"4px"}})]})),(0,x.jsx)("button",{className:"cell-detail-results-tab ".concat("output"===M?"active":""),onClick:()=>O("output"),children:"Output"}),we.length>0&&(0,x.jsxs)("button",{className:"cell-detail-results-tab ".concat("messages"===M?"active":""),onClick:()=>O("messages"),children:[(0,x.jsx)(c.In,{icon:"mdi:message-processing",width:"14"}),"Messages (",we.length,")"]}),Ne&&Object.keys(Ne.grouped).sort().map(e=>{const s=parseInt(e)===Ne.winner||"main"===e,n=Ne.grouped[e].length;return"0"!==e&&"1"!==e||console.log("[CellDetailPanel] Tab",e,"- isWinner:",s,"winner:",Ne.winner,"parsed:",parseInt(e)),(0,x.jsxs)("button",{className:"cell-detail-results-tab ".concat(M==="take-".concat(e)?"active":""," ").concat(s?"winner":""),onClick:()=>O("take-".concat(e)),title:s?"Take ".concat(e," (WINNER - ").concat(n," messages)"):"Take ".concat(e," (").concat(n," messages)"),children:[s&&(0,x.jsx)(c.In,{icon:"mdi:crown",width:"14"}),(0,x.jsx)(c.In,{icon:"mdi:message-processing",width:"14"}),"C",e]},e)}),Se&&!fe&&(0,x.jsx)("button",{className:"cell-detail-results-tab ".concat("raw"===M?"active":""),onClick:()=>O("raw"),children:"Raw"}),Ce&&(0,x.jsxs)("button",{className:"cell-detail-results-tab ".concat("request"===M?"active":""),onClick:()=>O("request"),title:"Full LLM request (for debugging)",children:[(0,x.jsx)(c.In,{icon:"mdi:api",width:"14"}),"Request"]}),ye&&ye.length>0&&(0,x.jsxs)("button",{className:"cell-detail-results-tab ".concat("images"===M?"active":""),onClick:()=>O("images"),children:[(0,x.jsx)(c.In,{icon:"mdi:image",width:"14"}),"Images (",ye.length,")"]}),fe&&(0,x.jsxs)("button",{className:"cell-detail-results-tab ".concat("error"===M?"active":""),onClick:()=>O("error"),children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"14"}),"Error"]})]})]}),(0,x.jsxs)("div",{className:"cell-detail-results-content",children:["decision"===M&&_e&&((e,s,n,t,a)=>{console.log("[CellDetailPanel] Rendering decision content:",{source:_e.source,hasUiSpec:!!_e.uiSpec,sections:null===(e=_e.uiSpec)||void 0===e||null===(s=e.sections)||void 0===s?void 0:s.length,checkpointId:_e.checkpointId});const l=null===(n=_e.uiSpec)||void 0===n||null===(t=n.sections)||void 0===t?void 0:t.find(e=>"html"===e.type);return console.log("[CellDetailPanel] HTML section:",{found:!!l,contentLength:null===l||void 0===l||null===(a=l.content)||void 0===a?void 0:a.length}),(0,x.jsxs)("div",{className:"cell-detail-decision-view",children:[Oe&&(0,x.jsxs)("div",{className:"cell-detail-decision-live-banner",children:[(0,x.jsx)(c.In,{icon:"mdi:clock-alert",width:"16"}),(0,x.jsx)("span",{children:"Cascade is waiting for your decision"})]}),l?(0,x.jsx)(Be.A,{spec:l,checkpointId:_e.checkpointId,sessionId:C,isSavedCheckpoint:!Oe}):(0,x.jsxs)("div",{className:"cell-detail-decision-fallback",children:[(0,x.jsxs)("div",{className:"cell-detail-decision-note",children:[(0,x.jsx)(c.In,{icon:"mdi:information-outline",width:"16"}),"No HTML UI found for this checkpoint"]}),(0,x.jsx)("pre",{className:"cell-detail-raw-json",children:JSON.stringify(_e,null,2)})]})]})})(),"output"===M&&(Se||fe?(0,x.jsxs)(x.Fragment,{children:[ke&&(0,x.jsxs)("div",{className:"cell-detail-evaluator-banner",children:[(0,x.jsxs)("div",{className:"cell-detail-evaluator-header",children:[(0,x.jsx)(c.In,{icon:"mdi:scale-balance",width:"16"}),(0,x.jsx)("span",{children:"Evaluator Selection"}),ke.model&&(0,x.jsxs)("span",{className:"cell-detail-evaluator-model",children:["(",ke.model,")"]})]}),(0,x.jsx)("div",{className:"cell-detail-evaluator-content",children:"string"===typeof ke.content?(0,x.jsx)("pre",{children:ke.content}):(0,x.jsx)("pre",{children:JSON.stringify(ke.content,null,2)})})]}),(0,x.jsx)(We,{result:Se,error:fe,images:"output"===M?ye:null})]}):(0,x.jsxs)("div",{className:"cell-detail-no-data",children:[(0,x.jsx)(c.In,{icon:"mdi:package-variant",width:"48"}),(0,x.jsx)("p",{children:"No output yet"}),(0,x.jsx)("span",{children:"Run the cell to see results here"})]})),Ne&&M.startsWith("take-")&&(()=>{const e=M.replace("take-",""),n=parseInt(e)===Ne.winner||"main"===e;return(0,x.jsxs)("div",{className:"cell-detail-take-messages-wrapper",children:[n&&(0,x.jsxs)("div",{className:"cell-detail-take-winner-banner",children:[(0,x.jsx)(c.In,{icon:"mdi:crown",width:"16"}),"This take was selected as the winner"]}),(0,x.jsx)(Ue.A,{logs:r||[],currentSessionId:u,shouldPollBudget:"replay"!==I&&_,showFilters:!0,filterByCell:s.name,filterByTake:e,showCellColumn:!1,compact:!0,className:"cell-detail-messages-log",onMessageClick:v,hoveredHash:g,onHoverHash:j,externalSelectedMessage:f})]})})(),"messages"===M&&(0,x.jsx)(Ue.A,{logs:r||[],currentSessionId:u,shouldPollBudget:"replay"!==I&&_,showFilters:!0,filterByCell:s.name,showCellColumn:!1,compact:!0,className:"cell-detail-messages-log",onMessageClick:v,hoveredHash:g,onHoverHash:j,externalSelectedMessage:f}),"raw"===M&&Se&&(0,x.jsx)("div",{className:"cell-detail-monaco-readonly",children:(0,x.jsx)(w.Ay,{height:"100%",language:"json",value:JSON.stringify(Se,null,2),theme:S.TH,beforeMount:S.$B,options:{readOnly:!0,minimap:{enabled:!1},fontSize:12,fontFamily:"'Google Sans Code', monospace",lineNumbers:"on",wordWrap:"on",wrappingIndent:"indent",automaticLayout:!0,scrollBeyondLastLine:!1,padding:{top:12,bottom:12},renderLineHighlight:"none",scrollbar:{vertical:"auto",horizontal:"auto",verticalScrollbarSize:10,horizontalScrollbarSize:10}}})}),"request"===M&&Ce&&(0,x.jsx)("div",{className:"cell-detail-monaco-readonly",children:(0,x.jsx)(w.Ay,{height:"100%",language:"json",value:JSON.stringify(Ce,null,2),theme:S.TH,beforeMount:S.$B,options:{readOnly:!0,minimap:{enabled:!1},fontSize:12,fontFamily:"'Google Sans Code', monospace",lineNumbers:"on",wordWrap:"on",wrappingIndent:"indent",automaticLayout:!0,scrollBeyondLastLine:!1,padding:{top:12,bottom:12},renderLineHighlight:"none",scrollbar:{vertical:"auto",horizontal:"auto",verticalScrollbarSize:10,horizontalScrollbarSize:10}}})}),"images"===M&&ye&&ye.length>0&&(0,x.jsx)("div",{className:"cell-detail-images-only",children:ye.map((e,s)=>{const n="string"===typeof e?e:"";if(!n)return null;let t,a;return n.startsWith("data:")?(t=n,a="Screenshot ".concat(s+1)):n.startsWith("/api")?(t="".concat(m.J).concat(n),a=n):(t=n,a=n),(0,x.jsx)("div",{className:"cell-detail-image-container",children:(0,x.jsx)("img",{src:t,alt:"Output ".concat(s+1),onClick:()=>K({url:t,path:a}),style:{cursor:"pointer"},title:"Click to view full size"})},s)})}),"error"===M&&fe&&(0,x.jsx)("div",{className:"cell-detail-error-detail",children:(0,x.jsx)("pre",{children:"string"===typeof fe?fe.replace(/\\n/g,"\n"):JSON.stringify(fe,null,2)})})]})]})]})}),(0,x.jsxs)(ae.aF,{isOpen:W,onClose:()=>B(!1),size:"sm",children:[(0,x.jsx)(ae.rQ,{title:"Delete Cell",icon:"mdi:delete-alert"}),(0,x.jsxs)(ae.$m,{children:[(0,x.jsxs)("p",{style:{color:"var(--color-text-secondary)",lineHeight:"1.5"},children:["Are you sure you want to delete ",(0,x.jsxs)("strong",{style:{color:"var(--color-accent-cyan)"},children:['"',s.name,'"']}),"?"]}),(0,x.jsx)("p",{style:{color:"var(--color-text-muted)",fontSize:"var(--font-size-sm)",marginTop:"8px"},children:"This action cannot be undone."})]}),(0,x.jsxs)(ae.jl,{align:"right",children:[(0,x.jsx)(ae.$n,{variant:"secondary",onClick:()=>B(!1),children:"Cancel"}),(0,x.jsx)(ae.$n,{variant:"danger",icon:"mdi:delete",onClick:()=>{b(n),B(!1),h()},children:"Delete"})]})]}),(0,x.jsx)(ae.aF,{isOpen:!!U,onClose:()=>K(null),size:"full",closeOnBackdrop:!0,closeOnEscape:!0,className:"result-image-modal",children:U&&(0,x.jsxs)("div",{className:"result-modal-image-container",children:[(0,x.jsx)("div",{className:"result-modal-image-header",children:(0,x.jsx)("span",{className:"result-modal-image-title",children:U.path})}),(0,x.jsx)("div",{className:"result-modal-image-body",children:(0,x.jsx)("img",{src:U.url,alt:"Full size",className:"result-modal-image",onClick:()=>K(null)})})]})})]})},ss=e=>{let{inputsSchema:s,instructions:n,tool:t}=e;const a=s&&Object.keys(s).length>0,l=n&&n.length>0;return(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-input",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-input",children:(0,x.jsx)(c.In,{icon:"mdi:import",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:"Input"})]}),(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[t&&(0,x.jsxs)("div",{className:"layer-input-tool",children:[(0,x.jsx)(c.In,{icon:"mdi:function",width:"14"}),(0,x.jsx)("span",{className:"layer-input-tool-name",children:t}),(0,x.jsx)("span",{className:"layer-input-tool-type",children:"Deterministic"})]}),l&&(0,x.jsxs)("div",{className:"layer-input-instructions",children:[(0,x.jsxs)("div",{className:"layer-input-instructions-label",children:[(0,x.jsx)(c.In,{icon:"mdi:text",width:"12"}),"Instructions"]}),(0,x.jsx)("div",{className:"layer-input-instructions-preview",children:n.length>500?n.substring(0,500)+"...":n})]}),a&&(0,x.jsx)("div",{className:"layer-input-params",children:Object.entries(s).map(e=>{let[s,n]=e;return(0,x.jsxs)("div",{className:"layer-input-param",children:[(0,x.jsx)("span",{className:"layer-input-param-key",children:"{{ input."+s+" }}"}),(0,x.jsx)("span",{className:"layer-input-param-desc",children:n})]},s)})}),!a&&!l&&!t&&(0,x.jsxs)("div",{className:"layer-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-collapse-down",width:"14"}),(0,x.jsx)("span",{children:"No explicit inputs"})]})]})]})},ns=e=>{let{context:s}=e;if(!s)return null;const n=s.from||[],t=s.include||["output"];return(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-context",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-context",children:(0,x.jsx)(c.In,{icon:"mdi:link-variant",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:"Context Injection"})]}),(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[(0,x.jsxs)("div",{className:"layer-context-sources",children:[(0,x.jsx)("span",{className:"layer-context-label",children:"from:"}),(0,x.jsx)("div",{className:"layer-context-chips",children:(Array.isArray(n)?n:[n]).map((e,s)=>(0,x.jsxs)("span",{className:"layer-context-chip layer-context-chip-source",children:[(0,x.jsx)(c.In,{icon:"mdi:chevron-right",width:"12"}),e]},s))})]}),(0,x.jsxs)("div",{className:"layer-context-includes",children:[(0,x.jsx)("span",{className:"layer-context-label",children:"include:"}),(0,x.jsx)("div",{className:"layer-context-chips",children:(Array.isArray(t)?t:[t]).map((e,s)=>(0,x.jsxs)("span",{className:"layer-context-chip layer-context-chip-type",children:["output"===e&&(0,x.jsx)(c.In,{icon:"mdi:export",width:"12"}),"images"===e&&(0,x.jsx)(c.In,{icon:"mdi:image",width:"12"}),"messages"===e&&(0,x.jsx)(c.In,{icon:"mdi:message",width:"12"}),"state"===e&&(0,x.jsx)(c.In,{icon:"mdi:database",width:"12"}),e]},s))})]})]})]})},ts=e=>e?"string"===typeof e?e:e.python?"python (inline)":e.javascript?"javascript (inline)":e.sql?"sql (inline)":e.clojure?"clojure (inline)":e.bash?"bash (inline)":e.tool?"".concat(e.tool," (inline)"):"polyglot (inline)":"validator",as=e=>{let{type:s,wards:n=[],results:t=[]}=e;if(!n||0===n.length)return null;const a="pre"===s,l=a?"Pre-Wards":"Post-Wards";return(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-wards cell-anatomy-layer-wards-".concat(s),children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-wards-".concat(s),children:(0,x.jsx)(c.In,{icon:a?"mdi:shield-check":"mdi:shield-check-outline",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:l})]}),(0,x.jsx)("div",{className:"cell-anatomy-layer-content",children:(0,x.jsx)("div",{className:"layer-wards-list",children:n.map((e,s)=>{const n="string"===typeof e?{validator:e,mode:"blocking"}:e,a=((e,s)=>{if(!t||0===t.length)return null;const n="string"===typeof e?e:ts(e.validator||e.name);return t.find(e=>e.name===n)||t[s]||null})(e,s),l="blocking"===(n.mode||"blocking"),i="failed"===(null===a||void 0===a?void 0:a.status),o=i&&l;return(0,x.jsxs)("div",{className:"layer-ward ".concat(o?"layer-ward-aborted":""),children:[(0,x.jsxs)("div",{className:"layer-ward-status ".concat((null===a||void 0===a?void 0:a.status)||"pending"),children:["passed"===(null===a||void 0===a?void 0:a.status)&&(0,x.jsx)(c.In,{icon:"mdi:check",width:"12"}),"failed"===(null===a||void 0===a?void 0:a.status)&&(0,x.jsx)(c.In,{icon:"mdi:close",width:"12"}),!a&&(0,x.jsx)(c.In,{icon:"mdi:circle-outline",width:"10"})]}),(0,x.jsx)("span",{className:"layer-ward-name",children:ts(n.validator||n.name)}),(0,x.jsx)("span",{className:"layer-ward-mode layer-ward-mode-".concat(n.mode||"blocking"),children:n.mode||"blocking"}),o&&(0,x.jsxs)("span",{className:"layer-ward-abort-badge",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-octagon",width:"10"}),"ABORTED"]}),(null===a||void 0===a?void 0:a.reason)&&(i?(0,x.jsxs)("div",{className:"layer-ward-failure-reason",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),(0,x.jsx)("span",{children:a.reason})]}):(0,x.jsx)("span",{className:"layer-ward-reason",title:a.reason,children:(0,x.jsx)(c.In,{icon:"mdi:information-outline",width:"12"})}))]},s)})})})]})},ls=e=>{let{lane:s,maxTurns:n,loopUntil:t,hasExecution:l}=e;const{index:i,mutation:o,model:r,turns:d,toolCalls:u,cost:m,duration:h,status:p,isWinner:v,isLoser:g}=s,j=e=>{if(!e||0===e)return null;if(e<1e3)return"".concat(Math.round(e),"ms");const s=e/1e3;if(s<60)return"".concat(s.toFixed(1),"s");const n=Math.floor(s/60),t=Math.round(s%60);return"".concat(n,"m").concat(t,"s")},f=a.useMemo(()=>{const e=[];for(let s=0;s<n;s++){const n=d[s]||null,t=(null===n||void 0===n?void 0:n.validationResult)||null,a=!0===(null===t||void 0===t?void 0:t.valid),l=!1===(null===t||void 0===t?void 0:t.valid);e.push({index:s,data:n,isUsed:!!n&&"pending"!==n.status,isEarlyExit:"complete"===(null===n||void 0===n?void 0:n.status)&&a,validationFailed:l,validationReason:(null===t||void 0===t?void 0:t.reason)||null,toolCalls:(null===n||void 0===n?void 0:n.toolCalls)||[],duration:(null===n||void 0===n?void 0:n.duration)||null})}return e},[d,n]),y=u.length||d.reduce((e,s)=>{var n;return e+((null===(n=s.toolCalls)||void 0===n?void 0:n.length)||0)},0),b=r?r.split("/").pop():null,N=j(h);return(0,x.jsxs)("div",{className:"take-lane ".concat(v?"take-lane-winner":""," ").concat(g?"take-lane-loser":""," take-lane-").concat(p),children:[(0,x.jsx)("div",{className:"take-lane-header",children:(0,x.jsxs)("span",{className:"take-lane-index",children:[v&&(0,x.jsx)(c.In,{icon:"mdi:crown",width:"12",className:"take-lane-crown"}),g&&(0,x.jsx)(c.In,{icon:"mdi:close-circle",width:"10",className:"take-lane-loser-icon"}),"S",i]})}),o&&(0,x.jsxs)("div",{className:"take-lane-row take-lane-mutation",children:[(0,x.jsx)("span",{className:"take-lane-row-label",children:(0,x.jsx)(c.In,{icon:"mdi:shuffle-variant",width:"10"})}),(0,x.jsx)("span",{className:"take-lane-mutation-badge mutation-".concat(o),children:o})]}),r&&(0,x.jsxs)("div",{className:"take-lane-row take-lane-model",children:[(0,x.jsx)("span",{className:"take-lane-row-label",children:(0,x.jsx)(P.Ay,{modelId:r,size:10})}),(0,x.jsx)("span",{className:"take-lane-model-name",title:r,style:{color:(0,P.t8)((0,P.sO)(r))},children:b})]}),(0,x.jsx)("div",{className:"take-lane-divider"}),(0,x.jsx)("div",{className:"take-lane-turns",children:f.map(e=>(0,x.jsxs)("div",{className:"take-lane-turn ".concat(e.isUsed?"used":"unused"," ").concat(e.isEarlyExit?"early-exit":""," ").concat(e.validationFailed?"validation-failed":""),children:[(0,x.jsxs)("span",{className:"take-lane-turn-index",children:["T",e.index]}),e.toolCalls.length>0&&(0,x.jsxs)("div",{className:"take-lane-turn-tools",children:[e.toolCalls.slice(0,3).map((e,s)=>(0,x.jsx)("span",{className:"take-lane-tool-badge",title:e.name||e,children:(0,x.jsx)(c.In,{icon:"mdi:hammer-wrench",width:"8"})},s)),e.toolCalls.length>3&&(0,x.jsxs)("span",{className:"take-lane-tool-more",children:["+",e.toolCalls.length-3]})]}),e.duration&&(0,x.jsx)("span",{className:"take-lane-turn-duration",title:"Turn ".concat(e.index," duration"),children:j(e.duration)}),t&&e.isUsed&&(0,x.jsx)("span",{className:"take-lane-turn-validation ".concat(e.isEarlyExit?"passed":""," ").concat(e.validationFailed?"failed":""),children:e.isEarlyExit?(0,x.jsx)(c.In,{icon:"mdi:lightning-bolt",width:"10",title:"Early exit - validation passed"}):e.validationFailed?(0,x.jsx)(c.In,{icon:"mdi:close-circle",width:"10",title:"Validation failed: ".concat(e.validationReason||"Unknown")}):(0,x.jsx)(c.In,{icon:"mdi:sync",width:"10",title:"Loop-until check"})}),e.validationFailed&&e.validationReason&&(0,x.jsxs)("div",{className:"take-lane-turn-validation-failure",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"10"}),(0,x.jsx)("span",{className:"take-lane-turn-validation-reason",children:e.validationReason.length>50?e.validationReason.substring(0,50)+"...":e.validationReason})]})]},e.index))}),d.length<n&&n>1&&(0,x.jsx)("div",{className:"take-lane-unused",children:(0,x.jsxs)("span",{className:"take-lane-unused-label",children:["(max ",n,")"]})}),(0,x.jsx)("div",{className:"take-lane-divider"}),(0,x.jsx)("div",{className:"take-lane-footer",children:l?(0,x.jsxs)(x.Fragment,{children:[m>0&&(0,x.jsxs)("span",{className:"take-lane-stat take-lane-cost",children:["$",m<.01?"<.01":m.toFixed(3)]}),N&&(0,x.jsxs)("span",{className:"take-lane-stat take-lane-duration",children:[(0,x.jsx)(c.In,{icon:"mdi:clock-outline",width:"10"}),N]}),(0,x.jsxs)("span",{className:"take-lane-stat take-lane-turns-count",children:[d.filter(e=>"pending"!==e.status).length," turns"]}),(0,x.jsxs)("span",{className:"take-lane-stat take-lane-tools-count",children:[y," tools"]})]}):(0,x.jsxs)("span",{className:"take-lane-stat take-lane-tools-count",children:[n," max turns"]})})]})},is=e=>{let{config:s,execution:n,isLLMCell:t}=e;const l=s.factor||1,i=s.maxTurns||1,o=s.skills||[],r=s.loopUntil,d=s.mutate,u=s.models,m="manifest"===o||Array.isArray(o)&&o.includes("manifest"),h=null===n||void 0===n?void 0:n.manifestSelection,p=null!==(null===n||void 0===n?void 0:n.winnerIndex)&&void 0!==(null===n||void 0===n?void 0:n.winnerIndex),v=a.useMemo(()=>null!==n&&void 0!==n&&n.takes&&n.takes.length>0?n.takes.map((e,s)=>({index:s,mutation:e.mutation||null,model:e.model,turns:e.turns||[],toolCalls:e.toolCalls||[],cost:e.cost||0,duration:e.duration||0,status:e.status||"pending",isWinner:n.winnerIndex===s,isLoser:p&&n.winnerIndex!==s,output:e.output||null})):Array.from({length:l},(e,s)=>({index:s,mutation:d?["rewrite","augment","approach","original"][s%4]:null,model:u?Array.isArray(u)?u[s%u.length]:u:null,turns:Array.from({length:i},(e,s)=>({index:s,toolCalls:[],status:"pending"})),toolCalls:[],cost:null,duration:null,status:"pending",isWinner:!1,isLoser:!1,output:null})),[l,i,d,u,n,p]),g=l>1;return(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-takes",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-takes",children:(0,x.jsx)(c.In,{icon:"mdi:animation-play",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:g?"Takes (factor: ".concat(l,")"):"Execution"}),(0,x.jsxs)("div",{className:"layer-takes-badges",children:[d&&(0,x.jsxs)("span",{className:"layer-takes-badge badge-mutate",children:[(0,x.jsx)(c.In,{icon:"mdi:shuffle-variant",width:"10"}),"Mutate"]}),u&&(0,x.jsxs)("span",{className:"layer-takes-badge badge-multimodel",children:[(0,x.jsx)(c.In,{icon:"mdi:robot",width:"10"}),"Multi-Model"]}),r&&(0,x.jsxs)("span",{className:"layer-takes-badge badge-loop",children:[(0,x.jsx)(c.In,{icon:"mdi:sync",width:"10"}),"Loop-Until"]})]})]}),(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[r&&(()=>{const e=(s=r)?"string"===typeof s?{type:"cascade",name:s,preview:s}:s.python?{type:"python",name:"python (inline)",preview:s.python}:s.javascript?{type:"javascript",name:"javascript (inline)",preview:s.javascript}:s.sql?{type:"sql",name:"sql (inline)",preview:s.sql}:s.clojure?{type:"clojure",name:"clojure (inline)",preview:s.clojure}:s.bash?{type:"bash",name:"bash (inline)",preview:s.bash}:s.tool?{type:"tool",name:"".concat(s.tool," (inline)"),preview:JSON.stringify(s.inputs||{})}:{type:"unknown",name:"polyglot (inline)",preview:JSON.stringify(s)}:null;var s;const n=(null===e||void 0===e?void 0:e.preview)||"",t=n.length>150?n.substring(0,150)+"...":n;return(0,x.jsxs)("div",{className:"layer-takes-loop-until",children:[(0,x.jsx)(c.In,{icon:"mdi:sync",width:"12"}),(0,x.jsx)("span",{className:"layer-takes-loop-until-label",children:"Loop Until:"}),"cascade"!==(null===e||void 0===e?void 0:e.type)&&(0,x.jsx)("span",{className:"layer-takes-loop-until-type type-".concat(null===e||void 0===e?void 0:e.type),children:null===e||void 0===e?void 0:e.name}),(0,x.jsx)("span",{className:"layer-takes-loop-until-preview",children:t})]})})(),m&&h&&h.selectedTools.length>0?(0,x.jsxs)("div",{className:"layer-takes-manifest",children:[(0,x.jsxs)("div",{className:"layer-takes-manifest-header",children:[(0,x.jsx)(c.In,{icon:"mdi:auto-fix",width:"14",className:"manifest-icon"}),(0,x.jsx)("span",{className:"layer-takes-manifest-label",children:"Quartermaster Selected:"}),h.model&&(0,x.jsxs)("span",{className:"layer-takes-manifest-model",title:h.model,children:["via ",h.model.split("/").pop()]})]}),(0,x.jsx)("div",{className:"layer-takes-skills-list",children:h.selectedTools.map((e,s)=>(0,x.jsx)("span",{className:"layer-takes-skills-item manifest-selected",children:e},s))})]}):m?(0,x.jsx)("div",{className:"layer-takes-manifest",children:(0,x.jsxs)("div",{className:"layer-takes-manifest-header",children:[(0,x.jsx)(c.In,{icon:"mdi:auto-fix",width:"14",className:"manifest-icon"}),(0,x.jsx)("span",{className:"layer-takes-manifest-label",children:"Manifest Mode"}),(0,x.jsx)("span",{className:"layer-takes-manifest-pending",children:"(Quartermaster will select tools)"})]})}):o.length>0&&(0,x.jsxs)("div",{className:"layer-takes-skills",children:[(0,x.jsxs)("span",{className:"layer-takes-skills-label",children:[(0,x.jsx)(c.In,{icon:"mdi:tools",width:"12"}),"Skills:"]}),(0,x.jsx)("div",{className:"layer-takes-skills-list",children:(Array.isArray(o)?o:[o]).map((e,s)=>(0,x.jsx)("span",{className:"layer-takes-skills-item",children:e},s))})]}),(0,x.jsx)("div",{className:"layer-takes-lanes",children:v.map(e=>(0,x.jsx)(ls,{lane:e,maxTurns:i,loopUntil:r,hasExecution:!!n},e.index))})]})]})};var os=n(50108),cs=n(16350),rs=n(52185),ds=n(6026),us=n(86150),ms=n(90168),hs=n(77943);const ps=e=>{let{paretoData:s}=e;const[n,l]=(0,a.useState)(!0),{frontierData:i,dominatedData:o,winnerData:r,frontierLine:d,modelColors:u,stats:m}=(0,a.useMemo)(()=>{if(!s||!s.all_takes)return{frontierData:[],dominatedData:[],winnerData:[],frontierLine:[],modelColors:{},stats:null};const e=[...new Set(s.all_takes.map(e=>e.model))],n=["#a78bfa","#60a5fa","#34d399","#fbbf24","#f472b6","#fb923c"],a={};e.forEach((e,s)=>{a[e]=n[s%n.length]});const l=[],i=[];let o=null;s.all_takes.forEach(e=>{const s=(0,t.A)((0,t.A)({},e),{},{displayCost:1e3*e.cost,color:a[e.model],shortModel:e.model.split("/").pop()});e.is_winner&&(o=s),e.is_pareto_optimal?l.push(s):i.push(s)});const c=[...l].sort((e,s)=>e.cost-s.cost),r=s.all_takes.map(e=>e.cost),d=s.all_takes.map(e=>e.quality),u={minCost:Math.min(...r),maxCost:Math.max(...r),minQuality:Math.min(...d),maxQuality:Math.max(...d),frontierSize:l.length,dominatedSize:i.length,totalTakes:s.all_takes.length};return{frontierData:l,dominatedData:i,winnerData:o?[o]:[],frontierLine:c,modelColors:a,stats:u}},[s]),h=e=>{let{active:s,payload:n}=e;if(!s||!n||!n.length)return null;const t=n[0].payload;return(0,x.jsxs)("div",{className:"layer-pareto-tooltip",children:[(0,x.jsxs)("div",{className:"pareto-tooltip-header",children:[(0,x.jsx)("span",{className:"pareto-tooltip-model",style:{color:t.color},children:t.shortModel}),t.is_winner&&(0,x.jsx)(c.In,{icon:"mdi:trophy",width:"12",className:"pareto-tooltip-trophy"})]}),(0,x.jsxs)("div",{className:"pareto-tooltip-row",children:[(0,x.jsx)(c.In,{icon:"mdi:chart-line",width:"10"}),(0,x.jsxs)("span",{children:["Quality: ",t.quality.toFixed(1)]})]}),(0,x.jsxs)("div",{className:"pareto-tooltip-row",children:[(0,x.jsx)(c.In,{icon:"mdi:currency-usd",width:"10"}),(0,x.jsxs)("span",{children:["Cost: $",t.cost.toFixed(6)]})]}),(0,x.jsxs)("div",{className:"pareto-tooltip-row",children:[(0,x.jsx)(c.In,{icon:"mdi:identifier",width:"10"}),(0,x.jsxs)("span",{children:["Take #",t.index]})]}),t.is_pareto_optimal&&(0,x.jsx)("div",{className:"pareto-tooltip-badge frontier",children:"Optimal"}),!t.is_pareto_optimal&&(0,x.jsx)("div",{className:"pareto-tooltip-badge dominated",children:"Dominated"})]})},p=(e,s)=>{const{cx:n,cy:t,payload:a}=e;if(!n||!t)return null;const l=a.is_winner,i=l?10:"frontier"===s?7:5;return l?(0,x.jsxs)("g",{children:[(0,x.jsx)("circle",{cx:n,cy:t,r:i+3,fill:"none",stroke:"#FFD700",strokeWidth:"1.5",strokeDasharray:"3 2"}),(0,x.jsx)("polygon",{points:v(n,t,i,i/2),fill:"#FFD700",stroke:"#0a0a0a",strokeWidth:"1"})]}):(0,x.jsx)("circle",{cx:n,cy:t,r:i,fill:"frontier"===s?a.color:"#4a5568",stroke:"frontier"===s?"#0a0a0a":"none",strokeWidth:"1.5",opacity:"frontier"===s?1:.4,style:{cursor:"pointer"}})},v=(e,s,n,t)=>{const a=[];for(let l=0;l<5;l++){const i=(72*l-90)*(Math.PI/180);a.push("".concat(e+n*Math.cos(i),",").concat(s+n*Math.sin(i)));const o=(72*l+36-90)*(Math.PI/180);a.push("".concat(e+t*Math.cos(o),",").concat(s+t*Math.sin(o)))}return a.join(" ")};return s&&s.all_takes&&0!==s.all_takes.length?(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-pareto",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",onClick:()=>l(!n),children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-pareto",children:(0,x.jsx)(c.In,{icon:"mdi:chart-scatter-plot",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:"Pareto Frontier"}),(0,x.jsxs)("div",{className:"layer-pareto-badges",children:[(0,x.jsxs)("span",{className:"layer-pareto-badge badge-frontier",children:[(0,x.jsx)(c.In,{icon:"mdi:target",width:"10"}),(null===m||void 0===m?void 0:m.frontierSize)||0," optimal"]}),(0,x.jsxs)("span",{className:"layer-pareto-badge badge-dominated",children:[(0,x.jsx)(c.In,{icon:"mdi:dots-horizontal",width:"10"}),(null===m||void 0===m?void 0:m.dominatedSize)||0," dominated"]})]}),(0,x.jsx)(c.In,{icon:n?"mdi:chevron-up":"mdi:chevron-down",width:"16",className:"cell-anatomy-layer-chevron"})]}),n&&(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[(0,x.jsx)("div",{className:"layer-pareto-chart-wrapper",children:(0,x.jsx)(os.u,{width:"100%",height:220,children:(0,x.jsxs)(cs.X,{margin:{top:10,right:20,bottom:30,left:40},children:[(0,x.jsx)(rs.W,{type:"number",dataKey:"displayCost",name:"Cost",tickFormatter:e=>0===e?"$0":"$".concat((e/1e3).toFixed(e<1?4:3)),domain:["dataMin - 0.1","dataMax + 0.1"],label:{value:"Cost ($)",position:"bottom",offset:10,style:{fill:"#64748b",fontSize:10}},tick:{fill:"#64748b",fontSize:9},stroke:"#1a1628"}),(0,x.jsx)(ds.h,{type:"number",dataKey:"quality",name:"Quality",domain:[e=>Math.max(0,Math.floor(e-5)),e=>Math.min(100,Math.ceil(e+5))],label:{value:"Quality",angle:-90,position:"insideLeft",style:{fill:"#64748b",fontSize:10,textAnchor:"middle"}},tick:{fill:"#64748b",fontSize:9},stroke:"#1a1628"}),(0,x.jsx)(us.m,{content:(0,x.jsx)(h,{})}),d.length>1&&(0,x.jsx)(ms.N,{type:"monotone",data:d,dataKey:"quality",stroke:"#34d399",strokeWidth:2,strokeDasharray:"5 3",dot:!1,isAnimationActive:!1,name:"Frontier",xAxisId:0,yAxisId:0}),(0,x.jsx)(hs.X,{name:"Dominated",data:o,fill:"#4a5568",shape:e=>p(e,"dominated")}),(0,x.jsx)(hs.X,{name:"Optimal",data:i,shape:e=>p(e,"frontier")}),r.length>0&&(0,x.jsx)(hs.X,{name:"Winner",data:r,shape:e=>p(e,"winner")})]})})}),(0,x.jsxs)("div",{className:"layer-pareto-legend",children:[(0,x.jsx)("span",{className:"layer-pareto-legend-title",children:"Models:"}),Object.entries(u).map(e=>{let[s,n]=e;return(0,x.jsxs)("span",{className:"layer-pareto-legend-item",children:[(0,x.jsx)("span",{className:"layer-pareto-legend-dot",style:{backgroundColor:n}}),(0,x.jsx)("span",{className:"layer-pareto-legend-model",children:s.split("/").pop()})]},s)})]}),r.length>0&&(0,x.jsxs)("div",{className:"layer-pareto-winner",children:[(0,x.jsx)(c.In,{icon:"mdi:trophy",width:"12"}),(0,x.jsxs)("span",{children:["Winner: ",(0,x.jsx)("strong",{children:r[0].shortModel})," "," (Q: ",r[0].quality.toFixed(1),", $",r[0].cost.toFixed(6),")"]})]})]})]}):null},xs=e=>{let{config:s,winnerIndex:n,mode:t="evaluate",evaluatorResult:a}=e;const{preValidator:l,evaluator:i}=s,o="aggregate"===t,r=a&&a.content;return(0,x.jsxs)("div",{className:"cell-anatomy-convergence",children:[(0,x.jsx)("div",{className:"convergence-funnel",children:(0,x.jsx)("div",{className:"convergence-funnel-line"})}),l&&(0,x.jsxs)("div",{className:"convergence-section convergence-prevalidator",children:[(0,x.jsx)("div",{className:"convergence-section-icon",children:(0,x.jsx)(c.In,{icon:"mdi:filter-check",width:"14"})}),(0,x.jsxs)("div",{className:"convergence-section-content",children:[(0,x.jsx)("span",{className:"convergence-section-label",children:"Pre-Validator"}),(0,x.jsx)("span",{className:"convergence-section-name",children:(d=l,d?"string"===typeof d?d:d.python?"python (inline)":d.javascript?"javascript (inline)":d.sql?"sql (inline)":d.clojure?"clojure (inline)":d.bash?"bash (inline)":d.tool?"".concat(d.tool," (inline)"):"polyglot (inline)":"validator")})]})]}),(0,x.jsxs)("div",{className:"convergence-evaluator-container ".concat(r?"has-result":""),children:[(0,x.jsxs)("div",{className:"convergence-section convergence-evaluator",children:[(0,x.jsx)("div",{className:"convergence-section-icon convergence-icon-evaluator",children:(0,x.jsx)(c.In,{icon:o?"mdi:merge":"mdi:scale-balance",width:"16"})}),(0,x.jsxs)("div",{className:"convergence-section-content",children:[(0,x.jsx)("span",{className:"convergence-section-label",children:o?"Aggregator":"Evaluator"}),(0,x.jsx)("span",{className:"convergence-mode-badge ".concat(o?"mode-aggregate":"mode-evaluate"),children:o?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:set-merge",width:"10"}),"Combine All"]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(c.In,{icon:"mdi:trophy",width:"10"}),"Pick Winner"]})}),i&&(0,x.jsx)("span",{className:"convergence-instructions",title:i,children:i.length>300?i.substring(0,300)+"...":i})]})]}),r&&(0,x.jsxs)("div",{className:"convergence-section convergence-result",children:[(0,x.jsx)("div",{className:"convergence-section-icon convergence-icon-result",children:(0,x.jsx)(c.In,{icon:"mdi:message-text",width:"16"})}),(0,x.jsxs)("div",{className:"convergence-section-content",children:[(0,x.jsxs)("div",{className:"convergence-result-header",children:[(0,x.jsx)("span",{className:"convergence-section-label",children:"Evaluator Decision"}),null!==n&&void 0!==n&&!o&&(0,x.jsxs)("div",{className:"convergence-winner",children:[(0,x.jsx)(c.In,{icon:"mdi:crown",width:"14"}),(0,x.jsxs)("span",{children:["Winner: S",n]})]})]}),a.model&&(0,x.jsxs)("span",{className:"convergence-result-model",style:{color:(0,P.t8)((0,P.sO)(a.model))},children:[(0,x.jsx)(P.Ay,{modelId:a.model,size:10}),a.model.split("/").pop()]}),(0,x.jsx)("div",{className:"convergence-result-content",children:a.content})]})]})]}),!r&&null!==n&&void 0!==n&&!o&&(0,x.jsxs)("div",{className:"convergence-winner-standalone",children:[(0,x.jsx)(c.In,{icon:"mdi:crown",width:"14"}),(0,x.jsxs)("span",{children:["Winner: S",n]})]})]});var d},vs=e=>{let{config:s,execution:n}=e;const t=(null===s||void 0===s?void 0:s.steps)||3,l=(null===s||void 0===s?void 0:s.factor_per_step)||2,i=null===s||void 0===s?void 0:s.honing_prompt,o=null===s||void 0===s?void 0:s.threshold,r=(null===s||void 0===s?void 0:s.mutate)||!1,d=a.useMemo(()=>null!==n&&void 0!==n&&n.steps&&n.steps.length>0?n.steps:Array.from({length:t},(e,s)=>({index:s,attempts:Array.from({length:l},(e,s)=>({index:s,turns:[{index:0},{index:1}],status:"pending",cost:null,duration:null})),winner:null,thresholdPassed:null,evaluatorReason:null})),[t,l,n]),u=d.findIndex(e=>!0===e.thresholdPassed),m=(null===n||void 0===n?void 0:n.steps)&&n.steps.length>0,h=d.reduce((e,s)=>{var n;return e+((null===(n=s.attempts)||void 0===n?void 0:n.length)||0)},0),p=d.filter(e=>null!==e.winner).length;return s?(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-reforge",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-reforge",children:(0,x.jsx)(c.In,{icon:"mdi:anvil",width:"14"})}),(0,x.jsxs)("span",{className:"cell-anatomy-layer-title",children:["Reforge (",p,"/",t," steps)"]}),(0,x.jsxs)("div",{className:"layer-reforge-badges",children:[(0,x.jsxs)("span",{className:"layer-reforge-badge",children:[(0,x.jsx)(c.In,{icon:"mdi:content-copy",width:"10"}),l,"/step"]}),o&&(0,x.jsxs)("span",{className:"layer-reforge-badge badge-threshold",children:[(0,x.jsx)(c.In,{icon:"mdi:target",width:"10"}),"Threshold"]}),r&&(0,x.jsxs)("span",{className:"layer-reforge-badge badge-mutate",children:[(0,x.jsx)(c.In,{icon:"mdi:shuffle-variant",width:"10"}),"Mutate"]})]})]}),(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[i&&(0,x.jsxs)("div",{className:"layer-reforge-honing",children:[(0,x.jsx)(c.In,{icon:"mdi:text-box-edit",width:"12"}),(0,x.jsx)("span",{className:"layer-reforge-honing-label",children:"Honing:"}),(0,x.jsx)("span",{className:"layer-reforge-honing-preview",children:i.length>120?i.substring(0,120)+"...":i})]}),(0,x.jsx)("div",{className:"layer-reforge-steps",children:d.map((e,s)=>{const n=null!==e.winner,t=u===s||s===d.length-1&&n;return(0,x.jsxs)("div",{className:"layer-reforge-step ".concat(e.thresholdPassed?"step-stopped":""," ").concat(t?"step-final":""," ").concat(n?"step-complete":""),children:[(0,x.jsxs)("div",{className:"layer-reforge-step-header",children:[(0,x.jsxs)("span",{className:"layer-reforge-step-label",children:[t&&(0,x.jsx)(c.In,{icon:"mdi:star",width:"10",className:"step-final-icon"}),"Step ",s+1]}),e.thresholdPassed&&(0,x.jsxs)("span",{className:"layer-reforge-step-stopped",children:[(0,x.jsx)(c.In,{icon:"mdi:check-circle",width:"12"}),"Threshold Met"]})]}),(0,x.jsx)("div",{className:"layer-reforge-attempts",children:e.attempts.map((n,t)=>{const a=e.winner===t,l=null!==e.winner&&e.winner!==t;return(0,x.jsxs)("div",{className:"layer-reforge-attempt ".concat(a?"attempt-winner":""," ").concat(l?"attempt-loser":""),children:[(0,x.jsxs)("span",{className:"layer-reforge-attempt-label",children:[a&&(0,x.jsx)(c.In,{icon:"mdi:crown",width:"8",className:"attempt-crown"}),"R",s,".",t]}),(0,x.jsx)("div",{className:"layer-reforge-attempt-turns",children:n.turns.map((e,s)=>(0,x.jsx)("span",{className:"layer-reforge-attempt-turn ".concat("complete"===e.status?"turn-complete":"")},s))}),n.cost>0&&(0,x.jsxs)("span",{className:"layer-reforge-attempt-cost",children:["$",n.cost<.01?"<.01":n.cost.toFixed(3)]})]},t)})}),(0,x.jsxs)("div",{className:"layer-reforge-step-eval ".concat(n?"eval-complete":""),children:[(0,x.jsxs)("div",{className:"layer-reforge-eval-header",children:[(0,x.jsx)(c.In,{icon:n?"mdi:scale-balance":"mdi:chevron-down",width:"14"}),(0,x.jsx)("span",{className:"layer-reforge-step-eval-label",children:n?"EVALUATED":"EVAL"})]}),null!==e.winner&&(0,x.jsxs)("div",{className:"layer-reforge-eval-result",children:[(0,x.jsxs)("span",{className:"layer-reforge-step-winner",children:[(0,x.jsx)(c.In,{icon:"mdi:crown",width:"10"}),"R",s,".",e.winner," wins"]}),e.evaluatorReason&&(0,x.jsx)("span",{className:"layer-reforge-eval-reason",title:e.evaluatorReason,children:e.evaluatorReason.length>60?e.evaluatorReason.substring(0,60)+"...":e.evaluatorReason})]})]}),s<d.length-1&&!e.thresholdPassed&&(0,x.jsx)("div",{className:"layer-reforge-step-arrow",children:(0,x.jsx)(c.In,{icon:"mdi:arrow-right",width:"16"})})]},s)})}),(0,x.jsxs)("div",{className:"layer-reforge-final ".concat(m&&p>0?"final-complete":""),children:[(0,x.jsx)(c.In,{icon:"mdi:shimmer",width:"14"}),(0,x.jsx)("span",{children:u>=0?"Early stop at Step ".concat(u+1," (threshold met)"):m&&p>0?"Final Output from Step ".concat(p):"Will output from Step ".concat(t)}),m&&(0,x.jsxs)("span",{className:"layer-reforge-final-stats",children:["(",h," total attempts)"]})]})]})]}):null},gs=e=>{let{outputSchema:s,outputExtraction:n,callouts:t,handoffs:a,result:l}=e;const i=s&&Object.keys(s).length>0,o=n&&n.length>0,r=t&&t.length>0,d=a&&a.length>0,u=null!==l&&void 0!==l;return(0,x.jsxs)("div",{className:"cell-anatomy-layer cell-anatomy-layer-output",children:[(0,x.jsxs)("div",{className:"cell-anatomy-layer-header",children:[(0,x.jsx)("div",{className:"cell-anatomy-layer-icon layer-icon-output",children:(0,x.jsx)(c.In,{icon:"mdi:export",width:"14"})}),(0,x.jsx)("span",{className:"cell-anatomy-layer-title",children:"Output"})]}),(0,x.jsxs)("div",{className:"cell-anatomy-layer-content",children:[i&&(0,x.jsxs)("div",{className:"layer-output-section",children:[(0,x.jsxs)("div",{className:"layer-output-section-header",children:[(0,x.jsx)(c.In,{icon:"mdi:code-json",width:"12"}),(0,x.jsx)("span",{children:"Output Schema"})]}),(0,x.jsxs)("div",{className:"layer-output-schema",children:[(0,x.jsx)("span",{className:"layer-output-schema-type",children:s.type||"object"}),s.required&&(0,x.jsxs)("span",{className:"layer-output-schema-required",children:["Required: ",s.required.join(", ")]})]})]}),o&&(0,x.jsxs)("div",{className:"layer-output-section",children:[(0,x.jsxs)("div",{className:"layer-output-section-header",children:[(0,x.jsx)(c.In,{icon:"mdi:regex",width:"12"}),(0,x.jsx)("span",{children:"Extraction"})]}),(0,x.jsx)("div",{className:"layer-output-extraction",children:(Array.isArray(n)?n:[n]).map((e,s)=>(0,x.jsxs)("div",{className:"layer-output-extraction-rule",children:[(0,x.jsx)("code",{className:"layer-output-extraction-pattern",children:e.pattern||e}),e.target&&(0,x.jsxs)("span",{className:"layer-output-extraction-target",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-right",width:"10"}),"state.",e.target]})]},s))})]}),r&&(0,x.jsxs)("div",{className:"layer-output-section",children:[(0,x.jsxs)("div",{className:"layer-output-section-header",children:[(0,x.jsx)(c.In,{icon:"mdi:tag",width:"12"}),(0,x.jsx)("span",{children:"Callouts"})]}),(0,x.jsx)("div",{className:"layer-output-callouts",children:(Array.isArray(t)?t:[t]).map((e,s)=>(0,x.jsx)("span",{className:"layer-output-callout-tag",children:e},s))})]}),d&&(0,x.jsxs)("div",{className:"layer-output-section",children:[(0,x.jsxs)("div",{className:"layer-output-section-header",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-decision",width:"12"}),(0,x.jsx)("span",{children:"Handoffs"})]}),(0,x.jsx)("div",{className:"layer-output-handoffs",children:a.map((e,s)=>(0,x.jsxs)("span",{className:"layer-output-handoff",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-right-bold",width:"10"}),e]},s))})]}),u&&(0,x.jsxs)("div",{className:"layer-output-section layer-output-result",children:[(0,x.jsxs)("div",{className:"layer-output-section-header",children:[(0,x.jsx)(c.In,{icon:"mdi:check-circle",width:"12"}),(0,x.jsx)("span",{children:"Result"})]}),(0,x.jsx)("div",{className:"layer-output-result-preview",children:"string"===typeof l?(0,x.jsx)("span",{children:l.length>500?l.substring(0,500)+"...":l}):null!==l&&void 0!==l&&l.rows?(0,x.jsxs)("span",{children:[l.rows.length," rows returned"]}):(0,x.jsxs)("span",{children:[JSON.stringify(l,null,2).substring(0,500),JSON.stringify(l).length>500?"...":""]})})]}),!i&&!o&&!r&&!d&&!u&&(0,x.jsxs)("div",{className:"layer-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:arrow-collapse-right",width:"14"}),(0,x.jsx)("span",{children:"Output passed to lineage"})]})]})]})},js=e=>{var s,n,t;let{cellState:a={},executionData:l,config:i,cascadeAnalytics:o,cellAnalytics:r}=e;const{duration:d,cost:u,tokens_in:m,tokens_out:h,status:p}=a,v=(null===l||void 0===l||null===(s=l.toolCalls)||void 0===s?void 0:s.length)||0,g=(null===l||void 0===l||null===(n=l.takes)||void 0===n?void 0:n.reduce((e,s)=>{var n;return e+((null===(n=s.turns)||void 0===n?void 0:n.filter(e=>"pending"!==e.status).length)||0)},0))||0,j=(null===l||void 0===l||null===(t=l.takes)||void 0===t?void 0:t.reduce((e,s)=>Math.max(e,s.duration||0),0))||0,f=d||j;return(0,x.jsxs)("div",{className:"cell-anatomy-summary",children:[(0,x.jsxs)("div",{className:"cell-anatomy-summary-left",children:[(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:layers-triple",width:"12"}),(0,x.jsx)("span",{children:"factor:"}),(0,x.jsx)("span",{className:"cell-anatomy-summary-stat-value",children:(null===i||void 0===i?void 0:i.factor)||1})]}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:repeat",width:"12"}),(0,x.jsx)("span",{children:"max_turns:"}),(0,x.jsx)("span",{className:"cell-anatomy-summary-stat-value",children:(null===i||void 0===i?void 0:i.maxTurns)||1})]}),f&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:clock-outline",width:"12"}),(0,x.jsx)("span",{className:"cell-anatomy-summary-stat-value",children:(e=>{if(!e)return null;if(e<1e3)return"<1s";const s=Math.floor(e/1e3),n=Math.floor(s/60);if(0===n)return"".concat(s,"s");const t=s%60;return 0===t?"".concat(n,"m"):"".concat(n,"m ").concat(t,"s")})(f)})]}),u>0&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat cell-anatomy-summary-stat-cost",children:[(0,x.jsx)(c.In,{icon:"mdi:currency-usd",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:["$",u<.01?"<0.01":u.toFixed(4)]}),(null===r||void 0===r?void 0:r.species_avg_cost)>0&&(0,x.jsxs)("span",{style:{marginLeft:"4px",fontSize:"10px",color:u/r.species_avg_cost>=1.5?"#f87171":u/r.species_avg_cost>=1.2?"#fbbf24":u/r.species_avg_cost<=.7?"#34d399":"#94a3b8"},title:"vs avg $".concat(r.species_avg_cost.toFixed(4)," (n=").concat(r.species_run_count," runs)"),children:["(",(u/r.species_avg_cost).toFixed(1),"x avg)"]})]}),(null===r||void 0===r?void 0:r.cell_cost_pct)>=25&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",style:{color:r.cell_cost_pct>60?"#f87171":r.cell_cost_pct>40?"#fbbf24":"#94a3b8"},title:"Percentage of total cascade cost consumed by this cell",children:[(0,x.jsx)(c.In,{icon:"mdi:chart-pie",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:[r.cell_cost_pct.toFixed(0),"% of cascade"]})]}),(null===o||void 0===o?void 0:o.context_cost_pct)>=30&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",style:{color:o.context_cost_pct>60?"#fbbf24":"#94a3b8"},title:"".concat(o.context_cost_pct.toFixed(0),"% of cascade cost from context injection"),children:[(0,x.jsx)(c.In,{icon:"mdi:database-import",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:[o.context_cost_pct.toFixed(0),"% ctx"]})]}),(m>0||h>0)&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat cell-anatomy-summary-stat-tokens",children:[(0,x.jsx)(c.In,{icon:"mdi:dice-multiple",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:[m||0," / ",h||0]})]}),v>0&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:hammer-wrench",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:[v," tools"]})]}),g>0&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat",children:[(0,x.jsx)(c.In,{icon:"mdi:sync",width:"12"}),(0,x.jsxs)("span",{className:"cell-anatomy-summary-stat-value",children:[g," turns"]})]})]}),(0,x.jsxs)("div",{className:"cell-anatomy-summary-right",children:[null!==(null===l||void 0===l?void 0:l.winnerIndex)&&void 0!==(null===l||void 0===l?void 0:l.winnerIndex)&&(0,x.jsxs)("div",{className:"cell-anatomy-winner-badge",children:[(0,x.jsx)(c.In,{icon:"mdi:crown",width:"12"}),(0,x.jsxs)("span",{children:["S",l.winnerIndex]})]}),p&&(0,x.jsxs)("span",{className:"cell-anatomy-summary-status status-".concat(p),children:["running"===p&&(0,x.jsx)(c.In,{icon:"mdi:loading",width:"12",className:"spin"}),"success"===p&&(0,x.jsx)(c.In,{icon:"mdi:check-circle",width:"12"}),"error"===p&&(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"12"}),"pending"===p&&(0,x.jsx)(c.In,{icon:"mdi:circle-outline",width:"12"}),p]})]})]})},fs=e=>{let{type:s="minor",label:n}=e;return(0,x.jsx)("div",{className:"cell-anatomy-divider cell-anatomy-divider-".concat(s),children:n&&(0,x.jsx)("span",{className:"cell-anatomy-divider-label",children:n})})},ys=e=>{var s,n;let{cell:t,cellLogs:l=[],cellState:i={},onClose:o,cascadeAnalytics:r,cellAnalytics:d}=e;const u=(0,a.useMemo)(()=>{if(!l||0===l.length)return null;const e={};let s=null,n=null;const t=[],a={pre:[],post:[]};let i=null,o=null;const c=e=>e?new Date(e).getTime():null,r=e=>{if(!e)return{};if("string"===typeof e)try{return JSON.parse(e)}catch(s){return{}}return e};for(const v of l){var d,u;const l=r(v.metadata_json),p=null!==(d=null!==(u=v.winner_index)&&void 0!==u?u:v.winning_take_index)&&void 0!==d?d:l.winner_index;if(null!==p&&void 0!==p&&p>=0&&(s=p),"evaluator"===v.role||"evaluator"===v.node_type){var m,h;let e=v.content_json;if("string"===typeof e)try{e=JSON.parse(e)}catch(x){}i={content:"string"===typeof e?e:(null===(m=e)||void 0===m?void 0:m.content)||(null===(h=e)||void 0===h?void 0:h.reasoning)||JSON.stringify(e),winnerIndex:v.winning_take_index,model:v.model,timestamp:v.timestamp_iso}}let g=null!==v.take_index&&void 0!==v.take_index?v.take_index:l.take_index;const j=["assistant","tool_call","structure","tool","cell_complete","error"].includes(v.role)||["agent","turn","tool_call","tool_result"].includes(v.node_type);if(null!==g&&void 0!==g||!j||(g=0),null!==g&&void 0!==g&&g>=0){e[g]||(e[g]={index:g,turns:[],toolCalls:[],model:null,mutation:null,cost:0,duration:0,status:"running",firstTs:null,lastTs:null});const s=e[g],n=c(v.timestamp_iso);n&&((!s.firstTs||n<s.firstTs)&&(s.firstTs=n),(!s.lastTs||n>s.lastTs)&&(s.lastTs=n));const t=l.turn_number;if(null!==t&&void 0!==t&&t>=0){const e=t>0?t-1:0;for(;s.turns.length<=e;)s.turns.push({index:s.turns.length,toolCalls:[],validationResult:null,status:"pending",duration:0,firstTs:null,lastTs:null});const a=s.turns[e];n&&((!a.firstTs||n<a.firstTs)&&(a.firstTs=n),(!a.lastTs||n>a.lastTs)&&(a.lastTs=n)),"turn"===v.node_type&&(a.status="running")}if("tool_call"===v.role||"tool_call"===v.node_type){const e=l.tool_name||"unknown";s.toolCalls.push(e);const n=l.turn_number;let t=0;if(null!==n&&void 0!==n&&n>=0&&(t=n>0?n-1:0),!s.turns[t])for(;s.turns.length<=t;)s.turns.push({index:s.turns.length,toolCalls:[],validationResult:null,status:"running",duration:0,firstTs:null,lastTs:null});s.turns[t].toolCalls.push({name:e,duration:v.duration_ms})}if("assistant"===v.role&&"agent"===v.node_type){const e=l.turn_number;if(null!==e&&void 0!==e&&e>=0){const n=e>0?e-1:0;s.turns[n]&&(s.turns[n].status="complete",v.duration_ms&&(s.turns[n].duration+=parseFloat(v.duration_ms)))}else if(0===s.turns.length)s.turns.push({index:0,toolCalls:[],validationResult:null,status:"complete",duration:v.duration_ms?parseFloat(v.duration_ms):0,firstTs:null,lastTs:null});else{const e=s.turns[s.turns.length-1];e.status="complete",v.duration_ms&&(e.duration+=parseFloat(v.duration_ms))}}v.model&&(s.model=v.model),v.mutation_type&&(s.mutation=v.mutation_type),v.cost&&(s.cost+=parseFloat(v.cost)),"take_attempt"!==v.role&&"take_attempt"!==v.node_type||(s.status="complete",s.turns.forEach(e=>{"running"===e.status&&(e.status="complete")})),"cell_complete"===v.role&&(s.status="complete"),"error"===v.role&&(s.status="error")}if("tool_call"===v.role||"tool_call"===v.node_type){const e=l.tool_name||"unknown",s=null!==v.take_index&&void 0!==v.take_index?v.take_index:l.take_index;t.push({name:e,take:s,turn:l.turn_number,duration:v.duration_ms})}if("pre_ward"===v.node_type||"post_ward"===v.node_type||"ward"===v.role){const e={name:l.validator||l.tool_name||"validator",status:!0===l.valid?"passed":!1===l.valid?"failed":"unknown",mode:l.mode||"blocking",reason:l.reason||null};"pre_ward"===v.node_type||"pre"===l.ward_type?a.pre.push(e):a.post.push(e)}if("validation"===v.role&&"validation"===v.node_type){const s={validator:l.validator||"validator",valid:l.valid,reason:l.reason||null,attempt:l.attempt||1,maxAttempts:l.max_attempts||1,timestamp:v.timestamp_iso},n=e[0];if(n&&n.turns.length>0){const e=n.turns[n.turns.length-1];e.validationResult=s,s.valid&&(e.validationPassed=!0)}}null!==v.reforge_step&&void 0!==v.reforge_step&&(n||(n={steps:[]})),"quartermaster"!==v.role&&"quartermaster_result"!==v.node_type||(o={selectedTools:l.selected_skills||l.selected_tackle||[],model:l.model||v.model||null,context:l.manifest_context||"current",timestamp:v.timestamp_iso})}const p=Object.values(e);for(const l of p){l.firstTs&&l.lastTs&&(l.duration=l.lastTs-l.firstTs);for(const e of l.turns)e.firstTs&&e.lastTs&&!e.duration&&(e.duration=e.lastTs-e.firstTs)}return{takes:p,winnerIndex:s,toolCalls:t,wardResults:a,reforgeData:n,evaluatorResult:i,manifestSelection:o,hasTakes:p.length>0}},[l]),h=u&&u.hasTakes,[p,v]=(0,a.useState)(null);(0,a.useEffect)(()=>{const e=l.length>0?l[0].session_id:null;if(!e||null===t||void 0===t||!t.name)return void v(null);(async()=>{try{const s=await fetch("".concat(m.J,"/api/pareto/").concat(e));if(s.ok){const e=await s.json();e.has_pareto&&e.cell_name===t.name?v(e):v(null)}else v(null)}catch(s){console.error("[CellAnatomyPanel] Failed to fetch pareto data:",s),v(null)}})()},[l,null===t||void 0===t?void 0:t.name]);const g=(0,a.useMemo)(()=>{var e,s,n,a,l,i,o,c,r,d,u,m;return{inputsSchema:(null===t||void 0===t?void 0:t.inputs_schema)||{},context:(null===t||void 0===t?void 0:t.context)||null,preWards:(null===t||void 0===t||null===(e=t.wards)||void 0===e?void 0:e.pre)||[],postWards:(null===t||void 0===t||null===(s=t.wards)||void 0===s?void 0:s.post)||[],takes:(null===t||void 0===t?void 0:t.takes)||null,factor:(null===t||void 0===t||null===(n=t.takes)||void 0===n?void 0:n.factor)||1,mutate:(null===t||void 0===t||null===(a=t.takes)||void 0===a?void 0:a.mutate)||!1,models:(null===t||void 0===t||null===(l=t.takes)||void 0===l?void 0:l.models)||null,evaluator:(null===t||void 0===t||null===(i=t.takes)||void 0===i?void 0:i.evaluator_instructions)||null,preValidator:(null===t||void 0===t||null===(o=t.takes)||void 0===o?void 0:o.validator)||null,mode:(null===t||void 0===t||null===(c=t.takes)||void 0===c?void 0:c.mode)||"evaluate",reforge:(null===t||void 0===t||null===(r=t.takes)||void 0===r?void 0:r.reforge)||null,maxTurns:(null===t||void 0===t||null===(d=t.rules)||void 0===d?void 0:d.max_turns)||1,maxAttempts:(null===t||void 0===t||null===(u=t.rules)||void 0===u?void 0:u.max_attempts)||1,loopUntil:(null===t||void 0===t||null===(m=t.rules)||void 0===m?void 0:m.loop_until)||null,skills:(null===t||void 0===t?void 0:t.skills)||[],outputSchema:(null===t||void 0===t?void 0:t.output_schema)||null,outputExtraction:(null===t||void 0===t?void 0:t.output_extraction)||null,callouts:(null===t||void 0===t?void 0:t.callouts)||null,handoffs:(null===t||void 0===t?void 0:t.handoffs)||[],model:(null===t||void 0===t?void 0:t.model)||null,instructions:(null===t||void 0===t?void 0:t.instructions)||null,tool:(null===t||void 0===t?void 0:t.tool)||null}},[t]),j=!g.tool&&g.instructions,f=!!g.tool;return(0,x.jsxs)("div",{className:"cell-anatomy-panel",children:[(0,x.jsxs)("div",{className:"cell-anatomy-header",children:[(0,x.jsxs)("div",{className:"cell-anatomy-header-left",children:[(0,x.jsx)(c.In,{icon:"mdi:cpu",width:"18",className:"cell-anatomy-icon"}),(0,x.jsx)("span",{className:"cell-anatomy-title",children:"Cell Anatomy"}),(0,x.jsx)("span",{className:"cell-anatomy-name",children:(null===t||void 0===t?void 0:t.name)||"Unknown"}),j&&(0,x.jsxs)("span",{className:"cell-anatomy-type cell-anatomy-type-llm",children:[(0,x.jsx)(c.In,{icon:"mdi:robot",width:"12"}),"LLM"]}),f&&(0,x.jsxs)("span",{className:"cell-anatomy-type cell-anatomy-type-deterministic",children:[(0,x.jsx)(c.In,{icon:"mdi:cog",width:"12"}),"Deterministic"]})]}),(0,x.jsxs)("div",{className:"cell-anatomy-header-right",children:[(0,x.jsxs)("span",{className:"cell-anatomy-mode ".concat(h?"execution":"spec"),children:[(0,x.jsx)(c.In,{icon:h?"mdi:play-circle":"mdi:file-document-outline",width:"14"}),h?"Execution":"Spec"]}),o&&(0,x.jsx)("button",{className:"cell-anatomy-close",onClick:o,children:(0,x.jsx)(c.In,{icon:"mdi:close",width:"16"})})]})]}),(0,x.jsxs)("div",{className:"cell-anatomy-body",children:[(0,x.jsx)(ss,{inputsSchema:g.inputsSchema,instructions:g.instructions,tool:g.tool}),g.context&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(fs,{type:"minor"}),(0,x.jsx)(ns,{context:g.context})]}),g.preWards.length>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(fs,{type:"minor"}),(0,x.jsx)(as,{type:"pre",wards:g.preWards,results:null===u||void 0===u||null===(s=u.wardResults)||void 0===s?void 0:s.pre})]}),(0,x.jsx)(fs,{type:"major",label:"Execution Chamber"}),(0,x.jsx)(is,{config:g,execution:u,isLLMCell:j}),p&&(0,x.jsx)(ps,{paretoData:p}),(g.factor>1||g.preValidator||g.evaluator)&&(0,x.jsx)(xs,{config:g,winnerIndex:null===u||void 0===u?void 0:u.winnerIndex,mode:g.mode,evaluatorResult:null===u||void 0===u?void 0:u.evaluatorResult}),(0,x.jsx)(fs,{type:"major"}),g.reforge&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(vs,{config:g.reforge,execution:null===u||void 0===u?void 0:u.reforgeData}),(0,x.jsx)(fs,{type:"major"})]}),g.postWards.length>0&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(as,{type:"post",wards:g.postWards,results:null===u||void 0===u||null===(n=u.wardResults)||void 0===n?void 0:n.post}),(0,x.jsx)(fs,{type:"minor"})]}),(0,x.jsx)(gs,{outputSchema:g.outputSchema,outputExtraction:g.outputExtraction,callouts:g.callouts,handoffs:g.handoffs,result:null===i||void 0===i?void 0:i.result})]}),(0,x.jsx)(js,{cellState:i,executionData:u,config:g,cascadeAnalytics:r,cellAnalytics:d})]})};var bs=n(3758);const Ns=a.memo(e=>{let{nodes:s,inputPositions:n,inputColorMap:t,timelineOffset:a,timelineHeight:l,scrollOffset:i,cellCostMetrics:o={}}=e;const c={type:"spring",stiffness:300,damping:30,mass:.8};return(0,x.jsxs)("svg",{className:"cascade-input-edges",style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",pointerEvents:"none",zIndex:5},children:[(0,x.jsx)("defs",{children:(0,x.jsx)("clipPath",{id:"timeline-clip",children:(0,x.jsx)("rect",{x:a.left,y:a.top,width:1e4,height:l||400})})}),(0,x.jsx)("g",{clipPath:"url(#timeline-clip)",children:s.map(e=>e.inputDeps&&0!==e.inputDeps.length?e.inputDeps.map(s=>{var l;const r=n[s]||50,d=t[s]||"#ffd700",u=(((o[null===(l=e.cell)||void 0===l?void 0:l.name]||{}).scale||1)-1)*bs.m8/2,m=a.left,h=0+r+52,p=a.left+(e.x-i.x)-u,v=a.top+(e.y+50-i.y);if(p<a.left-300||p>window.innerWidth)return null;const g=p-m,j=m+Math.min(60,.3*g),f=p-Math.min(60,.3*g),y="M ".concat(m,",").concat(h," C ").concat(j,",").concat(h," ").concat(f,",").concat(v," ").concat(p,",").concat(v),b="input-".concat(e.cellIdx,"-").concat(s);return(0,x.jsx)(L.P.path,{d:y,stroke:d,strokeWidth:"2.5",fill:"none",opacity:"0.75",strokeLinecap:"round",strokeDasharray:"5 5",initial:{d:y},animate:{d:y},transition:c},b)}):null)})]})});Ns.displayName="InputEdgesSVG";const ws=a.memo(e=>{let{edges:s,width:n,height:t,cellCostMetrics:a={}}=e;const l={type:"spring",stiffness:300,damping:30,mass:.8};return(0,x.jsx)("svg",{className:"cascade-edges",style:{position:"absolute",left:0,top:0,width:"".concat(n+100,"px"),height:"".concat(t+100,"px"),pointerEvents:"none",zIndex:0,overflow:"visible"},children:s.map((e,s)=>{var n,t;const{source:i,target:o,contextType:c,isBranch:r,isMerge:d}=e,u=a[null===(n=i.cell)||void 0===n?void 0:n.name]||{},m=a[null===(t=o.cell)||void 0===t?void 0:t.name]||{},h=u.scale||1,p=m.scale||1,v=(h-1)*bs.m8/2,g=(p-1)*bs.m8/2,j=i.x+bs.m8+v,f=i.y+bs.dv/2,y=o.x-g,b=o.y+bs.dv/2,N=r||d?"#ff006e":{data:"#00e5ff",selective:"#a78bfa",execution:"#64748b"}[c]||"#64748b",w="execution"===c?.3:.6,S=y-j,k=j+.5*S,_=y-.5*S,C="M ".concat(j,",").concat(f," C ").concat(k,",").concat(f," ").concat(_,",").concat(b," ").concat(y,",").concat(b),I="edge-".concat(i.cellIdx,"-").concat(o.cellIdx);return(0,x.jsx)(L.P.path,{d:C,stroke:N,strokeWidth:"3",fill:"none",opacity:w,strokeLinecap:"round",initial:{d:C},animate:{d:C},transition:l},I)})})});ws.displayName="CellEdgesSVG";const Ss=()=>{const{isOver:e,setNodeRef:s}=(0,i.zM)({id:"canvas-background",data:{type:"canvas-background"}});return(0,x.jsx)("div",{ref:s,className:"cascade-canvas-drop-zone ".concat(e?"cascade-canvas-drop-active":"")})},ks=e=>{let{onOpenBrowser:s,onMessageContextSelect:n,onLogsUpdate:l,onMessagesViewVisibleChange:i,hoveredHash:o,onHoverHash:r,gridSelectedMessage:d,onGridMessageSelect:u,onMessageFiltersChange:h}=e;const v=(0,p.A)(e=>e.cascade),g=(0,p.A)(e=>e.cascadePath),j=(0,p.A)(e=>e.cascadeDirty),f=(0,p.A)(e=>e.cellStates),y=(0,p.A)(e=>e.isRunningAll),b=(0,p.A)(e=>e.cascadeSessionId),N=(0,p.A)(e=>e.viewMode),w=(0,p.A)(e=>e.replaySessionId),S=(0,p.A)(e=>e.selectedCellIndex),k=(0,p.A)(e=>e.defaultModel),_=(0,p.A)(e=>e.fetchCascades),C=((0,p.A)(e=>e.loadCascade),(0,p.A)(e=>e.newCascade)),I=(0,p.A)(e=>e.restartSession),A=(0,p.A)(e=>e.updateCascade),T=(0,p.A)(e=>e.saveCascade),E=(0,p.A)(e=>e.setSelectedCellIndex),M=(0,p.A)(e=>e.updateCellStatesFromPolling),O=(0,p.A)(e=>e.updateAnalyticsFromPolling),[R,F]=(0,a.useState)(!1),[P,z]=(0,a.useState)(!1),[D,q]=(0,a.useState)(!1),[H,J]=(0,a.useState)(""),[W,U]=(0,a.useState)(""),[K,V]=(0,a.useState)(!1),[$,G]=(0,a.useState)(null),{showToast:Y}=(0,ae.dj)(),Q="replay"===N?w:b,X="replay"===N?!!w:!(!b||!y),{logs:Z,cellStates:ee,totalCost:se,sessionStatus:ne,sessionStatusFor:te,sessionError:le,childSessions:ie,cascadeAnalytics:oe,cellAnalytics:ce}=_e(Q,X,"replay"===N),{events:re}=(0,Ce.D)(Q,X);(0,a.useEffect)(()=>{if(Z&&Z.length>0){const e=Z.filter(e=>{var s;return(null===(s=e.context_hashes)||void 0===s?void 0:s.length)>0});console.log("[CascadeTimeline] Logs with context:",{total:Z.length,withContext:e.length,sampleWithContext:e[0]}),l&&l(Z)}},[Z,l]),(0,a.useEffect)(()=>{const e=Z&&Z.length>0,s=e&&(null===S||null!==S);console.log("[CascadeTimeline] Messages view visible:",s,{selectedCellIndex:S,logsLength:null===Z||void 0===Z?void 0:Z.length}),i&&i(e)},[S,Z,i]),(0,a.useEffect)(()=>{if(console.log("[CascadeTimeline] Terminal state check:",{sessionStatus:ne,sessionStatusFor:te,cascadeSessionId:b,isRunningAll:y,sessionToPoll:Q}),!ne||!b)return;if(te!==b)return void console.log("[CascadeTimeline] Ignoring stale sessionStatus:",{statusFor:te,currentSession:b,status:ne});["completed","error","cancelled","orphaned"].includes(ne)&&($&&(console.log("[CascadeTimeline] Clearing blocked cell indicator (session terminal)"),G(null)),y&&(console.log("[CascadeTimeline] \u26a0\ufe0f SETTING isRunningAll = FALSE due to terminal status:",{sessionId:b,sessionStatus:ne,sessionError:le}),p.A.setState({isRunningAll:!1})))},[ne,te,b,y,le,Q,$]),a.useEffect(()=>{},[N,Q,X,Z.length,ee,se]);const de=(0,a.useRef)("");(0,a.useEffect)(()=>{if(!ee||0===Object.keys(ee).length)return;const e=JSON.stringify(ee);e!==de.current&&(de.current=e,M(ee))},[ee,M]);const ue=(0,a.useRef)("");(0,a.useEffect)(()=>{if(!ie||0===Object.keys(ie).length)return;const e=JSON.stringify(ie);e!==ue.current&&(console.log("[CascadeTimeline] Updating childSessions from polling:",Object.keys(ie)),ue.current=e,p.A.setState({childSessions:ie}))},[ie]);const me="replay"===N?w:b;(0,a.useEffect)(()=>{if(console.log("[CascadeTimeline] Checkpoint polling setup:",{checkpointSessionId:me,cascadeSessionId:b,viewMode:N}),!me)return void G(null);const e=async()=>{try{const e=await fetch("".concat(m.J,"/api/checkpoints")),s=await e.json();if(s.error)return;const n=(s.checkpoints||[]).find(e=>"pending"===e.status&&e.session_id===me);console.log("[CascadeTimeline] Checkpoint check:",{checkpointSessionId:me,foundCell:null===n||void 0===n?void 0:n.cell_name,pendingCount:(s.checkpoints||[]).filter(e=>"pending"===e.status).length}),G((null===n||void 0===n?void 0:n.cell_name)||null)}catch(e){}};e();const s=setInterval(e,y?2e3:5e3);return()=>clearInterval(s)},[me,y]);const he=(0,a.useRef)("");(0,a.useEffect)(()=>{if(!oe&&(!ce||0===Object.keys(ce).length))return;const e=JSON.stringify({cascadeAnalytics:oe,cellAnalytics:ce});e!==he.current&&(console.log("[CascadeTimeline] Updating analytics from polling:",{hasCascadeAnalytics:!!oe,cellAnalyticsCount:Object.keys(ce||{}).length}),he.current=e,O(oe,ce))},[oe,ce,O]);const pe=(0,a.useRef)(null),[xe,ve]=(0,a.useState)("linear"),[ge,je]=(0,a.useState)({x:0,y:0}),[fe,ye]=(0,a.useState)({left:0,top:0}),[be,Ne]=(0,a.useState)(0),[we,Se]=(0,a.useState)(!1),[ke,Ie]=(0,a.useState)(()=>{try{const e=localStorage.getItem("studio-graph-panel-height");return e?parseInt(e,10):null}catch(e){return null}}),[Ae,Te]=(0,a.useState)(!1),Me=(0,a.useRef)({y:0,initialHeight:0}),[Oe,Le]=(0,a.useState)(!1),Re=(0,a.useRef)({x:0,y:0,scrollLeft:0,scrollTop:0}),Fe=(0,a.useRef)(null),Pe=(0,a.useCallback)(e=>{if(0!==e.button)return;if(e.target.closest(".cell-card, button, input, textarea, .cascade-drop-zone"))return;const s=pe.current;s&&(Le(!0),Re.current={x:e.clientX,y:e.clientY,scrollLeft:s.scrollLeft,scrollTop:s.scrollTop},e.preventDefault())},[]),ze=(0,a.useCallback)(e=>{if(!Oe)return;const s=pe.current;if(!s)return;const n=e.clientX-Re.current.x,t=e.clientY-Re.current.y;s.scrollLeft=Re.current.scrollLeft-n,s.scrollTop=Re.current.scrollTop-t},[Oe]),De=(0,a.useCallback)(()=>{Le(!1)},[]),qe=(0,a.useCallback)(e=>{e.preventDefault(),Te(!0);const s=pe.current;if(!s)return;const n=s.clientHeight;Me.current={y:e.clientY,initialHeight:n}},[]),He=(0,a.useCallback)(e=>{if(!Ae)return;const s=e.clientY-Me.current.y,n=Me.current.initialHeight+s,t=Math.max(150,Math.min(600,n));Ie(t);t>=290&&"linear"===xe?(console.log("[CascadeTimeline] Auto-switching to graph mode at",t),ve("graph")):t<=270&&"graph"===xe&&(console.log("[CascadeTimeline] Auto-switching to linear mode at",t),ve("linear"))},[Ae,xe]),Je=(0,a.useCallback)(()=>{if(Te(!1),null!==ke)try{localStorage.setItem("studio-graph-panel-height",String(ke))}catch(e){console.warn("Failed to save graph panel height to localStorage:",e)}},[ke]);(0,a.useEffect)(()=>{if(Oe)return window.addEventListener("mousemove",ze),window.addEventListener("mouseup",De),()=>{window.removeEventListener("mousemove",ze),window.removeEventListener("mouseup",De)}},[Oe,ze,De]),(0,a.useEffect)(()=>{if(Ae)return window.addEventListener("mousemove",He),window.addEventListener("mouseup",Je),document.body.style.userSelect="none",document.body.style.cursor="ns-resize",()=>{window.removeEventListener("mousemove",He),window.removeEventListener("mouseup",Je),document.body.style.userSelect="",document.body.style.cursor=""}},[Ae,He,Je]),(0,a.useEffect)(()=>{const e=pe.current;if(!e)return;const s=()=>{const s=e.getBoundingClientRect(),n={left:s.left,top:s.top};ye(n),Ne(s.height)},n=()=>{Fe.current||(Fe.current=requestAnimationFrame(()=>{je({x:e.scrollLeft,y:e.scrollTop}),Fe.current=null}))},t=()=>{s()};s(),n(),window.addEventListener("resize",s),window.addEventListener("scroll",t,{passive:!0}),e.addEventListener("scroll",n,{passive:!0});const a=new ResizeObserver(s),l=e.parentElement;l&&a.observe(l);const i=setTimeout(s,100),o=setTimeout(s,300),c=setTimeout(s,600);return()=>{window.removeEventListener("resize",s),window.removeEventListener("scroll",t),e.removeEventListener("scroll",n),a.disconnect(),clearTimeout(i),clearTimeout(o),clearTimeout(c),Fe.current&&(cancelAnimationFrame(Fe.current),Fe.current=null)}},[xe,null===v||void 0===v?void 0:v.cascade_id,ke]);const We=(0,a.useMemo)(()=>(null===v||void 0===v?void 0:v.cells)||[],[null===v||void 0===v?void 0:v.cells]),Be=(0,a.useMemo)(()=>(null===v||void 0===v?void 0:v.inputs_schema)||{},[null===v||void 0===v?void 0:v.inputs_schema]);a.useEffect(()=>{console.log("[CascadeTimeline] Cascade data:",{hasCascade:!!v,cascadeId:null===v||void 0===v?void 0:v.cascade_id,cellsLength:We.length,cellNames:We.map(e=>e.name),inputsSchema:Object.keys(Be)})},[v,We,Be]);const Ke=()=>{z(!1),F(!0),setTimeout(()=>{C(),setTimeout(()=>{F(!1)},100)},500)};(0,a.useEffect)(()=>{_()},[_]),(0,a.useEffect)(()=>{v||C()},[v,C]);const Ve=(0,a.useCallback)(e=>{E(S===e?null:e)},[S,E]),$e=(0,a.useMemo)(()=>[],[]),Ge=(0,a.useMemo)(()=>{const e={};return Z.forEach(s=>{s.cell_name&&(e[s.cell_name]||(e[s.cell_name]=[]),e[s.cell_name].push(s))}),e},[Z]),Ye=(0,a.useRef)({}),Qe=(0,a.useMemo)(()=>{const e={};return Object.keys(f).forEach(s=>{const n=f[s],t=Ye.current[s];t&&JSON.stringify(n)===JSON.stringify(t)?e[s]=t:e[s]=n}),Ye.current=e,e},[f]),Xe=(0,a.useMemo)(()=>{if(!We||0===We.length)return{};console.log("[CascadeTimeline] Calculating cellCostMetrics, cellAnalytics:",ce);const e={};let s=0;return We.forEach(n=>{var t;const a=(null===(t=Qe[n.name])||void 0===t?void 0:t.cost)||0;e[n.name]={cost:a},s+=a}),Object.keys(e).forEach(n=>{var t;const a=e[n].cost,l=(null===(t=Qe[n])||void 0===t?void 0:t.duration)||0,i=null===ce||void 0===ce?void 0:ce[n];i&&console.log("[CascadeTimeline] Using analytics for ".concat(n,":"),i);let o=null,c=0,r=!1,d=0,u=0;i&&i.species_avg_cost>0?(o=a/i.species_avg_cost,c=i.cell_cost_pct||0,r=i.is_cost_outlier||!1,d=i.species_avg_cost,u=i.species_run_count||0):c=s>0?a/s*100:0;let m=1;c>60?m=1.3:c>40?m=1.2:c>25?m=1.1:c<10?m=.9:c<5&&(m=.85);let h="cyan";r||o&&o>=1.5?h="red":o&&o>=1.2?h="orange":o&&o<=.7?h="green":c>50&&(h="orange"),e[n]={cost:a,duration:l,scale:m,color:h,cellCostPct:c,costMultiplier:o,isOutlier:r,speciesAvgCost:d,speciesRunCount:u,costDeltaPct:o?100*(o-1):0}}),e},[We,Qe,ce]),Ze=(0,a.useMemo)(()=>{const e=(0,bs.xb)(We,Be,"linear"===xe,Xe);return console.log("[CascadeTimeline] FBP Layout built:",{cellsInput:We.length,nodesOutput:e.nodes.length,edgesOutput:e.edges.length,width:e.width,height:e.height}),e},[We,Be,xe,Xe]);let ss=null;if(Z&&Z.length>0){const e={};let s=0;for(const n of Z){const t=n.role;t&&!t.startsWith("cell_")&&(e[t]=(e[t]||0)+1,s++)}s>0&&(ss=(0,t.A)((0,t.A)({},e),{},{total:s}))}const ns=null!==S?We[S]:null;return v?(0,x.jsxs)("div",{className:"cascade-timeline",children:[(0,x.jsxs)("div",{className:"cascade-control-bar",children:[(0,x.jsxs)("div",{className:"cascade-control-left",children:[j&&(0,x.jsx)("span",{className:"cascade-dirty-dot",title:"Unsaved changes"}),"replay"===N&&(0,x.jsxs)("span",{className:"cascade-replay-badge",title:"Viewing past execution",children:[(0,x.jsx)(c.In,{icon:"mdi:history",width:"14"}),"Replay"]}),(0,x.jsx)("input",{className:"cascade-description-input",value:v.description||"",onChange:e=>{A({description:e.target.value})},placeholder:"Description..."}),Q&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)("div",{className:"cascade-control-divider"}),(0,x.jsxs)("div",{className:"cascade-session-id-compact",title:"Session: ".concat(Q),children:[(0,x.jsx)(c.In,{icon:"mdi:identifier",width:"14"}),(0,x.jsx)("span",{className:"cascade-session-id-value",children:Q})]}),(0,x.jsx)("div",{className:"cascade-total-cost-compact",title:"Total cascade cost (polling: ".concat(X?"active":"inactive",")"),children:(0,x.jsx)("span",{className:"cascade-total-cost-value",children:0===se?"$0.00":se<.01?"<$0.01":"$".concat(se.toFixed(4))})}),ss&&(0,x.jsxs)("div",{className:"cascade-message-counts-compact",title:Object.entries(ss).filter(e=>{let[s]=e;return"total"!==s}).map(e=>{let[s,n]=e;return"".concat(s,": ").concat(n)}).join(", "),children:[(0,x.jsx)(c.In,{icon:"mdi:message-text",width:"14"}),(0,x.jsxs)("span",{className:"cascade-message-counts-value",children:[["user","assistant","tool"].filter(e=>ss[e]).map(e=>"".concat(ss[e]).concat(e[0])).join(" "),Object.keys(ss).filter(e=>"total"!==e&&!["user","assistant","tool"].includes(e)).sort().map(e=>" ".concat(ss[e]).concat(e[0])).join("")]})]})]})]}),(0,x.jsxs)("div",{className:"cascade-control-right",children:[(0,x.jsx)("div",{className:"cascade-control-divider"}),(0,x.jsx)(B.m_,{label:"Edge Legend",description:"Cyan: Data flow \u2022 Purple: Context \u2022 Gray: Execution order \u2022 Pink: Branch/merge \u2022 Warm: Input params",children:(0,x.jsx)("div",{className:"cascade-edge-legend",children:(0,x.jsxs)("div",{className:"legend-dots",children:[(0,x.jsx)("div",{className:"legend-dot",style:{backgroundColor:"#00e5ff"}}),(0,x.jsx)("div",{className:"legend-dot",style:{backgroundColor:"#a78bfa"}}),(0,x.jsx)("div",{className:"legend-dot",style:{backgroundColor:"#64748b"}}),(0,x.jsx)("div",{className:"legend-dot",style:{backgroundColor:"#ff006e"}}),(0,x.jsx)("div",{className:"legend-dot legend-dot-gradient"})]})})}),(0,x.jsx)("div",{className:"cascade-control-divider"}),(0,x.jsx)(B.m_,{label:"New",description:"Create blank cascade",children:(0,x.jsx)(ae.$n,{variant:"secondary",icon:"mdi:file-plus-outline",onClick:async()=>{j?z(!0):Ke()},children:"New"})}),(0,x.jsx)(B.m_,{label:"Open",description:"Open cascade file",children:(0,x.jsx)(ae.$n,{variant:"secondary",icon:"mdi:folder-open",onClick:()=>s&&s(),children:"Open"})}),(0,x.jsx)(B.m_,{label:"Clear",description:"Clear session and start fresh",children:(0,x.jsx)(ae.$n,{variant:"secondary",icon:"mdi:restart",onClick:async()=>{window.confirm("Restart session? This will clear all outputs.")&&await I()},children:" Clear "})}),(0,x.jsx)(B.m_,{label:"Save",description:"Save cascade changes",children:(0,x.jsx)(ae.$n,{variant:"tool",icon:"mdi:content-save",onClick:()=>{const e=g||"cascades/".concat((null===v||void 0===v?void 0:v.cascade_id)||"cascade",".yaml");J(e),U((null===v||void 0===v?void 0:v.cascade_id)||""),q(!0)},disabled:!j&&g,children:"Save"})})]})]}),Object.keys(Be).length>0&&(0,x.jsx)(Ns,{nodes:Ze.nodes,inputPositions:Ze.inputPositions,inputColorMap:Ze.inputColorMap,timelineOffset:fe,timelineHeight:be,scrollOffset:ge,cellCostMetrics:Xe}),(0,x.jsx)("div",{className:"cascade-timeline-strip ".concat(Oe?"grabbing":""),ref:pe,onMouseDown:Pe,style:{height:ke?"".concat(ke,"px"):0===We.length?"100%":"linear"===xe?"180px":"400px",minHeight:ke?void 0:0===We.length?"100%":"linear"===xe?"180px":"150px",maxHeight:ke?void 0:0===We.length?"none":"linear"===xe?"180px":"400px",flex:0===We.length?1:void 0,cursor:Oe?"grabbing":"grab"},children:(0,x.jsxs)("div",{className:"cascade-fbp-canvas",style:{width:0===We.length?"100%":"".concat(Ze.width,"px"),height:0===We.length?"100%":"".concat(Ze.height,"px"),position:"relative",minHeight:"100%",overflow:"visible"},children:[(0,x.jsx)(Ss,{}),(0,x.jsx)(ws,{edges:Ze.edges,width:Ze.width,height:Ze.height,cellCostMetrics:Xe}),Ze.nodes.map(e=>(0,x.jsxs)(L.P.div,{className:"fbp-node",style:{position:"absolute",width:"240px",zIndex:S===e.cellIdx?100:50},initial:{left:e.x,top:e.y},animate:{left:e.x,top:e.y},transition:{type:"spring",stiffness:300,damping:30,mass:.8},children:[(0,x.jsx)(Ee,{cell:e.cell,index:e.cellIdx,cellState:Qe[e.cell.name],cellLogs:Ge[e.cell.name]||$e,isSelected:S===e.cellIdx,onSelect:Ve,defaultModel:k,costMetrics:Xe[e.cell.name],isBlocked:$===e.cell.name}),re&&re.filter(s=>s.cell_name===e.cell.name).length>0&&(0,x.jsxs)("div",{style:{position:"absolute",top:"-32px",right:"0",fontSize:"11px",fontFamily:"IBM Plex Mono, monospace",fontWeight:"700",color:"#fbbf24",whiteSpace:"nowrap",textShadow:"0 0 6px rgba(0, 0, 0, 0.9), 0 0 3px rgba(0, 0, 0, 1)",cursor:"help"},title:"Budget enforced: ".concat(re.filter(s=>s.cell_name===e.cell.name).map(e=>"-".concat(((e.budget_tokens_pruned||0)/1e3).toFixed(1),"K tokens")).join(", ")),children:["\ud83d\udca5 ",re.filter(s=>s.cell_name===e.cell.name).reduce((e,s)=>e+(s.budget_tokens_pruned||0),0)>=1e3?"-".concat((re.filter(s=>s.cell_name===e.cell.name).reduce((e,s)=>e+(s.budget_tokens_pruned||0),0)/1e3).toFixed(1),"K"):"-".concat(re.filter(s=>s.cell_name===e.cell.name).reduce((e,s)=>e+(s.budget_tokens_pruned||0),0))]})]},"node-".concat(e.cellIdx))),0===We.length&&(0,x.jsxs)("div",{className:"cascade-empty-hint",children:[(0,x.jsx)(c.In,{icon:"mdi:hand-back-left",width:"32"}),(0,x.jsx)("span",{children:"Drag cell types from the sidebar to start"})]})]})}),We.length>0&&(0,x.jsx)("div",{className:"cascade-resize-handle",onMouseDown:qe,style:{height:"4px",background:Ae?"rgba(167, 139, 250, 0.5)":"transparent",cursor:"ns-resize",position:"relative",zIndex:10,transition:Ae?"none":"background 0.15s ease"},onMouseEnter:e=>{Ae||(e.currentTarget.style.background="rgba(167, 139, 250, 0.3)")},onMouseLeave:e=>{Ae||(e.currentTarget.style.background="transparent")},children:(0,x.jsxs)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",display:"flex",gap:"4px",pointerEvents:"none"},children:[(0,x.jsx)("div",{style:{width:"3px",height:"3px",borderRadius:"50%",background:"#64748b"}}),(0,x.jsx)("div",{style:{width:"3px",height:"3px",borderRadius:"50%",background:"#64748b"}}),(0,x.jsx)("div",{style:{width:"3px",height:"3px",borderRadius:"50%",background:"#64748b"}})]})}),We.length>0&&(ns?(0,x.jsx)(es,{cell:ns,index:S,cellState:Qe[ns.name],cellLogs:Ge[ns.name]||$e,allSessionLogs:Z,currentSessionId:Q,onClose:()=>E(null),hoveredHash:o,onHoverHash:r,externalSelectedMessage:d,onMessageClick:e=>{u&&u(e),n&&n(e)}}):Z.length>0?(0,x.jsx)(Ue.A,{logs:Z,currentSessionId:Q,shouldPollBudget:X,hoveredHash:o,onHoverHash:r,externalSelectedMessage:d,onSelectCell:e=>{const s=We.findIndex(s=>s.name===e);-1!==s&&E(s)},onMessageClick:e=>{u&&u(e),n&&n(e)},onFiltersChange:h}):(0,x.jsxs)("div",{className:"cascade-empty-detail",children:[(0,x.jsx)(c.In,{icon:"mdi:cursor-pointer",width:"32"}),(0,x.jsx)("p",{children:"Select a cell above to view details"})]})),ns&&(0,x.jsxs)("div",{className:"cascade-anatomy-edge-tab ".concat(we?"active":""),onClick:()=>Se(!we),title:"Cell Anatomy - Internal structure visualization",children:[(0,x.jsx)(c.In,{icon:"mdi:cogs",width:"20"}),(0,x.jsx)("span",{className:"cascade-anatomy-edge-label",children:"Anatomy"})]}),we&&ns&&(0,x.jsx)("div",{className:"cascade-anatomy-panel-container",children:(0,x.jsx)(ys,{cell:ns,cellLogs:Ge[ns.name]||$e,cellState:Qe[ns.name],onClose:()=>Se(!1),cascadeAnalytics:oe,cellAnalytics:null===ce||void 0===ce?void 0:ce[ns.name]})}),R&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(L.P.div,{className:"cascade-screen-wipe",initial:{scaleX:0},animate:{scaleX:1},transition:{duration:.5,ease:[.87,0,.13,1]},style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"linear-gradient(90deg, #000000 0%, #001a1a 20%, #003366 60%, #00e5ff 100%)",transformOrigin:"left",zIndex:9998,pointerEvents:"none"}}),(0,x.jsx)(L.P.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.2,delay:.1},style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 229, 255, 0.03) 2px, rgba(0, 229, 255, 0.03) 4px)",zIndex:9999,pointerEvents:"none"}}),(0,x.jsx)(L.P.div,{initial:{opacity:0},animate:{opacity:.15},transition:{duration:.3,delay:.15},style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundImage:"\n                linear-gradient(rgba(0, 229, 255, 0.1) 1px, transparent 1px),\n                linear-gradient(90deg, rgba(0, 229, 255, 0.1) 1px, transparent 1px)\n              ",backgroundSize:"50px 50px",zIndex:1e4,pointerEvents:"none"}}),(0,x.jsx)(L.P.div,{initial:{scaleX:0,opacity:0},animate:{scaleX:1,opacity:1},transition:{duration:.5,ease:[.87,0,.13,1]},style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",boxShadow:"inset -3px 0 20px rgba(0, 229, 255, 0.8), inset -10px 0 60px rgba(167, 139, 250, 0.4)",transformOrigin:"left",zIndex:10001,pointerEvents:"none"}})]}),(0,x.jsxs)(ae.aF,{isOpen:P,onClose:()=>z(!1),size:"small",children:[(0,x.jsx)(ae.rQ,{icon:"mdi:alert-circle-outline",title:"Unsaved Changes",iconColor:"#fbbf24"}),(0,x.jsxs)(ae.$m,{children:[(0,x.jsx)("p",{style:{marginBottom:"12px",color:"#cbd5e1"},children:"You have unsaved changes to the current cascade."}),(0,x.jsx)("p",{style:{color:"#94a3b8"},children:"Creating a new cascade will discard these changes."})]}),(0,x.jsxs)(ae.jl,{align:"right",children:[(0,x.jsx)(ae.$n,{variant:"secondary",onClick:()=>z(!1),children:"Cancel"}),(0,x.jsx)(ae.$n,{variant:"danger",icon:"mdi:file-plus-outline",onClick:Ke,children:"Create New"})]})]}),(0,x.jsxs)(ae.aF,{isOpen:D,onClose:()=>q(!1),size:"sm",children:[(0,x.jsx)(ae.rQ,{icon:"mdi:content-save",title:"Save Cascade"}),(0,x.jsx)(ae.$m,{children:(0,x.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{style:{display:"block",marginBottom:"6px",color:"#94a3b8",fontSize:"12px",fontWeight:500},children:"Cascade ID"}),(0,x.jsx)("input",{type:"text",value:W,onChange:e=>U(e.target.value),placeholder:"my_cascade",style:{width:"100%",padding:"10px 12px",backgroundColor:"#0a0818",border:"1px solid #1e1b4b",borderRadius:"6px",color:"#e2e8f0",fontSize:"14px",fontFamily:"monospace"}}),(0,x.jsx)("p",{style:{marginTop:"4px",color:"#64748b",fontSize:"11px"},children:"Unique identifier for this cascade. Change if saving a copy."})]}),(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{style:{display:"block",marginBottom:"6px",color:"#94a3b8",fontSize:"12px",fontWeight:500},children:"File Path"}),(0,x.jsx)("input",{type:"text",value:H,onChange:e=>J(e.target.value),placeholder:"cascades/my_cascade.yaml",style:{width:"100%",padding:"10px 12px",backgroundColor:"#0a0818",border:"1px solid #1e1b4b",borderRadius:"6px",color:"#e2e8f0",fontSize:"14px",fontFamily:"monospace"}}),(0,x.jsxs)("p",{style:{marginTop:"4px",color:"#64748b",fontSize:"11px"},children:["Relative to LARS root. Use ",(0,x.jsx)("code",{style:{color:"#a78bfa"},children:"cascades/"})," for cascades or ",(0,x.jsx)("code",{style:{color:"#a78bfa"},children:"skills/"})," for reusable tools."]})]}),g&&H!==g&&(0,x.jsxs)("div",{style:{padding:"10px 12px",backgroundColor:"rgba(251, 191, 36, 0.1)",border:"1px solid rgba(251, 191, 36, 0.3)",borderRadius:"6px",display:"flex",gap:"8px",alignItems:"flex-start"},children:[(0,x.jsx)(c.In,{icon:"mdi:alert",style:{color:"#fbbf24",flexShrink:0,marginTop:"2px"}}),(0,x.jsx)("p",{style:{color:"#fbbf24",fontSize:"12px",margin:0},children:"Saving to a different path. Consider changing the Cascade ID to avoid duplicates."})]})]})}),(0,x.jsxs)(ae.jl,{align:"right",children:[(0,x.jsx)(ae.$n,{variant:"secondary",onClick:()=>q(!1),disabled:K,children:"Cancel"}),(0,x.jsx)(ae.$n,{variant:"primary",icon:K?"mdi:loading":"mdi:content-save",onClick:async()=>{if(H.trim())if(W.trim()){V(!0);try{W!==(null===v||void 0===v?void 0:v.cascade_id)&&A({cascade_id:W}),await T(H),Y("Saved to ".concat(H),{type:"success"}),q(!1)}catch(e){console.error("Failed to save cascade:",e),Y("Failed to save: ".concat(e.message),{type:"error",duration:6e3})}finally{V(!1)}}else Y("Please enter a cascade ID",{type:"error"});else Y("Please enter a file path",{type:"error"})},disabled:K,children:K?"Saving...":"Save"})]})]})]}):(0,x.jsxs)("div",{className:"cascade-timeline cascade-loading",children:[(0,x.jsx)("div",{className:"cascade-spinner"}),"Loading cascade..."]})};const _s=function(e){let{isOpen:s,onClose:n,onLoad:l}=e;const[i,o]=(0,a.useState)([]),[r,d]=(0,a.useState)(!0),[u,h]=(0,a.useState)(null),[p,v]=(0,a.useState)(""),[g,j]=(0,a.useState)(new Set(["examples","skills"])),[f,y]=(0,a.useState)(null);(0,a.useEffect)(()=>{s&&(d(!0),h(null),fetch("".concat(m.J,"/api/playground/browse")).then(e=>e.json()).then(e=>{e.error?h(e.error):o(e.categories||[]),d(!1)}).catch(e=>{h(e.message),d(!1)}))},[s]);const b=i.map(e=>(0,t.A)((0,t.A)({},e),{},{files:e.files.filter(e=>{if(!p)return!0;const s=p.toLowerCase();return e.name.toLowerCase().includes(s)||(e.description||"").toLowerCase().includes(s)||e.filename.toLowerCase().includes(s)})})).filter(e=>e.files.length>0),N=(0,a.useCallback)(e=>{j(s=>{const n=new Set(s);return n.has(e)?n.delete(e):n.add(e),n})},[]),w=(0,a.useCallback)(e=>{y(e)},[]),S=(0,a.useCallback)(()=>{f&&l&&(l(f),n())},[f,l,n]),k=(0,a.useCallback)(e=>{l&&(l(e),n())},[l,n]);return(0,a.useEffect)(()=>{const e=e=>{"Escape"===e.key&&n()};if(s)return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[s,n]),s?(0,x.jsx)("div",{className:"studio-browser-overlay",onClick:n,children:(0,x.jsxs)("div",{className:"studio-browser-modal",onClick:e=>e.stopPropagation(),children:[(0,x.jsxs)("div",{className:"studio-browser-header",children:[(0,x.jsxs)("div",{className:"header-title",children:[(0,x.jsx)(c.In,{icon:"mdi:folder-open",width:"24"}),(0,x.jsx)("span",{children:"Open Cascade"})]}),(0,x.jsx)("button",{className:"close-button",onClick:n,children:(0,x.jsx)(c.In,{icon:"mdi:close",width:"20"})})]}),(0,x.jsxs)("div",{className:"studio-browser-search",children:[(0,x.jsx)(c.In,{icon:"mdi:magnify",width:"18"}),(0,x.jsx)("input",{type:"text",placeholder:"Search cascades...",value:p,onChange:e=>v(e.target.value),autoFocus:!0}),p&&(0,x.jsx)("button",{className:"clear-search",onClick:()=>v(""),children:(0,x.jsx)(c.In,{icon:"mdi:close-circle",width:"16"})})]}),(0,x.jsxs)("div",{className:"studio-browser-content",children:[r&&(0,x.jsxs)("div",{className:"browser-loading",children:[(0,x.jsx)(c.In,{icon:"mdi:loading",className:"spin",width:"32"}),(0,x.jsx)("span",{children:"Loading files..."})]}),u&&(0,x.jsxs)("div",{className:"browser-error",children:[(0,x.jsx)(c.In,{icon:"mdi:alert-circle",width:"24"}),(0,x.jsx)("span",{children:u})]}),!r&&!u&&0===b.length&&(0,x.jsxs)("div",{className:"browser-empty",children:[(0,x.jsx)(c.In,{icon:"mdi:folder-off",width:"48"}),(0,x.jsx)("span",{children:"No cascades found"}),p&&(0,x.jsx)("p",{children:"Try a different search term"})]}),!r&&!u&&b.map(e=>(0,x.jsxs)("div",{className:"browser-category",children:[(0,x.jsxs)("div",{className:"category-header",onClick:()=>N(e.id),children:[(0,x.jsx)(c.In,{icon:g.has(e.id)?"mdi:chevron-down":"mdi:chevron-right",width:"20"}),(0,x.jsx)(c.In,{icon:e.icon,width:"18"}),(0,x.jsx)("span",{className:"category-name",children:e.name}),(0,x.jsx)("span",{className:"category-count",children:e.count})]}),g.has(e.id)&&(0,x.jsx)("div",{className:"category-files",children:e.files.map(e=>(0,x.jsxs)("div",{className:"file-item ".concat((null===f||void 0===f?void 0:f.filepath)===e.filepath?"selected":""),onClick:()=>w(e),onDoubleClick:()=>k(e),children:[(0,x.jsx)("div",{className:"file-icon",children:(0,x.jsx)(c.In,{icon:e.is_image_cascade?"mdi:image":"mdi:transit-connection-variant",width:"20"})}),(0,x.jsxs)("div",{className:"file-info",children:[(0,x.jsx)("div",{className:"file-name",children:e.name}),e.description&&(0,x.jsx)("div",{className:"file-description",children:e.description}),(0,x.jsxs)("div",{className:"file-meta",children:[(0,x.jsxs)("span",{children:[(0,x.jsx)(c.In,{icon:"mdi:puzzle",width:"12"}),e.cell_count," cell",1!==e.cell_count?"s":""]}),e.input_count>0&&(0,x.jsxs)("span",{children:[(0,x.jsx)(c.In,{icon:"mdi:form-textbox",width:"12"}),e.input_count," input",1!==e.input_count?"s":""]})]})]})]},e.filepath))})]},e.id))]}),(0,x.jsx)("div",{className:"studio-browser-footer",children:(0,x.jsxs)("div",{className:"footer-actions",children:[(0,x.jsx)("button",{className:"btn-secondary",onClick:n,children:"Cancel"}),(0,x.jsx)("button",{className:"btn-primary",onClick:S,disabled:!f,children:"Open"})]})})]})}):null};var Cs=n(82172);const Is=function(){const{cascadeId:e,sessionId:s}=(0,l.g)(),r=e?decodeURIComponent(e):null,d=s?decodeURIComponent(s):null,{historyPanelOpen:u,fetchConnections:v,connections:g}=h(),{mode:j,setMode:f,fetchCascades:y,loadCascade:w,addCell:S,updateCascade:_,setReplayMode:C,fetchDefaultModel:I,fetchCellTypes:T,joinLiveSession:E,cascadeAnalytics:O,cellAnalytics:L}=(0,p.A)(),[R,F]=a.useState(()=>{try{const e=localStorage.getItem("studio-timeline-split-sizes");return e?JSON.parse(e):[20,80]}catch(e){return[20,80]}}),P=a.useCallback(e=>{F(e);try{localStorage.setItem("studio-timeline-split-sizes",JSON.stringify(e))}catch(s){console.warn("Failed to save split sizes to localStorage:",s)}},[]),[z,D]=(0,a.useState)(null),[q,H]=(0,a.useState)(!1),[J,W]=(0,a.useState)(null),[B,U]=(0,a.useState)([]),[K,V]=(0,a.useState)(!1),[$,G]=(0,a.useState)(null),[Y,Q]=(0,a.useState)(null),[X,Z]=(0,a.useState)(null),ee=(0,a.useCallback)(async e=>{try{await w(e.filepath)}catch(s){console.error("[StudioPage] Load failed:",s)}},[w]),se=(0,a.useCallback)(e=>{var s;if(console.log("[StudioPage] Message selected:",e),console.log("[StudioPage] Has context_hashes?",null===e||void 0===e?void 0:e.context_hashes,"Length:",null===e||void 0===e||null===(s=e.context_hashes)||void 0===s?void 0:s.length),!e)return console.log("[StudioPage] Message deselected, clearing context explorer"),void W(null);e.context_hashes&&e.context_hashes.length>0?(console.log("[StudioPage] Showing context explorer for message"),W(e)):(console.log("[StudioPage] Message has no context, not showing explorer"),W(null))},[]);(0,a.useEffect)(()=>{!K&&J&&(console.log("[StudioPage] Messages view hidden, clearing context explorer"),W(null))},[K,J]);const ne=(0,a.useCallback)(()=>{W(null)},[]),te=(0,a.useCallback)(e=>{console.log("[StudioPage] Navigate to message (scroll only):",e),e&&Q((0,t.A)((0,t.A)({},e),{},{_scrollOnly:!0}))},[]);(0,a.useEffect)(()=>{v(),I(),T()},[v,I,T]),(0,a.useEffect)(()=>{if(g.length>0){const e=h.getState(),s=e.tabs.find(s=>s.id===e.activeTabId);s&&!s.connection&&e.updateTab(s.id,{connection:g[0].name})}},[g]);const ae=(0,a.useRef)({cascade:null,session:null});return(0,a.useEffect)(()=>{(async()=>{const e=p.A.getState();if(d){if("replay"===e.viewMode&&e.replaySessionId===d)return console.log("[StudioPage] Store already in replay mode with this session, skipping URL load"),void(ae.current={cascade:r,session:d});if("live"===e.viewMode&&e.cascadeSessionId===d)return console.log("[StudioPage] Session is currently running LIVE, skipping URL load (not switching to replay)"),void(ae.current={cascade:r,session:d})}if(ae.current.cascade===r&&ae.current.session===d)return void console.log("[StudioPage] Already loaded this URL combination, skipping");if(await new Promise(e=>setTimeout(e,100)),d){console.log("[StudioPage] Loading session from URL:",d);try{var s;const e=await fetch("".concat(m.J,"/api/sessions/").concat(d)),n=await e.json();if(n.session_id&&["starting","running","blocked"].includes(null===(s=n.status)||void 0===s?void 0:s.toLowerCase()))console.log("[StudioPage] \u26a1 Session is RUNNING, joining as live session"),await E(d,n.cascade_id,n.cascade_file||null);else{console.log("[StudioPage] \ud83d\udcd6 Session is finished, loading in replay mode"),await C(d),console.log("[StudioPage] Fetching replay data...");const e=await p.A.getState().fetchReplayData(d);e.success?console.log("[StudioPage] \u2713 Replay data loaded:",e.cellCount,"cells"):console.warn("[StudioPage] \u26a0 Replay data fetch failed:",e.error)}f("timeline")}catch(i){console.error("[StudioPage] Failed to load session:",i)}return void(ae.current={cascade:r,session:d})}if(r){console.log("[StudioPage] Loading cascade from URL:",r),await y();const e=p.A.getState().cascades.find(e=>e.cascade_id===r);return e?(await w(e.path),f("timeline"),console.log("[StudioPage] \u2713 Cascade loaded")):console.warn("[StudioPage] Cascade not found:",r),void(ae.current={cascade:r,session:null})}console.log("[StudioPage] No URL parameters");const t=p.A.getState();if(t.cascade&&t.cascade.cascade_id)return console.log("[StudioPage] Store already has cascade, keeping it:",t.cascade.cascade_id),ae.current={cascade:t.cascade.cascade_id,session:null},void f("timeline");console.log("[StudioPage] Creating new blank cascade");const{autoGenerateSessionId:a}=await Promise.resolve().then(n.bind(n,38190)),l="studio_new_".concat(a().split("-").pop());console.log("[StudioPage] Generated new cascade:",l),p.A.setState({cascade:{cascade_id:l,description:"New cascade",inputs_schema:{},cells:[]},cascadePath:null,cascadeDirty:!1,cascadeSessionId:null,replaySessionId:null,viewMode:"live",isRunningAll:!1,cascadeInputs:{},cellStates:{}}),f("timeline"),ae.current={cascade:l,session:null}})()},[r,d]),(0,x.jsxs)("div",{className:"studio-page",children:["timeline"===j?(0,x.jsxs)(i.Mp,{onDragStart:e=>{const{active:s}=e;D(s.data.current)},onDragEnd:e=>{var s,n,a,l,i;D(null);const{active:o,over:c}=e;if(!c)return;const r=null===(s=o.data.current)||void 0===s?void 0:s.type;if("cell-type"===r){const e=o.data.current.cellType,s=c.data.current;if("cell-card"===(null===s||void 0===s?void 0:s.type)){const n=s.cellIndex;return void S(e,n,null,!1)}if("canvas-background"===(null===s||void 0===s?void 0:s.type))return void S(e,null,null,!1);const n=null===s||void 0===s?void 0:s.position;void 0!==n&&S(e,n)}if("model"===r){const e=o.data.current.modelId,s=c.data.current;if("cell-card"===(null===s||void 0===s?void 0:s.type)){var d;const n=s.cellIndex,a=p.A.getState(),l=null===(d=a.cascade)||void 0===d?void 0:d.cells[n];if(l){const s=[...a.cascade.cells];s[n]=(0,t.A)((0,t.A)({},l),{},{model:e}),_({cells:s})}return}if("canvas-background"===(null===s||void 0===s?void 0:s.type)){var u;const s=e=>e.split("/").pop().replace(/[^a-z0-9_]/gi,"_").toLowerCase().slice(0,30),n=s(e),t=(null===(u=p.A.getState().cascade)||void 0===u?void 0:u.cells)||[];let a=n,l=1;for(;t.some(e=>e.name===a);)a="".concat(n,"_").concat(l),l++;const i={name:a,instructions:"{{ input.prompt }}",model:e},o=[...t,i];return void _({cells:o})}}if("tool"===r){const e=o.data.current.toolId,s=c.data.current;if("cell-card"===(null===s||void 0===s?void 0:s.type)){var m;const n=s.cellIndex,a=p.A.getState(),l=null===(m=a.cascade)||void 0===m?void 0:m.cells[n];if(l){const s=l.skills||[],i=s.includes(e)?s:[...s,e],o=[...a.cascade.cells];o[n]=(0,t.A)((0,t.A)({},l),{},{skills:i}),_({cells:o})}return}if("canvas-background"===(null===s||void 0===s?void 0:s.type)){var h;const s=(null===(h=p.A.getState().cascade)||void 0===h?void 0:h.cells)||[];let n="use_".concat(e),t=1;for(;s.some(e=>e.name===n);)n="use_".concat(e,"_").concat(t),t++;const a={name:n,instructions:"{{ input.prompt }}",skills:[e]},l=[...s,a];return void _({cells:l})}}if("input-placeholder"===r){const e=c.data.current,s=()=>{var e;const s=(null===(e=p.A.getState().cascade)||void 0===e?void 0:e.inputs_schema)||{};let n="input_1",a=1;for(;s[n];)a++,n="input_".concat(a);return{inputName:n,updatedInputsSchema:(0,t.A)((0,t.A)({},s),{},{[n]:"Describe this input parameter"})}};if("canvas-background"===(null===e||void 0===e?void 0:e.type)){var x;const e=(null===(x=p.A.getState().cascade)||void 0===x?void 0:x.cells)||[],{inputName:n,updatedInputsSchema:t}=s();let a="with_input",l=1;for(;e.some(e=>e.name===a);)a="with_input_".concat(l),l++;const i={name:a,instructions:"Process this data:\n\n{{ input.".concat(n," }}")},o=[...e,i];return void _({inputs_schema:t,cells:o})}if("cell-card"===(null===e||void 0===e?void 0:e.type)){var v;const n=e.cellIndex,a=p.A.getState(),l=null===(v=a.cascade)||void 0===v?void 0:v.cells[n];if(l){var g;const{inputName:e,updatedInputsSchema:i}=s(),o="{{ input.".concat(e," }}"),c=[...a.cascade.cells];if(void 0!==l.instructions){const e=l.instructions||"";c[n]=(0,t.A)((0,t.A)({},l),{},{instructions:e+(e?"\n\n":"")+o})}else if(void 0!==(null===(g=l.inputs)||void 0===g?void 0:g.code)){const e=l.inputs.code||"";c[n]=(0,t.A)((0,t.A)({},l),{},{inputs:(0,t.A)((0,t.A)({},l.inputs),{},{code:e+(e?"\n\n":"")+"# Input: ".concat(o,"\n")})})}else c[n]=(0,t.A)((0,t.A)({},l),{},{instructions:o});_({inputs_schema:i,cells:c})}return}}if("variable"===r&&"monaco-editor"===(null===c||void 0===c||null===(n=c.data)||void 0===n||null===(a=n.current)||void 0===a?void 0:a.type)){const e=o.data.current.variablePath,s=window.__activeMonacoEditor;if(s&&e){const n=s.getPosition(),t="{{ ".concat(e," }}");s.executeEdits("insert-variable",[{range:{startLineNumber:n.lineNumber,startColumn:n.column,endLineNumber:n.lineNumber,endColumn:n.column},text:t}]),s.setPosition({lineNumber:n.lineNumber,column:n.column+t.length}),s.focus()}}if("model"===r&&"monaco-editor"===(null===c||void 0===c||null===(l=c.data)||void 0===l||null===(i=l.current)||void 0===i?void 0:i.type)){const e=o.data.current.modelId,s=window.__activeMonacoEditor;if(s&&e){const n=s.getPosition();s.executeEdits("insert-model",[{range:{startLineNumber:n.lineNumber,startColumn:n.column,endLineNumber:n.lineNumber,endColumn:n.column},text:e}]),s.setPosition({lineNumber:n.lineNumber,column:n.column+e.length}),s.focus()}}},children:[(0,x.jsx)("div",{className:"studio-timeline-layout",children:(0,x.jsxs)(o.A,{className:"studio-horizontal-split",sizes:R,onDragEnd:P,minSize:[180,400],maxSize:[500,1/0],gutterSize:6,gutterAlign:"center",direction:"horizontal",children:[(0,x.jsx)("div",{className:"studio-schema-panel timeline-mode",children:J&&K?(0,x.jsx)(Cs.A,{selectedMessage:J,allLogs:B,hoveredHash:$,onHoverHash:G,onClose:ne,onNavigateToMessage:te,cascadeAnalytics:O,cellAnalytics:L,messageFilters:X}):(0,x.jsx)(Se,{})}),(0,x.jsx)("div",{className:"studio-timeline-area",children:(0,x.jsx)(ks,{onOpenBrowser:()=>H(!0),onMessageContextSelect:se,onLogsUpdate:U,onMessagesViewVisibleChange:V,hoveredHash:$,onHoverHash:G,gridSelectedMessage:Y,onGridMessageSelect:Q,onMessageFiltersChange:Z},"timeline-mode")})]})}),(0,x.jsx)(i.Hd,{children:z&&(0,x.jsxs)("div",{className:"studio-drag-overlay",children:["variable"===z.type&&(0,x.jsxs)("div",{className:"studio-drag-variable",children:[(0,x.jsx)(c.In,{icon:"mdi:code-braces",width:"14"}),"{{ ".concat(z.variablePath," }}")]}),"model"===z.type&&(0,x.jsxs)("div",{className:"studio-drag-model",children:[(0,x.jsx)(c.In,{icon:"mdi:robot-outline",width:"14"}),z.modelId]}),"cell-type"===z.type&&(0,x.jsxs)("div",{className:"studio-drag-cell",children:["Adding ",z.cellType,"..."]}),"input-placeholder"===z.type&&(0,x.jsxs)("div",{className:"studio-drag-input",children:[(0,x.jsx)(c.In,{icon:"mdi:textbox",width:"14",style:{color:"#34d399"}}),(0,x.jsx)("span",{style:{color:"#34d399"},children:"Input"})]}),"tool"===z.type&&(0,x.jsxs)("div",{className:"studio-drag-tool",children:[(0,x.jsx)(c.In,{icon:"mdi:tools",width:"14"}),z.toolId]})]})})]}):null,"timeline"===j?null:(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)(o.A,{className:"studio-horizontal-split",sizes:[20,80],minSize:[180,400],maxSize:[500,1/0],gutterSize:6,gutterAlign:"center",direction:"horizontal",children:[(0,x.jsxs)("div",{className:"studio-schema-panel",children:[(0,x.jsx)("div",{className:"studio-schema-header",children:(0,x.jsx)("span",{className:"studio-schema-title",children:"Schema Browser"})}),(0,x.jsx)(b,{})]}),(0,x.jsxs)(o.A,{className:"studio-vertical-split",sizes:[60,40],minSize:[150,100],gutterSize:6,gutterAlign:"center",direction:"vertical",children:[(0,x.jsxs)("div",{className:"studio-editor-area",children:[(0,x.jsx)(N,{}),(0,x.jsx)(k,{})]}),(0,x.jsx)("div",{className:"studio-results-panel",children:(0,x.jsx)(A,{})})]})]}),u&&(0,x.jsx)("div",{className:"studio-history-panel",children:(0,x.jsx)(M,{})})]}),(0,x.jsx)(_s,{isOpen:q,onClose:()=>H(!1),onLoad:ee})]})}}}]);
//# sourceMappingURL=272.3cc0e5fa.chunk.js.map