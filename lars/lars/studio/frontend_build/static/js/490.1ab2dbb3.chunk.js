"use strict";(self.webpackChunklars_ui=self.webpackChunklars_ui||[]).push([[490],{3758:(e,s,a)=>{a.d(s,{C:()=>r,F$:()=>p,RZ:()=>c,YR:()=>u,dv:()=>l,fV:()=>f,m8:()=>o,vy:()=>i,xb:()=>d});const t=["#ffd700","#ffa94d","#ff9d76","#fb7185","#f472b6","#d4a8ff","#fde047","#a7f3d0"],n={data:"#00e5ff",selective:"#a78bfa",execution:"#64748b",branch:"#ff006e"},o=240,l=90,c=120,i=20,r=40,d=function(e,s){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!e||0===e.length)return{nodes:[],edges:[],width:0,height:0,inputPositions:{},inputColorMap:{}};const l={},r={};if(s){const e=Object.keys(s),a=50,n=55;e.forEach((e,s)=>{l[e]=a+s*n,r[e]=t[s%t.length]})}const d={},u={},f={};e.forEach((e,s)=>{d[s]={cell:e,name:e.name,handoffs:e.handoffs||[],targets:[],sources:[],implicitDeps:[],inputDeps:[]},u[s]=0,f[s]=0}),e.forEach((s,a)=>{const t=JSON.stringify(s),n=new Set,o=new Set,l=/\{\{\s*outputs\.(\w+)/g;let c;for(;null!==(c=l.exec(t));){const s=c[1],t=e.findIndex(e=>e.name===s);-1!==t&&t!==a&&n.add(t)}const i=/\{\{\s*input\.(\w+)/g;for(;null!==(c=i.exec(t));)o.add(c[1]);if(s.context&&s.context.from){(Array.isArray(s.context.from)?s.context.from:[s.context.from]).forEach(s=>{const t=e.findIndex(e=>e.name===s);-1!==t&&t!==a&&n.add(t)})}d[a].implicitDeps=Array.from(n),d[a].inputDeps=Array.from(o)}),e.forEach((s,a)=>{(s.handoffs||[]).forEach(s=>{const t=e.findIndex(e=>e.name===s);-1!==t&&(d[a].targets.includes(t)||(d[a].targets.push(t),f[a]++),d[t].sources.includes(a)||(d[t].sources.push(a),u[t]++))}),d[a].implicitDeps.forEach(e=>{d[e].targets.includes(a)||(d[e].targets.push(a),f[e]++),d[a].sources.includes(e)||(d[a].sources.push(e),u[a]++)})});const p=240,g=a?60:120,h=o?i+c+20:0,m=a?40:160,y=o?Math.max(h,m):m,S=a?20:40,v=[],w={},_=new Set(e.map((e,s)=>s));for(;_.size>0;){const e=[];for(const s of _)d[s].sources.every(e=>void 0!==w[e])&&e.push(s);if(0===e.length)break;e.forEach(e=>{w[e]=v.length,_.delete(e)}),v.push(e)}const k=[];if(a){let s=y;e.forEach((a,t)=>{var o;const l=(null===(o=n[a.name])||void 0===o?void 0:o.scale)||1;k.push({cellIdx:t,cell:e[t],x:s,y:S,layer:0,isBranch:f[t]>1,isMerge:u[t]>1,inputDeps:d[t].inputDeps});s=s+120*(1+l)+g+20})}else{const s=[];v.forEach((a,t)=>{let o=y;if(t>0&&void 0!==s[t-1]){const a=v[t-1],l=Math.max(...a.map(s=>{var a;return(null===(a=n[e[s].name])||void 0===a?void 0:a.scale)||1}),1),c=p*l;o=s[t-1]+c+g}else t>0&&(o=y+t*(p+g));s[t]=o;let l=S;a.forEach((s,a)=>{var c;const i=130*((null===(c=n[e[s].name])||void 0===c?void 0:c.scale)||1);k.push({cellIdx:s,cell:e[s],x:o,y:l,layer:t,isBranch:f[s]>1,isMerge:u[s]>1,inputDeps:d[s].inputDeps}),l+=i+0+25})})}const I=[];k.forEach(s=>{d[s.cellIdx].targets.forEach(a=>{var t;const n=k.find(e=>e.cellIdx===a);if(!n)return;const o=e[s.cellIdx],l=e[a];let c="execution";if(null===(t=l.context)||void 0===t?void 0:t.from){const e=l.context.from||[];(e.includes(o.name)||e.includes("all"))&&(c="selective")}const i=JSON.stringify(l);new RegExp("\\{\\{\\s*outputs\\.".concat(o.name),"g").test(i)&&(c="data"),I.push({source:s,target:n,contextType:c,isBranch:s.isBranch,isMerge:n.isMerge})})});const C=a?k.reduce((e,s)=>{var a;const t=(null===(a=n[s.cell.name])||void 0===a?void 0:a.scale)||1;return e+p*t+g},y+40):k.reduce((e,s)=>{var a;const t=(null===(a=n[s.cell.name])||void 0===a?void 0:a.scale)||1,o=s.x+p*t;return Math.max(e,o)},0)+40,A=a?169+2*S+25:k.reduce((e,s)=>{var a;const t=(null===(a=n[s.cell.name])||void 0===a?void 0:a.scale)||1,o=s.y+130*t+25;return Math.max(e,o)},0)+S;return{nodes:k,edges:I,width:C,height:A,inputPositions:l,inputColorMap:r}},u=function(e,s){var a,t,n,c;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=(null===(a=i[null===(t=e.cell)||void 0===t?void 0:t.name])||void 0===a?void 0:a.scale)||1,d=(null===(n=i[null===(c=s.cell)||void 0===c?void 0:c.name])||void 0===n?void 0:n.scale)||1,u=(r-1)*o/2,f=(d-1)*o/2,p=e.x+o+u,g=e.y+l/2,h=s.x-f,m=s.y+l/2,y=h-p,S=p+.5*y,v=h-.5*y;return"M ".concat(p,",").concat(g," C ").concat(S,",").concat(g," ").concat(v,",").concat(m," ").concat(h,",").concat(m)},f=function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?n.branch:n[e]||n.execution},p=e=>"execution"===e?.3:.6},38190:(e,s,a)=>{a.d(s,{autoGenerateSessionId:()=>l});const t=["quick","swift","nimble","fleet","agile","bouncy","zippy","speedy","clever","wise","bright","sharp","keen","alert","cunning","smart","gentle","quiet","shy","bold","wild","free","playful","happy","mossy","leafy","shadowy","misty","dewy","frosty","sunlit","amber","brave","curious","friendly","fuzzy","cozy","spry","merry","noble","silver","golden","russet","crimson","azure","emerald","ivory","dawn","dusk","spring","autumn","winter","summer","twilight"],n=["rabbit","hare","bunny","cottontail","jackrabbit","snowshoe","fox","squirrel","chipmunk","mouse","vole","hedgehog","badger","ferret","weasel","otter","beaver","marmot","pika","shrew","deer","fawn","elk","moose","caribou","antelope","owl","woodpecker","robin","wren","jay","thrush","finch","hawk","falcon","eagle","sparrow","cardinal","chickadee","raccoon","porcupine","skunk","opossum","mole","mink","lynx","bobcat","coyote","wolf","bear","boar"];function o(){const e=t[Math.floor(Math.random()*t.length)],s=n[Math.floor(Math.random()*n.length)],a=function(e){let s=0;for(let a=0;a<e.length;a++)s=(s<<5)-s+e.charCodeAt(a),s&=s;return Math.abs(s).toString(16).padStart(6,"0").slice(0,6)}("".concat(e).concat(s).concat(Date.now()).concat(Math.random()));return"".concat(e,"-").concat(s,"-").concat(a)}function l(){return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"woodland";return"woodland"===e?o():"uuid"===e?"nb_".concat(Date.now().toString(36),"_").concat(Math.random().toString(36).slice(2,8)):o()}(localStorage.getItem("lars_session_id_style")||"woodland")}},50717:(e,s,a)=>{a.d(s,{A:()=>d});var t=a(89379),n=a(4131),o=a(54893),l=a(23814),c=a(38190),i=a(84713),r=a(24227);const d=(0,n.v)((0,o.Zr)((0,l.D)((e,s)=>({mode:"timeline",cascade:null,cascadeYamlText:null,cascadePath:null,cascadeDirty:!1,cascadeInputs:{},cellStates:{},cascadeAnalytics:null,cellAnalytics:{},isRunningAll:!1,cascadeSessionId:null,sessionId:null,childSessions:{},parentSessionId:null,parentCell:null,selectedCellIndex:null,desiredOutputTab:null,viewMode:"live",replaySessionId:null,yamlViewMode:!1,autoFixConfig:{enabled:!0,max_attempts:2,model:"x-ai/grok-4.1-fast",prompt:null},cellAutoFixOverrides:{},undoStack:[],redoStack:[],maxHistorySize:50,cascades:[],cascadesLoading:!1,cascadesError:null,defaultModel:null,cellTypes:[],cellTypesLoading:!1,_saveToUndoStack:()=>{var a;const t=s();if(null===(a=t.cascade)||void 0===a||!a.cells)return;const n=JSON.parse(JSON.stringify(t.cascade.cells));e(e=>{e.undoStack.push(n),e.undoStack.length>e.maxHistorySize&&e.undoStack.shift(),e.redoStack=[]})},undo:()=>{const a=s();return!(!a.cascade||0===a.undoStack.length)&&(e(e=>{const s=JSON.parse(JSON.stringify(e.cascade.cells));e.redoStack.push(s);const a=e.undoStack.pop();e.cascade.cells=a,e.cascadeDirty=!0}),!0)},redo:()=>{const a=s();return!(!a.cascade||0===a.redoStack.length)&&(e(e=>{const s=JSON.parse(JSON.stringify(e.cascade.cells));e.undoStack.push(s);const a=e.redoStack.pop();e.cascade.cells=a,e.cascadeDirty=!0}),!0)},canUndo:()=>s().undoStack.length>0,canRedo:()=>s().redoStack.length>0,clearHistory:()=>{e(e=>{e.undoStack=[],e.redoStack=[]})},setMode:s=>{e(e=>{e.mode=s})},setSelectedCellIndex:s=>{e(e=>{e.selectedCellIndex=s})},setDesiredOutputTab:s=>{e(e=>{e.desiredOutputTab=s})},setReplayMode:async a=>{try{const i=await fetch("".concat(r.e,"/session-cascade/").concat(a)),d=await i.json();if(d.error)console.error("[setReplayMode] Failed to load session cascade:",d.error);else if(d.cascade){var t,n,o,l,c;console.log("[setReplayMode] Loaded historical cascade:",d.cascade),d.input_data&&console.log("[setReplayMode] Loaded historical inputs:",d.input_data),d.warning&&console.warn("[setReplayMode]",d.warning),"cascade_sessions_table"===d.source?console.log("[setReplayMode] \u2713 Full definition from cascade_sessions table"):console.log("[setReplayMode] \u26a0 Reconstructed from logs (partial data)"),console.log("[setReplayMode] Setting cascade in state:"),console.log("[setReplayMode]   - Cells:",null===(t=d.cascade.cells)||void 0===t?void 0:t.length),d.cascade.cells&&d.cascade.cells[0]&&(console.log("[setReplayMode]   - First cell tool:",d.cascade.cells[0].tool),console.log("[setReplayMode]   - First cell inputs:",Object.keys(d.cascade.cells[0].inputs||{}))),e(e=>{if(e.viewMode="replay",e.replaySessionId=a,e.cascade=d.cascade,!e.cascadePath){const s=d.config_path||null;!s||s.includes("/session_")||s.includes("\\session_")||s.includes("/.tmp_")||s.includes("\\.tmp_")||(e.cascadePath=s)}e.cascadeDirty=!1,d.input_data&&Object.keys(d.input_data).length>0&&(e.cascadeInputs=d.input_data,console.log("[setReplayMode] Loaded historical inputs into cascadeInputs:",d.input_data)),e.isRunningAll=!1,e.cellStates={}});const i=s();return console.log("[setReplayMode] State after set:"),console.log("[setReplayMode]   - cascade.cells:",null===(n=i.cascade)||void 0===n||null===(o=n.cells)||void 0===o?void 0:o.length),void(null!==(l=i.cascade)&&void 0!==l&&null!==(c=l.cells)&&void 0!==c&&c[0]&&console.log("[setReplayMode]   - First cell tool:",i.cascade.cells[0].tool))}}catch(i){console.error("[setReplayMode] Error loading session cascade:",i)}e(e=>{e.viewMode="replay",e.replaySessionId=a,e.isRunningAll=!1})},fetchReplayData:async a=>{console.log("[fetchReplayData] Fetching session data:",a);try{var t,n;const o="".concat(r.J,"/api/playground/session-stream/").concat(a,"?after=1970-01-01 00:00:00"),l=await fetch(o);if(!l.ok)throw new Error("HTTP ".concat(l.status));const c=await l.json();if(c.error)throw new Error(c.error);console.log("[fetchReplayData] Got",(null===(t=c.rows)||void 0===t?void 0:t.length)||0,"rows"),console.log("[fetchReplayData] Child sessions:",(null===(n=c.child_sessions)||void 0===n?void 0:n.length)||0);const d=c.rows||[],u=d.filter(e=>e.session_id===a),f=[...new Set(u.map(e=>e.cell_name).filter(Boolean))],p={};for(const e of f)p[e]=(0,i.l)(u,e);s().updateCellStatesFromPolling(p),c.child_sessions&&c.child_sessions.length>0&&(e(e=>{e.childSessions={},c.child_sessions.forEach(s=>{e.childSessions[s.session_id]=s})}),console.log("[fetchReplayData] \u2713 Child sessions updated:",Object.keys(s().childSessions)));const g=d.find(e=>e.parent_session_id&&e.session_id===a);return g&&g.parent_session_id&&(e(e=>{e.parentSessionId=g.parent_session_id}),console.log("[fetchReplayData] \u2713 This is a child session, parent:",g.parent_session_id)),console.log("[fetchReplayData] \u2713 Cell states updated:",Object.keys(p)),{success:!0,cellCount:f.length}}catch(o){return console.error("[fetchReplayData] Error:",o),{success:!1,error:o.message}}},setLiveMode:()=>{e(e=>{e.viewMode="live",e.replaySessionId=null})},joinLiveSession:async(a,t,n)=>{console.log("[joinLiveSession] Joining session:",a,"cascade:",t);try{const t=await fetch("".concat(r.e,"/session-cascade/").concat(a)),o=await t.json();o.error&&console.error("[joinLiveSession] Failed to load session cascade:",o.error),e(e=>{if(e.viewMode="live",e.cascadeSessionId=a,e.replaySessionId=null,e.isRunningAll=!0,o.cascade){if(e.cascade=o.cascade,!e.cascadePath){const s=o.config_path||n||null;!s||s.includes("/session_")||s.includes("\\session_")||s.includes("/.tmp_")||s.includes("\\.tmp_")||(e.cascadePath=s)}e.cascadeDirty=!1,o.input_data&&Object.keys(o.input_data).length>0&&(e.cascadeInputs=o.input_data)}e.cellStates={}});const l=s();return l.fetchReplayData&&await l.fetchReplayData(a),console.log("[joinLiveSession] Successfully joined session:",a),{success:!0}}catch(o){return console.error("[joinLiveSession] Error:",o),e(e=>{e.viewMode="live",e.cascadeSessionId=a,e.replaySessionId=null,e.isRunningAll=!0,e.cellStates={}}),{success:!1,error:o.message}}},generateSessionId:()=>{const s=(0,c.autoGenerateSessionId)();return e(e=>{e.sessionId=s}),s},restartSession:async()=>{const a=s().sessionId;if(a)try{await fetch("".concat(r.e,"/cleanup-session"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:a})})}catch(t){console.warn("Failed to cleanup old session:",t)}e(e=>{var s;e.sessionId=(0,c.autoGenerateSessionId)(),e.cellStates={},null!==(s=e.cascade)&&void 0!==s&&s.cells&&e.cascade.cells.forEach(s=>{e.cellStates[s.name]={status:"pending"}})})},newCascade:()=>{const s="studio_new_".concat((0,c.autoGenerateSessionId)().split("-").pop());console.log("[newCascade] Creating blank cascade with ID:",s),e(e=>{e.cascade={cascade_id:s,description:"New cascade",inputs_schema:{},cells:[]},e.cascadePath=null,e.cascadeDirty=!1,e.cascadeInputs={},e.cellStates={},e.sessionId=(0,c.autoGenerateSessionId)(),e.cascadeSessionId=null,e.replaySessionId=null,e.viewMode="live",e.isRunningAll=!1,e.undoStack=[],e.redoStack=[]})},loadCascade:async s=>{try{const a=await fetch("".concat(r.e,"/load?path=").concat(encodeURIComponent(s))),t=await a.json();if(t.error)throw new Error(t.error);return e(e=>{e.cascade=t.cascade||t.notebook,e.cascadeYamlText=t.raw_yaml||null,e.cascadePath=s,e.cascadeDirty=!1,e.cascadeInputs={},e.cellStates={},e.sessionId=(0,c.autoGenerateSessionId)(),e.undoStack=[],e.redoStack=[]}),t.notebook}catch(a){throw console.error("Failed to load cascade:",a),a}},saveCascade:async function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=s(),n=a||t.cascadePath;if(!n)throw new Error("No path specified for saving");if(!t.cascade)throw new Error("No cascade to save");try{const s={path:n,notebook:t.cascade};t.cascadeYamlText&&(s.raw_yaml=t.cascadeYamlText);const a=await fetch("".concat(r.e,"/save"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),o=await a.json();if(o.error)throw new Error(o.error);return e(e=>{e.cascadePath=n,e.cascadeDirty=!1}),o}catch(o){throw console.error("Failed to save cascade:",o),o}},updateCascade:s=>{e(e=>{e.cascade&&(Object.assign(e.cascade,s),e.cascadeDirty=!0,e.cascadeYamlText=null)})},addCell:function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sql_data",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];s()._saveToUndoStack(),e(e=>{if(!e.cascade)return;const s=e.cascade.cells,l=s.length+1,c=e.cellTypes.find(e=>e.type_id===a);if(!c)return void console.error("Cell type not found: ".concat(a));const i=c.name_prefix||a.replace(/_data$/,"");let r="".concat(i,"_").concat(l),d=l;for(;s.some(e=>e.name===r);)d++,r="".concat(i,"_").concat(d);const u=JSON.parse(JSON.stringify(c.template)),f=(0,t.A)({name:r},u),p=s=>{var a;if("string"===typeof s)return s.replace(/\{\{CELL_NAME\}\}/g,r).replace(/\{\{CASCADE_ID\}\}/g,(null===(a=e.cascade)||void 0===a?void 0:a.cascade_id)||"untitled");if(Array.isArray(s))return s.map(p);if(s&&"object"===typeof s){const e={};for(const[a,t]of Object.entries(s))e[a]=p(t);return e}return s};if(Object.keys(f).forEach(e=>{f[e]=p(f[e])}),null===n)o&&s.length>0&&(s[s.length-1].handoffs=[f.name]),s.push(f);else{if(o)n>=0&&s[n]&&(s[n].handoffs=[f.name]),n+1<s.length&&(f.handoffs=[s[n+1].name]);else if(n>=0&&s[n]){const e=s[n].handoffs||[];s[n].handoffs=e.includes(f.name)?e:[...e,f.name]}s.splice(n+1,0,f)}e.cascadeDirty=!0,e.cellStates[f.name]={status:"pending"},e.cascadeYamlText=null})},updateCell:(a,t)=>{s()._saveToUndoStack(),e(e=>{if(!e.cascade||!e.cascade.cells[a])return;const n=e.cascade.cells[a],o=n.name;t.name&&t.name!==o&&(e.cascade.cells.forEach(e=>{e.handoffs&&(e.handoffs=e.handoffs.map(e=>e===o?t.name:e))}),e.cellStates[o]&&(e.cellStates[t.name]=e.cellStates[o],delete e.cellStates[o])),Object.assign(n,t),e.cascadeDirty=!0,e.cascadeYamlText=null,t.inputs&&s().markDownstreamStale(a)})},removeCell:a=>{s()._saveToUndoStack(),e(e=>{if(!e.cascade||e.cascade.cells.length<=1)return;const s=e.cascade.cells,t=s[a].name;if(a>0&&s[a-1].handoffs){const e=s[a+1];s[a-1].handoffs=e?[e.name]:[]}delete e.cellStates[t],s.splice(a,1),e.cascadeDirty=!0,e.cascadeYamlText=null})},moveCell:(a,t)=>{s()._saveToUndoStack(),e(e=>{if(!e.cascade)return;const s=e.cascade.cells;if(a<0||a>=s.length)return;if(t<0||t>=s.length)return;const[n]=s.splice(a,1);s.splice(t,0,n),s.forEach((e,a)=>{a<s.length-1?e.handoffs=[s[a+1].name]:delete e.handoffs}),e.cascadeDirty=!0,e.cascadeYamlText=null})},setCascadeInput:(s,a)=>{e(e=>{e.cascadeInputs[s]=a})},clearCascadeInputs:()=>{e(e=>{e.cascadeInputs={}})},setCellState:(s,a)=>{e(e=>{e.cellStates[s]=(0,t.A)((0,t.A)({},e.cellStates[s]),a)})},markDownstreamStale:s=>{e(e=>{if(e.cascade)for(let t=s+1;t<e.cascade.cells.length;t++){var a;const s=e.cascade.cells[t].name;"success"===(null===(a=e.cellStates[s])||void 0===a?void 0:a.status)&&(e.cellStates[s].status="stale")}})},clearCellStates:()=>{e(e=>{e.cellStates={}})},setGlobalAutoFix:s=>{e(e=>{e.autoFixConfig=(0,t.A)((0,t.A)({},e.autoFixConfig),s)})},setCellAutoFix:(s,a)=>{e(e=>{e.cellAutoFixOverrides[s]=(0,t.A)((0,t.A)({},e.cellAutoFixOverrides[s]||{}),a)})},clearCellAutoFix:s=>{e(e=>{delete e.cellAutoFixOverrides[s]})},getEffectiveAutoFixConfig:e=>{const a=s(),n=a.cellAutoFixOverrides[e];return n?(0,t.A)((0,t.A)({},a.autoFixConfig),n):a.autoFixConfig},runCell:async function(a){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o=s();if(!o.cascade)return;const l=o.cascade.cells.findIndex(e=>e.name===a);if(-1===l)return;const c=o.cascade.cells[l];let i=o.sessionId;i||(i=s().generateSessionId());const d={};for(let e=0;e<l;e++){const s=o.cascade.cells[e],a=o.cellStates[s.name];null!==a&&void 0!==a&&a.inputHash&&(d[s.name]=a.inputHash)}const u=function(e,s,a){const t=JSON.stringify({tool:e.tool,inputs:e.inputs,cascadeInputs:s,priorOutputHashes:a});let n=5381;for(let o=0;o<t.length;o++)n=(n<<5)+n+t.charCodeAt(o),n&=n;return n.toString(16)}(c,o.cascadeInputs,d),f=o.cellStates[a];if(!n&&"success"===(null===f||void 0===f?void 0:f.status)&&(null===f||void 0===f?void 0:f.inputHash)===u&&null!==f&&void 0!==f&&f.result)return e(e=>{e.cellStates[a]=(0,t.A)((0,t.A)({},f),{},{cached:!0})}),void console.log("[Cache] Hit for ".concat(a," (hash: ").concat(u,")"));e(e=>{e.cellStates[a]={status:"running",result:null,error:null,cached:!1}});const p=performance.now();try{const t={};for(let e=0;e<l;e++){const s=o.cascade.cells[e],a=o.cellStates[s.name];null!==a&&void 0!==a&&a.result&&(t[s.name]=a.result)}const n=s().getEffectiveAutoFixConfig(a),d=await fetch("".concat(r.e,"/run-cell"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cell:c,inputs:o.cascadeInputs,prior_outputs:t,session_id:i,auto_fix:n})}),f=await d.json(),g=Math.round(performance.now()-p);f.error||"error"===f._route?e(e=>{e.cellStates[a]={status:"error",error:f.error,autoFixError:f.auto_fix_error,duration:g,inputHash:u,cached:!1}}):(e(e=>{e.cellStates[a]={status:"success",result:f,duration:g,inputHash:u,cached:!1,autoFixed:f._auto_fixed||!1,fixAttempts:f._fix_attempts||null,fixedCode:f._fixed_code||null,originalError:f._original_error||null}}),s().markDownstreamStale(l))}catch(g){const s=Math.round(performance.now()-p);e(e=>{e.cellStates[a]={status:"error",error:g.message,duration:s,inputHash:u,cached:!1}})}},runCascadeStandard:async()=>{const t=s();if(!t.cascade||t.isRunningAll)return;console.log("[runCascadeStandard] Starting. Current state:",{viewMode:t.viewMode,replaySessionId:t.replaySessionId,cascadeSessionId:t.cascadeSessionId});const n=(0,c.autoGenerateSessionId)();e(e=>{e.isRunningAll=!0,e.cascadeSessionId=n,e.sessionId=n,e.viewMode="live",e.replaySessionId=null,e.childSessions={},e.cascade.cells.forEach(s=>{e.cellStates[s.name]={status:"pending"}})});const o=s();console.log("[runCascadeStandard] State after set:",{viewMode:o.viewMode,replaySessionId:o.replaySessionId,cascadeSessionId:o.cascadeSessionId,sessionId:o.sessionId,isRunningAll:o.isRunningAll});try{const e=a(85637),o=t.cascadeYamlText||e.dump(t.cascade,{indent:2,lineWidth:-1}),l=await fetch("".concat(r.J,"/api/run-cascade"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cascade_yaml:o,cascade_path:t.cascadePath,inputs:t.cascadeInputs,session_id:n})}),c=await l.json();if(c.error)throw new Error(c.error);console.log("[runCascadeStandard] Execution started, session:",n),console.log("[runCascadeStandard] Polling will update cell states"),console.log("[runCascadeStandard] isRunningAll should still be true:",s().isRunningAll)}catch(l){console.error("[runCascadeStandard] Error:",l),e(e=>{console.log("[runCascadeStandard] Setting isRunningAll = false due to error"),e.isRunningAll=!1})}},updateCellStatesFromPolling:s=>{e(e=>{var a;for(const[o,l]of Object.entries(s)){let s=l.result;if("string"===typeof s)try{s=JSON.parse(s)}catch(n){}e.cellStates[o]=(0,t.A)((0,t.A)({},l),{},{result:s}),(l.duration||l.cost||l.tokens_in)&&console.log("[updateCellStatesFromPolling]",o,"- Duration:",l.duration,"Cost:",l.cost,"Tokens:",l.tokens_in,"/",l.tokens_out)}if(null!==(a=e.cascade)&&void 0!==a&&a.cells&&e.cascadeSessionId){const s=e.cascade.cells,a=s.map(s=>{var a;return{name:s.name,status:(null===(a=e.cellStates[s.name])||void 0===a?void 0:a.status)||"pending"}}),t=s.some(s=>{var a;return"running"===(null===(a=e.cellStates[s.name])||void 0===a?void 0:a.status)}),n=s.every(s=>{var a;const t=null===(a=e.cellStates[s.name])||void 0===a?void 0:a.status;return"success"===t||"error"===t});console.log("[updateCellStatesFromPolling] Data-driven execution check:",{totalCells:s.length,hasAnyRunning:t,allComplete:n,cellStatuses:a,currentIsRunningAll:e.isRunningAll}),t?e.isRunningAll||(console.log("[updateCellStatesFromPolling] Cells are running, setting isRunningAll = true"),e.isRunningAll=!0):n&&e.isRunningAll&&(console.log("[updateCellStatesFromPolling] \u2713 All cells complete! Setting isRunningAll = false"),e.isRunningAll=!1)}})},updateAnalyticsFromPolling:(s,a)=>{e(e=>{s&&(e.cascadeAnalytics=s),a&&Object.keys(a).length>0&&(e.cellAnalytics=a)})},runAllCells:async()=>{const a=s();if(!a.cascade||a.isRunningAll)return;const t=(0,c.autoGenerateSessionId)();e(e=>{e.viewMode="live",e.replaySessionId=null,e.isRunningAll=!0,e.sessionId=t,e.cascadeSessionId=t,e.cascade.cells.forEach(s=>{e.cellStates[s.name]={status:"pending"}}),console.log("[runAllCells] Transitioning to live mode. Session:",t)});try{for(const e of s().cascade.cells){var n;if(await s().runCell(e.name),"error"===(null===(n=s().cellStates[e.name])||void 0===n?void 0:n.status))break}}finally{e(e=>{e.isRunningAll=!1})}},runFromCell:async e=>{const a=s();if(!a.cascade)return;const t=a.cascade.cells.findIndex(s=>s.name===e);if(-1!==t){a.sessionId||s().generateSessionId();for(let e=t;e<a.cascade.cells.length;e++){var n;const t=a.cascade.cells[e];if(await s().runCell(t.name),"error"===(null===(n=s().cellStates[t.name])||void 0===n?void 0:n.status))break}}},fetchCascades:async()=>{e(e=>{e.cascadesLoading=!0,e.cascadesError=null});try{const s=await fetch("".concat(r.e,"/list")),a=await s.json();if(a.error)throw new Error(a.error);e(e=>{e.cascades=a.cascades||a.notebooks||[],e.cascadesLoading=!1})}catch(s){e(e=>{e.cascadesError=s.message,e.cascadesLoading=!1})}},fetchDefaultModel:async()=>{console.log("[fetchDefaultModel] Starting fetch...");try{const s=await fetch("".concat(r.e,"/models"));console.log("[fetchDefaultModel] Response status:",s.status);const a=await s.json();console.log("[fetchDefaultModel] Response data:",a),a.default_model?(console.log("[fetchDefaultModel] Setting default model:",a.default_model),e(e=>{e.defaultModel=a.default_model})):(console.warn("[fetchDefaultModel] No default_model in response, using fallback"),e(e=>{e.defaultModel="google/gemini-2.5-flash-lite"}))}catch(s){console.error("[fetchDefaultModel] Failed to fetch:",s),e(e=>{e.defaultModel="google/gemini-2.5-flash-lite"})}},fetchCellTypes:async()=>{e(e=>{e.cellTypesLoading=!0});try{const s=await fetch("".concat(r.e,"/cell-types")),a=await s.json();e(e=>{e.cellTypes=a||[],e.cellTypesLoading=!1}),console.log("[fetchCellTypes] Loaded types:",a.length)}catch(s){console.error("[fetchCellTypes] Failed:",s),e(e=>{e.cellTypes=[],e.cellTypesLoading=!1})}},setYamlViewMode:s=>{e(e=>{e.yamlViewMode=s})},updateCascadeFromYaml:s=>{try{const n=a(85637);if(!s||!s.trim())throw new Error("YAML is empty");const o=n.load(s);if(!o||"object"!==typeof o)throw new Error("YAML parsing returned empty result - check for syntax errors or ensure document has content");if(!o.cascade_id)throw new Error("Missing required field: cascade_id");if(!Array.isArray(o.cells))throw new Error("Missing or invalid field: cells (must be an array)");for(const e of o.cells)if(!e.name)throw new Error("Cell missing required field: name");return e(e=>{e.cascade=(0,t.A)((0,t.A)({},o),{},{cells:o.cells,description:o.description||"",inputs_schema:o.inputs_schema||{}}),e.cascadeYamlText=s,e.cascadeDirty=!0,Object.keys(e.cellStates).forEach(s=>{o.cells.find(e=>e.name===s)?e.cellStates[s]&&(e.cellStates[s].status="stale"):delete e.cellStates[s]}),e.undoStack=[],e.redoStack=[]}),{success:!0}}catch(n){return{success:!1,error:n.message}}}})),{name:"studio-cascade-storage",version:2,partialize:e=>({mode:e.mode,cascadeSessionId:e.cascadeSessionId,isRunningAll:e.isRunningAll}),migrate:(e,s)=>(console.log("[Migration] Migrating from version",s,"to version 2"),s<2?(console.log("[Migration] Forcing mode to timeline (from version",s,")"),(0,t.A)((0,t.A)({},e),{},{mode:"timeline"})):e),onRehydrateStorage:()=>e=>{const s=localStorage.getItem("notebook-storage"),a=localStorage.getItem("studio-cascade-storage");s&&!a&&(console.log("[Migration] Copying notebook-storage \u2192 studio-cascade-storage"),localStorage.setItem("studio-cascade-storage",s)),e&&(console.log("[Migration] Checking for old property names in persisted state..."),"query"!==e.mode&&"notebook"!==e.mode||(console.log("[Migration] Updating mode: query/notebook \u2192 timeline"),e.mode="timeline"),console.log("[Migration] Migration complete. Final mode:",e.mode))}}))},84713:(e,s,a)=>{function t(e,s){var a,t;const n=e.filter(e=>e.cell_name===s);if(0===n.length)return{status:"pending",result:null,error:null,duration:null,images:null,cost:null,model:null,tokens_in:null,tokens_out:null};let o="pending",l=null,c=null,i=null,r=null,d=0,u=null,f=0,p=0;for(const S of n){const e=S.role;if("cell_start"!==e&&"structure"!==e||(o="running"),"cell_complete"===e&&(o="success"),"error"!==e&&"error"!==S.node_type||(o="error",c=S.content_json||S.content||"Unknown error"),"tool"===e&&S.content_json){let e=S.content_json;for(;"string"===typeof e;)try{e=JSON.parse(e)}catch(m){break}l=e}if("assistant"===e&&S.content_json){let e=S.content_json;for(;"string"===typeof e&&e.startsWith('"');)try{e=JSON.parse(e)}catch(y){break}l=e}if(S.metadata_json){var g;let e=S.metadata_json;if("string"===typeof e)try{e=JSON.parse(e)}catch(m){console.warn("[deriveCellState] Failed to parse metadata_json:",m)}null!==(g=e)&&void 0!==g&&g.images&&Array.isArray(e.images)&&(r=e.images)}if(l&&"object"===typeof l&&Array.isArray(l.images)&&l.images.length>0&&(r=l.images),void 0!==S.duration_ms&&null!==S.duration_ms){const e=parseFloat(S.duration_ms);!isNaN(e)&&e>0&&(i=(i||0)+e)}if(void 0!==S.cost&&null!==S.cost){const e=parseFloat(S.cost);isNaN(e)||(d+=e)}if(void 0!==S.tokens_in&&null!==S.tokens_in){const e=parseFloat(S.tokens_in);isNaN(e)||(f+=e)}if(void 0!==S.tokens_out&&null!==S.tokens_out){const e=parseFloat(S.tokens_out);isNaN(e)||(p+=e)}S.model&&(u=S.model)}const h={status:o,result:l,error:c,duration:i?Math.round(i):null,images:r,cost:d>0?d:null,model:u,tokens_in:f>0?Math.round(f):null,tokens_out:p>0?Math.round(p):null};return console.log("[deriveCellState]",s,"Final state:",{status:o,hasResult:!!l,resultType:l?typeof l:"null",hasRows:null===(a=l)||void 0===a||null===(t=a.rows)||void 0===t?void 0:t.length,duration:h.duration,cost:h.cost,hasImages:!!r}),h}a.d(s,{l:()=>t})}}]);
//# sourceMappingURL=490.1ab2dbb3.chunk.js.map