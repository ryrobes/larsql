(self.webpackChunklars_ui=self.webpackChunklars_ui||[]).push([[958],{3758:(e,t,s)=>{"use strict";s.d(t,{C:()=>r,F$:()=>h,RZ:()=>c,YR:()=>u,dv:()=>l,fV:()=>p,m8:()=>a,vy:()=>i,xb:()=>d});const o=["#ffd700","#ffa94d","#ff9d76","#fb7185","#f472b6","#d4a8ff","#fde047","#a7f3d0"],n={data:"#00e5ff",selective:"#a78bfa",execution:"#64748b",branch:"#ff006e"},a=240,l=90,c=120,i=20,r=40,d=function(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!e||0===e.length)return{nodes:[],edges:[],width:0,height:0,inputPositions:{},inputColorMap:{}};const l={},r={};if(t){const e=Object.keys(t),s=50,n=55;e.forEach((e,t)=>{l[e]=s+t*n,r[e]=o[t%o.length]})}const d={},u={},p={};e.forEach((e,t)=>{d[t]={cell:e,name:e.name,handoffs:e.handoffs||[],targets:[],sources:[],implicitDeps:[],inputDeps:[]},u[t]=0,p[t]=0}),e.forEach((t,s)=>{const o=JSON.stringify(t),n=new Set,a=new Set,l=/\{\{\s*outputs\.(\w+)/g;let c;for(;null!==(c=l.exec(o));){const t=c[1],o=e.findIndex(e=>e.name===t);-1!==o&&o!==s&&n.add(o)}const i=/\{\{\s*input\.(\w+)/g;for(;null!==(c=i.exec(o));)a.add(c[1]);if(t.context&&t.context.from){(Array.isArray(t.context.from)?t.context.from:[t.context.from]).forEach(t=>{const o=e.findIndex(e=>e.name===t);-1!==o&&o!==s&&n.add(o)})}d[s].implicitDeps=Array.from(n),d[s].inputDeps=Array.from(a)}),e.forEach((t,s)=>{(t.handoffs||[]).forEach(t=>{const o=e.findIndex(e=>e.name===t);-1!==o&&(d[s].targets.includes(o)||(d[s].targets.push(o),p[s]++),d[o].sources.includes(s)||(d[o].sources.push(s),u[o]++))}),d[s].implicitDeps.forEach(e=>{d[e].targets.includes(s)||(d[e].targets.push(s),p[e]++),d[s].sources.includes(e)||(d[s].sources.push(e),u[s]++)})});const h=240,m=s?60:120,g=a?i+c+20:0,f=s?40:160,v=a?Math.max(g,f):f,y=s?20:40,_=[],j={},x=new Set(e.map((e,t)=>t));for(;x.size>0;){const e=[];for(const t of x)d[t].sources.every(e=>void 0!==j[e])&&e.push(t);if(0===e.length)break;e.forEach(e=>{j[e]=_.length,x.delete(e)}),_.push(e)}const w=[];if(s){let t=v;e.forEach((s,o)=>{var a;const l=(null===(a=n[s.name])||void 0===a?void 0:a.scale)||1;w.push({cellIdx:o,cell:e[o],x:t,y:y,layer:0,isBranch:p[o]>1,isMerge:u[o]>1,inputDeps:d[o].inputDeps});t=t+120*(1+l)+m+20})}else{const t=[];_.forEach((s,o)=>{let a=v;if(o>0&&void 0!==t[o-1]){const s=_[o-1],l=Math.max(...s.map(t=>{var s;return(null===(s=n[e[t].name])||void 0===s?void 0:s.scale)||1}),1),c=h*l;a=t[o-1]+c+m}else o>0&&(a=v+o*(h+m));t[o]=a;let l=y;s.forEach((t,s)=>{var c;const i=130*((null===(c=n[e[t].name])||void 0===c?void 0:c.scale)||1);w.push({cellIdx:t,cell:e[t],x:a,y:l,layer:o,isBranch:p[t]>1,isMerge:u[t]>1,inputDeps:d[t].inputDeps}),l+=i+0+25})})}const C=[];w.forEach(t=>{d[t.cellIdx].targets.forEach(s=>{var o;const n=w.find(e=>e.cellIdx===s);if(!n)return;const a=e[t.cellIdx],l=e[s];let c="execution";if(null===(o=l.context)||void 0===o?void 0:o.from){const e=l.context.from||[];(e.includes(a.name)||e.includes("all"))&&(c="selective")}const i=JSON.stringify(l);new RegExp("\\{\\{\\s*outputs\\.".concat(a.name),"g").test(i)&&(c="data"),C.push({source:t,target:n,contextType:c,isBranch:t.isBranch,isMerge:n.isMerge})})});const S=s?w.reduce((e,t)=>{var s;const o=(null===(s=n[t.cell.name])||void 0===s?void 0:s.scale)||1;return e+h*o+m},v+40):w.reduce((e,t)=>{var s;const o=(null===(s=n[t.cell.name])||void 0===s?void 0:s.scale)||1,a=t.x+h*o;return Math.max(e,a)},0)+40,N=s?169+2*y+25:w.reduce((e,t)=>{var s;const o=(null===(s=n[t.cell.name])||void 0===s?void 0:s.scale)||1,a=t.y+130*o+25;return Math.max(e,a)},0)+y;return{nodes:w,edges:C,width:S,height:N,inputPositions:l,inputColorMap:r}},u=function(e,t){var s,o,n,c;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=(null===(s=i[null===(o=e.cell)||void 0===o?void 0:o.name])||void 0===s?void 0:s.scale)||1,d=(null===(n=i[null===(c=t.cell)||void 0===c?void 0:c.name])||void 0===n?void 0:n.scale)||1,u=(r-1)*a/2,p=(d-1)*a/2,h=e.x+a+u,m=e.y+l/2,g=t.x-p,f=t.y+l/2,v=g-h,y=h+.5*v,_=g-.5*v;return"M ".concat(h,",").concat(m," C ").concat(y,",").concat(m," ").concat(_,",").concat(f," ").concat(g,",").concat(f)},p=function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]?n.branch:n[e]||n.execution},h=e=>"execution"===e?.3:.6},4579:(e,t,s)=>{"use strict";s.d(t,{A:()=>c});var o=s(89379),n=s(65043),a=s(24227);const l=750;function c(e){const[t,s]=(0,n.useState)([]),[c,i]=(0,n.useState)(null),[r,d]=(0,n.useState)([]),[u,p]=(0,n.useState)([]),[h,m]=(0,n.useState)({}),[g,f]=(0,n.useState)({currentCell:null,currentModel:null,totalCost:0,status:"idle",cascadeId:null,cellHistory:[],turnCount:0}),[v,y]=(0,n.useState)(null),[_,j]=(0,n.useState)(null),[x,w]=(0,n.useState)(0),[C,S]=(0,n.useState)(null),[N,b]=(0,n.useState)(!1),[k,I]=(0,n.useState)(null),[A,E]=(0,n.useState)({messageCount:0,tokensIn:0,tokensOut:0,durationMs:0,startTime:null,lastActivityTime:null,roleCounts:{},modelUsage:{},modelCosts:{},recentActivity:[]}),[T,O]=(0,n.useState)({}),[M,P]=(0,n.useState)(null),[D,V]=(0,n.useState)([]),J=(0,n.useRef)("1970-01-01 00:00:00"),R=(0,n.useRef)(new Set),F=(0,n.useRef)(new Map),W=(0,n.useRef)(null),L=(0,n.useRef)(null),z=(0,n.useRef)(null);(0,n.useEffect)(()=>{e!==z.current&&(console.log("[useExplorePolling] Session changed:",z.current,"\u2192",e,"- CLEARING ALL DATA"),W.current&&(clearInterval(W.current),W.current=null),L.current&&(clearInterval(L.current),L.current=null),s([]),i(null),d([]),p([]),m({}),f({currentCell:null,currentModel:null,totalCost:0,status:"idle",cascadeId:null,cellHistory:[],turnCount:0}),y(null),j(null),w(0),S(null),b(!1),I(null),E({messageCount:0,tokensIn:0,tokensOut:0,durationMs:0,startTime:null,lastActivityTime:null,roleCounts:{},modelUsage:{},modelCosts:{},recentActivity:[]}),O({}),P(null),V([]),J.current="1970-01-01 00:00:00",R.current.clear(),F.current.forEach(e=>clearTimeout(e)),F.current.clear(),z.current=e,console.log("[useExplorePolling] State cleared, ready for new session"))},[e]);const G=(0,n.useCallback)(e=>{console.log("[deriveGhostMessages] Processing",e.length,"new logs");const t=[],s={};for(const o of e){let e=null,c=null;if(o.content_json)try{const t=JSON.parse(o.content_json);t.tool&&(e=t.tool,c=t.arguments||null)}catch(l){}if(!e&&o.tool_calls_json)try{const t=JSON.parse(o.tool_calls_json);var n,a;if(Array.isArray(t)&&t.length>0)e=(null===(n=t[0].function)||void 0===n?void 0:n.name)||t[0].name,c=(null===(a=t[0].function)||void 0===a?void 0:a.arguments)||t[0].arguments}catch(l){}if(!e&&o.metadata_json)try{const t=JSON.parse(o.metadata_json);t.tool_name&&(e=t.tool_name)}catch(l){}if(console.log("[deriveGhostMessages] Log:",{role:o.role,toolName:e,node_type:o.node_type,hasContent:!!o.content_json,message_id:o.message_id}),e&&"assistant"===o.role&&(console.log("[deriveGhostMessages] Found tool_call:",e),t.push({id:o.message_id||"ghost_".concat(Date.now(),"_").concat(Math.random()),type:"tool_call",tool:e,content:o.content_json,arguments:c,timestamp:o.timestamp,createdAt:Date.now()}),s[e]=(s[e]||0)+1),"tool"===o.role){let s=e||"tool";if(!e&&o.metadata_json)try{const e=JSON.parse(o.metadata_json);s=e.tool_name||e.name||"tool"}catch(l){}console.log("[deriveGhostMessages] Found tool_result:",s),t.push({id:o.message_id||"ghost_".concat(Date.now(),"_").concat(Math.random()),type:"tool_result",tool:s,result:o.content_json,timestamp:o.timestamp,createdAt:Date.now()})}if("assistant"===o.role&&!e&&o.content_json)try{const e=JSON.parse(o.content_json),s="string"===typeof e?e:JSON.stringify(e);s.length>50&&(console.log("[deriveGhostMessages] Found thinking message, len:",s.length),t.push({id:o.message_id||"ghost_".concat(Date.now(),"_").concat(Math.random()),type:"thinking",content:s,timestamp:o.timestamp,createdAt:Date.now()}))}catch(l){o.content_json.length>50&&(console.log("[deriveGhostMessages] Found raw thinking message"),t.push({id:o.message_id||"ghost_".concat(Date.now(),"_").concat(Math.random()),type:"thinking",content:o.content_json,timestamp:o.timestamp,createdAt:Date.now()}))}}console.log("[deriveGhostMessages] Created",t.length,"new ghosts"),Object.keys(s).length>0&&m(e=>{const t=(0,o.A)({},e);for(const[o,n]of Object.entries(s))t[o]=(t[o]||0)+n;return console.log("[deriveGhostMessages] Tool counts updated:",t),t}),t.length>0&&p(e=>{const s=[...e,...t];return console.log("[deriveGhostMessages] Ghost messages now:",s.length),s})},[]),H=(0,n.useCallback)((e,t)=>{if(0===t.length&&0===e.length)return;let s=0,n=0,a=0;const l={},c={},i={},r=[];for(const o of t){if(s+=parseInt(o.tokens_in||0,10),n+=parseInt(o.tokens_out||0,10),a+=parseInt(o.duration_ms||0,10),o.role&&(l[o.role]=(l[o.role]||0)+1),o.model){c[o.model]=(c[o.model]||0)+1;const e=parseFloat(o.cost||0);e>0&&(i[o.model]=(i[o.model]||0)+e)}if("tool"===o.role||"assistant"===o.role&&o.tool_calls_json){let e=null;try{if(o.tool_calls_json){var d,u,p;const t=JSON.parse(o.tool_calls_json);e=(null===(d=t[0])||void 0===d||null===(u=d.function)||void 0===u?void 0:u.name)||(null===(p=t[0])||void 0===p?void 0:p.name)}if(!e&&o.metadata_json){const t=JSON.parse(o.metadata_json);e=t.tool_name||t.name}}catch(g){}r.push({type:"tool"===o.role?"tool_result":"tool_call",tool:e||"unknown",cell:o.cell_name,timestamp:o.timestamp})}else"render"===o.role&&r.push({type:"checkpoint",cell:o.cell_name,timestamp:o.timestamp})}const h=e[0],m=e[e.length-1]||t[t.length-1];E(e=>{const d=(0,o.A)({},e.roleCounts);for(const[t,s]of Object.entries(l))d[t]=(d[t]||0)+s;const u=(0,o.A)({},e.modelUsage);for(const[t,s]of Object.entries(c))u[t]=(u[t]||0)+s;const p=(0,o.A)({},e.modelCosts);for(const[t,s]of Object.entries(i))p[t]=(p[t]||0)+s;const g=[...e.recentActivity,...r].slice(-8);return{messageCount:e.messageCount+t.length,tokensIn:e.tokensIn+s,tokensOut:e.tokensOut+n,durationMs:e.durationMs+a,startTime:e.startTime||(null===h||void 0===h?void 0:h.timestamp),lastActivityTime:(null===m||void 0===m?void 0:m.timestamp)||e.lastActivityTime,roleCounts:d,modelUsage:u,modelCosts:p,recentActivity:g}})},[]),Y=(0,n.useCallback)((e,t)=>{console.log("[updateOrchestrationState] Processing",e.length,"logs");const s=[...e].reverse().find(e=>e.cell_name||e.model);console.log("[updateOrchestrationState] Latest log:",{cell_name:null===s||void 0===s?void 0:s.cell_name,model:null===s||void 0===s?void 0:s.model,role:null===s||void 0===s?void 0:s.role});let o="idle";if(c)o="waiting_human";else{const t=e.slice(-5);t.some(e=>"tool"===e.role)?o="tool_running":t.some(e=>"assistant"===e.role)&&(o="thinking")}const n={currentCell:(null===s||void 0===s?void 0:s.cell_name)||null,currentModel:(null===s||void 0===s?void 0:s.model)||null,totalCost:(null===t||void 0===t?void 0:t.total_cost)||0,status:o,cascadeId:(null===t||void 0===t?void 0:t.cascade_id)||null};console.log("[updateOrchestrationState] New state:",n),f(n)},[c]),B=(0,n.useCallback)(async()=>{if(e)try{b(!0);const t="".concat(a.J,"/api/playground/session-stream/").concat(e,"?after=").concat(encodeURIComponent(J.current)),o=await fetch(t);if(!o.ok)throw new Error("HTTP ".concat(o.status));const n=await o.json();if(n.error)throw new Error(n.error);const l=[];for(const e of n.rows||[])e.message_id&&!R.current.has(e.message_id)&&(R.current.add(e.message_id),l.push(e));l.length>0&&(console.log("[useExplorePolling] Got new rows:",l.length),console.log("[useExplorePolling] Sample row:",l[0]),s(e=>{const t=[...e,...l];return console.log("[useExplorePolling] Total logs now:",t.length),H(t,l),t}),G(l),J.current=n.cursor||J.current),void 0===n.total_cost&&void 0===n.session_status||s(e=>(Y(e,n),e)),void 0!==n.session_status&&y(n.session_status),void 0!==n.session_error&&j(n.session_error),void 0!==n.total_cost&&w(n.total_cost),n.cascade_id&&S(n.cascade_id),n.cascade_analytics&&P(n.cascade_analytics),n.cell_analytics&&Object.keys(n.cell_analytics).length>0&&O(n.cell_analytics),n.child_sessions&&n.child_sessions.length>0&&V(n.child_sessions),I(null)}catch(t){console.error("[useExplorePolling] Session logs error:",t),I(t.message)}finally{b(!1)}},[e,G,H,Y]),U=(0,n.useCallback)(async()=>{if(e)try{var t,s;const o=await fetch("".concat(a.J,"/api/checkpoints?session_id=").concat(e));if(!o.ok)throw new Error("HTTP ".concat(o.status));const n=await o.json();if(console.log("[pollCheckpoint] Response:",{error:n.error,count:null===(t=n.checkpoints)||void 0===t?void 0:t.length,checkpoints:null===(s=n.checkpoints)||void 0===s?void 0:s.map(e=>({id:e.id,status:e.status}))}),!n.error&&n.checkpoints&&n.checkpoints.length>0){d(n.checkpoints);const e=n.checkpoints.find(e=>"pending"===e.status);console.log("[pollCheckpoint] Pending checkpoint:",e?e.id:"none"),i(t=>(null===e||void 0===e?void 0:e.id)!==(null===t||void 0===t?void 0:t.id)?e||null:t)}else i(e=>e?null:e)}catch(o){console.error("[useExplorePolling] Checkpoint poll error:",o)}},[e]);return(0,n.useEffect)(()=>{if(!e)return;console.log("[useExplorePolling] Setting up polling for session:",e),B(),U();const t=setInterval(()=>{B()},l),s=setInterval(()=>{U()},l);return console.log("[useExplorePolling] Intervals set up"),()=>{console.log("[useExplorePolling] Cleanup: clearing intervals for session:",e),clearInterval(t),clearInterval(s),F.current.forEach(e=>clearTimeout(e)),F.current.clear()}},[e]),(0,n.useEffect)(()=>{if(("completed"===v||"cancelled"===v)&&e){const e=setTimeout(()=>{console.log("[useExplorePolling] Session completed, stopping polls"),W.current&&(clearInterval(W.current),W.current=null),L.current&&(clearInterval(L.current),L.current=null)},1e4);return()=>clearTimeout(e)}},[v,e]),{logs:t,checkpoint:c,checkpointHistory:r,ghostMessages:u,orchestrationState:g,toolCounts:h,sessionStatus:v,sessionError:_,totalCost:x,cascadeId:C,sessionStats:A,cellAnalytics:T,cascadeAnalytics:M,childSessions:D,isPolling:N,error:k,refresh:()=>{B(),U()},clearGhosts:()=>{p([]),F.current.forEach(e=>clearTimeout(e)),F.current.clear()}}}},13218:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},41497:(e,t,s)=>{"use strict";var o=s(13218);function n(){}function a(){}a.resetWarningCache=n,e.exports=function(){function e(e,t,s,n,a,l){if(l!==o){var c=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw c.name="Invariant Violation",c}}function t(){return e}e.isRequired=e;var s={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:a,resetWarningCache:n};return s.PropTypes=s,s}},45448:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>j});var o=s(89379),n=s(65043),a=s(45685),l=s(24768),c=s(59570),i=s(38491),r=s(5748),d=s(64065),u=s(44658),p=s(63313),h=s(4579),m=s(60263),g=s(24227),f=s(70579);const v="calliope_last_session",y="calliope_last_session_time",_="calliope_goal_",j=()=>{var e,t;const{sessionId:s}=(0,a.g)(),j=(0,a.Zp)(),{showToast:x}=(0,d.dj)(),w=(0,n.useRef)(null),C=(0,n.useRef)(!1),[S,N]=(0,n.useState)(s||null),[b,k]=(0,n.useState)(!1),[I,A]=(0,n.useState)(""),[E,T]=(0,n.useState)(null),[O,M]=(0,n.useState)([]),[P,D]=(0,n.useState)({}),[V,J]=(0,n.useState)(null),[R,F]=(0,n.useState)(null),[W,L]=(0,n.useState)(null),[z,G]=(0,n.useState)([35,65]),[H,Y]=(0,n.useState)([40,60]),[B,U]=(0,n.useState)(!1),{logs:$,checkpoint:q,ghostMessages:Z,orchestrationState:K,sessionStatus:Q,totalCost:X,isPolling:ee,error:te}=(0,h.A)(S),se=(0,n.useMemo)(()=>{if(!O||0===O.length||!W)return{};const e={},t=O.map(e=>e.name),s=t.indexOf(W);for(let o=0;o<t.length;o++){const n=t[o];e[n]=o<s?"completed":n===W?"current":"pending"}return e},[O,W]);(0,n.useEffect)(()=>{if(s||C.current)return;C.current=!0;const e=localStorage.getItem(v),t=localStorage.getItem(y);if(!e||!t)return;Date.now()-parseInt(t,10)>=36e5?console.log("[CalliopeView] Session expired"):fetch("".concat(g.J,"/api/sessions?limit=100")).then(e=>e.json()).then(t=>{var s;const o=null===(s=t.sessions)||void 0===s?void 0:s.find(t=>t.session_id===e);!o||"running"!==o.status&&"blocked"!==o.status||(console.log("[CalliopeView] Auto-restoring session:",e),N(e),j(m.bw.calliopeWithSession(e)))}).catch(e=>console.error("[CalliopeView] Failed to validate session:",e))},[s,j]),(0,n.useEffect)(()=>{S&&(localStorage.setItem(v,S),localStorage.setItem(y,Date.now().toString()))},[S]),(0,n.useEffect)(()=>{if(S&&!I){const e=localStorage.getItem("".concat(_).concat(S));if(e)return void A(e);fetch("".concat(g.J,"/api/studio/session-cascade/").concat(S)).then(e=>e.json()).then(e=>{var t;null!==(t=e.input_data)&&void 0!==t&&t.goal&&(A(e.input_data.goal),localStorage.setItem("".concat(_).concat(S),e.input_data.goal))}).catch(e=>console.log("[CalliopeView] Failed to fetch session goal:",e))}},[S]);const oe=(0,n.useRef)(null),ne=(0,n.useRef)(!1),ae=(0,n.useCallback)(()=>{const e=oe.current;if(!e)return;const t=e.scrollHeight-e.scrollTop-e.clientHeight<100;ne.current=!t},[]);(0,n.useEffect)(()=>{var e;ne.current||(null===(e=w.current)||void 0===e||e.scrollIntoView({behavior:"smooth"}))},[$,q]),(0,n.useEffect)(()=>{if($&&0!==$.length){console.log("[CalliopeView] Processing",$.length,"logs for cascade_write");for(const i of[...$].reverse()){const r=i.content_json&&(i.content_json.includes("cascade_write")||i.content_json.includes("'cascade_id'")||i.content_json.includes('"cascade_id"')),d="tool_result"===i.node_type||"deterministic"===i.node_type||"tool"===i.role||r;var e;if(i.node_type||"tool"===i.role)console.log("[CalliopeView] Take log:",{role:i.role,node_type:i.node_type,isToolResult:d,hasContent:!!i.content_json,contentLen:null===(e=i.content_json)||void 0===e?void 0:e.length});if(d){var t;let e=null;if(i.metadata_json)try{const t="string"===typeof i.metadata_json?JSON.parse(i.metadata_json):i.metadata_json;e=t.tool_name||t.name||t.tool}catch(c){}if(console.log("[CalliopeView] Tool result log:",{toolName:e,role:i.role,node_type:i.node_type,hasContent:!!i.content_json,contentPreview:null===(t=i.content_json)||void 0===t?void 0:t.substring(0,200),metadata:i.metadata_json}),i.content_json)try{let t=i.content_json;if("string"===typeof t)try{t=JSON.parse(t)}catch(c){}if("string"===typeof t&&t.startsWith("Tool Result (")){const e=t.match(/^Tool Result \([^)]+\):\n([^]+)$/);if(e){let o=e[1];console.log("[CalliopeView] Extracted tool result body:",o.substring(0,100));try{const e=o.match(/'cascade_id':\s*'([^']+)'/),n=o.match(/'success':\s*(True|False)/),a=o.match(/'path':\s*'([^']+)'/),l=o.match(/'cell_count':\s*(\d+)/),c=o.match(/'cells':\s*\[([^]*?)\],\s*'graph'/);let i=[];if(c&&c[1].trim()){const e=c[1].matchAll(/\{'name':\s*'([^']+)',\s*'type':\s*'([^']+)'[^}]*'handoffs':\s*\[([^\]]*)\][^}]*\}/g);for(const t of e){var s;const e=(null===(s=t[3].match(/'([^']+)'/g))||void 0===s?void 0:s.map(e=>e.replace(/'/g,"")))||[];i.push({name:t[1],type:t[2],handoffs:e})}}const r=o.match(/'nodes':\s*\[([^]*?)\],\s*'edges'/);let d=[];if(r&&r[1].trim()){const e=r[1].matchAll(/\{'id':\s*'([^']+)',\s*'label':\s*'([^']+)',\s*'type':\s*'([^']+)'/g);for(const t of e)d.push({id:t[1],label:t[2],type:t[3]})}const u=o.match(/'edges':\s*\[([^]*?)\]/);let p=[];if(u&&u[1].trim()){const e=u[1].matchAll(/\{'source':\s*'([^']+)',\s*'target':\s*'([^']+)'\}/g);for(const t of e)p.push({source:t[1],target:t[2]})}const h=o.match(/'yaml_preview':\s*["']([^]*?)["'],\s*'cell_count'/);let m="";h&&(m=h[1].replace(/\\n/g,"\n").replace(/\\'/g,"'")),e&&(t={cascade_id:e[1],success:!!n&&"True"===n[1],path:a?a[1]:null,cell_count:l?parseInt(l[1]):i.length,cells:i,graph:{nodes:d,edges:p},yaml_preview:m},console.log("[CalliopeView] Parsed Python repr via regex:",{cascade_id:t.cascade_id,cells:i.length,nodes:d.length}))}catch(c){console.log("[CalliopeView] Failed to extract from Python repr:",c.message)}}}if("string"===typeof t&&(t.startsWith("{")||t.startsWith("["))){let e=t.replace(/'/g,'"').replace(/\bTrue\b/g,"true").replace(/\bFalse\b/g,"false").replace(/\bNone\b/g,"null");try{t=JSON.parse(e)}catch(c){}}if((t&&"object"===typeof t&&t.cascade_id&&void 0!==t.success||"cascade_write"===e)&&t&&"object"===typeof t){var o,n,a,l;if(console.log("[CalliopeView] \u2713 Found cascade_write result!",{cascade_id:t.cascade_id,success:t.success,path:t.path,cell_count:t.cell_count,has_graph:!!t.graph,has_cells:!!t.cells,graph_nodes:null===(o=t.graph)||void 0===o||null===(n=o.nodes)||void 0===n?void 0:n.length,cells_len:null===(a=t.cells)||void 0===a?void 0:a.length}),T(t),null!==(l=t.graph)&&void 0!==l&&l.nodes&&t.graph.nodes.length>0){const e=t.graph.nodes.map(e=>({name:e.label||e.id,tool:e.tool,instructions:"llm"===e.type?"LLM cell":void 0,hitl:"hitl"===e.type?"<hitl>":void 0,handoffs:(t.graph.edges||[]).filter(t=>t.source===e.id).map(e=>e.target)}));M(e),console.log("[CalliopeView] Set builtCells from graph:",e)}else if(t.cells&&t.cells.length>0){const e=t.cells.map(e=>({name:e.name,tool:e.tool,hitl:"hitl"===e.type?"<hitl>":void 0,instructions:"llm"===e.type?"LLM cell":void 0,handoffs:e.handoffs||[]}));M(e),console.log("[CalliopeView] Set builtCells from cells:",e)}else t.cell_count&&t.cell_count>0&&console.log("[CalliopeView] No graph/cells data, but cell_count:",t.cell_count);break}if(t&&"object"===typeof t&&t.session_id&&"started"===t.status)console.log("[CalliopeView] Found spawn_cascade result (object):",t.session_id),J(t.session_id);else if("spawn_cascade"===e&&"string"===typeof t){const e=t.match(/Session ID: (\S+)/);e&&(console.log("[CalliopeView] Found spawn_cascade result (text):",e[1]),J(e[1]))}else if("string"===typeof i.content_json&&i.content_json.includes("spawn_cascade")){const e=i.content_json.match(/Session ID: (\S+)/);e&&(console.log("[CalliopeView] Found spawn_cascade session ID from raw:",e[1]),J(e[1]))}}catch(c){console.log("[CalliopeView] Failed to parse tool result:",c)}}}}},[$]);const le=(0,n.useRef)(new Set),ce=(0,n.useCallback)(async e=>{if(console.log("[CalliopeView] App session completed:",e),q&&!le.current.has(e.sessionId)){le.current.add(e.sessionId);const s={spawned_session:e.sessionId,spawned_status:e.status,spawned_state:e.state};console.log("[CalliopeView] Auto-sending feedback to Calliope:",s);try{await fetch("".concat(g.J,"/api/checkpoints/").concat(q.id,"/respond"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:(0,o.A)({feedback:"Spawned cascade ".concat(e.status)},s)})}),x("Feedback sent to Calliope",{type:"info"})}catch(t){console.error("[CalliopeView] Failed to send feedback:",t)}}},[q,x]),ie=(0,n.useCallback)((e,t)=>{console.log("[CalliopeView] App cell changed:",e),L(e),t&&F(t)},[]),re=(0,n.useCallback)(e=>{console.error("[CalliopeView] App error:",e),x("App error: ".concat(e.message),{type:"error"})},[x]),de=["cascade_write","cascade_read","spawn_cascade","request_decision","set_state","route_to"],ue=(0,n.useMemo)(()=>{const e=[];let t=[];for(const o of $){if("tool_result"===o.node_type||"deterministic"===o.node_type||"tool_call"===o.node_type){let s="tool";if(o.metadata_json)try{const e="string"===typeof o.metadata_json?JSON.parse(o.metadata_json):o.metadata_json;s=e.tool_name||e.name||e.tool||"tool"}catch(n){}t.push({id:o.message_id||"tool_".concat(e.length,"_").concat(t.length),tool:s,timestamp:o.timestamp});continue}if("user"===o.role&&o.content_json)try{let s=o.content_json;if("string"===typeof s)try{const e=JSON.parse(s);"string"===typeof e?s=e:e&&"object"===typeof e&&(e.content&&"string"===typeof e.content?s=e.content:e.text&&"string"===typeof e.text&&(s=e.text))}catch(n){}if("string"!==typeof s)continue;const a=s.toLowerCase();if(s.startsWith("## New Task")||s.startsWith("## Input Data:")||s.startsWith("## Tool Response")||s.includes("You are an AI assistant")||a.startsWith("system:"))continue;if(o.metadata_json)try{const e="string"===typeof o.metadata_json?JSON.parse(o.metadata_json):o.metadata_json;if(e.debug_only||e.not_sent_to_llm)continue;if("framework"===e.semantic_actor&&"task_input"===e.semantic_purpose)continue}catch(n){}if(s.length<3)continue;t.length>0&&(e.push({id:"toolgroup_".concat(e.length),type:"tool_group",tools:[...t],timestamp:t[0].timestamp}),t=[]),e.push({id:o.message_id||"user_".concat(e.length),type:"user",content:s,timestamp:o.timestamp})}catch(n){console.log("[CalliopeView] Failed to parse user message:",n)}else if("assistant"===o.role&&o.content_json){t.length>0&&(e.push({id:"toolgroup_".concat(e.length),type:"tool_group",tools:[...t],timestamp:t[0].timestamp}),t=[]);try{let t=o.content_json;if("string"===typeof t){if(t.includes('"tool"')||t.includes('"function"')||t.includes('"arguments"')||t.includes('"tool_calls"')||t.includes("'tool'")||t.includes("'arguments'")||t.includes('"type": "function"')||t.includes("'type': 'function'"))continue;if(de.some(e=>t.includes('"'.concat(e,'"'))||t.includes("'".concat(e,"'"))))continue;const e=t.trim();if(e.startsWith("{")||e.startsWith("["))continue}try{const e=JSON.parse(t);if(e&&"object"===typeof e){if(e.tool||e.function||e.name||e.tool_calls||e.arguments||"function"===e.type)continue;if(Array.isArray(e)&&e.some(e=>e.tool||e.function||e.name))continue;if(e.content&&"string"===typeof e.content)t=e.content;else{if(!e.text||"string"!==typeof e.text)continue;t=e.text}}else"string"===typeof e&&(t=e)}catch(n){}if("string"===typeof t){const e=t.trim();if(e.startsWith("{")||e.startsWith("["))continue;if(t.includes('"tool"')||t.includes('"arguments"')||t.includes("'tool'")||t.includes("'arguments'"))continue;if(t.includes('"type":')&&t.includes('"name":'))continue}if("string"!==typeof t||t.length<10)continue;e.push({id:o.message_id||"msg_".concat(e.length),type:"assistant",content:t,timestamp:o.timestamp})}catch(n){console.log("[CalliopeView] Failed to parse assistant message:",n)}}}t.length>0&&e.push({id:"toolgroup_".concat(e.length),type:"tool_group",tools:[...t],timestamp:t[0].timestamp});const s=[];for(const a of e)if("tool_group"===a.type){const e=s[s.length-1];e&&"tool_group"===e.type?e.tools=[...e.tools,...a.tools]:s.push((0,o.A)((0,o.A)({},a),{},{tools:[...a.tools]}))}else s.push(a);return s},[$]),[pe,he]=(0,n.useState)(new Set),me=(0,n.useCallback)(e=>{he(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},[]),ge=async()=>{k(!0);try{const e=await fetch("".concat(g.J,"/api/run-cascade"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cascade_path:"cascades/calliope.yaml",inputs:I?{goal:I}:{}})}),t=await e.json();if(t.error)return x(t.error,{type:"error"}),void k(!1);N(t.session_id),I&&localStorage.setItem("".concat(_).concat(t.session_id),I),j(m.bw.calliopeWithSession(t.session_id)),x("Calliope is ready!",{type:"success"})}catch(e){x("Failed to start: ".concat(e.message),{type:"error"})}finally{k(!1)}};return S?(0,f.jsx)("div",{className:"calliope-view",children:(0,f.jsxs)(l.A,{className:"calliope-split",sizes:z,onDragEnd:e=>G(e),minSize:[300,300],gutterSize:4,gutterAlign:"center",direction:"horizontal",children:[(0,f.jsxs)("div",{className:"calliope-chat-panel",children:[(0,f.jsxs)("div",{className:"chat-header",children:[(0,f.jsx)("div",{className:"chat-avatar",children:(0,f.jsx)("img",{src:"/Calliope.jpg",alt:"Calliope",className:"calliope-avatar-img"})}),(0,f.jsxs)("div",{className:"chat-title",children:[(0,f.jsx)("h2",{children:"Calliope"}),(0,f.jsx)("span",{className:"chat-subtitle",children:"running"===Q?"Building your app...":"blocked"===Q?"Waiting for input...":"completed"===Q?"Session complete":"Ready"})]}),(0,f.jsxs)("div",{className:"chat-header-actions",children:["running"===Q&&!q&&(0,f.jsxs)(d.Ex,{variant:"label",color:"purple",size:"sm",pulse:!0,children:[(0,f.jsx)(r.In,{icon:"mdi:loading",className:"spinning",width:"12"}),"Thinking"]}),X>0&&(0,f.jsxs)(d.Ex,{variant:"label",color:"green",size:"sm",children:["$",X.toFixed(4)]}),(0,f.jsx)(d.$n,{variant:"ghost",size:"sm",icon:"mdi:plus",onClick:()=>{localStorage.removeItem(v),localStorage.removeItem(y),N(null),T(null),M([]),J(null),F(null),L(null),j(m.bw.CALLIOPE)},title:"New Session"})]})]}),(0,f.jsxs)("div",{className:"chat-messages",ref:oe,onScroll:ae,children:[(0,f.jsxs)("div",{className:"message assistant",children:[(0,f.jsx)("div",{className:"message-avatar",children:(0,f.jsx)("img",{src:"/Calliope.jpg",alt:"Calliope",className:"calliope-avatar-img chat-avatar-tinted"})}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(u.A,{children:"Hello! I'm **Calliope**, your creative partner in app building. What would you like to create today?"})})]}),I&&(0,f.jsxs)("div",{className:"message user",children:[(0,f.jsx)("div",{className:"message-avatar user-avatar",children:(0,f.jsx)(r.In,{icon:"mdi:account",width:"16"})}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(u.A,{children:I})})]}),(0,f.jsx)(c.N,{children:ue.map(e=>{if("tool_group"===e.type){const t=pe.has(e.id);return(0,f.jsxs)(i.P.div,{className:"message tool-group",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},children:[(0,f.jsxs)("div",{className:"tool-group-header",onClick:()=>me(e.id),children:[(0,f.jsx)(r.In,{icon:t?"mdi:chevron-down":"mdi:chevron-right",width:"16"}),(0,f.jsx)(r.In,{icon:"mdi:tools",width:"14"}),(0,f.jsxs)("span",{children:[e.tools.length," tool",1!==e.tools.length?"s":""," used"]})]}),t&&(0,f.jsx)("div",{className:"tool-group-list",children:e.tools.map(e=>(0,f.jsxs)("div",{className:"tool-group-item",children:[(0,f.jsx)(r.In,{icon:"mdi:play-circle-outline",width:"12"}),(0,f.jsx)("span",{children:e.tool})]},e.id))})]},e.id)}return"user"===e.type?(0,f.jsxs)(i.P.div,{className:"message user",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},children:[(0,f.jsx)("div",{className:"message-avatar user-avatar",children:(0,f.jsx)(r.In,{icon:"mdi:account",width:"16"})}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(u.A,{children:e.content})})]},e.id):(0,f.jsxs)(i.P.div,{className:"message assistant",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},children:[(0,f.jsx)("div",{className:"message-avatar",children:(0,f.jsx)("img",{src:"/Calliope.jpg",alt:"Calliope",className:"calliope-avatar-img chat-avatar-tinted"})}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(u.A,{children:e.content})})]},e.id)})}),!E&&(0,f.jsx)(c.N,{children:Z.slice(-3).map(e=>(0,f.jsx)(i.P.div,{className:"message ghost",initial:{opacity:0,x:-10},animate:{opacity:.7,x:0},exit:{opacity:0,x:-20},children:(0,f.jsxs)("div",{className:"ghost-indicator",children:[(0,f.jsx)(r.In,{icon:"tool_call"===e.type?"mdi:play":"tool_result"===e.type?"mdi:check":"mdi:thought-bubble",width:"12"}),(0,f.jsx)("span",{children:e.tool||"thinking..."})]})},e.id))}),"running"===Q&&!q&&0===ue.length&&(0,f.jsxs)(i.P.div,{className:"message assistant thinking",initial:{opacity:0},animate:{opacity:1},children:[(0,f.jsx)("div",{className:"message-avatar",children:(0,f.jsx)("img",{src:"/Calliope.jpg",alt:"Calliope",className:"calliope-avatar-img chat-avatar-tinted"})}),(0,f.jsxs)("div",{className:"thinking-dots",children:[(0,f.jsx)("span",{}),(0,f.jsx)("span",{}),(0,f.jsx)("span",{})]})]}),q&&(0,f.jsxs)(i.P.div,{className:"chat-checkpoint",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[(0,f.jsxs)("div",{className:"checkpoint-label",children:[(0,f.jsx)(r.In,{icon:"mdi:hand-back-right",width:"12"}),(0,f.jsx)("span",{children:"Calliope needs your input"})]}),(0,f.jsx)(d.cT,{checkpoint:q,onSubmit:async e=>{if(q)try{const t=await fetch("".concat(g.J,"/api/checkpoints/").concat(q.id,"/respond"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:e})}),s=await t.json();if(s.error)return void x("Failed: ".concat(s.error),{type:"error"});x("Response sent",{type:"success"})}catch(t){x("Error: ".concat(t.message),{type:"error"})}},variant:"inline",showCellOutput:!1})]}),(0,f.jsx)("div",{ref:w})]})]}),(0,f.jsxs)("div",{className:"calliope-cascade-panel",children:[(0,f.jsxs)("div",{className:"cascade-header",children:[(0,f.jsxs)("div",{className:"cascade-title",children:[(0,f.jsx)(r.In,{icon:"mdi:sitemap",width:"16"}),(0,f.jsx)("h3",{children:(null===E||void 0===E?void 0:E.cascade_id)||"Your App"}),E&&(0,f.jsxs)(d.Ex,{variant:"label",color:E.success?"green":"yellow",size:"sm",children:[E.cell_count||O.length||0," screens"]})]}),(0,f.jsxs)("div",{className:"cascade-actions",children:[E&&(O.length>0||E.yaml_preview)&&(0,f.jsx)(d.$n,{variant:"ghost",size:"sm",icon:B?"mdi:graph":"mdi:code-braces",onClick:()=>U(!B),title:B?"View Graph":"View YAML",children:B?"Graph":"YAML"}),V&&(0,f.jsxs)(d.Ex,{variant:"label",color:"green",size:"sm",children:[(0,f.jsx)(r.In,{icon:"mdi:play-circle",width:"12"}),"Live"]})]})]}),V&&E?(0,f.jsxs)(l.A,{className:"cascade-vertical-split",sizes:H,onDragEnd:e=>Y(e),minSize:[100,100],gutterSize:6,gutterAlign:"center",direction:"vertical",children:[(0,f.jsx)("div",{className:"cascade-content",children:0!==O.length||E?0===O.length&&E?B&&E.yaml_preview?(0,f.jsx)("pre",{className:"cascade-yaml",children:E.yaml_preview}):(0,f.jsxs)("div",{className:"cascade-empty",children:[(0,f.jsx)(r.In,{icon:"mdi:file-document-check",width:"40"}),(0,f.jsxs)("p",{children:["Cascade created: ",(0,f.jsx)("strong",{children:E.cascade_id})]}),E.path&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:folder",width:"14"}),E.path]}),0===E.cell_count&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:information",width:"14"}),"No screens added yet..."]}),E.cell_count>0&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:check",width:"14"}),E.cell_count," screens ready"]})]}):B?(0,f.jsx)("pre",{className:"cascade-yaml",children:(null===E||void 0===E?void 0:E.yaml_preview)||"No YAML preview available"}):(0,f.jsx)("div",{className:"cascade-graph-wrapper",children:(0,f.jsx)(p.A,{cells:O,inputsSchema:P,cascadeId:null===E||void 0===E?void 0:E.cascade_id,cellStatus:se})}):(0,f.jsxs)("div",{className:"cascade-empty",children:[(0,f.jsx)(r.In,{icon:"mdi:sitemap",width:"40"}),(0,f.jsx)("p",{children:"Your app will appear here as we build it together"}),$.length>0&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:information",width:"14"}),"Waiting for Calliope to create screens..."]})]})}),(0,f.jsx)(d.gJ,{cascadeId:E.cascade_id,onSessionComplete:ce,onCellChange:ie,onError:re,onStateChange:F})]}):(0,f.jsx)("div",{className:"cascade-content",children:0!==O.length||E?0===O.length&&E?B&&E.yaml_preview?(0,f.jsx)("pre",{className:"cascade-yaml",children:E.yaml_preview}):(0,f.jsxs)("div",{className:"cascade-empty",children:[(0,f.jsx)(r.In,{icon:"mdi:file-document-check",width:"40"}),(0,f.jsxs)("p",{children:["Cascade created: ",(0,f.jsx)("strong",{children:E.cascade_id})]}),E.path&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:folder",width:"14"}),E.path]}),0===E.cell_count&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:information",width:"14"}),"No screens added yet..."]}),E.cell_count>0&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:check",width:"14"}),E.cell_count," screens ready"]})]}):B?(0,f.jsx)("pre",{className:"cascade-yaml",children:(null===E||void 0===E?void 0:E.yaml_preview)||"No YAML preview available"}):(0,f.jsx)("div",{className:"cascade-graph-wrapper",children:(0,f.jsx)(p.A,{cells:O,inputsSchema:P,cascadeId:null===E||void 0===E?void 0:E.cascade_id,cellStatus:se})}):(0,f.jsxs)("div",{className:"cascade-empty",children:[(0,f.jsx)(r.In,{icon:"mdi:sitemap",width:"40"}),(0,f.jsx)("p",{children:"Your app will appear here as we build it together"}),$.length>0&&(0,f.jsxs)("p",{className:"cascade-empty-hint",children:[(0,f.jsx)(r.In,{icon:"mdi:information",width:"14"}),"Waiting for Calliope to create screens..."]})]})}),(null===E||void 0===E?void 0:E.validation)&&!E.validation.valid&&(0,f.jsxs)("div",{className:"cascade-validation",children:[(0,f.jsx)(r.In,{icon:"mdi:alert",width:"16"}),(0,f.jsxs)("span",{children:[(null===(e=E.validation.errors)||void 0===e?void 0:e.length)||0," errors,"," ",(null===(t=E.validation.warnings)||void 0===t?void 0:t.length)||0," warnings"]})]})]})]})}):(0,f.jsx)("div",{className:"calliope-welcome",style:{zoom:1.3},children:(0,f.jsxs)("div",{className:"welcome-content",children:[(0,f.jsx)("div",{className:"welcome-avatar",children:(0,f.jsx)("img",{src:"/Calliope.jpg",alt:"Calliope",className:"calliope-avatar-img"})}),(0,f.jsx)("h1",{style:{color:"#fc0fc0",fontFamily:"Homemade Apple",fontSize:28},children:"Meet Calliope"}),(0,f.jsx)("p",{className:"welcome-tagline",children:"Muse of Cascade Building"}),(0,f.jsx)("p",{className:"welcome-description",children:"Describe what you want to build, and I'll help you create it. We'll design your app together through conversation."}),(0,f.jsxs)("div",{className:"welcome-input-area",children:[(0,f.jsx)("input",{type:"text",value:I,onChange:e=>A(e.target.value),placeholder:"What would you like to build? (optional)",className:"goal-input",onKeyDown:e=>"Enter"===e.key&&ge()}),(0,f.jsx)(d.$n,{variant:"primary",size:"lg",icon:b?"mdi:loading":"mdi:message-text",iconClass:b?"spinning":"",onClick:ge,disabled:b,children:b?"Starting...":"Start Building"})]}),(0,f.jsxs)("div",{className:"welcome-hints",children:[(0,f.jsx)("h3",{children:"Example ideas:"}),(0,f.jsxs)("ul",{children:[(0,f.jsx)("li",{children:'"A feedback review app where I can approve or reject items"'}),(0,f.jsx)("li",{children:'"A multi-step onboarding wizard for new users"'}),(0,f.jsx)("li",{children:'"A data review dashboard with approve/escalate actions"'})]})]})]})})}},65173:(e,t,s)=>{e.exports=s(41497)()}}]);
//# sourceMappingURL=958.b4854fe3.chunk.js.map