-- Table: cascade_sessions
CREATE TABLE IF NOT EXISTS cascade_sessions (`session_id` String, `cascade_id` String, `cascade_definition` String, `input_data` String, `config_path` String, `created_at` DateTime DEFAULT now(), `parent_session_id` String, `depth` UInt8 DEFAULT 0, `caller_id` String DEFAULT '', `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `genus_hash` String DEFAULT '' CODEC(ZSTD(1)), `output` String DEFAULT '' CODEC(ZSTD(3)), INDEX idx_genus_hash genus_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_output_bloom output TYPE bloom_filter(0.01) GRANULARITY 1, INDEX idx_session_id session_id TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree ORDER BY (cascade_id, created_at) SETTINGS index_granularity = 8192;


-- Table: cascade_template_vectors
CREATE TABLE IF NOT EXISTS cascade_template_vectors (`cascade_id` String, `cascade_file` String, `description` String, `cell_count` UInt8, `run_count` UInt32 DEFAULT 0, `avg_cost` Nullable(Float64), `avg_duration_seconds` Nullable(Float64), `success_rate` Nullable(Float32), `description_embedding` Array(Float32), `instructions_embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, `last_updated` DateTime64(3) DEFAULT now64(3)) ENGINE = ReplacingMergeTree(last_updated) ORDER BY cascade_id SETTINGS index_granularity = 8192;


-- Table: checkpoints
CREATE TABLE IF NOT EXISTS checkpoints (`id` String, `session_id` String, `cascade_id` String, `cell_name` String, `status` Enum8('pending' = 1, 'responded' = 2, 'timeout' = 3, 'cancelled' = 4), `created_at` DateTime64(3) DEFAULT now64(3), `responded_at` Nullable(DateTime64(3)), `timeout_at` Nullable(DateTime64(3)), `checkpoint_type` Enum8('cell_input' = 1, 'take_eval' = 2, 'free_text' = 3, 'choice' = 4, 'multi_choice' = 5, 'confirmation' = 6, 'rating' = 7, 'audible' = 8, 'decision' = 9), `ui_spec` String DEFAULT '{}', `echo_snapshot` String DEFAULT '{}', `cell_output` Nullable(String), `trace_context` Nullable(String), `take_outputs` Nullable(String), `take_metadata` Nullable(String), `response` Nullable(String), `response_reasoning` Nullable(String), `response_confidence` Nullable(Float32), `winner_index` Nullable(Int32), `rankings` Nullable(String), `ratings` Nullable(String), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: context_cards
CREATE TABLE IF NOT EXISTS context_cards (`session_id` String, `content_hash` String, `summary` String, `keywords` Array(String) DEFAULT [], `embedding` Array(Float32) DEFAULT [], `embedding_model` LowCardinality(Nullable(String)), `embedding_dim` Nullable(UInt16), `estimated_tokens` UInt32 DEFAULT 0, `role` LowCardinality(String), `cell_name` Nullable(String), `turn_number` Nullable(UInt32), `is_anchor` Bool DEFAULT false, `is_callout` Bool DEFAULT false, `callout_name` Nullable(String), `generated_at` DateTime64(3) DEFAULT now64(3), `generator_model` LowCardinality(Nullable(String)), `message_timestamp` DateTime64(3) DEFAULT now64(3), `cascade_id` Nullable(String), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_content_hash content_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_is_anchor is_anchor TYPE set(2) GRANULARITY 1, INDEX idx_is_callout is_callout TYPE set(2) GRANULARITY 1, INDEX idx_keywords keywords TYPE bloom_filter GRANULARITY 1, INDEX idx_timestamp message_timestamp TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(generated_at) PARTITION BY toYYYYMM(message_timestamp) ORDER BY (session_id, content_hash) TTL message_timestamp + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: context_shadow_assessments
CREATE TABLE IF NOT EXISTS context_shadow_assessments (`assessment_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `session_id` String, `cascade_id` String, `target_cell_name` String, `target_cell_instructions` String, `source_cell_name` String, `content_hash` String, `message_role` LowCardinality(String), `content_preview` String, `estimated_tokens` UInt32, `message_turn_number` Nullable(UInt32), `heuristic_score` Float32, `heuristic_keyword_overlap` UInt16, `heuristic_recency_score` Float32, `heuristic_callout_boost` Float32, `heuristic_role_boost` Float32, `semantic_score` Nullable(Float32), `semantic_embedding_available` Bool DEFAULT false, `llm_selected` Bool DEFAULT false, `llm_reasoning` String DEFAULT '', `llm_model` String DEFAULT '', `llm_cost` Nullable(Float64), `composite_score` Float32, `would_include_heuristic` Bool, `would_include_semantic` Bool, `would_include_llm` Bool, `would_include_hybrid` Bool, `rank_heuristic` UInt16, `rank_semantic` Nullable(UInt16), `rank_composite` UInt16, `total_takes` UInt16, `budget_total` UInt32, `cumulative_tokens_at_rank` UInt32, `would_fit_budget` Bool, `was_actually_included` Bool, `actual_mode` LowCardinality(String), `assessment_duration_ms` UInt32, `assessment_batch_id` String, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_target_cell target_cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_source_cell source_cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_content_hash content_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_batch assessment_batch_id TYPE bloom_filter GRANULARITY 1, INDEX idx_would_include_heuristic would_include_heuristic TYPE set(2) GRANULARITY 1, INDEX idx_would_include_llm would_include_llm TYPE set(2) GRANULARITY 1, INDEX idx_was_included was_actually_included TYPE set(2) GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_composite_score composite_score TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, target_cell_name, rank_composite) TTL timestamp + toIntervalDay(30) SETTINGS index_granularity = 8192;


-- Table: credit_snapshots
CREATE TABLE IF NOT EXISTS credit_snapshots (`timestamp` DateTime64(3) DEFAULT now64(3), `total_credits` Float64, `total_usage` Float64, `balance` Float64, `delta` Float64 DEFAULT 0, `source` LowCardinality(String), `cascade_id` Nullable(String), `session_id` Nullable(String), `burn_rate_1h` Nullable(Float64), `burn_rate_24h` Nullable(Float64), `burn_rate_7d` Nullable(Float64), INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_source source TYPE set(0) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY timestamp SETTINGS index_granularity = 8192;


-- Table: evaluations
CREATE TABLE IF NOT EXISTS evaluations (`id` UUID DEFAULT generateUUIDv4(), `created_at` DateTime64(3) DEFAULT now64(3), `session_id` String, `cell_name` String, `take_index` Int32, `evaluation_type` Enum8('rating' = 0, 'preference' = 1, 'flag' = 2), `rating` Nullable(Float32), `preferred_index` Nullable(Int32), `flag_reason` Nullable(String), `evaluator_id` Nullable(String), `evaluator_type` Enum8('human' = 0, 'model' = 1) DEFAULT 'human', INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: hf_spaces
CREATE TABLE IF NOT EXISTS hf_spaces (`space_id` String, `author` String, `space_name` String, `status` LowCardinality(String), `hardware` LowCardinality(Nullable(String)), `sdk` LowCardinality(Nullable(String)), `hourly_cost` Nullable(Float64), `is_billable` Bool DEFAULT false, `is_callable` Bool DEFAULT false, `endpoints_json` Nullable(String), `private` Bool DEFAULT false, `space_url` String DEFAULT '', `sleep_time` Nullable(Int32), `requested_hardware` Nullable(String), `first_seen` DateTime64(3) DEFAULT now64(3), `last_seen` DateTime64(3) DEFAULT now64(3), `last_refreshed` DateTime64(3) DEFAULT now64(3), `total_invocations` Nullable(UInt64) DEFAULT 0, `last_invocation` Nullable(DateTime64(3)), INDEX idx_space_id space_id TYPE bloom_filter GRANULARITY 1, INDEX idx_author author TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_hardware hardware TYPE set(50) GRANULARITY 1, INDEX idx_sdk sdk TYPE set(10) GRANULARITY 1, INDEX idx_is_billable is_billable TYPE set(2) GRANULARITY 1, INDEX idx_is_callable is_callable TYPE set(2) GRANULARITY 1) ENGINE = ReplacingMergeTree(last_refreshed) ORDER BY space_id SETTINGS index_granularity = 8192;


-- Table: intra_context_shadow_assessments
CREATE TABLE IF NOT EXISTS intra_context_shadow_assessments (`assessment_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `session_id` String, `cascade_id` String, `cell_name` String, `take_index` Nullable(Int16), `turn_number` UInt16, `is_loop_retry` Bool DEFAULT false, `config_window` UInt8, `config_mask_after` UInt8, `config_min_masked_size` UInt16, `config_compress_loops` Bool, `config_preserve_reasoning` Bool, `config_preserve_errors` Bool, `full_history_size` UInt16, `context_size` UInt16, `tokens_before` UInt32, `tokens_after` UInt32, `tokens_saved` UInt32, `compression_ratio` Float32, `messages_masked` UInt16, `messages_preserved` UInt16, `messages_truncated` UInt16, `message_breakdown` String DEFAULT '[]', `tokens_vs_baseline_saved` UInt32, `tokens_vs_baseline_pct` Float32, `actual_config_enabled` Bool, `actual_tokens_after` Nullable(UInt32), `differs_from_actual` Bool, `assessment_batch_id` String, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_take take_index TYPE set(100) GRANULARITY 1, INDEX idx_turn turn_number TYPE set(100) GRANULARITY 1, INDEX idx_batch assessment_batch_id TYPE bloom_filter GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_compression compression_ratio TYPE minmax GRANULARITY 1, INDEX idx_window config_window TYPE set(20) GRANULARITY 1, INDEX idx_mask_after config_mask_after TYPE set(20) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, cell_name, turn_number, config_window, config_mask_after) TTL timestamp + toIntervalDay(30) SETTINGS index_granularity = 8192;


-- Table: openrouter_models
CREATE TABLE IF NOT EXISTS openrouter_models (`model_id` String, `model_name` String, `provider` String, `description` String DEFAULT '', `context_length` UInt32 DEFAULT 0, `tier` LowCardinality(String), `popular` Bool DEFAULT false, `model_type` LowCardinality(String), `input_modalities` Array(String) DEFAULT [], `output_modalities` Array(String) DEFAULT [], `prompt_price` Float64 DEFAULT 0, `completion_price` Float64 DEFAULT 0, `is_active` Bool DEFAULT true, `last_verified` DateTime64(3) DEFAULT now64(3), `verification_error` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), `metadata_json` String DEFAULT '{}', `inference_type` LowCardinality(String) DEFAULT 'ON_DEMAND', `is_inference_profile` Bool DEFAULT false, INDEX idx_provider provider TYPE bloom_filter GRANULARITY 1, INDEX idx_tier tier TYPE set(10) GRANULARITY 1, INDEX idx_model_type model_type TYPE set(10) GRANULARITY 1, INDEX idx_is_active is_active TYPE set(2) GRANULARITY 1, INDEX idx_popular popular TYPE set(2) GRANULARITY 1, INDEX idx_inference_type inference_type TYPE set(10) GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) PARTITION BY model_type ORDER BY model_id SETTINGS index_granularity = 8192;


-- Table: output_tags
CREATE TABLE IF NOT EXISTS output_tags (`tag_id` UUID DEFAULT generateUUIDv4(), `tag_name` String, `tag_mode` Enum8('instance' = 1, 'dynamic' = 2), `message_id` Nullable(UUID), `cascade_id` Nullable(String), `cell_name` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `created_by` Nullable(String), `note` Nullable(String), INDEX idx_tag_name tag_name TYPE bloom_filter GRANULARITY 1, INDEX idx_message_id message_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_name cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_tag_mode tag_mode TYPE set(2) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (tag_name, created_at) SETTINGS index_granularity = 8192;


-- Table: rag_chunks
CREATE TABLE IF NOT EXISTS rag_chunks (`chunk_id` UUID DEFAULT generateUUIDv4(), `rag_id` String, `doc_id` String, `rel_path` String, `chunk_index` UInt32, `text` String, `char_start` UInt32, `char_end` UInt32, `start_line` UInt32, `end_line` UInt32, `file_hash` String, `created_at` DateTime64(3) DEFAULT now64(3), `embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, INDEX idx_rag_id rag_id TYPE bloom_filter GRANULARITY 1, INDEX idx_doc_id doc_id TYPE bloom_filter GRANULARITY 1, INDEX idx_rel_path rel_path TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY rag_id ORDER BY (rag_id, doc_id, chunk_index) SETTINGS index_granularity = 8192;


-- Table: rag_manifests
CREATE TABLE IF NOT EXISTS rag_manifests (`doc_id` String, `rag_id` String, `rel_path` String, `abs_path` String, `file_hash` String, `file_size` UInt64, `mtime` Float64, `chunk_count` UInt32, `content_hash` String, `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), INDEX idx_rag_id rag_id TYPE bloom_filter GRANULARITY 1, INDEX idx_rel_path rel_path TYPE bloom_filter GRANULARITY 1, INDEX idx_file_hash file_hash TYPE bloom_filter GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) ORDER BY (rag_id, rel_path) SETTINGS index_granularity = 8192;


-- Table: research_sessions
CREATE TABLE IF NOT EXISTS research_sessions (`id` String, `original_session_id` String, `cascade_id` String, `title` String, `description` String, `created_at` DateTime, `frozen_at` DateTime, `status` String, `context_snapshot` String, `checkpoints_data` String, `entries_snapshot` String, `mermaid_graph` String, `screenshots` String, `total_cost` Float64, `total_turns` UInt32, `total_input_tokens` UInt64, `total_output_tokens` UInt64, `duration_seconds` Float64, `cells_visited` String, `tools_used` String, `tags` String, `parent_session_id` Nullable(String), `branch_point_checkpoint_id` Nullable(String), `updated_at` DateTime, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_original_session original_session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_frozen frozen_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(frozen_at) ORDER BY (cascade_id, frozen_at, id) SETTINGS index_granularity = 8192;


-- Table: schema_migrations
CREATE TABLE IF NOT EXISTS schema_migrations (`version` UInt32, `name` String, `description` String, `checksum` String, `executed_at` DateTime64(3) DEFAULT now64(3), `execution_time_ms` UInt32 DEFAULT 0, `status` Enum8('pending' = 1, 'applied' = 2, 'failed' = 3, 'rolled_back' = 4), `author` Nullable(String), `migration_date` Nullable(String), `always_run` Bool DEFAULT false, `error_message` Nullable(String), INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_executed executed_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(executed_at) ORDER BY version SETTINGS index_granularity = 8192;


-- Table: semantic_sql_cache
CREATE TABLE IF NOT EXISTS semantic_sql_cache (`cache_key` String, `function_name` LowCardinality(String), `args_json` String CODEC(ZSTD(3)), `args_preview` String DEFAULT '', `result` String CODEC(ZSTD(3)), `result_type` LowCardinality(String), `created_at` DateTime64(3) DEFAULT now64(), `expires_at` DateTime64(3) DEFAULT toDateTime64('2100-01-01 00:00:00', 3), `ttl_seconds` UInt32 DEFAULT 0, `hit_count` UInt64 DEFAULT 1, `last_hit_at` DateTime64(3) DEFAULT now64(), `result_bytes` UInt32 DEFAULT 0, `first_session_id` String DEFAULT '', `first_caller_id` String DEFAULT '', INDEX idx_function function_name TYPE set(100) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1, INDEX idx_expires expires_at TYPE minmax GRANULARITY 1, INDEX idx_last_hit last_hit_at TYPE minmax GRANULARITY 1, INDEX idx_hit_count hit_count TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(last_hit_at) ORDER BY cache_key TTL expires_at SETTINGS index_granularity = 8192;


-- Table: session_state
CREATE TABLE IF NOT EXISTS session_state (`session_id` String, `cascade_id` String, `parent_session_id` Nullable(String), `caller_id` String DEFAULT '', `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `status` Enum8('starting' = 1, 'running' = 2, 'blocked' = 3, 'completed' = 4, 'error' = 5, 'cancelled' = 6, 'orphaned' = 7), `current_cell` Nullable(String), `depth` UInt8 DEFAULT 0, `blocked_type` Nullable(Enum8('signal' = 1, 'hitl' = 2, 'sensor' = 3, 'approval' = 4, 'checkpoint' = 5, 'decision' = 6)), `blocked_on` Nullable(String), `blocked_description` Nullable(String), `blocked_timeout_at` Nullable(DateTime64(3)), `heartbeat_at` DateTime64(3) DEFAULT now64(3), `heartbeat_lease_seconds` UInt16 DEFAULT 60, `cancel_requested` Bool DEFAULT false, `cancel_reason` Nullable(String), `cancelled_at` Nullable(DateTime64(3)), `error_message` Nullable(String), `error_cell` Nullable(String), `last_checkpoint_id` Nullable(String), `resumable` Bool DEFAULT false, `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `updated_at` DateTime64(3) DEFAULT now64(3), `metadata_json` String DEFAULT '{}', INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_parent parent_session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_caller_id caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_heartbeat heartbeat_at TYPE minmax GRANULARITY 1, INDEX idx_started started_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) PARTITION BY toYYYYMM(started_at) ORDER BY session_id SETTINGS index_granularity = 8192;


-- Table: signals
CREATE TABLE IF NOT EXISTS signals (`signal_id` String, `signal_name` String, `status` Enum8('waiting' = 1, 'fired' = 2, 'timeout' = 3, 'cancelled' = 4), `created_at` DateTime64(3) DEFAULT now64(3), `fired_at` Nullable(DateTime64(3)), `timeout_at` Nullable(DateTime64(3)), `session_id` String, `cascade_id` String, `cell_name` Nullable(String), `callback_host` Nullable(String), `callback_port` Nullable(UInt16), `callback_token` Nullable(String), `payload_json` Nullable(String), `target_cell` Nullable(String), `inputs_json` Nullable(String), `description` Nullable(String), `source` Nullable(String), `metadata_json` Nullable(String), INDEX idx_signal_name signal_name TYPE bloom_filter GRANULARITY 1, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(created_at) PARTITION BY toYYYYMM(created_at) ORDER BY signal_id SETTINGS index_granularity = 8192;


-- Table: sql_query_log
CREATE TABLE IF NOT EXISTS sql_query_log (`query_id` UUID DEFAULT generateUUIDv4(), `caller_id` String, `query_raw` String CODEC(ZSTD(3)), `query_fingerprint` String, `query_template` String CODEC(ZSTD(3)), `query_type` LowCardinality(String), `udf_types` Array(String) DEFAULT [], `udf_count` UInt16 DEFAULT 0, `cascade_paths` Array(String) DEFAULT [], `cascade_count` UInt16 DEFAULT 0, `started_at` DateTime64(6), `completed_at` Nullable(DateTime64(6)), `duration_ms` Nullable(Float64), `status` LowCardinality(String), `rows_input` Nullable(Int32), `rows_output` Nullable(Int32), `total_cost` Nullable(Float64), `total_tokens_in` Nullable(Int64), `total_tokens_out` Nullable(Int64), `llm_calls_count` UInt32 DEFAULT 0, `cache_hits` UInt32 DEFAULT 0, `cache_misses` UInt32 DEFAULT 0, `error_message` Nullable(String), `result_db_name` Nullable(String), `result_db_path` Nullable(String), `result_schema` Nullable(String), `result_table` Nullable(String), `protocol` LowCardinality(String), `timestamp` DateTime64(6) DEFAULT now64(6), INDEX idx_caller caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_fingerprint query_fingerprint TYPE bloom_filter GRANULARITY 1, INDEX idx_query_type query_type TYPE set(20) GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_duration duration_ms TYPE minmax GRANULARITY 1, INDEX idx_cost total_cost TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (timestamp, caller_id) TTL timestamp + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: tag_definitions
CREATE TABLE IF NOT EXISTS tag_definitions (`tag_name` String, `tag_color` String DEFAULT '#a78bfa', `description` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) ORDER BY tag_name SETTINGS index_granularity = 8192;


-- Table: test_results
CREATE TABLE IF NOT EXISTS test_results (`run_id` String, `test_id` String, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2), `test_group` String, `test_name` String, `test_description` String DEFAULT '', `source_file` String DEFAULT '', `source_line` UInt32 DEFAULT 0, `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `duration_ms` Float64 DEFAULT 0, `status` Enum8('pending' = 0, 'running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'skipped' = 5), `sql_query` String DEFAULT '' CODEC(ZSTD(3)), `expected_value` String DEFAULT '' CODEC(ZSTD(3)), `actual_value` String DEFAULT '' CODEC(ZSTD(3)), `expect_type` String DEFAULT '', `validation_mode` String DEFAULT '', `cells_validated` UInt32 DEFAULT 0, `contracts_checked` UInt32 DEFAULT 0, `contracts_passed` UInt32 DEFAULT 0, `anchors_checked` UInt32 DEFAULT 0, `anchors_passed` UInt32 DEFAULT 0, `judge_score` Nullable(Float32), `judge_reasoning` String DEFAULT '' CODEC(ZSTD(3)), `failure_type` String DEFAULT '', `failure_message` String DEFAULT '' CODEC(ZSTD(3)), `failure_diff` String DEFAULT '' CODEC(ZSTD(3)), `error_type` String DEFAULT '', `error_message` String DEFAULT '' CODEC(ZSTD(3)), `error_traceback` String DEFAULT '' CODEC(ZSTD(3)), INDEX idx_run_id run_id TYPE bloom_filter GRANULARITY 1, INDEX idx_test_type test_type TYPE set(10) GRANULARITY 1, INDEX idx_test_group test_group TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_source_file source_file TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(started_at) ORDER BY (run_id, test_type, test_group, test_id) SETTINGS index_granularity = 8192;


-- Table: test_runs
CREATE TABLE IF NOT EXISTS test_runs (`run_id` String, `run_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2, 'mixed' = 3), `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `duration_ms` Float64 DEFAULT 0, `status` Enum8('running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'cancelled' = 5), `total_tests` UInt32 DEFAULT 0, `passed_tests` UInt32 DEFAULT 0, `failed_tests` UInt32 DEFAULT 0, `skipped_tests` UInt32 DEFAULT 0, `error_tests` UInt32 DEFAULT 0, `trigger` Enum8('manual' = 1, 'ci' = 2, 'scheduled' = 3, 'hook' = 4, 'api' = 5) DEFAULT 'manual', `trigger_source` String DEFAULT '', `git_commit` String DEFAULT '', `git_branch` String DEFAULT '', `git_dirty` UInt8 DEFAULT 0, `test_filter` String DEFAULT '', `run_options` String DEFAULT '', `error_message` String DEFAULT '', `error_traceback` String DEFAULT '' CODEC(ZSTD(3)), INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_run_type run_type TYPE set(10) GRANULARITY 1, INDEX idx_trigger trigger TYPE set(10) GRANULARITY 1, INDEX idx_git_commit git_commit TYPE bloom_filter GRANULARITY 1, INDEX idx_started_at started_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(started_at) ORDER BY (started_at, run_id) SETTINGS index_granularity = 8192;


-- Table: tool_manifest_vectors
CREATE TABLE IF NOT EXISTS tool_manifest_vectors (`tool_name` String, `tool_type` Enum8('function' = 0, 'cascade' = 1, 'memory' = 2, 'validator' = 3), `tool_description` String, `schema_json` Nullable(String), `source_path` Nullable(String), `embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, `last_updated` DateTime64(3) DEFAULT now64(3), INDEX idx_tool_type tool_type TYPE set(10) GRANULARITY 1) ENGINE = ReplacingMergeTree(last_updated) ORDER BY tool_name SETTINGS index_granularity = 8192;


-- Table: training_preferences
CREATE TABLE IF NOT EXISTS training_preferences (`id` String, `created_at` DateTime64(3) DEFAULT now64(3), `session_id` String, `cascade_id` String, `cell_name` String, `checkpoint_id` String, `prompt_text` String, `prompt_messages` String, `system_prompt` String, `preference_type` Enum8('pairwise' = 1, 'ranking' = 2, 'rating' = 3), `chosen_response` String, `rejected_response` String, `chosen_model` Nullable(String), `rejected_model` Nullable(String), `chosen_cost` Nullable(Float64), `rejected_cost` Nullable(Float64), `chosen_tokens` Nullable(Int32), `rejected_tokens` Nullable(Int32), `margin` Float32 DEFAULT 1., `all_responses` Nullable(String), `ranking_order` Nullable(String), `num_responses` Nullable(Int32), `ratings_json` Nullable(String), `rating_scale_max` Nullable(Int32), `human_reasoning` Nullable(String), `human_confidence` Nullable(Float32), `chosen_mutation` Nullable(String), `rejected_mutation` Nullable(String), `model_comparison` Bool DEFAULT false, `reasoning_quality` Nullable(Float32), `is_tie` Bool DEFAULT false, `is_rejection` Bool DEFAULT false, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_pref_type preference_type TYPE set(10) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id, preference_type) SETTINGS index_granularity = 8192;


-- Table: ui_sql_log
CREATE TABLE IF NOT EXISTS ui_sql_log (`timestamp` DateTime64(6) DEFAULT now64(6), `query_type` LowCardinality(String), `sql_preview` String, `sql_hash` String, `duration_ms` Float64, `rows_returned` Nullable(Int32), `rows_affected` Nullable(Int32), `source` LowCardinality(String) DEFAULT 'unknown', `caller` Nullable(String), `request_path` Nullable(String), `page_ref` Nullable(String), `success` Bool DEFAULT true, `error_message` Nullable(String), INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_duration duration_ms TYPE minmax GRANULARITY 1, INDEX idx_query_type query_type TYPE set(20) GRANULARITY 1, INDEX idx_sql_hash sql_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_source source TYPE set(20) GRANULARITY 1, INDEX idx_success success TYPE set(2) GRANULARITY 1, INDEX idx_page_ref page_ref TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMMDD(timestamp) ORDER BY (timestamp, query_type) TTL timestamp + toIntervalDay(7) SETTINGS index_granularity = 8192;


-- Table: unified_logs
CREATE TABLE IF NOT EXISTS unified_logs (`message_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `timestamp_iso` String, `session_id` String, `trace_id` String, `parent_id` Nullable(String), `parent_session_id` Nullable(String), `parent_message_id` Nullable(String), `caller_id` String DEFAULT '', `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `is_sql_udf` Bool DEFAULT false, `udf_type` LowCardinality(Nullable(String)), `cache_hit` Bool DEFAULT false, `input_hash` Nullable(String), `source_column_name` Nullable(String), `source_row_index` Nullable(Int64), `source_table_name` Nullable(String), `node_type` LowCardinality(String), `role` LowCardinality(String), `depth` UInt8 DEFAULT 0, `semantic_actor` LowCardinality(Nullable(String)), `semantic_purpose` LowCardinality(Nullable(String)), `take_index` Nullable(Int32), `is_winner` Nullable(Bool), `reforge_step` Nullable(Int32), `winning_take_index` Nullable(Int32), `attempt_number` Nullable(Int32), `turn_number` Nullable(Int32), `mutation_applied` Nullable(String), `mutation_type` LowCardinality(Nullable(String)), `mutation_template` Nullable(String), `cascade_id` Nullable(String), `cascade_file` Nullable(String), `cascade_json` Nullable(String) CODEC(ZSTD(3)), `cell_name` Nullable(String), `cell_json` Nullable(String) CODEC(ZSTD(3)), `species_hash` Nullable(String), `genus_hash` Nullable(String), `model` Nullable(String), `model_requested` Nullable(String), `request_id` Nullable(String), `provider` LowCardinality(Nullable(String)), `duration_ms` Nullable(Float64), `tokens_in` Nullable(Int32), `tokens_out` Nullable(Int32), `total_tokens` Nullable(Int32), `cost` Nullable(Float64), `reasoning_enabled` Nullable(Bool), `reasoning_effort` LowCardinality(Nullable(String)), `reasoning_max_tokens` Nullable(Int32), `tokens_reasoning` Nullable(Int32), `budget_strategy` LowCardinality(Nullable(String)), `budget_tokens_before` Nullable(Int32), `budget_tokens_after` Nullable(Int32), `budget_tokens_limit` Nullable(Int32), `budget_tokens_pruned` Nullable(Int32), `budget_percentage` Nullable(Float32), `content_json` Nullable(String), `full_request_json` Nullable(String) CODEC(ZSTD(3)), `full_response_json` Nullable(String) CODEC(ZSTD(3)), `tool_calls_json` Nullable(String), `images_json` Nullable(String), `has_images` Bool DEFAULT false, `has_base64` Bool DEFAULT false, `has_base64_stripped` Bool DEFAULT false, `videos_json` Nullable(String), `has_videos` Bool DEFAULT false, `audio_json` Nullable(String), `has_audio` Bool DEFAULT false, `mermaid_content` Nullable(String), `content_hash` Nullable(String), `context_hashes` Array(String) DEFAULT [], `estimated_tokens` Nullable(Int32), `content_embedding` Array(Float32) DEFAULT [], `request_embedding` Array(Float32) DEFAULT [], `embedding_model` LowCardinality(Nullable(String)), `embedding_dim` Nullable(UInt16), `is_callout` Bool DEFAULT false, `callout_name` Nullable(String), `metadata_json` Nullable(String), `content_type` LowCardinality(Nullable(String)), `data_format` LowCardinality(Nullable(String)), `data_size_json` Nullable(Int32), `data_size_toon` Nullable(Int32), `data_token_savings_pct` Nullable(Float32), `toon_encoding_ms` Nullable(Float32), `toon_decode_attempted` Nullable(Bool), `toon_decode_success` Nullable(Bool), `data_rows` Nullable(Int32), `data_columns` Nullable(Int32), INDEX idx_session_id session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_caller_id caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_name cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_species_hash species_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 1, INDEX idx_node_type node_type TYPE set(100) GRANULARITY 1, INDEX idx_role role TYPE set(10) GRANULARITY 1, INDEX idx_is_winner is_winner TYPE set(2) GRANULARITY 1, INDEX idx_is_callout is_callout TYPE set(2) GRANULARITY 1, INDEX idx_cost cost TYPE minmax GRANULARITY 4, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_is_sql_udf is_sql_udf TYPE set(2) GRANULARITY 1, INDEX idx_udf_type udf_type TYPE set(10) GRANULARITY 1, INDEX idx_cache_hit cache_hit TYPE set(2) GRANULARITY 1, INDEX idx_source_column source_column_name TYPE bloom_filter GRANULARITY 1, INDEX idx_source_row source_row_index TYPE minmax GRANULARITY 4, INDEX idx_genus_hash genus_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_content_type content_type TYPE set(100) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, timestamp, trace_id) TTL timestamp + toIntervalYear(1) SETTINGS index_granularity = 8192;


-- Table: mv_session_summary
CREATE MATERIALIZED VIEW lars.mv_session_summary (`session_id` String, `cascade_id_key` String, `cascade_id` Nullable(String), `start_time` DateTime64(6), `end_time` DateTime64(6), `total_cost` Nullable(Float64), `total_tokens_in` Nullable(Int64), `total_tokens_out` Nullable(Int64), `total_tokens_reasoning` Nullable(Int64), `message_count` UInt64, `assistant_messages` UInt64, `tool_calls` UInt64, `reasoning_calls` UInt64) ENGINE = SummingMergeTree ORDER BY (session_id, cascade_id_key) SETTINGS index_granularity = 8192 AS SELECT session_id, coalesce(cascade_id, '') AS cascade_id_key, cascade_id, min(timestamp) AS start_time, max(timestamp) AS end_time, sum(cost) AS total_cost, sum(tokens_in) AS total_tokens_in, sum(tokens_out) AS total_tokens_out, sum(tokens_reasoning) AS total_tokens_reasoning, count() AS message_count, countIf(role = 'assistant') AS assistant_messages, countIf(node_type = 'tool_call') AS tool_calls, countIf(reasoning_enabled = true) AS reasoning_calls FROM lars.unified_logs GROUP BY session_id, cascade_id;


-- Table: mv_test_flaky_detection
CREATE MATERIALIZED VIEW lars.mv_test_flaky_detection (`test_id` String, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2), `test_group` String, `test_name` String, `total_runs` UInt64, `pass_count` UInt64, `fail_count` UInt64, `error_count` UInt64, `flakiness_score` Float64, `first_seen` DateTime64(3), `last_seen` DateTime64(3), `avg_pass_duration_ms` Float64, `avg_fail_duration_ms` Float64) ENGINE = AggregatingMergeTree ORDER BY (test_id, test_type) SETTINGS index_granularity = 8192 AS SELECT test_id, test_type, test_group, test_name, count() AS total_runs, countIf(status = 'passed') AS pass_count, countIf(status = 'failed') AS fail_count, countIf(status = 'error') AS error_count, if((countIf(status = 'passed') > 0) AND (countIf((status IN ('failed', 'error'))) > 0), (least(countIf(status = 'passed'), countIf((status IN ('failed', 'error')))) * 2.) / count(), 0) AS flakiness_score, min(started_at) AS first_seen, max(started_at) AS last_seen, avgIf(duration_ms, status = 'passed') AS avg_pass_duration_ms, avgIf(duration_ms, status = 'failed') AS avg_fail_duration_ms FROM lars.test_results GROUP BY test_id, test_type, test_group, test_name;


-- Table: mv_test_summary
CREATE MATERIALIZED VIEW lars.mv_test_summary (`date` Date, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2), `test_group` String, `status` Enum8('pending' = 0, 'running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'skipped' = 5), `test_count` UInt64, `total_duration_ms` Float64, `avg_duration_ms` Float64) ENGINE = SummingMergeTree ORDER BY (date, test_type, test_group) SETTINGS index_granularity = 8192 AS SELECT toDate(started_at) AS date, test_type, test_group, status, count() AS test_count, sum(duration_ms) AS total_duration_ms, avg(duration_ms) AS avg_duration_ms FROM lars.test_results GROUP BY date, test_type, test_group, status;


