-- Table: artifacts
CREATE TABLE IF NOT EXISTS artifacts (`id` String, `session_id` String, `cascade_id` String, `cell_name` String, `title` String, `artifact_type` String, `description` String, `html_content` String, `tags` String, `created_at` DateTime, `updated_at` DateTime) ENGINE = MergeTree ORDER BY (cascade_id, created_at) SETTINGS index_granularity = 8192;


-- Table: cascade_analytics
CREATE TABLE IF NOT EXISTS cascade_analytics (`session_id` String, `cascade_id` String, `genus_hash` String, `created_at` DateTime DEFAULT now(), `input_complexity_score` Float32, `input_category` LowCardinality(String), `input_fingerprint` String, `input_char_count` UInt32, `input_estimated_tokens` UInt32, `total_cost` Float64, `total_duration_ms` Float64, `total_tokens_in` UInt32, `total_tokens_out` UInt32, `total_tokens` UInt32, `message_count` UInt16, `cell_count` UInt8, `error_count` UInt8, `candidate_count` UInt8 DEFAULT 0, `winner_candidate_index` Nullable(Int8), `global_avg_cost` Float64, `global_avg_duration` Float64, `global_avg_tokens` Float64, `global_run_count` UInt32, `cluster_avg_cost` Float64, `cluster_stddev_cost` Float64, `cluster_avg_duration` Float64, `cluster_stddev_duration` Float64, `cluster_avg_tokens` Float64, `cluster_stddev_tokens` Float64, `cluster_run_count` UInt32, `genus_avg_cost` Nullable(Float64), `genus_avg_duration` Nullable(Float64), `genus_run_count` UInt16, `cost_z_score` Float32, `duration_z_score` Float32, `tokens_z_score` Float32, `is_cost_outlier` Bool, `is_duration_outlier` Bool, `is_tokens_outlier` Bool, `cost_per_message` Float32, `cost_per_token` Float32, `duration_per_message` Float32, `tokens_per_message` Float32, `models_used` Array(String), `primary_model` String, `model_switches` UInt8, `hour_of_day` UInt8, `day_of_week` UInt8, `is_weekend` Bool, `analyzed_at` DateTime DEFAULT now(), `analysis_version` UInt8 DEFAULT 1, `total_context_tokens` UInt32 DEFAULT 0, `total_new_tokens` UInt32 DEFAULT 0, `total_context_cost_estimated` Float64 DEFAULT 0, `total_new_cost_estimated` Float64 DEFAULT 0, `context_cost_pct` Float32 DEFAULT 0, `cells_with_context` UInt8 DEFAULT 0, `avg_cell_context_pct` Float32 DEFAULT 0, `max_cell_context_pct` Float32 DEFAULT 0, `take_count` UInt8 DEFAULT 0, `winner_take_index` Nullable(Int8), INDEX idx_genus genus_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_input_category input_category TYPE set(0) GRANULARITY 1, INDEX idx_cost_outlier is_cost_outlier TYPE set(0) GRANULARITY 1, INDEX idx_duration_outlier is_duration_outlier TYPE set(0) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (cascade_id, created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: cascade_sessions
CREATE TABLE IF NOT EXISTS cascade_sessions (`session_id` String, `cascade_id` String, `cascade_definition` String, `input_data` String, `config_path` String, `created_at` DateTime DEFAULT now(), `parent_session_id` String, `caller_id` String DEFAULT '', `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `depth` UInt8 DEFAULT 0, `output` String DEFAULT '' CODEC(ZSTD(3)), `genus_hash` String DEFAULT '' CODEC(ZSTD(1)), INDEX idx_caller_id caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_output_bloom output TYPE bloom_filter(0.01) GRANULARITY 1, INDEX idx_genus_hash genus_hash TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree ORDER BY (cascade_id, created_at) SETTINGS index_granularity = 8192;


-- Table: cascade_state
CREATE TABLE IF NOT EXISTS cascade_state (`session_id` String, `cascade_id` String, `key` String, `value` String, `cell_name` String, `created_at` DateTime DEFAULT now(), `value_type` String DEFAULT 'unknown') ENGINE = MergeTree ORDER BY (cascade_id, session_id, key, created_at) SETTINGS index_granularity = 8192;


-- Table: cascade_template_vectors
CREATE TABLE IF NOT EXISTS cascade_template_vectors (`cascade_id` String, `cascade_file` String, `description` String, `cell_count` UInt8, `run_count` UInt32 DEFAULT 0, `avg_cost` Nullable(Float64), `avg_duration_seconds` Nullable(Float64), `success_rate` Nullable(Float32), `description_embedding` Array(Float32), `instructions_embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, `last_updated` DateTime64(3) DEFAULT now64(3)) ENGINE = ReplacingMergeTree(last_updated) ORDER BY cascade_id SETTINGS index_granularity = 8192;


-- Table: cell_analytics
CREATE TABLE IF NOT EXISTS cell_analytics (`session_id` String, `cascade_id` String, `cell_name` String, `species_hash` String, `genus_hash` String, `created_at` DateTime DEFAULT now(), `cell_type` LowCardinality(String), `tool` Nullable(String), `model` Nullable(String), `cell_cost` Float64, `cell_duration_ms` Float64, `cell_tokens_in` UInt32, `cell_tokens_out` UInt32, `cell_tokens` UInt32, `message_count` UInt16, `turn_count` UInt8, `candidate_count` UInt8 DEFAULT 0, `error_occurred` Bool DEFAULT false, `global_cell_avg_cost` Float64, `global_cell_avg_duration` Float64, `global_cell_run_count` UInt32, `species_avg_cost` Float64, `species_stddev_cost` Float64, `species_avg_duration` Float64, `species_stddev_duration` Float64, `species_run_count` UInt32, `cost_z_score` Float32, `duration_z_score` Float32, `is_cost_outlier` Bool, `is_duration_outlier` Bool, `cost_per_turn` Float32, `cost_per_token` Float32, `tokens_per_turn` Float32, `duration_per_turn` Float32, `cascade_total_cost` Float64, `cascade_total_duration` Float64, `cell_cost_pct` Float32, `cell_duration_pct` Float32, `cell_index` UInt8, `is_first_cell` Bool, `is_last_cell` Bool, `analyzed_at` DateTime DEFAULT now(), `analysis_version` UInt8 DEFAULT 1, `context_token_count` UInt32 DEFAULT 0, `new_message_tokens` UInt32 DEFAULT 0, `context_message_count` UInt8 DEFAULT 0, `has_context` Bool DEFAULT false, `context_depth_avg` Float32 DEFAULT 0, `context_depth_max` UInt8 DEFAULT 0, `context_cost_estimated` Float64 DEFAULT 0, `new_message_cost_estimated` Float64 DEFAULT 0, `context_cost_pct` Float32 DEFAULT 0, `take_count` UInt8 DEFAULT 0, INDEX idx_species species_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_genus genus_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_name cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_cost_outlier is_cost_outlier TYPE set(0) GRANULARITY 1, INDEX idx_cell_duration_outlier is_duration_outlier TYPE set(0) GRANULARITY 1, INDEX idx_cell_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_has_context has_context TYPE set(0) GRANULARITY 1, INDEX idx_context_pct_high context_cost_pct TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (cascade_id, cell_name, created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: cell_context_breakdown
CREATE TABLE IF NOT EXISTS cell_context_breakdown (`session_id` String, `cascade_id` String, `cell_name` String, `cell_index` UInt8, `context_message_hash` String, `context_message_cell` String, `context_message_role` LowCardinality(String), `context_message_index` UInt8, `context_message_tokens` UInt32, `context_message_cost_estimated` Float64, `context_message_pct` Float32, `total_context_messages` UInt8, `total_context_tokens` UInt32, `total_cell_cost` Float64, `created_at` DateTime DEFAULT now(), `model_requested` String DEFAULT '', `candidate_index` Nullable(Int32), `relevance_score` Nullable(Float32), `relevance_reasoning` Nullable(String), `relevance_analysis_cost` Nullable(Float64), `relevance_analyzed_at` Nullable(DateTime), `relevance_analysis_session` Nullable(String), `take_index` Nullable(Int32), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_source_cell context_message_cell TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (session_id, cell_name, context_message_index) SETTINGS index_granularity = 8192;


-- Table: checkpoints
CREATE TABLE IF NOT EXISTS checkpoints (`id` String, `session_id` String, `cascade_id` String, `cell_name` String, `status` Enum8('pending' = 1, 'responded' = 2, 'timeout' = 3, 'cancelled' = 4), `created_at` DateTime64(3) DEFAULT now64(3), `responded_at` Nullable(DateTime64(3)), `timeout_at` Nullable(DateTime64(3)), `checkpoint_type` Enum8('cell_input' = 1, 'candidate_eval' = 2, 'free_text' = 3, 'choice' = 4, 'multi_choice' = 5, 'confirmation' = 6, 'rating' = 7, 'audible' = 8, 'decision' = 9, 'take_eval' = 10), `ui_spec` String DEFAULT '{}', `echo_snapshot` String DEFAULT '{}', `cell_output` Nullable(String), `trace_context` Nullable(String), `candidate_outputs` Nullable(String), `candidate_metadata` Nullable(String), `response` Nullable(String), `response_reasoning` Nullable(String), `response_confidence` Nullable(Float32), `winner_index` Nullable(Int32), `rankings` Nullable(String), `ratings` Nullable(String), `summary` Nullable(String), `take_outputs` Nullable(String), `take_metadata` Nullable(String), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: context_cards
CREATE TABLE IF NOT EXISTS context_cards (`session_id` String, `content_hash` String, `summary` String, `keywords` Array(String) DEFAULT [], `embedding` Array(Float32) DEFAULT [], `embedding_model` LowCardinality(Nullable(String)), `embedding_dim` Nullable(UInt16), `estimated_tokens` UInt32 DEFAULT 0, `role` LowCardinality(String), `cell_name` Nullable(String), `turn_number` Nullable(UInt32), `is_anchor` Bool DEFAULT false, `is_callout` Bool DEFAULT false, `callout_name` Nullable(String), `generated_at` DateTime64(3) DEFAULT now64(3), `generator_model` LowCardinality(Nullable(String)), `message_timestamp` DateTime64(3) DEFAULT now64(3), `cascade_id` Nullable(String), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_phase cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_content_hash content_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_is_anchor is_anchor TYPE set(2) GRANULARITY 1, INDEX idx_is_callout is_callout TYPE set(2) GRANULARITY 1, INDEX idx_keywords keywords TYPE bloom_filter GRANULARITY 1, INDEX idx_timestamp message_timestamp TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(generated_at) PARTITION BY toYYYYMM(message_timestamp) ORDER BY (session_id, content_hash) TTL message_timestamp + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: context_shadow_assessments
CREATE TABLE IF NOT EXISTS context_shadow_assessments (`assessment_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `session_id` String, `cascade_id` String, `target_cell_name` String, `target_cell_instructions` String, `source_cell_name` String, `content_hash` String, `message_role` LowCardinality(String), `content_preview` String, `estimated_tokens` UInt32, `message_turn_number` Nullable(UInt32), `heuristic_score` Float32, `heuristic_keyword_overlap` UInt16, `heuristic_recency_score` Float32, `heuristic_callout_boost` Float32, `heuristic_role_boost` Float32, `semantic_score` Nullable(Float32), `semantic_embedding_available` Bool DEFAULT false, `llm_selected` Bool DEFAULT false, `llm_reasoning` String DEFAULT '', `llm_model` String DEFAULT '', `llm_cost` Nullable(Float64), `composite_score` Float32, `would_include_heuristic` Bool, `would_include_semantic` Bool, `would_include_llm` Bool, `would_include_hybrid` Bool, `rank_heuristic` UInt16, `rank_semantic` Nullable(UInt16), `rank_composite` UInt16, `total_candidates` UInt16, `budget_total` UInt32, `cumulative_tokens_at_rank` UInt32, `would_fit_budget` Bool, `was_actually_included` Bool, `actual_mode` LowCardinality(String), `assessment_duration_ms` UInt32, `assessment_batch_id` String, `total_takes` UInt16 DEFAULT 0, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_target_cell target_cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_source_cell source_cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_content_hash content_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_batch assessment_batch_id TYPE bloom_filter GRANULARITY 1, INDEX idx_would_include_heuristic would_include_heuristic TYPE set(2) GRANULARITY 1, INDEX idx_would_include_llm would_include_llm TYPE set(2) GRANULARITY 1, INDEX idx_was_included was_actually_included TYPE set(2) GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_composite_score composite_score TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, target_cell_name, rank_composite) TTL timestamp + toIntervalDay(30) SETTINGS index_granularity = 8192;


-- Table: credit_snapshots
CREATE TABLE IF NOT EXISTS credit_snapshots (`timestamp` DateTime64(3) DEFAULT now64(3), `total_credits` Float64, `total_usage` Float64, `balance` Float64, `delta` Float64 DEFAULT 0, `source` LowCardinality(String), `cascade_id` Nullable(String), `session_id` Nullable(String), `burn_rate_1h` Nullable(Float64), `burn_rate_24h` Nullable(Float64), `burn_rate_7d` Nullable(Float64), INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_source source TYPE set(0) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY timestamp SETTINGS index_granularity = 8192;


-- Table: evaluations
CREATE TABLE IF NOT EXISTS evaluations (`id` UUID DEFAULT generateUUIDv4(), `created_at` DateTime64(3) DEFAULT now64(3), `session_id` String, `cell_name` String, `candidate_index` Int32, `evaluation_type` Enum8('rating' = 0, 'preference' = 1, 'flag' = 2), `rating` Nullable(Float32), `preferred_index` Nullable(Int32), `flag_reason` Nullable(String), `evaluator_id` Nullable(String), `evaluator_type` Enum8('human' = 0, 'model' = 1) DEFAULT 'human', `take_index` Int32 DEFAULT 0, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id) SETTINGS index_granularity = 8192;


-- Table: hf_spaces
CREATE TABLE IF NOT EXISTS hf_spaces (`space_id` String, `author` String, `space_name` String, `status` LowCardinality(String), `hardware` LowCardinality(Nullable(String)), `sdk` LowCardinality(Nullable(String)), `hourly_cost` Nullable(Float64), `is_billable` Bool DEFAULT false, `is_callable` Bool DEFAULT false, `endpoints_json` Nullable(String), `private` Bool DEFAULT false, `space_url` String DEFAULT '', `sleep_time` Nullable(Int32), `requested_hardware` Nullable(String), `first_seen` DateTime64(3) DEFAULT now64(3), `last_seen` DateTime64(3) DEFAULT now64(3), `last_refreshed` DateTime64(3) DEFAULT now64(3), `total_invocations` Nullable(UInt64) DEFAULT 0, `last_invocation` Nullable(DateTime64(3)), INDEX idx_space_id space_id TYPE bloom_filter GRANULARITY 1, INDEX idx_author author TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_hardware hardware TYPE set(50) GRANULARITY 1, INDEX idx_sdk sdk TYPE set(10) GRANULARITY 1, INDEX idx_is_billable is_billable TYPE set(2) GRANULARITY 1, INDEX idx_is_callable is_callable TYPE set(2) GRANULARITY 1) ENGINE = ReplacingMergeTree(last_refreshed) ORDER BY space_id SETTINGS index_granularity = 8192;


-- Table: intra_context_shadow_assessments
CREATE TABLE IF NOT EXISTS intra_context_shadow_assessments (`assessment_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `session_id` String, `cascade_id` String, `cell_name` String, `candidate_index` Nullable(Int16), `turn_number` UInt16, `is_loop_retry` Bool DEFAULT false, `config_window` UInt8, `config_mask_after` UInt8, `config_min_masked_size` UInt16, `config_compress_loops` Bool, `config_preserve_reasoning` Bool, `config_preserve_errors` Bool, `full_history_size` UInt16, `context_size` UInt16, `tokens_before` UInt32, `tokens_after` UInt32, `tokens_saved` UInt32, `compression_ratio` Float32, `messages_masked` UInt16, `messages_preserved` UInt16, `messages_truncated` UInt16, `message_breakdown` String DEFAULT '[]', `tokens_vs_baseline_saved` UInt32, `tokens_vs_baseline_pct` Float32, `actual_config_enabled` Bool, `actual_tokens_after` Nullable(UInt32), `differs_from_actual` Bool, `assessment_batch_id` String, `take_index` Nullable(Int16), INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_candidate candidate_index TYPE set(100) GRANULARITY 1, INDEX idx_turn turn_number TYPE set(100) GRANULARITY 1, INDEX idx_batch assessment_batch_id TYPE bloom_filter GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_compression compression_ratio TYPE minmax GRANULARITY 1, INDEX idx_window config_window TYPE set(20) GRANULARITY 1, INDEX idx_mask_after config_mask_after TYPE set(20) GRANULARITY 1, INDEX idx_take take_index TYPE set(100) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, cell_name, turn_number, config_window, config_mask_after) TTL timestamp + toIntervalDay(30) SETTINGS index_granularity = 8192;


-- Table: openrouter_models
CREATE TABLE IF NOT EXISTS openrouter_models (`model_id` String, `model_name` String, `provider` String, `description` String DEFAULT '', `context_length` UInt32 DEFAULT 0, `tier` LowCardinality(String), `popular` Bool DEFAULT false, `model_type` LowCardinality(String), `input_modalities` Array(String) DEFAULT [], `output_modalities` Array(String) DEFAULT [], `prompt_price` Float64 DEFAULT 0, `completion_price` Float64 DEFAULT 0, `is_active` Bool DEFAULT true, `last_verified` DateTime64(3) DEFAULT now64(3), `verification_error` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), `metadata_json` String DEFAULT '{}', `inference_type` LowCardinality(String) DEFAULT 'ON_DEMAND', `is_inference_profile` Bool DEFAULT false, INDEX idx_provider provider TYPE bloom_filter GRANULARITY 1, INDEX idx_tier tier TYPE set(10) GRANULARITY 1, INDEX idx_model_type model_type TYPE set(10) GRANULARITY 1, INDEX idx_is_active is_active TYPE set(2) GRANULARITY 1, INDEX idx_popular popular TYPE set(2) GRANULARITY 1, INDEX idx_inference_type inference_type TYPE set(10) GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) PARTITION BY model_type ORDER BY model_id SETTINGS index_granularity = 8192;


-- Table: output_tags
CREATE TABLE IF NOT EXISTS output_tags (`tag_id` UUID DEFAULT generateUUIDv4(), `tag_name` String, `tag_mode` Enum8('instance' = 1, 'dynamic' = 2), `message_id` Nullable(UUID), `cascade_id` Nullable(String), `cell_name` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `created_by` Nullable(String), `note` Nullable(String), INDEX idx_tag_name tag_name TYPE bloom_filter GRANULARITY 1, INDEX idx_message_id message_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_name cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_tag_mode tag_mode TYPE set(2) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (tag_name, created_at) SETTINGS index_granularity = 8192;


-- Table: prompt_lineage
CREATE TABLE IF NOT EXISTS prompt_lineage (`lineage_id` UUID DEFAULT generateUUIDv4(), `session_id` String, `cascade_id` String, `cell_name` String, `trace_id` String, `species_hash` String, `candidate_index` Int32, `generation` Int32 DEFAULT 0, `parent_lineage_id` Nullable(UUID), `mutation_type` LowCardinality(Nullable(String)), `mutation_template` Nullable(String), `full_prompt_text` String CODEC(ZSTD(3)), `prompt_hash` String, `prompt_embedding` Array(Float32) DEFAULT [], `embedding_model` LowCardinality(Nullable(String)), `embedding_dim` Nullable(UInt16), `bigrams` Array(String) DEFAULT [], `trigrams` Array(String) DEFAULT [], `quadgrams` Array(String) DEFAULT [], `fingerprint` Array(String) DEFAULT [], `is_winner` Bool DEFAULT false, `evaluator_score` Nullable(Float32), `cost` Nullable(Float64), `duration_ms` Nullable(Float64), `tokens_in` Nullable(Int32), `tokens_out` Nullable(Int32), `model` LowCardinality(Nullable(String)), `created_at` DateTime64(3) DEFAULT now64(3), `take_index` Int32 DEFAULT 0, INDEX idx_species species_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_trace trace_id TYPE bloom_filter GRANULARITY 1, INDEX idx_is_winner is_winner TYPE set(2) GRANULARITY 1, INDEX idx_generation generation TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (species_hash, cascade_id, cell_name, created_at) TTL created_at + toIntervalYear(1) SETTINGS index_granularity = 8192;


-- Table: rag_chunks
CREATE TABLE IF NOT EXISTS rag_chunks (`chunk_id` UUID DEFAULT generateUUIDv4(), `rag_id` String, `doc_id` String, `rel_path` String, `chunk_index` UInt32, `text` String, `char_start` UInt32, `char_end` UInt32, `start_line` UInt32, `end_line` UInt32, `file_hash` String, `created_at` DateTime64(3) DEFAULT now64(3), `embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, INDEX idx_rag_id rag_id TYPE bloom_filter GRANULARITY 1, INDEX idx_doc_id doc_id TYPE bloom_filter GRANULARITY 1, INDEX idx_rel_path rel_path TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY rag_id ORDER BY (rag_id, doc_id, chunk_index) SETTINGS index_granularity = 8192;


-- Table: rag_manifests
CREATE TABLE IF NOT EXISTS rag_manifests (`doc_id` String, `rag_id` String, `rel_path` String, `abs_path` String, `file_hash` String, `file_size` UInt64, `mtime` Float64, `chunk_count` UInt32, `content_hash` String, `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), INDEX idx_rag_id rag_id TYPE bloom_filter GRANULARITY 1, INDEX idx_rel_path rel_path TYPE bloom_filter GRANULARITY 1, INDEX idx_file_hash file_hash TYPE bloom_filter GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) ORDER BY (rag_id, rel_path) SETTINGS index_granularity = 8192;


-- Table: render_entries
CREATE VIEW rvbbit.render_entries (`session_id` String, `trace_id` String, `parent_id` Nullable(String), `timestamp_iso` String, `cascade_id` Nullable(String), `cell_name` Nullable(String), `content_type` Nullable(String), `content_json` Nullable(String), `metadata_json` Nullable(String), `candidate_index` Nullable(Int32), `role` LowCardinality(String), `node_type` LowCardinality(String), `screenshot_path` Nullable(String), `screenshot_url` Nullable(String), `checkpoint_id` Nullable(String)) AS SELECT session_id, trace_id, parent_id, timestamp_iso, cascade_id, cell_name, content_type, content_json, metadata_json, candidate_index, role, node_type, JSONExtractString(metadata_json, 'screenshot_path') AS screenshot_path, JSONExtractString(metadata_json, 'screenshot_url') AS screenshot_url, JSONExtractString(metadata_json, 'checkpoint_id') AS checkpoint_id FROM rvbbit.unified_logs WHERE content_type LIKE 'render:%' ORDER BY timestamp_iso DESC;


-- Table: request_decision_renders
CREATE VIEW rvbbit.request_decision_renders (`session_id` String, `trace_id` String, `timestamp_iso` String, `cascade_id` Nullable(String), `cell_name` Nullable(String), `ui_spec` Nullable(String), `screenshot_path` Nullable(String), `screenshot_url` Nullable(String), `checkpoint_id` Nullable(String), `question` Nullable(String), `severity` Nullable(String), `has_html` Nullable(UInt8), `options_count` Nullable(Int64), `candidate_index` Nullable(Int32)) AS SELECT session_id, trace_id, timestamp_iso, cascade_id, cell_name, content_json AS ui_spec, JSONExtractString(metadata_json, 'screenshot_path') AS screenshot_path, JSONExtractString(metadata_json, 'screenshot_url') AS screenshot_url, JSONExtractString(metadata_json, 'checkpoint_id') AS checkpoint_id, JSONExtractString(metadata_json, 'question') AS question, JSONExtractString(metadata_json, 'severity') AS severity, JSONExtractBool(metadata_json, 'has_html') AS has_html, JSONExtractInt(metadata_json, 'options_count') AS options_count, candidate_index FROM rvbbit.unified_logs WHERE content_type = 'render:request_decision' ORDER BY timestamp_iso DESC;


-- Table: research_sessions
CREATE TABLE IF NOT EXISTS research_sessions (`id` String, `original_session_id` String, `cascade_id` String, `title` String, `description` String, `created_at` DateTime, `frozen_at` DateTime, `status` String, `context_snapshot` String, `checkpoints_data` String, `entries_snapshot` String, `mermaid_graph` String, `screenshots` String, `total_cost` Float64, `total_turns` UInt32, `total_input_tokens` UInt64, `total_output_tokens` UInt64, `duration_seconds` Float64, `cells_visited` String, `tools_used` String, `tags` String, `parent_session_id` Nullable(String), `branch_point_checkpoint_id` Nullable(String), `updated_at` DateTime, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_original_session original_session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_frozen frozen_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(frozen_at) ORDER BY (cascade_id, frozen_at, id) SETTINGS index_granularity = 8192;


-- Table: rvbbit_embeddings
CREATE TABLE IF NOT EXISTS rvbbit_embeddings (`source_table` LowCardinality(String), `source_id` String, `text` String, `embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, `metadata` String DEFAULT '{}', `created_at` DateTime64(3) DEFAULT now64(3), INDEX idx_source_table source_table TYPE bloom_filter GRANULARITY 1, INDEX idx_source_id source_id TYPE bloom_filter GRANULARITY 1) ENGINE = ReplacingMergeTree(created_at) ORDER BY (source_table, source_id) SETTINGS index_granularity = 8192;


-- Table: schema_migrations
CREATE TABLE IF NOT EXISTS schema_migrations (`version` UInt32, `name` String, `description` String, `checksum` String, `executed_at` DateTime64(3) DEFAULT now64(3), `execution_time_ms` UInt32 DEFAULT 0, `status` Enum8('pending' = 1, 'applied' = 2, 'failed' = 3, 'rolled_back' = 4), `author` Nullable(String), `migration_date` Nullable(String), `always_run` Bool DEFAULT false, `error_message` Nullable(String), INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_executed executed_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(executed_at) ORDER BY version SETTINGS index_granularity = 8192;


-- Table: semantic_sql_cache
CREATE TABLE IF NOT EXISTS semantic_sql_cache (`cache_key` String, `function_name` LowCardinality(String), `args_json` String CODEC(ZSTD(3)), `args_preview` String DEFAULT '', `result` String CODEC(ZSTD(3)), `result_type` LowCardinality(String), `created_at` DateTime64(3) DEFAULT now64(), `expires_at` DateTime64(3) DEFAULT toDateTime64('2100-01-01 00:00:00', 3), `ttl_seconds` UInt32 DEFAULT 0, `hit_count` UInt64 DEFAULT 1, `last_hit_at` DateTime64(3) DEFAULT now64(), `result_bytes` UInt32 DEFAULT 0, `first_session_id` String DEFAULT '', `first_caller_id` String DEFAULT '', INDEX idx_function function_name TYPE set(100) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1, INDEX idx_expires expires_at TYPE minmax GRANULARITY 1, INDEX idx_last_hit last_hit_at TYPE minmax GRANULARITY 1, INDEX idx_hit_count hit_count TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(last_hit_at) ORDER BY cache_key TTL expires_at SETTINGS index_granularity = 8192;


-- Table: session_state
CREATE TABLE IF NOT EXISTS session_state (`session_id` String, `cascade_id` String, `parent_session_id` Nullable(String), `caller_id` String DEFAULT '', `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `status` Enum8('starting' = 1, 'running' = 2, 'blocked' = 3, 'completed' = 4, 'error' = 5, 'cancelled' = 6, 'orphaned' = 7), `current_cell` Nullable(String), `depth` UInt8 DEFAULT 0, `blocked_type` Nullable(Enum8('signal' = 1, 'hitl' = 2, 'sensor' = 3, 'approval' = 4, 'checkpoint' = 5, 'decision' = 6)), `blocked_on` Nullable(String), `blocked_description` Nullable(String), `blocked_timeout_at` Nullable(DateTime64(3)), `heartbeat_at` DateTime64(3) DEFAULT now64(3), `heartbeat_lease_seconds` UInt16 DEFAULT 60, `cancel_requested` Bool DEFAULT false, `cancel_reason` Nullable(String), `cancelled_at` Nullable(DateTime64(3)), `error_message` Nullable(String), `error_cell` Nullable(String), `last_checkpoint_id` Nullable(String), `resumable` Bool DEFAULT false, `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `updated_at` DateTime64(3) DEFAULT now64(3), `metadata_json` String DEFAULT '{}', INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_parent parent_session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_heartbeat heartbeat_at TYPE minmax GRANULARITY 1, INDEX idx_started started_at TYPE minmax GRANULARITY 1, INDEX idx_caller_id caller_id TYPE bloom_filter GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) PARTITION BY toYYYYMM(started_at) ORDER BY session_id SETTINGS index_granularity = 8192;


-- Table: signals
CREATE TABLE IF NOT EXISTS signals (`signal_id` String, `signal_name` String, `status` Enum8('waiting' = 1, 'fired' = 2, 'timeout' = 3, 'cancelled' = 4), `created_at` DateTime64(3) DEFAULT now64(3), `fired_at` Nullable(DateTime64(3)), `timeout_at` Nullable(DateTime64(3)), `session_id` String, `cascade_id` String, `cell_name` Nullable(String), `callback_host` Nullable(String), `callback_port` Nullable(UInt16), `callback_token` Nullable(String), `payload_json` Nullable(String), `target_cell` Nullable(String), `inputs_json` Nullable(String), `description` Nullable(String), `source` Nullable(String), `metadata_json` Nullable(String), INDEX idx_signal_name signal_name TYPE bloom_filter GRANULARITY 1, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(created_at) PARTITION BY toYYYYMM(created_at) ORDER BY signal_id SETTINGS index_granularity = 8192;


-- Table: sql_cascade_executions
CREATE TABLE IF NOT EXISTS sql_cascade_executions (`caller_id` String, `session_id` String, `cascade_id` String, `cascade_path` String, `inputs_summary` String DEFAULT '', `timestamp` DateTime64(3) DEFAULT now64(3), INDEX idx_caller caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (caller_id, timestamp) TTL timestamp + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: sql_query_log
CREATE TABLE IF NOT EXISTS sql_query_log (`query_id` UUID DEFAULT generateUUIDv4(), `caller_id` String, `query_raw` String CODEC(ZSTD(3)), `query_fingerprint` String, `query_template` String CODEC(ZSTD(3)), `query_type` LowCardinality(String), `udf_types` Array(String) DEFAULT [], `udf_count` UInt16 DEFAULT 0, `cascade_paths` Array(String) DEFAULT [], `cascade_count` UInt16 DEFAULT 0, `started_at` DateTime64(6), `completed_at` Nullable(DateTime64(6)), `duration_ms` Nullable(Float64), `status` LowCardinality(String), `rows_input` Nullable(Int32), `rows_output` Nullable(Int32), `total_cost` Nullable(Float64), `total_tokens_in` Nullable(Int64), `total_tokens_out` Nullable(Int64), `llm_calls_count` UInt32 DEFAULT 0, `cache_hits` UInt32 DEFAULT 0, `cache_misses` UInt32 DEFAULT 0, `error_message` Nullable(String), `result_db_name` Nullable(String), `result_db_path` Nullable(String), `result_schema` Nullable(String), `result_table` Nullable(String), `protocol` LowCardinality(String), `timestamp` DateTime64(6) DEFAULT now64(6), INDEX idx_caller caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_fingerprint query_fingerprint TYPE bloom_filter GRANULARITY 1, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (timestamp, caller_id) TTL timestamp + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: tag_definitions
CREATE TABLE IF NOT EXISTS tag_definitions (`tag_name` String, `tag_color` String DEFAULT '#a78bfa', `description` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(3), `updated_at` DateTime64(3) DEFAULT now64(3), INDEX idx_created created_at TYPE minmax GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) ORDER BY tag_name SETTINGS index_granularity = 8192;


-- Table: test_events
CREATE TABLE IF NOT EXISTS test_events (`event_id` String DEFAULT generateUUIDv4(), `event_type` String, `severity` String DEFAULT 'info', `message` String, `value` Float64 DEFAULT 0, `created_at` DateTime64(3) DEFAULT now64()) ENGINE = MergeTree ORDER BY (created_at, event_id) SETTINGS index_granularity = 8192;


-- Table: test_results
CREATE TABLE IF NOT EXISTS test_results (`run_id` String, `test_id` String, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2, 'visual_regression' = 3), `test_group` String, `test_name` String, `test_description` String DEFAULT '', `source_file` String DEFAULT '', `source_line` UInt32 DEFAULT 0, `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `duration_ms` Float64 DEFAULT 0, `status` Enum8('pending' = 0, 'running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'skipped' = 5), `sql_query` String DEFAULT '' CODEC(ZSTD(3)), `expected_value` String DEFAULT '' CODEC(ZSTD(3)), `actual_value` String DEFAULT '' CODEC(ZSTD(3)), `expect_type` String DEFAULT '', `validation_mode` String DEFAULT '', `cells_validated` UInt32 DEFAULT 0, `contracts_checked` UInt32 DEFAULT 0, `contracts_passed` UInt32 DEFAULT 0, `anchors_checked` UInt32 DEFAULT 0, `anchors_passed` UInt32 DEFAULT 0, `judge_score` Nullable(Float32), `judge_reasoning` String DEFAULT '' CODEC(ZSTD(3)), `failure_type` String DEFAULT '', `failure_message` String DEFAULT '' CODEC(ZSTD(3)), `failure_diff` String DEFAULT '' CODEC(ZSTD(3)), `error_type` String DEFAULT '', `error_message` String DEFAULT '' CODEC(ZSTD(3)), `error_traceback` String DEFAULT '' CODEC(ZSTD(3)), `session_id` String DEFAULT '', `previous_session_id` String DEFAULT '', `overall_score` Float32 DEFAULT 0, `is_baseline` UInt8 DEFAULT 0, `screenshots_compared` String DEFAULT '', INDEX idx_run_id run_id TYPE bloom_filter GRANULARITY 1, INDEX idx_test_type test_type TYPE set(10) GRANULARITY 1, INDEX idx_test_group test_group TYPE bloom_filter GRANULARITY 1, INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_source_file source_file TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(started_at) ORDER BY (run_id, test_type, test_group, test_id) SETTINGS index_granularity = 8192;


-- Table: test_runs
CREATE TABLE IF NOT EXISTS test_runs (`run_id` String, `run_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2, 'mixed' = 3), `started_at` DateTime64(3) DEFAULT now64(3), `completed_at` Nullable(DateTime64(3)), `duration_ms` Float64 DEFAULT 0, `status` Enum8('running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'cancelled' = 5), `total_tests` UInt32 DEFAULT 0, `passed_tests` UInt32 DEFAULT 0, `failed_tests` UInt32 DEFAULT 0, `skipped_tests` UInt32 DEFAULT 0, `error_tests` UInt32 DEFAULT 0, `trigger` Enum8('manual' = 1, 'ci' = 2, 'scheduled' = 3, 'hook' = 4, 'api' = 5) DEFAULT 'manual', `trigger_source` String DEFAULT '', `git_commit` String DEFAULT '', `git_branch` String DEFAULT '', `git_dirty` UInt8 DEFAULT 0, `test_filter` String DEFAULT '', `run_options` String DEFAULT '', `error_message` String DEFAULT '', `error_traceback` String DEFAULT '' CODEC(ZSTD(3)), INDEX idx_status status TYPE set(10) GRANULARITY 1, INDEX idx_run_type run_type TYPE set(10) GRANULARITY 1, INDEX idx_trigger trigger TYPE set(10) GRANULARITY 1, INDEX idx_git_commit git_commit TYPE bloom_filter GRANULARITY 1, INDEX idx_started_at started_at TYPE minmax GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(started_at) ORDER BY (started_at, run_id) SETTINGS index_granularity = 8192;


-- Table: tool_manifest_vectors
CREATE TABLE IF NOT EXISTS tool_manifest_vectors (`tool_name` String, `tool_type` Enum8('function' = 0, 'cascade' = 1, 'memory' = 2, 'validator' = 3), `tool_description` String, `schema_json` Nullable(String), `source_path` Nullable(String), `embedding` Array(Float32), `embedding_model` LowCardinality(String), `embedding_dim` UInt16, `last_updated` DateTime64(3) DEFAULT now64(3), INDEX idx_tool_type tool_type TYPE set(10) GRANULARITY 1) ENGINE = ReplacingMergeTree(last_updated) ORDER BY tool_name SETTINGS index_granularity = 8192;


-- Table: training_annotations
CREATE TABLE IF NOT EXISTS training_annotations (`trace_id` String, `trainable` Bool DEFAULT false, `verified` Bool DEFAULT false, `confidence` Nullable(Float32) DEFAULT NULL, `notes` String DEFAULT '', `tags` Array(String) DEFAULT [], `annotated_at` DateTime64(3) DEFAULT now64(3), `annotated_by` String DEFAULT 'human', INDEX idx_trainable trainable TYPE set(0) GRANULARITY 1, INDEX idx_verified verified TYPE set(0) GRANULARITY 1) ENGINE = ReplacingMergeTree(annotated_at) ORDER BY trace_id SETTINGS index_granularity = 8192;


-- Table: training_examples_mv
CREATE VIEW rvbbit.training_examples_mv (`trace_id` String, `session_id` String, `timestamp` DateTime64(6), `cascade_id` Nullable(String), `cell_name` Nullable(String), `user_input` Nullable(String), `assistant_output` String, `model` Nullable(String), `cost` Nullable(Float64), `tokens_in` Nullable(Int32), `tokens_out` Nullable(Int32), `duration_ms` Nullable(Float64), `caller_id` String, `node_type` LowCardinality(String), `role` LowCardinality(String)) AS SELECT trace_id, session_id, timestamp, cascade_id, cell_name, if((full_request_json IS NOT NULL) AND (full_request_json != ''), substring(full_request_json, 1, 2000), '') AS user_input, coalesce(content_json, '') AS assistant_output, model, cost, tokens_in, tokens_out, duration_ms, caller_id, node_type, role FROM rvbbit.unified_logs WHERE (role = 'assistant') AND (cascade_id != '') AND (content_json IS NOT NULL) AND (content_json != '');


-- Table: training_examples_with_annotations
CREATE VIEW rvbbit.training_examples_with_annotations (`trace_id` String, `session_id` String, `timestamp` DateTime64(6), `cascade_id` Nullable(String), `cell_name` Nullable(String), `user_input` Nullable(String), `assistant_output` String, `model` Nullable(String), `cost` Nullable(Float64), `tokens_in` Nullable(Int32), `tokens_out` Nullable(Int32), `duration_ms` Nullable(Float64), `caller_id` String, `node_type` LowCardinality(String), `role` LowCardinality(String), `trainable` Bool, `verified` Bool, `confidence` Nullable(Float32), `notes` String, `tags` Array(String), `annotated_at` DateTime64(3), `annotated_by` String) AS SELECT mv.*, coalesce(ta.trainable, false) AS trainable, coalesce(ta.verified, false) AS verified, ta.confidence AS confidence, ta.notes, ta.tags, ta.annotated_at, ta.annotated_by FROM rvbbit.training_examples_mv AS mv LEFT JOIN rvbbit.training_annotations AS ta ON mv.trace_id = ta.trace_id;


-- Table: training_preferences
CREATE TABLE IF NOT EXISTS training_preferences (`id` String, `created_at` DateTime64(3) DEFAULT now64(3), `session_id` String, `cascade_id` String, `cell_name` String, `checkpoint_id` String, `prompt_text` String, `prompt_messages` String, `system_prompt` String, `preference_type` Enum8('pairwise' = 1, 'ranking' = 2, 'rating' = 3), `chosen_response` String, `rejected_response` String, `chosen_model` Nullable(String), `rejected_model` Nullable(String), `chosen_cost` Nullable(Float64), `rejected_cost` Nullable(Float64), `chosen_tokens` Nullable(Int32), `rejected_tokens` Nullable(Int32), `margin` Float32 DEFAULT 1., `all_responses` Nullable(String), `ranking_order` Nullable(String), `num_responses` Nullable(Int32), `ratings_json` Nullable(String), `rating_scale_max` Nullable(Int32), `human_reasoning` Nullable(String), `human_confidence` Nullable(Float32), `chosen_mutation` Nullable(String), `rejected_mutation` Nullable(String), `model_comparison` Bool DEFAULT false, `reasoning_quality` Nullable(Float32), `is_tie` Bool DEFAULT false, `is_rejection` Bool DEFAULT false, INDEX idx_session session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_pref_type preference_type TYPE set(10) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(created_at) ORDER BY (created_at, session_id, preference_type) SETTINGS index_granularity = 8192;


-- Table: training_stats_by_cascade
CREATE VIEW rvbbit.training_stats_by_cascade (`cascade_id` Nullable(String), `cell_name` Nullable(String), `trainable_count` UInt64, `verified_count` UInt64, `avg_confidence` Nullable(Float64), `total_executions` UInt64) AS SELECT cascade_id, cell_name, countIf(trainable = true) AS trainable_count, countIf(verified = true) AS verified_count, avg(confidence) AS avg_confidence, count() AS total_executions FROM rvbbit.training_examples_with_annotations GROUP BY cascade_id, cell_name ORDER BY trainable_count DESC;


-- Table: ui_sql_log
CREATE TABLE IF NOT EXISTS ui_sql_log (`timestamp` DateTime64(6) DEFAULT now64(6), `query_type` LowCardinality(String), `sql_preview` String, `sql_hash` String, `duration_ms` Float64, `rows_returned` Nullable(Int32), `rows_affected` Nullable(Int32), `source` LowCardinality(String) DEFAULT 'unknown', `caller` Nullable(String), `request_path` Nullable(String), `page_ref` Nullable(String), `success` Bool DEFAULT true, `error_message` Nullable(String), INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_duration duration_ms TYPE minmax GRANULARITY 1, INDEX idx_query_type query_type TYPE set(20) GRANULARITY 1, INDEX idx_sql_hash sql_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_source source TYPE set(20) GRANULARITY 1, INDEX idx_success success TYPE set(2) GRANULARITY 1, INDEX idx_page_ref page_ref TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMMDD(timestamp) ORDER BY (timestamp, query_type) TTL timestamp + toIntervalDay(7) SETTINGS index_granularity = 8192;


-- Table: unified_logs
CREATE TABLE IF NOT EXISTS unified_logs (`message_id` UUID DEFAULT generateUUIDv4(), `timestamp` DateTime64(6) DEFAULT now64(6), `timestamp_iso` String, `session_id` String, `trace_id` String, `parent_id` Nullable(String), `parent_session_id` Nullable(String), `parent_message_id` Nullable(String), `caller_id` String DEFAULT '', `is_sql_udf` Bool DEFAULT false, `udf_type` LowCardinality(Nullable(String)), `cache_hit` Bool DEFAULT false, `input_hash` Nullable(String), `invocation_metadata_json` String DEFAULT '{}' CODEC(ZSTD(3)), `node_type` LowCardinality(String), `role` LowCardinality(String), `depth` UInt8 DEFAULT 0, `semantic_actor` LowCardinality(Nullable(String)), `semantic_purpose` LowCardinality(Nullable(String)), `candidate_index` Nullable(Int32), `is_winner` Nullable(Bool), `reforge_step` Nullable(Int32), `winning_candidate_index` Nullable(Int32), `attempt_number` Nullable(Int32), `turn_number` Nullable(Int32), `mutation_applied` Nullable(String), `mutation_type` LowCardinality(Nullable(String)), `mutation_template` Nullable(String), `cascade_id` Nullable(String), `cascade_file` Nullable(String), `cascade_json` Nullable(String) CODEC(ZSTD(3)), `cell_name` Nullable(String), `cell_json` Nullable(String) CODEC(ZSTD(3)), `species_hash` Nullable(String), `genus_hash` Nullable(String), `model` Nullable(String), `model_requested` Nullable(String), `request_id` Nullable(String), `provider` LowCardinality(Nullable(String)), `duration_ms` Nullable(Float64), `tokens_in` Nullable(Int32), `tokens_out` Nullable(Int32), `total_tokens` Nullable(Int32), `cost` Nullable(Float64), `reasoning_enabled` Nullable(Bool), `reasoning_effort` LowCardinality(Nullable(String)), `reasoning_max_tokens` Nullable(Int32), `tokens_reasoning` Nullable(Int32), `content_json` Nullable(String), `full_request_json` Nullable(String) CODEC(ZSTD(3)), `full_response_json` Nullable(String) CODEC(ZSTD(3)), `tool_calls_json` Nullable(String), `images_json` Nullable(String), `has_images` Bool DEFAULT false, `has_base64` Bool DEFAULT false, `has_base64_stripped` Bool DEFAULT false, `audio_json` Nullable(String), `has_audio` Bool DEFAULT false, `mermaid_content` Nullable(String), `content_hash` Nullable(String), `context_hashes` Array(String) DEFAULT [], `estimated_tokens` Nullable(Int32), `content_embedding` Array(Float32) DEFAULT [], `request_embedding` Array(Float32) DEFAULT [], `embedding_model` LowCardinality(Nullable(String)), `embedding_dim` Nullable(UInt16), `is_callout` Bool DEFAULT false, `callout_name` Nullable(String), `metadata_json` Nullable(String), `budget_strategy` LowCardinality(Nullable(String)), `budget_tokens_before` Nullable(Int32), `budget_tokens_after` Nullable(Int32), `budget_tokens_limit` Nullable(Int32), `budget_tokens_pruned` Nullable(Int32), `budget_percentage` Nullable(Float32), `content_type` Nullable(String) DEFAULT 'text', `videos_json` Nullable(String), `has_videos` Bool DEFAULT false, `data_format` String DEFAULT '' COMMENT 'Data encoding format used: toon, json, or empty', `data_size_json` Nullable(UInt32) COMMENT 'Data size in characters (JSON baseline for comparison)', `data_size_toon` Nullable(UInt32) COMMENT 'Data size in characters (TOON encoded, if used)', `data_token_savings_pct` Nullable(Float32) COMMENT 'Token savings percentage (TOON vs JSON baseline)', `toon_encoding_ms` Nullable(Float32) COMMENT 'Time to encode data as TOON in milliseconds', `toon_decode_attempted` Nullable(Bool) COMMENT 'Whether TOON decoding was attempted on LLM response', `toon_decode_success` Nullable(Bool) COMMENT 'Whether TOON decoding succeeded (if attempted)', `data_rows` Nullable(UInt32) COMMENT 'Number of rows in detected JSON array payloads', `data_columns` Nullable(UInt32) COMMENT 'Number of columns in detected JSON array of objects', `source_column_name` Nullable(String) COMMENT 'Column name being processed by semantic SQL operator', `source_row_index` Nullable(Int64) COMMENT 'Row index (0-based) in source SQL query', `source_table_name` Nullable(String) COMMENT 'Source table name if known from SQL context', `take_index` Nullable(Int32), `winning_take_index` Nullable(Int32), INDEX idx_session_id session_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cascade_id cascade_id TYPE bloom_filter GRANULARITY 1, INDEX idx_cell_name cell_name TYPE bloom_filter GRANULARITY 1, INDEX idx_species_hash species_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 1, INDEX idx_node_type node_type TYPE set(100) GRANULARITY 1, INDEX idx_role role TYPE set(10) GRANULARITY 1, INDEX idx_is_winner is_winner TYPE set(2) GRANULARITY 1, INDEX idx_is_callout is_callout TYPE set(2) GRANULARITY 1, INDEX idx_cost cost TYPE minmax GRANULARITY 4, INDEX idx_timestamp timestamp TYPE minmax GRANULARITY 1, INDEX idx_caller_id caller_id TYPE bloom_filter GRANULARITY 1, INDEX idx_genus_unified genus_hash TYPE bloom_filter GRANULARITY 1, INDEX idx_content_type content_type TYPE bloom_filter GRANULARITY 1, INDEX idx_source_column source_column_name TYPE bloom_filter GRANULARITY 1, INDEX idx_source_row source_row_index TYPE minmax GRANULARITY 4, INDEX idx_take_index take_index TYPE set(100) GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(timestamp) ORDER BY (session_id, timestamp, trace_id) TTL timestamp + toIntervalYear(1) SETTINGS index_granularity = 8192;


-- Table: watch_executions
CREATE TABLE IF NOT EXISTS watch_executions (`execution_id` String, `watch_id` String, `watch_name` String, `triggered_at` DateTime64(3), `completed_at` Nullable(DateTime64(3)), `duration_ms` Nullable(UInt32), `row_count` UInt32, `result_hash` String, `result_preview` String, `action_type` Enum8('cascade' = 1, 'signal' = 2, 'sql' = 3), `cascade_session_id` Nullable(String), `signal_fired` Nullable(String), `status` Enum8('triggered' = 1, 'running' = 2, 'success' = 3, 'failed' = 4, 'skipped' = 5), `error_message` Nullable(String), `cost` Nullable(Decimal(18, 6)), `tokens_in` Nullable(UInt32), `tokens_out` Nullable(UInt32), INDEX idx_exec_watch_id watch_id TYPE bloom_filter GRANULARITY 1, INDEX idx_exec_status status TYPE set(8) GRANULARITY 1, INDEX idx_exec_cascade_session cascade_session_id TYPE bloom_filter GRANULARITY 1) ENGINE = MergeTree PARTITION BY toYYYYMM(triggered_at) ORDER BY (watch_name, triggered_at) TTL triggered_at + toIntervalDay(90) SETTINGS index_granularity = 8192;


-- Table: watches
CREATE TABLE IF NOT EXISTS watches (`watch_id` String, `name` String, `query` String, `action_type` Enum8('cascade' = 1, 'signal' = 2, 'sql' = 3), `action_spec` String, `poll_interval_seconds` UInt32 DEFAULT 300, `enabled` Bool DEFAULT true, `last_result_hash` Nullable(String), `last_checked_at` Nullable(DateTime64(3)), `last_triggered_at` Nullable(DateTime64(3)), `trigger_count` UInt64 DEFAULT 0, `consecutive_errors` UInt32 DEFAULT 0, `last_error` Nullable(String), `created_at` DateTime64(3) DEFAULT now64(), `updated_at` DateTime64(3) DEFAULT now64(), `created_by` String DEFAULT '', `description` String DEFAULT '', `inputs_template` String DEFAULT '{"trigger_rows": {{ rows | tojson }}, "watch_name": "{{ watch_name }}"}', INDEX idx_watch_name name TYPE bloom_filter GRANULARITY 1, INDEX idx_watch_enabled enabled TYPE set(2) GRANULARITY 1) ENGINE = ReplacingMergeTree(updated_at) ORDER BY watch_id SETTINGS index_granularity = 8192;


-- Table: mv_session_summary
CREATE MATERIALIZED VIEW rvbbit.mv_session_summary (`session_id` String, `cascade_id_key` String, `cascade_id` Nullable(String), `start_time` DateTime64(6), `end_time` DateTime64(6), `total_cost` Nullable(Float64), `total_tokens_in` Nullable(Int64), `total_tokens_out` Nullable(Int64), `total_tokens_reasoning` Nullable(Int64), `message_count` UInt64, `assistant_messages` UInt64, `tool_calls` UInt64, `reasoning_calls` UInt64) ENGINE = SummingMergeTree ORDER BY (session_id, cascade_id_key) SETTINGS index_granularity = 8192 AS SELECT session_id, coalesce(cascade_id, '') AS cascade_id_key, cascade_id, min(timestamp) AS start_time, max(timestamp) AS end_time, sum(cost) AS total_cost, sum(tokens_in) AS total_tokens_in, sum(tokens_out) AS total_tokens_out, sum(tokens_reasoning) AS total_tokens_reasoning, count() AS message_count, countIf(role = 'assistant') AS assistant_messages, countIf(node_type = 'tool_call') AS tool_calls, countIf(reasoning_enabled = true) AS reasoning_calls FROM rvbbit.unified_logs GROUP BY session_id, cascade_id;


-- Table: mv_sql_query_costs
CREATE MATERIALIZED VIEW rvbbit.mv_sql_query_costs (`caller_id` String, `total_cost` Nullable(Float64), `total_tokens_in` Nullable(Int64), `total_tokens_out` Nullable(Int64), `llm_calls_count` UInt64) ENGINE = SummingMergeTree ORDER BY caller_id SETTINGS index_granularity = 8192 AS SELECT caller_id, sum(cost) AS total_cost, sum(tokens_in) AS total_tokens_in, sum(tokens_out) AS total_tokens_out, count() AS llm_calls_count FROM rvbbit.unified_logs WHERE (caller_id != '') AND (caller_id LIKE 'sql-%') AND (cost IS NOT NULL) GROUP BY caller_id;


-- Table: mv_test_flaky_detection
CREATE MATERIALIZED VIEW rvbbit.mv_test_flaky_detection (`test_id` String, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2), `test_group` String, `test_name` String, `total_runs` UInt64, `pass_count` UInt64, `fail_count` UInt64, `error_count` UInt64, `flakiness_score` Float64, `first_seen` DateTime64(3), `last_seen` DateTime64(3), `avg_pass_duration_ms` Float64, `avg_fail_duration_ms` Float64) ENGINE = AggregatingMergeTree ORDER BY (test_id, test_type) SETTINGS index_granularity = 8192 AS SELECT test_id, test_type, test_group, test_name, count() AS total_runs, countIf(status = 'passed') AS pass_count, countIf(status = 'failed') AS fail_count, countIf(status = 'error') AS error_count, if((countIf(status = 'passed') > 0) AND (countIf(status IN ('failed', 'error')) > 0), (least(countIf(status = 'passed'), countIf(status IN ('failed', 'error'))) * 2.) / count(), 0) AS flakiness_score, min(started_at) AS first_seen, max(started_at) AS last_seen, avgIf(duration_ms, status = 'passed') AS avg_pass_duration_ms, avgIf(duration_ms, status = 'failed') AS avg_fail_duration_ms FROM rvbbit.test_results GROUP BY test_id, test_type, test_group, test_name;


-- Table: mv_test_summary
CREATE MATERIALIZED VIEW rvbbit.mv_test_summary (`date` Date, `test_type` Enum8('semantic_sql' = 1, 'cascade_snapshot' = 2), `test_group` String, `status` Enum8('pending' = 0, 'running' = 1, 'passed' = 2, 'failed' = 3, 'error' = 4, 'skipped' = 5), `test_count` UInt64, `total_duration_ms` Float64, `avg_duration_ms` Float64) ENGINE = SummingMergeTree ORDER BY (date, test_type, test_group) SETTINGS index_granularity = 8192 AS SELECT toDate(started_at) AS date, test_type, test_group, status, count() AS test_count, sum(duration_ms) AS total_duration_ms, avg(duration_ms) AS avg_duration_ms FROM rvbbit.test_results GROUP BY date, test_type, test_group, status;


-- Table: mv_watch_stats
CREATE MATERIALIZED VIEW rvbbit.mv_watch_stats (`watch_name` String, `execution_count` UInt64, `success_count` UInt64, `failed_count` UInt64, `total_cost` Decimal(38, 6), `total_tokens_in` UInt64, `total_tokens_out` UInt64, `avg_duration_ms` Nullable(Float64), `last_triggered_at` DateTime64(3)) ENGINE = SummingMergeTree ORDER BY watch_name SETTINGS index_granularity = 8192 AS SELECT watch_name, count() AS execution_count, countIf(status = 'success') AS success_count, countIf(status = 'failed') AS failed_count, sum(coalesce(cost, 0)) AS total_cost, sum(coalesce(tokens_in, 0)) AS total_tokens_in, sum(coalesce(tokens_out, 0)) AS total_tokens_out, avg(duration_ms) AS avg_duration_ms, max(triggered_at) AS last_triggered_at FROM rvbbit.watch_executions GROUP BY watch_name;


-- Table: species_stats
CREATE MATERIALIZED VIEW rvbbit.species_stats (`species_hash` String, `cascade_id` String, `cell_name` String, `total_prompts` UInt64, `winner_count` UInt64, `loser_count` UInt64, `session_count` UInt64, `model_count` UInt64, `total_cost` Nullable(Float64), `avg_cost` Nullable(Float64), `avg_winner_cost` Nullable(Float64), `avg_loser_cost` Nullable(Float64), `max_generation` Int32, `base_prompts` UInt64, `evolved_prompts` UInt64, `first_seen` DateTime64(3), `last_seen` DateTime64(3)) ENGINE = SummingMergeTree ORDER BY (species_hash, cascade_id, cell_name) SETTINGS index_granularity = 8192 AS SELECT species_hash, cascade_id, cell_name, count() AS total_prompts, countIf(is_winner = true) AS winner_count, countIf((is_winner = false) OR (is_winner IS NULL)) AS loser_count, countDistinct(session_id) AS session_count, countDistinct(model) AS model_count, sum(cost) AS total_cost, avg(cost) AS avg_cost, avgIf(cost, is_winner = true) AS avg_winner_cost, avgIf(cost, is_winner = false) AS avg_loser_cost, max(generation) AS max_generation, countIf(generation = 0) AS base_prompts, countIf(generation > 0) AS evolved_prompts, min(created_at) AS first_seen, max(created_at) AS last_seen FROM rvbbit.prompt_lineage GROUP BY species_hash, cascade_id, cell_name;


