#!/usr/bin/env bash
set -euo pipefail

# Simple ElevenLabs "say" script for Omarchy / Hyprland
# Requirements:
#   - curl
#   - mpv OR ffplay
#   - notify-send (optional but recommended)

API_KEY="${ELEVENLABS_API_KEY:-}"
VOICE_ID="${ELEVENLABS_VOICE_ID:-}"
MODEL_ID="${ELEVENLABS_MODEL_ID:-eleven_v3}"  # default model

if [[ -z "$API_KEY" || -z "$VOICE_ID" ]]; then
  echo "Error: ELEVENLABS_API_KEY and ELEVENLABS_VOICE_ID must be set in the environment." >&2
  exit 1
fi

if [[ $# -eq 0 ]]; then
  echo "Usage: $0 your text to speak..." >&2
  exit 1
fi

TEXT="$*"

# Short version for notification (avoid giant popups)
NOTIFY_TEXT="$TEXT"
MAX_LEN=160
if (( ${#NOTIFY_TEXT} > MAX_LEN )); then
  NOTIFY_TEXT="${NOTIFY_TEXT:0:MAX_LEN}..."
fi

# Show desktop notification if available
if command -v notify-send >/dev/null 2>&1; then
  notify-send "ElevenLabs TTS" "$NOTIFY_TEXT"
fi
# (Intentionally *not* using hyprctl notify to avoid double notifications)

# Choose audio player: mpv preferred, ffplay as fallback
PLAY_CMD=()
if command -v mpv >/dev/null 2>&1; then
  PLAY_CMD=(mpv --no-terminal --really-quiet -)
elif command -v ffplay >/dev/null 2>&1; then
  PLAY_CMD=(ffplay -autoexit -nodisp -loglevel quiet -)
else
  echo "Error: Need 'mpv' or 'ffplay' installed to play audio." >&2
  exit 1
fi

# Escape the text for JSON (basic but good enough for typical sentences)
JSON_TEXT="$TEXT"
JSON_TEXT=${JSON_TEXT//\\/\\\\}           # backslashes
JSON_TEXT=${JSON_TEXT//\"/\\\"}          # double quotes
JSON_TEXT=${JSON_TEXT//$'\n'/\\n}        # newlines

# Build JSON body
BODY=$(
  cat <<EOF
{
  "text": "$JSON_TEXT",
  "model_id": "$MODEL_ID",
  "voice_settings": {
    "stability": 0.5,
    "similarity_boost": 0.8
  }
}
EOF
)

# Hit ElevenLabs TTS API and stream audio to the player
curl -sS -X POST \
  "https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}?output_format=mp3_44100_128" \
  -H "xi-api-key: ${API_KEY}" \
  -H "Content-Type: application/json" \
  -H "Accept: audio/mpeg" \
  -d "$BODY" \
  | "${PLAY_CMD[@]}"
