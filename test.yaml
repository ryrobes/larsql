blocks:
- block_id: session_resolver
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT session_id, cascade_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1" --format json 2>/dev/null || echo '[{"session_id": "", "cascade_id": ""}]'
    sleep 1.0
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_string
      prefix: '"session_id":"'
      suffix: '"'
      metric: session_id
- block_id: header
  type: panel
  x: 10
  y: 2
  width: 120
  height: 5
  content:
  - '[bold magenta]RVBBIT Cascade Monitor[/bold magenta]'
  - ''
  - 'Cascade: [cyan]demo_brand_extract_v3[/cyan]'
  - 'Session: [yellow]{{session_resolver.session_id}}[/yellow] [dim](auto)[/dim]'
  block_map:
    title: RVBBIT
    overlay_color: '#9b59b6'
    darken_factor: 0.5
    blend_opacity: 0.4
    border: false
    padding: 1
- block_id: status_setup_brands
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT MAX(CASE WHEN role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name = 'setup_brands'" --format json 2>/dev/null || echo '[{"completed": 0, "started": 0, "cost": 0}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"completed":'
      metric: completed
    - type: extract_number
      prefix: '"started":'
      metric: started
    - type: extract_number
      prefix: '"cost":'
      metric: cost
- block_id: status_prep
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT MAX(CASE WHEN role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name = 'prep'" --format json 2>/dev/null || echo '[{"completed": 0, "started": 0, "cost": 0}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"completed":'
      metric: completed
    - type: extract_number
      prefix: '"started":'
      metric: started
    - type: extract_number
      prefix: '"cost":'
      metric: cost
- block_id: status_lookup_brands
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT MAX(CASE WHEN role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name = 'lookup_brands'" --format json 2>/dev/null || echo '[{"completed": 0, "started": 0, "cost": 0}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"completed":'
      metric: completed
    - type: extract_number
      prefix: '"started":'
      metric: started
    - type: extract_number
      prefix: '"cost":'
      metric: cost
- block_id: status_extract_brand
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT MAX(CASE WHEN role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name = 'extract_brand'" --format json 2>/dev/null || echo '[{"completed": 0, "started": 0, "cost": 0}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"completed":'
      metric: completed
    - type: extract_number
      prefix: '"started":'
      metric: started
    - type: extract_number
      prefix: '"cost":'
      metric: cost
- block_id: status_validate
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT MAX(CASE WHEN role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name = 'validate'" --format json 2>/dev/null || echo '[{"completed": 0, "started": 0, "cost": 0}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"completed":'
      metric: completed
    - type: extract_number
      prefix: '"started":'
      metric: started
    - type: extract_number
      prefix: '"cost":'
      metric: cost
- block_id: cell_setup_brands
  type: panel
  x: 10
  y: 8
  width: 38
  height: 12
  content:
  - '[bold cyan]setup_brands[/bold cyan]'
  - '[dim]TOOL[/dim]'
  - ''
  - 'Status: {{status_setup_brands.completed == 1 ? ''[green]Complete[/green]'' :
    (status_setup_brands.started == 1 ? ''[yellow]Running...[/yellow]'' : ''[dim]Pending[/dim]'')}}'
  - 'Cost: ${{status_setup_brands.cost}}'
  block_map:
    title: setup_brands
    overlay_color: '{{gradient(status_setup_brands.completed, 0, 1, ''#2c3e50'', ''#27ae60'')}}'
    border_color: '{{status_setup_brands.completed == 1 ? ''#27ae60'' : (status_setup_brands.started
      == 1 ? ''#f39c12'' : ''#3c3c5c'')}}'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: true
    padding: 1
  parent_of:
  - cell_prep
  connection_style:
    line_style: solid
    color: cyan
    opacity: 0.4
- block_id: cell_prep
  type: panel
  x: 56
  y: 8
  width: 38
  height: 12
  content:
  - '[bold cyan]prep[/bold cyan]'
  - '[dim]TOOL[/dim]'
  - ''
  - 'Status: {{status_prep.completed == 1 ? ''[green]Complete[/green]'' : (status_prep.started
    == 1 ? ''[yellow]Running...[/yellow]'' : ''[dim]Pending[/dim]'')}}'
  - 'Cost: ${{status_prep.cost}}'
  block_map:
    title: prep
    overlay_color: '{{gradient(status_prep.completed, 0, 1, ''#2c3e50'', ''#27ae60'')}}'
    border_color: '{{status_prep.completed == 1 ? ''#27ae60'' : (status_prep.started
      == 1 ? ''#f39c12'' : ''#3c3c5c'')}}'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: true
    padding: 1
  parent_of:
  - cell_lookup_brands
  connection_style:
    line_style: solid
    color: cyan
    opacity: 0.4
- block_id: cell_lookup_brands
  type: panel
  x: 102
  y: 8
  width: 38
  height: 12
  content:
  - '[bold cyan]lookup_brands[/bold cyan]'
  - '[dim]TOOL[/dim]'
  - ''
  - 'Status: {{status_lookup_brands.completed == 1 ? ''[green]Complete[/green]'' :
    (status_lookup_brands.started == 1 ? ''[yellow]Running...[/yellow]'' : ''[dim]Pending[/dim]'')}}'
  - 'Cost: ${{status_lookup_brands.cost}}'
  block_map:
    title: lookup_brands
    overlay_color: '{{gradient(status_lookup_brands.completed, 0, 1, ''#2c3e50'',
      ''#27ae60'')}}'
    border_color: '{{status_lookup_brands.completed == 1 ? ''#27ae60'' : (status_lookup_brands.started
      == 1 ? ''#f39c12'' : ''#3c3c5c'')}}'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: true
    padding: 1
  parent_of:
  - cell_extract_brand
  connection_style:
    line_style: solid
    color: cyan
    opacity: 0.4
- block_id: cell_extract_brand
  type: panel
  x: 148
  y: 8
  width: 38
  height: 12
  content:
  - '[bold cyan]extract_brand[/bold cyan]'
  - '[dim]LLM x3[/dim]'
  - ''
  - 'Status: {{status_extract_brand.completed == 1 ? ''[green]Complete[/green]'' :
    (status_extract_brand.started == 1 ? ''[yellow]Running...[/yellow]'' : ''[dim]Pending[/dim]'')}}'
  - 'Cost: ${{status_extract_brand.cost}}'
  - '[dim]Skills: brave_web_search[/dim]'
  block_map:
    title: extract_brand
    overlay_color: '{{gradient(status_extract_brand.completed, 0, 1, ''#2c3e50'',
      ''#27ae60'')}}'
    border_color: '{{status_extract_brand.completed == 1 ? ''#27ae60'' : (status_extract_brand.started
      == 1 ? ''#f39c12'' : ''#3c3c5c'')}}'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: true
    padding: 1
  parent_of:
  - cell_validate
  connection_style:
    line_style: solid
    color: cyan
    opacity: 0.4
- block_id: cell_validate
  type: panel
  x: 194
  y: 8
  width: 38
  height: 12
  content:
  - '[bold cyan]validate[/bold cyan]'
  - '[dim]LLM[/dim]'
  - ''
  - 'Status: {{status_validate.completed == 1 ? ''[green]Complete[/green]'' : (status_validate.started
    == 1 ? ''[yellow]Running...[/yellow]'' : ''[dim]Pending[/dim]'')}}'
  - 'Cost: ${{status_validate.cost}}'
  block_map:
    title: validate
    overlay_color: '{{gradient(status_validate.completed, 0, 1, ''#2c3e50'', ''#27ae60'')}}'
    border_color: '{{status_validate.completed == 1 ? ''#27ae60'' : (status_validate.started
      == 1 ? ''#f39c12'' : ''#3c3c5c'')}}'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: true
    padding: 1
- block_id: execution_state
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT cell_name, MAX(CASE WHEN node_type='cell_complete' OR role='cell_complete' THEN 1 ELSE 0 END) as completed, MAX(CASE WHEN node_type='cell_start' OR role='cell_start' THEN 1 ELSE 0 END) as started, round(COALESCE(SUM(cost), 0), 4) as cost, COALESCE(SUM(total_tokens), 0) as tokens FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) GROUP BY cell_name" --format json 2>/dev/null || echo '[]'
    sleep 0.5
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: structured
      format: json
      path: $
      store_as: cells
- block_id: metrics_fetcher
  type: continuous
  visible: false
  command: |-
    while true; do
    rvbbit sql query "SELECT round(COALESCE(SUM(cost), 0), 4) as total_cost, COALESCE(SUM(total_tokens), 0) as total_tokens, COUNT(DISTINCT cell_name) as cells_touched, COUNT(DISTINCT trace_id) as total_messages FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1)" --format json 2>/dev/null || echo '[{}]'
    sleep 1
    done
  x: 0
  y: 0
  width: 1
  height: 1
  data_extraction:
    patterns:
    - type: extract_number
      prefix: '"total_cost":'
      metric: total_cost
    - type: extract_number
      prefix: '"total_tokens":'
      metric: total_tokens
    - type: extract_number
      prefix: '"cells_touched":'
      metric: cells_touched
    - type: extract_number
      prefix: '"total_messages":'
      metric: total_messages
- block_id: metrics_panel
  type: panel
  x: 245
  y: 8
  width: 35
  height: 10
  content:
  - '[bold cyan]Execution Metrics[/bold cyan]'
  - ''
  - 'Total Cost:   ${{metrics_fetcher.total_cost}}'
  - 'Total Tokens: {{metrics_fetcher.total_tokens}}'
  - 'Cells:        {{metrics_fetcher.cells_touched}}'
  - 'Messages:     {{metrics_fetcher.total_messages}}'
  block_map:
    title: Metrics
    overlay_color: '#27ae60'
    darken_factor: 0.6
    blend_opacity: 0.3
    border: false
    padding: 1
- block_id: cost_chart
  type: continuous
  command: |-
    while true; do
    rvbbit sql query "SELECT cell_name, round(SUM(cost), 4) as cost FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND cell_name != '' GROUP BY cell_name ORDER BY cost DESC LIMIT 8" --format json 2>/dev/null | cheshire "SELECT cell_name as x, cost as y FROM data" bar 0 --title "Cost by Cell" 2>/dev/null || echo "Waiting for data..."
    sleep 2
    done
  x: 245
  y: 20
  width: 35
  height: 12
  block_map:
    title: Cost by Cell
    overlay_color: '#1a1a2e'
    darken_factor: 0.7
    blend_opacity: 0.4
    border: true
    padding: 1
- block_id: execution_log
  type: continuous
  command: |-
    while true; do
    rvbbit sql query "SELECT substring(toString(timestamp), 12, 8) as time, cell_name, role, substring(content, 1, 60) as preview FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) AND role IN ('cell_start', 'cell_complete', 'assistant', 'tool') ORDER BY timestamp DESC LIMIT 15" --format table 2>/dev/null || echo 'Waiting for data...'
    sleep 0.5
    done
  x: 10
  y: 25
  width: 120
  height: 15
  block_map:
    title: Execution Log
    overlay_color: '#1a1a2e'
    darken_factor: 0.7
    blend_opacity: 0.4
    border: false
    padding: 1
- block_id: timeline_chart
  type: continuous
  command: |-
    while true; do
    rvbbit sql query "SELECT toUnixTimestamp(timestamp) as ts, count(*) as cnt FROM all_data WHERE session_id IN (SELECT session_id FROM all_data WHERE cascade_id = 'demo_brand_extract_v3' ORDER BY timestamp DESC LIMIT 1) GROUP BY ts ORDER BY ts" --format json 2>/dev/null | cheshire "SELECT ts as x, cnt as y FROM data" line 0 --title "Activity" 2>/dev/null || echo "Waiting for data..."
    sleep 2
    done
  x: 245
  y: 33
  width: 35
  height: 12
  block_map:
    title: Message Timeline
    overlay_color: '#0f3460'
    darken_factor: 0.7
    blend_opacity: 0.4
    border: true
    padding: 1
background_image: /home/ryanr/repos/rvbbit/rvbbit/rvbbit/tui/background5.jpg
background_darken: 0.6
