# Test: Ward Modes (Blocking and Advisory)
# Tests: Different ward validation modes - blocking aborts, advisory warns
# Expected: Blocking wards stop execution, advisory wards continue with warnings

cascade_id: integration_test_ward_modes
description: |
  Integration test verifying ward modes:
  - advisory mode: logs warning but continues execution
  - We test advisory mode which should pass through

inputs_schema: {}

cells:
  # Cell 1: Generate content with advisory ward
  - name: generate_content
    instructions: |
      Write a short greeting message (1-2 sentences).
      Just the greeting, nothing else.
    rules:
      max_turns: 1
    wards:
      post:
        - mode: advisory
          validator:
            python: |
              # Advisory ward - always passes but logs info
              text = content.strip() if content else ""
              has_content = len(text) > 5
              result = {
                "valid": has_content,
                "reason": "Content check: " + str(len(text)) + " chars"
              }
    handoffs:
      - verify

  # Cell 2: Deterministic verification
  - name: verify
    tool: python_data
    inputs:
      code: |
        checks = []
        errors = []

        # Check 1: generate_content output exists (advisory ward did not block)
        output_str = state.get('output_generate_content') or ''
        if output_str and len(output_str) > 0:
            checks.append({'check': 'advisory_ward_passed', 'passed': True})
        else:
            checks.append({'check': 'advisory_ward_passed', 'passed': False})
            errors.append("No output - advisory ward may have blocked unexpectedly")

        # Check 2: Content has reasonable length
        if len(output_str) > 5:
            checks.append({'check': 'has_content', 'passed': True})
        else:
            checks.append({'check': 'has_content', 'passed': False})
            errors.append("Content too short")

        # Check 3: Verify cell executed (proves ward mode worked)
        checks.append({'check': 'verify_executed', 'passed': True})

        all_passed = len(errors) == 0
        reason_str = 'All checks passed' if all_passed else '; '.join(errors)

        result = {
            'passed': all_passed,
            'reason': reason_str,
            'checks': checks,
            'content_preview': output_str[:100] if output_str else None
        }
