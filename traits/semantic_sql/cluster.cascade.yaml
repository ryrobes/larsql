# MEANING / CLUSTER - Semantic grouping
# Assigns each value to a semantic cluster for GROUP BY operations
#
# SQL Usage:
#   SELECT MEANING(county, 8, 'geographic region') as region, COUNT(*)
#   FROM sightings GROUP BY 1
#
# Direct Function:
#   SELECT semantic_cluster(to_json(list(county)), 8, 'geographic region') FROM sightings

cascade_id: semantic_cluster

description: |
  Semantic clustering - assigns values to semantic clusters.
  Returns a JSON object mapping each value to its cluster name.

inputs_schema:
  values: JSON array of values to cluster
  num_clusters: Number of clusters to create (default 8)
  criterion: Optional semantic guidance for clustering

sql_function:
  name: semantic_cluster
  description: Assigns values to N semantic clusters
  args:
    - name: values
      type: JSON
    - name: num_clusters
      type: INTEGER
      default: "8"
    - name: criterion
      type: VARCHAR
      optional: true
  returns: VARCHAR
  shape: AGGREGATE
  context_arg: values
  operators:
    - "MEANING({{ values }})"
    - "MEANING({{ values }}, {{ num_clusters }})"
    - "MEANING({{ values }}, {{ num_clusters }}, '{{ criterion }}')"
    - "CLUSTER({{ values }})"
    - "CLUSTER({{ values }}, {{ num_clusters }})"
  cache: true

cells:
  - name: cluster_values
    model: google/gemini-2.5-flash-lite
    instructions: |
      Cluster these values into {{ input.num_clusters | default(8) }} semantic groups.

      VALUES:
      {{ input.values }}

      {% if input.criterion %}
      CLUSTERING BY: {{ input.criterion }}
      {% else %}
      Group by semantic similarity - find natural categories.
      {% endif %}

      Return a JSON object mapping each value to its cluster name:
      {"value1": "Cluster A", "value2": "Cluster B", "value3": "Cluster A", ...}

      Rules:
      - Create approximately {{ input.num_clusters | default(8) }} distinct clusters
      - Cluster names should be short and descriptive (2-4 words)
      - Every input value must appear as a key
      - Similar values should map to the same cluster

      Return ONLY the JSON object, no explanation or markdown.
    rules:
      max_turns: 1
