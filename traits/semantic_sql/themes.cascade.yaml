# TOPICS / THEMES - Topic extraction aggregate
# Extracts N topics from text collection
#
# SQL Usage:
#   SELECT state, THEMES(observed, 5) FROM sightings GROUP BY state
#
# Direct Function:
#   SELECT semantic_themes(to_json(list(title)), 5) FROM sightings

cascade_id: semantic_themes

description: |
  Topic extraction - extracts N main topics/themes from a text collection.
  Returns a JSON array of topic strings.

inputs_schema:
  texts: JSON array of texts to analyze
  num_topics: Number of topics to extract (default 5)

sql_function:
  name: semantic_themes
  description: Extracts N topics from texts, returns JSON array of topics
  args:
    - name: texts
      type: JSON
    - name: num_topics
      type: INTEGER
      default: "5"
  returns: VARCHAR
  shape: AGGREGATE
  context_arg: texts
  operators:
    - "THEMES({{ texts }})"
    - "THEMES({{ texts }}, {{ num_topics }})"
    - "TOPICS({{ texts }})"
    - "TOPICS({{ texts }}, {{ num_topics }})"
  cache: true

cells:
  - name: extract_themes
    model: google/gemini-2.5-flash-lite
    instructions: |
      Analyze these texts and identify the {{ input.num_topics | default(5) }} main topics/themes.

      TEXTS:
      {{ input.texts }}

      Return a JSON array of topic names - short, descriptive labels:
      ["Topic 1", "Topic 2", "Topic 3"]

      Rules:
      - Extract exactly {{ input.num_topics | default(5) }} topics
      - Topics should be distinct and non-overlapping
      - Topic names should be concise (2-5 words)
      - Order by prevalence (most common first)

      Return ONLY the JSON array, no explanation or markdown.
    rules:
      max_turns: 1
